{% extends 'base.html' %}
{% block title %}Évènement — {{ ev.title }}{% endblock %}
{% block content %}
<div class="header-row">
  <div>
    <h1 class="mb-0">{{ ev.title }}</h1>
    <p class="muted">Le {{ ev.date.strftime('%d/%m/%Y %H:%M') }} — {{ ev.location or '—' }}</p>
  </div>

  <form method="post" action="{{ url_for('events.change_state', event_id=ev.id) }}" class="row gap-8">
    <select name="state">
      <option value="draft"       {% if ev.state=='draft' %}selected{% endif %}>Brouillon</option>
      <option value="in_progress" {% if ev.state=='in_progress' %}selected{% endif %}>En cours</option>
      <option value="closed"      {% if ev.state=='closed' %}selected{% endif %}>Clôturé</option>
    </select>
    <button class="btn" type="submit"><i class="fa-solid fa-toggle-on"></i> Changer</button>
  </form>
</div>

<div class="row gap-8 my-12">
  <a class="btn" href="{{ url_for('events.event_link', event_id=ev.id) }}">
    <i class="fa-solid fa-share-nodes"></i> Lien secouristes
  </a>
  <a class="btn" href="{{ url_for('events.export_csv', event_id=ev.id) }}"><i class="fa-solid fa-file-csv"></i> Export CSV</a>
  <a class="btn" href="{{ url_for('events.export_pdf', event_id=ev.id) }}"><i class="fa-solid fa-file-pdf"></i> Export PDF</a>
  <a class="btn" href="{{ url_for('events.export_log', event_id=ev.id) }}"><i class="fa-solid fa-clock-rotate-left"></i> Journal</a>
</div>

<div id="live" data-event="{{ ev.id }}">
  <div class="grid">
    {% for parent, children in tree %}
    <div class="card parent-card" id="parent-{{ parent.id }}" data-parent="{{ parent.id }}">
      <div class="row-between">
        <h3 class="parent-title">{{ parent.name }}</h3>
        <label class="switch">
          <input type="checkbox"
                 onchange="toggleLoaded({{ ev.id }}, {{ parent.id }}, this.checked)"
                 data-loaded-for="{{ parent.id }}">
          <span>Chargé</span>
        </label>
      </div>

      <ul class="list children" id="children-{{ parent.id }}">
        {% for c in children %}
        <li class="child-row" data-item="{{ c.id }}">
          <label class="row-between">
            <span>
              <!-- en vue chef/admin, la coche est en lecture seule (MAIS on la affiche live) -->
              <input type="checkbox" disabled data-checkbox="{{ c.id }}">
              <span class="child-name">{{ c.name }}</span>
              <span class="muted">×{{ c.expected_qty }}</span>
            </span>
            <span class="byline muted small">
              par <span class="who" data-who="{{ c.id }}">—</span>
              <span class="when" data-when="{{ c.id }}"></span>
            </span>
          </label>
        </li>
        {% endfor %}
        {% if not children %}
        <li class="muted">Aucun élément enfant inclus pour ce parent.</li>
        {% endif %}
      </ul>

      <div class="muted small busy" id="busy-{{ parent.id }}"></div>
    </div>
    {% endfor %}
  </div>

  <div class="mt-16">
    <h3>Historique</h3>
    <ul id="history" class="list"></ul>
  </div>
</div>

<script>
  // Démarre le poll /1s pour appliquer les changements live
  if(typeof startLive === 'function'){ startLive(1000); }
</script>
{% endblock %}
