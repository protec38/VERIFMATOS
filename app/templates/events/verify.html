{% extends 'base.html' %}
{% block title %}Checklist • MediCheck{% endblock %}
{% block content %}
<div id="verify-live" data-token="{{ token }}"></div>

<div class="bg-white rounded-2xl shadow p-4 mb-4">
  <div class="text-sm text-slate-600">
    Connecté en tant que <strong>{{ actor }}</strong>
  </div>
</div>

<div class="grid lg:grid-cols-2 gap-4">
  {% for ep in parents %}
    {% set pid = ep.parent.id %}
    <div class="parent-card bg-white rounded-2xl shadow p-4" data-parent="{{ pid }}">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium flex items-center gap-2">
          <i class="fa-solid {{ ep.parent.icon or 'fa-box-open' }}"></i> {{ ep.parent.name }}
        </div>
        <span class="text-xs px-2 py-1 rounded-full {{ 'bg-green-100 text-green-700' if ep.complete else 'bg-slate-100 text-slate-600' }}">
          {{ 'Complet' if ep.complete else 'En cours' }}
        </span>
      </div>
      <ul class="space-y-2">
        {% for ec in ep.children %}
          {% set c = ec.child %}
          <li class="child-row flex items-center justify-between p-3 rounded-xl border {{ 'ok' if ec.verified else '' }}" data-item="{{ c.id }}">
            <div class="flex items-center gap-3">
              <input type="checkbox" {% if ec.verified %}checked{% endif %}
                     onchange="markVerified('{{ token }}', {{ c.id }}, this.checked)">
              <div class="flex items-center gap-2">
                <i class="fa-solid {{ c.icon or 'fa-pills' }}"></i>
                <span class="font-medium">{{ c.name }}</span>
                <span class="text-xs text-slate-500">x{{ c.expected_qty }}</span>
              </div>
            </div>
            <div class="text-xs text-slate-500">
              <span class="who" data-who="{{ c.id }}">{{ ec.verified_by or '—' }}</span>
              <span class="when" data-when="{{ c.id }}">{{ ec.verified_at.strftime('— %d/%m %H:%M') if ec.verified_at else '' }}</span>
            </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endfor %}
</div>

<div class="mt-8">
  <a class="px-4 py-2 rounded-xl border" href="{{ url_for('events.verify_access', token=token) }}"><i class="fa-solid fa-arrow-left"></i> Changer d'identité</a>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.startVerifyLive && window.startVerifyLive(1000);
</script>
{% endblock %}
