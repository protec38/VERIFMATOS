{% extends 'base.html' %}
{% block title %}Vérification — {{ ev.title }}{% endblock %}
{% block content %}
<div id="verify-live" data-token="{{ ev.token }}">
  <header class="row-between">
    <div>
      <h1 class="mb-0">{{ ev.title }}</h1>
      <p class="muted">Le {{ ev.date.strftime('%d/%m/%Y %H:%M') }} — {{ ev.location or '—' }}</p>
    </div>
    <div class="pill pill-info"><i class="fa-solid fa-user"></i> {{ session.get('volunteer_name') }}</div>
  </header>

  <p class="muted small">Coche les <b>feuilles</b> (éléments finaux). Les parents passent en vert quand toutes leurs feuilles sont OK.</p>

  <div class="grid">
  {% for parent, leaves in data %}
    <div class="card parent-card" id="parent-{{ parent.id }}" data-parent="{{ parent.id }}">
      <div class="row-between">
        <h3 class="parent-title">{{ parent.name }}</h3>
        <div class="pill pill-muted small"><i class="fa-solid fa-diagram-project"></i> Parent</div>
      </div>

      <ul class="list children" id="children-{{ parent.id }}">
        {% for c in leaves %}
        <li class="child-row" data-item="{{ c.id }}">
          <label class="row-between">
            <span>
              <input type="checkbox" onchange="markVerified('{{ ev.token }}', {{ c.id }}, this.checked)">
              <span class="child-name">{{ c.name }}</span>
              <span class="muted">×{{ c.expected_qty }}</span>
            </span>
            <span class="byline muted small">par <span class="who" data-who="{{ c.id }}">—</span> <span class="when" data-when="{{ c.id }}"></span></span>
          </label>
        </li>
        {% endfor %}
      </ul>
      <div class="muted small busy" id="busy-{{ parent.id }}"></div>
    </div>
  {% endfor %}
  </div>
</div>

<script>
  document.querySelectorAll('.parent-card').forEach(card=>{
    const parentId = card.dataset.parent;
    const token = document.getElementById('verify-live').dataset.token;
    let lastPing = 0;
    function ping(){
      const now = Date.now();
      if(now - lastPing < 3000) return;
      lastPing = now;
      fetch(`/events/api/token/${token}/presence`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ parent_id: parseInt(parentId) })
      }).catch(()=>{});
    }
    card.addEventListener('mouseenter', ping);
    card.addEventListener('touchstart', ping, {passive:true});
    ping();
  });
  if(typeof startVerifyLive==='function'){ startVerifyLive(1000); }
</script>
{% endblock %}
