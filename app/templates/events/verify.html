{% extends 'base.html' %}
{% block title %}Vérification — {{ ev.title }}{% endblock %}
{% block content %}
<div id="verify-live" data-token="{{ ev.token }}">
  <header class="row-between">
    <div>
      <h1 class="mb-0">{{ ev.title }}</h1>
      <p class="muted">Le {{ ev.date.strftime('%d/%m/%Y %H:%M') }} — {{ ev.location or '—' }}</p>
    </div>
    <div class="pill pill-info">
      <i class="fa-solid fa-user"></i>
      <span>{{ session.get('volunteer_name') }}</span>
    </div>
  </header>

  <p class="muted small">Coche les éléments <strong>enfants</strong>. Quand tous les enfants d’un parent sont OK, le parent passe automatiquement en vert.</p>

  <div class="grid">
    {% for parent, children in data %}
    <div class="card parent-card" id="parent-{{ parent.id }}" data-parent="{{ parent.id }}">
      <div class="row-between">
        <h3 class="parent-title">{{ parent.name }}</h3>
        <div class="pill pill-muted small">
          <i class="fa-solid fa-boxes-stacked"></i>
          <span>Parent</span>
        </div>
      </div>

      <ul class="list children" id="children-{{ parent.id }}">
        {% for c in children %}
        <li class="child-row" data-item="{{ c.id }}">
          <label class="row-between">
            <span>
              <input type="checkbox"
                     onchange="markVerified('{{ ev.token }}', {{ c.id }}, this.checked)">
              <span class="child-name">{{ c.name }}</span>
              <span class="muted">×{{ c.expected_qty }}</span>
            </span>
            <span class="byline muted small">
              par <span class="who" data-who="{{ c.id }}">—</span>
              <span class="when" data-when="{{ c.id }}"></span>
            </span>
          </label>
        </li>
        {% endfor %}
        {% if not children %}
        <li class="muted">Aucun enfant inclus pour ce parent.</li>
        {% endif %}
      </ul>

      <div class="muted small busy" id="busy-{{ parent.id }}"></div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  // Ping de présence sur chaque parent (hover/touch) pour afficher qui bosse dessus
  document.querySelectorAll('.parent-card').forEach(card=>{
    const parentId = card.dataset.parent;
    const token = document.getElementById('verify-live').dataset.token;

    let lastPing = 0;
    function ping(){
      const now = Date.now();
      if(now - lastPing < 3000) return; // throttle 3s
      lastPing = now;
      fetch(`/events/api/token/${token}/presence`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({parent_id: parseInt(parentId)})
      }).catch(()=>{});
    }

    card.addEventListener('mouseenter', ping);
    card.addEventListener('touchstart', ping, {passive:true});
    // ping une fois au montage
    ping();
  });

  // Lancement du live poll (1s)
  if(typeof startVerifyLive === 'function'){ startVerifyLive(1000); }
</script>
{% endblock %}
