{% extends "base.html" %}
{% set title = "Tableau de bord" %}
{% block content %}

<style>
  :root {
    --panel-bg: #0f1b2b;
    --panel-border: rgba(158, 201, 255, 0.18);
    --panel-shadow: 0 12px 40px rgba(12, 22, 35, 0.35);
    --divider: rgba(255, 255, 255, 0.05);
  }

  .dashboard-layout {
    display: grid;
    gap: 24px;
  }

  @media (min-width: 1180px) {
    .dashboard-layout {
      grid-template-columns: minmax(0, 1.45fr) minmax(0, 1fr);
      align-items: start;
    }
  }

  @media (min-width: 1440px) {
    .dashboard-layout {
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
    }
  }

  .panel {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 18px;
    box-shadow: var(--panel-shadow);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .panel-header {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .panel-header h2 {
    font-size: 1.4rem;
    font-weight: 700;
    margin: 0;
  }

  .panel-subtitle {
    color: var(--muted);
    margin: 0;
    line-height: 1.5;
  }

  .form-grid {
    display: grid;
    gap: 12px;
  }

  @media (min-width: 720px) {
    .form-grid.two {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group label {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .slot-card {
    border-radius: 14px;
    border: 1px solid var(--panel-border);
    background: #101f33;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .slot-card h3 {
    font-size: 1.1rem;
    margin: 0;
  }

  .slot-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .slot-list[aria-live="polite"] {
    min-height: 44px;
  }

  .slot-chip {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px dashed rgba(158, 201, 255, 0.32);
    background: rgba(15, 32, 53, 0.65);
  }

  .slot-chip .info {
    font-weight: 700;
    color: #dce9ff;
  }

  .slot-chip .meta {
    color: var(--muted);
    font-size: 0.85rem;
  }

  .slot-form {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .slot-form input {
    flex: 1;
    min-width: 200px;
  }

  .slot-hint {
    color: var(--muted);
    font-size: 0.85rem;
  }

  .template-selectors {
    display: grid;
    gap: 14px;
    padding: 18px;
    border-radius: 14px;
    background: rgba(16, 37, 56, 0.65);
    border: 1px solid rgba(158, 201, 255, 0.12);
  }

  fieldset.root-groups {
    border: 1px solid rgba(158, 201, 255, 0.18);
    border-radius: 14px;
    padding: 18px;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: rgba(12, 26, 43, 0.55);
  }

  fieldset.root-groups legend {
    font-weight: 600;
    padding: 0 8px;
  }

  .root-group {
    border-radius: 12px;
    border: 1px solid rgba(158, 201, 255, 0.14);
    padding: 14px;
    background: rgba(16, 31, 49, 0.65);
    display: grid;
    gap: 10px;
  }

  .root-group header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    font-weight: 600;
  }

  .root-group header span {
    font-size: 0.75rem;
  }

  .root-group-nodes {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .root-group-empty {
    font-size: 0.85rem;
    color: var(--muted);
  }

  label.root-node {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(158, 201, 255, 0.25);
    background: rgba(11, 23, 38, 0.85);
    cursor: pointer;
    transition: border-color 0.2s ease, background 0.2s ease;
  }

  label.root-node:hover,
  label.root-node:focus-within {
    border-color: rgba(135, 187, 255, 0.5);
    background: rgba(19, 43, 70, 0.9);
  }

  label.root-node input[type="checkbox"] {
    accent-color: var(--accent);
  }

  .root-qty {
    margin-left: 6px;
  }

  .panel-divider {
    height: 1px;
    width: 100%;
    background: var(--divider);
  }

  .search-meta {
    color: var(--muted);
    font-size: 0.9rem;
  }

  .table caption {
    text-align: left;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--muted);
  }

  .btn.sm {
    padding: 6px 10px;
    font-size: 0.8rem;
    border-radius: 8px;
  }

  .actions-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: flex-end;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }
</style>

<div class="dashboard-layout">
  <section class="panel" aria-labelledby="create-event-title">
    <header class="panel-header">
      <div>
        <h2 id="create-event-title">Cr√©er un √©v√©nement</h2>
        <p class="panel-subtitle">Renseigne les informations essentielles puis s√©lectionne les stocks ¬´&nbsp;parents&nbsp;¬ª √† v√©rifier.</p>
      </div>
    </header>

    <form id="event-form" class="form-grid two" onsubmit="return false;" aria-describedby="event-form-help">
      <div class="form-group">
        <label for="ev-name">Nom de l'√©v√©nement <span class="sr-only">(requis)</span></label>
        <input type="text" name="name" id="ev-name" placeholder="Nom de l'√©v√©nement" required aria-required="true">
      </div>
      <div class="form-group">
        <label for="ev-date">Date de l'√©v√©nement</label>
        <input type="date" name="date" id="ev-date" placeholder="Date (optionnel)">
      </div>
    </form>
    <p id="event-form-help" class="sr-only">Le nom de l'√©v√©nement est obligatoire. La date est optionnelle et sera renseign√©e automatiquement lors de l'ajout d'un cr√©neau.</p>

    <div class="slot-card" aria-live="polite">
      <div>
        <h3 id="slot-title">Cr√©neaux horaires</h3>
        <p class="panel-subtitle">Ajoute un ou plusieurs cr√©neaux correspondant aux p√©riodes de v√©rification.</p>
      </div>
      <div class="slot-list" id="slot-list" role="list" aria-live="polite" aria-describedby="slot-hint"></div>
      <div class="slot-form" aria-labelledby="slot-title">
        <label class="sr-only" for="slot-start">D√©but du cr√©neau</label>
        <input type="datetime-local" id="slot-start" step="900" placeholder="D√©but">
        <label class="sr-only" for="slot-end">Fin du cr√©neau</label>
        <input type="datetime-local" id="slot-end" step="900" placeholder="Fin">
        <button class="btn" type="button" id="btn-add-slot">Ajouter le cr√©neau</button>
      </div>
      <p class="slot-hint" id="slot-hint">Ajoute au moins un cr√©neau (date et heures de d√©part / fin).</p>
    </div>

    <div class="template-selectors" role="group" aria-labelledby="template-selectors-title">
      <h3 id="template-selectors-title" style="margin:0;font-size:1.05rem;">Templates et lots disponibles</h3>
      <div class="form-grid two">
        <div class="form-group">
          <label for="template-select">Appliquer un template</label>
          <select id="template-select" style="min-width:220px">
            <option value="">S√©lectionner un template‚Ä¶</option>
            {% for tpl in templates %}
              <option value="{{ tpl.id }}">{{ tpl.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="lot-select">Ajouter un lot</label>
          <select id="lot-select" style="min-width:220px">
            <option value="">Ajouter un lot‚Ä¶</option>
            {% for lot in lots %}
              <option value="{{ lot.id }}">{{ lot.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    {% if root_groups and root_groups|length %}
      <fieldset class="root-groups">
        <legend>Parents disponibles</legend>
        {% for group in root_groups %}
          <div class="root-group">
            <header>
              <span>{{ group.category.name if group.category else "Sans cat√©gorie" }}</span>
              {% if group.nodes %}
                <span class="badge" aria-label="{{ group.nodes|length }} parent{{ 's' if group.nodes|length > 1 else '' }} dans ce groupe">{{ group.nodes|length }} parent{{ 's' if group.nodes|length > 1 else '' }}</span>
              {% endif %}
            </header>
            {% if group.nodes and group.nodes|length %}
              <div class="root-group-nodes" role="list">
                {% for r in group.nodes %}
                  <label class="root-node" role="listitem">
                    <input type="checkbox" class="root-cb" value="{{ r.id }}"
                           data-name="{{ r.name }}"
                           data-unique="{{ 1 if r.unique_item else 0 }}"
                           data-max="{{ r.unique_quantity if r.unique_quantity is not none else '' }}">
                    <span>{{ r.name }}</span>
                  </label>
                {% endfor %}
              </div>
            {% else %}
              <p class="root-group-empty">Aucun parent dans cette cat√©gorie.</p>
            {% endif %}
          </div>
        {% endfor %}
      </fieldset>
    {% else %}
      <p class="muted">Aucun parent racine disponible. Cr√©e d‚Äôabord un stock parent dans üß∞ Stock.</p>
    {% endif %}

    <div class="panel-divider" role="presentation"></div>
    <div class="actions-row">
      <button id="btn-create" class="btn primary">Cr√©er l'√©v√©nement</button>
    </div>
  </section>

  <section class="panel" aria-labelledby="recent-events-title">
    <header class="panel-header">
      <div>
        <h2 id="recent-events-title">Derniers √©v√©nements</h2>
        <p class="panel-subtitle">Consulte les √©v√©nements r√©cents, recherche un nom pr√©cis ou exporte le rapport PDF.</p>
      </div>
    </header>

    <form method="get" class="form-grid" style="gap:12px;" aria-label="Recherche d'√©v√©nements">
      <div class="form-group" style="margin:0;">
        <label for="event-search">Rechercher un √©v√©nement</label>
        <input id="event-search" type="search" name="q" placeholder="Rechercher un √©v√©nement" value="{{ search_query }}" style="flex:1;min-width:220px;">
      </div>
      <div class="actions-row" style="justify-content:flex-start;">
        <button class="btn" type="submit">Rechercher</button>
        {% if search_query %}
          <a class="btn ghost" href="{{ url_for('pages.dashboard') }}">R√©initialiser</a>
        {% endif %}
      </div>
    </form>
    {% if search_query %}
      <p class="search-meta" role="status">{{ events|length }} r√©sultat{{ 's' if events|length > 1 else '' }} pour ¬´ {{ search_query }} ¬ª.</p>
    {% endif %}

    <table class="table" style="margin-top:8px" aria-describedby="recent-events-title">
      <caption>Liste des √©v√©nements avec liens rapides.</caption>
      <thead>
        <tr>
          <th scope="col">Nom</th>
          <th scope="col">Statut</th>
          <th scope="col">Date</th>
          <th scope="col" style="width:270px">Actions</th>
        </tr>
      </thead>
      <tbody id="events-body">
        {% for ev in events %}
        <tr data-id="{{ ev.id }}">
          <td><a href="{{ url_for('pages.event_page', event_id=ev.id) }}">{{ ev.name }}</a></td>
          <td><span class="badge">{{ ev.status }}</span></td>
          <td>{{ ev.date or "‚Äî" }}</td>
          <td class="row" style="gap:8px;">
            <a class="btn" href="{{ url_for('pages.event_page', event_id=ev.id) }}">Ouvrir</a>
            <a class="btn" target="_blank" href="/reports/event/{{ ev.id }}/pdf">Export PDF</a>
            <button class="btn danger btn-del" data-id="{{ ev.id }}">Supprimer</button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="muted">
            {% if search_query %}
              Aucun √©v√©nement ne correspond √† ¬´ {{ search_query }} ¬ª.
            {% else %}
              Aucun √©v√©nement pour le moment.
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<script>
(function(){
  const byId = (id)=>document.getElementById(id);
  const rootSelections = new Map();
  const templateSpecs = {{ templates|tojson }};
  const lotSpecs = {{ lots|tojson }};
  const templateMap = new Map((templateSpecs||[]).map(t => [String(t.id), t]));
  const lotMap = new Map((lotSpecs||[]).map(t => [String(t.id), t]));
  const searchQuery = {{ search_query|tojson }};
  const isSearchActive = typeof searchQuery === 'string' && searchQuery.trim().length > 0;
  const slotList = byId('slot-list');
  const slotHint = byId('slot-hint');
  const slotStartInput = byId('slot-start');
  const slotEndInput = byId('slot-end');
  const slotAddBtn = byId('btn-add-slot');
  const evDateInput = byId('ev-date');
  const slotsState = [];
  const fmtSlotDay = new Intl.DateTimeFormat('fr-FR', {weekday:'short', day:'2-digit', month:'short'});
  const fmtSlotTime = new Intl.DateTimeFormat('fr-FR', {hour:'2-digit', minute:'2-digit'});

  function slotLabel(start, end){
    const startDate = new Date(start);
    const endDate = new Date(end);
    if(isNaN(startDate) || isNaN(endDate)){
      return `${start} ‚Üí ${end}`;
    }
    const sameDay = startDate.getFullYear() === endDate.getFullYear()
      && startDate.getMonth() === endDate.getMonth()
      && startDate.getDate() === endDate.getDate();
    if(sameDay){
      return `${fmtSlotDay.format(startDate)} ‚Ä¢ ${fmtSlotTime.format(startDate)} ‚Üí ${fmtSlotTime.format(endDate)}`;
    }
    return `${fmtSlotDay.format(startDate)} ‚Ä¢ ${fmtSlotTime.format(startDate)} ‚Üí ${fmtSlotDay.format(endDate)} ‚Ä¢ ${fmtSlotTime.format(endDate)}`;
  }

  function renderSlots(){
    if(!slotList) return;
    slotList.innerHTML = '';
    if(slotsState.length === 0){
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = 'Aucun cr√©neau ajout√© pour le moment.';
      slotList.appendChild(empty);
      if(slotHint){ slotHint.textContent = 'Ajoute au moins un cr√©neau (date et heures de d√©part / fin).'; }
      return;
    }

    slotsState.forEach((slot, index) => {
      const row = document.createElement('div');
      row.className = 'slot-chip';
      row.setAttribute('role', 'listitem');

      const info = document.createElement('div');
      info.className = 'info';
      info.textContent = slotLabel(slot.start, slot.end);
      row.appendChild(info);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `Cr√©neau ${index + 1}`;
      row.appendChild(meta);

      const remove = document.createElement('button');
      remove.className = 'btn danger sm';
      remove.type = 'button';
      remove.setAttribute('aria-label', `Retirer le cr√©neau ${index + 1}`);
      remove.textContent = 'Retirer';
      remove.addEventListener('click', () => {
        slotsState.splice(index, 1);
        renderSlots();
      });
      row.appendChild(remove);

      slotList.appendChild(row);
    });

    if(slotHint){
      slotHint.textContent = `${slotsState.length} cr√©neau${slotsState.length>1?'x':''} configur√©${slotsState.length>1?'s':''}.`;
    }
  }

  slotAddBtn?.addEventListener('click', () => {
    const startVal = (slotStartInput?.value || '').trim();
    const endVal = (slotEndInput?.value || '').trim();
    if(!startVal || !endVal){
      alert('Renseigne la date et les heures de d√©but/fin.');
      return;
    }
    const startDate = new Date(startVal);
    const endDate = new Date(endVal);
    if(isNaN(startDate) || isNaN(endDate)){
      alert('Format de date/heure invalide.');
      return;
    }
    if(endDate <= startDate){
      alert('La fin du cr√©neau doit √™tre apr√®s le d√©but.');
      return;
    }
    if(slotsState.some(slot => slot.start === startVal && slot.end === endVal)){
      alert('Ce cr√©neau est d√©j√† pr√©sent.');
      return;
    }
    const overlaps = slotsState.some(slot => {
      const existingStart = new Date(slot.start);
      const existingEnd = new Date(slot.end);
      return endDate > existingStart && startDate < existingEnd;
    });
    if(overlaps && !confirm('Ce cr√©neau chevauche un autre cr√©neau d√©j√† ajout√©. Continuer malgr√© tout ?')){
      return;
    }
    slotsState.push({start: startVal, end: endVal});
    slotsState.sort((a,b)=> new Date(a.start) - new Date(b.start));
    if(evDateInput && !evDateInput.value){
      evDateInput.value = startVal.slice(0, 10);
    }
    if(slotStartInput){ slotStartInput.value = ''; }
    if(slotEndInput){ slotEndInput.value = ''; }
    renderSlots();
  });

  renderSlots();

  function updateRootBadge(cb){
    const wrap = cb.closest('label');
    if(!wrap) return;
    let badge = wrap.querySelector('.root-qty');
    const id = parseInt(cb.value, 10);
    const qty = rootSelections.get(id);
    if(badge && (!cb.checked || qty==null)){
      badge.remove();
      badge = null;
    }
    if(cb.checked && qty != null){
      if(!badge){
        badge = document.createElement('span');
        badge.className = 'badge root-qty';
        badge.style.marginLeft = '6px';
        badge.setAttribute('aria-label', `Quantit√© s√©lectionn√©e: ${qty}`);
        wrap.appendChild(badge);
      }
      badge.textContent = `Qt√©: ${qty}`;
    }
  }

  document.querySelectorAll('.root-cb').forEach(cb => {
    cb.addEventListener('change', () => {
      const id = parseInt(cb.value, 10);
      const isUnique = (cb.dataset.unique === '1');
      if(cb.checked){
        if(isUnique){
          const maxRaw = cb.dataset.max;
          const max = maxRaw ? parseInt(maxRaw, 10) : null;
          const current = rootSelections.get(id) ?? (max ?? 1);
          const label = cb.dataset.name || 'parent';
          let msg = `Quantit√© d√©sir√©e pour ${label}`;
          if(max != null){ msg += ` (max ${max})`; }
          let input = prompt(msg, String(current));
          if(input === null){
            cb.checked = false;
            return;
          }
          let qty = parseInt(input, 10);
          if(isNaN(qty) || qty < 0){
            alert('Quantit√© invalide');
            cb.checked = false;
            return;
          }
          if(max != null && qty > max){
            alert(`Quantit√© sup√©rieure au maximum (${max}).`);
            cb.checked = false;
            return;
          }
          rootSelections.set(id, qty);
        }else{
          rootSelections.delete(id);
        }
      }else{
        rootSelections.delete(id);
      }
      updateRootBadge(cb);
    });
  });

  function clearSelection(){
    document.querySelectorAll('.root-cb').forEach(cb => {
      cb.checked = false;
      const id = parseInt(cb.value, 10);
      rootSelections.delete(id);
      updateRootBadge(cb);
    });
  }

  function applyNodes(nodes, {reset=false}={}){
    if(reset){
      clearSelection();
    }
    if(!Array.isArray(nodes)) return;
    nodes.forEach(spec => {
      if(!spec) return;
      const id = parseInt(spec.id ?? spec.node_id, 10);
      if(!id) return;
      const cb = document.querySelector(`.root-cb[value="${id}"]`);
      if(!cb) return;
      cb.checked = true;
      if(spec.quantity != null){
        rootSelections.set(id, spec.quantity);
      }else{
        rootSelections.delete(id);
      }
      updateRootBadge(cb);
    });
  }

  function buildSelectionPayload(){
    const payload = [];
    document.querySelectorAll('.root-cb:checked').forEach(cb => {
      const id = parseInt(cb.value, 10);
      if(!id) return;
      const entry = {id};
      if(rootSelections.has(id)){
        entry.quantity = rootSelections.get(id);
      }
      payload.push(entry);
    });
    return payload;
  }

  const tplSelect = byId('template-select');
  tplSelect?.addEventListener('change', () => {
    const choice = tplSelect.value;
    if(!choice) return;
    const tpl = templateMap.get(choice);
    if(tpl){
      applyNodes(tpl.nodes || [], {reset:true});
    }
    tplSelect.value = '';
  });

  const lotSelect = byId('lot-select');
  lotSelect?.addEventListener('change', () => {
    const choice = lotSelect.value;
    if(!choice) return;
    const lot = lotMap.get(choice);
    if(lot){
      applyNodes(lot.nodes || [], {reset:false});
    }
    lotSelect.value = '';
  });

  // -------- Cr√©ation --------
  let creating = false;
  byId('btn-create')?.addEventListener('click', async () => {
    if (creating) return;
    const name = byId('ev-name').value.trim();
    const date = byId('ev-date').value || null;
    const selectedCbs = Array.from(document.querySelectorAll('.root-cb:checked'));
    const rootsPayload = [];
    for(const cb of selectedCbs){
      const id = parseInt(cb.value, 10);
      const isUnique = (cb.dataset.unique === '1');
      if(isUnique){
        if(!rootSelections.has(id)){
          alert(`S√©lectionne une quantit√© pour ${cb.dataset.name || 'ce parent'}.`);
          return;
        }
        rootsPayload.push({id, quantity: rootSelections.get(id)});
      }else{
        rootsPayload.push({id});
      }
    }

    if(!name){ alert("Nom requis"); return; }
    if(rootsPayload.length === 0){ alert("S√©lectionne au moins un parent"); return; }
    if(slotsState.length === 0){
      alert("Ajoute au moins un cr√©neau horaire pour l'√©v√©nement.");
      return;
    }

    const slotsPayload = slotsState.map(slot => ({start: slot.start, end: slot.end}));

    creating = true;
    try {
      const res = await fetch('/events', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'Accept':'application/json'},
        body: JSON.stringify({ name, date, roots: rootsPayload, slots: slotsPayload })
      });

      const text = await res.text();
      if(!res.ok){
        let message = text;
        try {
          const data = JSON.parse(text);
          if(data && typeof data.error === 'string'){ message = data.error; }
        } catch(_){}
        alert(message);
        return;
      }
      let data; try{ data = JSON.parse(text); }catch{ data = {}; }
      if(data.url){ location.href = data.url; }
      else { location.reload(); }
    } catch (e){
      alert("Erreur r√©seau: "+ e);
    } finally {
      creating = false;
    }
  });

  // -------- Suppression (POST fallback) --------
  function bindDeleteButtons(scope=document){
    scope.querySelectorAll('.btn-del').forEach(btn => {
      if (btn._bound) return;
      btn._bound = true;
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if(!confirm("Supprimer cet √©v√©nement ?")) return;
        try {
          const res = await fetch(`/events/${id}/delete`, {
            method: 'POST',
            headers: {'Accept':'application/json'}
          });
          if(!res.ok){
            const t = await res.text();
            alert(t);
            return;
          }
          const tr = document.querySelector(`tr[data-id="${id}"]`);
          tr?.parentNode?.removeChild(tr);
        } catch(e){
          alert("Erreur r√©seau: "+e);
        }
      });
    });
  }
  bindDeleteButtons();

  // -------- Actualisation douce de la liste --------
  const bodyEl = byId('events-body');

  function badgeHTML(status){
    return `<span class="badge">${status}</span>`;
  }

  function rowHTML(ev){
    const date = ev.date || "‚Äî";
    return `
      <tr data-id="${ev.id}">
        <td><a href="/events/${ev.id}">${ev.name}</a></td>
        <td>${badgeHTML(ev.status)}</td>
        <td>${date}</td>
        <td class="row" style="gap:8px;">
          <a class="btn" href="/events/${ev.id}">Ouvrir</a>
          <a class="btn" target="_blank" href="/reports/event/${ev.id}/pdf">Export PDF</a>
          <button class="btn danger btn-del" data-id="${ev.id}">Supprimer</button>
        </td>
      </tr>`;
  }

  function diffApply(list){
    const existing = new Map();
    bodyEl.querySelectorAll('tr[data-id]').forEach(tr=>{
      existing.set(parseInt(tr.getAttribute('data-id'),10), tr);
    });

    const frag = document.createDocumentFragment();
    list.forEach(ev=>{
      const tr = existing.get(ev.id);
      if(!tr){
        const tmp = document.createElement('tbody');
        tmp.innerHTML = rowHTML(ev);
        const newTr = tmp.firstElementChild;
        frag.appendChild(newTr);
        bindDeleteButtons(newTr);
      }else{
        const tds = tr.querySelectorAll('td');
        const a = tds[0].querySelector('a');
        if (a && (a.textContent !== ev.name || a.getAttribute('href') !== `/events/${ev.id}`)) {
          a.textContent = ev.name;
          a.setAttribute('href', `/events/${ev.id}`);
        }
        const statusCell = tds[1];
        if (statusCell && statusCell.innerHTML.trim() !== badgeHTML(ev.status)) {
          statusCell.innerHTML = badgeHTML(ev.status);
        }
        const date = ev.date || "‚Äî";
        if (tds[2] && tds[2].textContent.trim() !== date) {
          tds[2].textContent = date;
        }
        const pdf = tr.querySelector(`a[href="/reports/event/${ev.id}/pdf"]`);
        if (!pdf) {
          const actions = tds[3];
          const btnPDF = document.createElement('a');
          btnPDF.className = 'btn';
          btnPDF.target = '_blank';
          btnPDF.href = `/reports/event/${ev.id}/pdf`;
          btnPDF.textContent = 'Export PDF';
          actions.insertBefore(btnPDF, actions.querySelector('.btn-del'));
        }
      }
    });

    if (frag.childNodes.length) bodyEl.appendChild(frag);

    existing.forEach((tr, id)=>{
      if(!list.find(e=>e.id===id)){
        tr.parentNode.removeChild(tr);
      }
    });
  }

  async function fetchEventsOnce(){
    try{
      let res = await fetch('/events/list', {headers:{'Accept':'application/json'}});
      if(!res.ok){
        res = await fetch('/api/events', {headers:{'Accept':'application/json'}});
      }
      if(!res.ok) return;
      const data = await res.json();
      if(Array.isArray(data)) diffApply(data);
    }catch(_){}
  }

  if(bodyEl && !isSearchActive){
    fetchEventsOnce();
    setInterval(fetchEventsOnce, 5000);
  }
})();
</script>

{% endblock %}
