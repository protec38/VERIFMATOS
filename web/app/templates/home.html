{% extends "base.html" %}
{% set title = "Tableau de bord" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="title">Créer un événement</div>
      <div class="row wrap" style="margin-top:8px;">
        <input id="ev-name" placeholder="Nom de l'événement" style="flex:1; min-width:240px;">
        <input id="ev-date" type="date" style="max-width: 220px;">
      </div>
      <div class="subtitle">Sélectionne les parents (stocks racine) à vérifier pour cet événement :</div>
      <div id="parents" class="row wrap" style="gap:10px; margin-top:6px;"></div>
      <div class="row" style="margin-top:10px;">
        <a class="btn primary" id="btn-create">Créer l'événement</a>
      </div>
    </div>

    <div class="card">
      <div class="title">Informations</div>
      <div class="subtitle">Après création, ouvre l’événement pour générer le lien secouristes et suivre la progression.</div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row space-between">
      <div class="title">Événements récents</div>
      <div class="subtitle">Ouvre un événement pour voir le matériel et partager le lien.</div>
    </div>
    {% if events %}
      <table class="table">
        <thead>
          <tr>
            <th>#</th><th>Nom</th><th>Date</th><th>Statut</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for e in events %}
          <tr>
            <td>{{ e.id }}</td>
            <td>{{ e.name }}</td>
            <td>{{ e.date or "—" }}</td>
            <td>{{ e.status if e.status is string else e.status.name }}</td>
            <td class="row wrap" style="gap:6px;">
              <a class="btn" href="{{ url_for('pages.event_page', event_id=e.id) }}">Ouvrir</a>
              <a class="btn" href="/reports/event/{{ e.id }}/pdf" target="_blank">Export PDF</a>
              {% if current_user.role.name == 'ADMIN' %}
                <a class="btn danger" href="#" data-event-id="{{ e.id }}" onclick="return deleteEvent(this);">Supprimer</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted" style="margin-top:6px;">Aucun événement.</div>
    {% endif %}
  </div>

  <script>
    async function api(url, opts={}){
      const r = await fetch(url, {credentials:'include', ...opts});
      if(!r.ok){ let t=''; try{t=await r.text();}catch{}; throw new Error(t||('HTTP '+r.status)); }
      const ct = r.headers.get('Content-Type') || '';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    async function loadParents(){
      try{
        const roots = await api('/stock/roots');
        const host = document.getElementById('parents');
        host.innerHTML = '';
        roots.forEach(r => {
          const label = document.createElement('label'); label.className='badge';
          label.style.display='inline-flex'; label.style.alignItems='center'; label.style.gap='6px';
          const inp = document.createElement('input'); inp.type='checkbox'; inp.value=String(r.id);
          inp.style.width='18px'; inp.style.height='18px';
          const span = document.createElement('span'); span.textContent = r.name;
          label.append(inp, span);
          host.append(label);
        });
        if(!roots.length){
          host.innerHTML = '<div class="muted">Aucune racine. Va dans “Stock”.</div>';
        }
      }catch(e){
        document.getElementById('parents').innerHTML =
          '<div class="alert">Impossible de charger les racines (droits insuffisants ?)</div>';
      }
    }

    async function createEvent(){
      const name = (document.getElementById('ev-name').value || '').trim();
      const date = document.getElementById('ev-date').value || '';
      if(!name){ alert("Nom requis"); return; }
      const parent_ids = Array.from(
        document.querySelectorAll('#parents input[type=checkbox]:checked')
      ).map(i=>parseInt(i.value,10));
      if(parent_ids.length===0){ alert("Sélectionne au moins un stock parent."); return; }
      const res = await api('/events', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, date, parent_ids})
      });
      if(res?.id){ location.href = '/events/' + res.id; }
    }

    document.getElementById('btn-create').onclick = ()=>createEvent().catch(e=>alert(e.message||e));
    loadParents();

    {% if current_user.role.name == 'ADMIN' %}
    async function deleteEvent(a){
      const id = a.getAttribute('data-event-id');
      if(!confirm("Supprimer l'événement #"+id+" ?")) return false;
      const r = await fetch('/events/'+id, {method:'DELETE', credentials:'include'});
      if(!r.ok){ alert(await r.text()); return false; }
      location.reload();
      return false;
    }
    {% endif %}
  </script>
{% endblock %}
