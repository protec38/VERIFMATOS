{% extends "base.html" %}
{% from "base.html" import icon %}
{% set title = "Tableau de bord" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="title">Cr√©er un √©v√©nement</div>
      <div class="row">
        <input id="ev-name" placeholder="Nom de l'√©v√©nement" style="flex:1;">
        <input id="ev-date" type="date" style="max-width: 200px;">
      </div>
      <div class="muted" style="margin-top:8px;">
        S√©lectionne les parents (stocks racine) √† v√©rifier pour cet √©v√©nement :
      </div>
      <div id="parents" class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px;"></div>
      <div class="row" style="margin-top:8px;">
        <a class="btn primary" id="btn-create">Cr√©er l'√©v√©nement</a>
      </div>
      <div class="muted" style="margin-top:8px;">
        Astuce : les parents sont les ‚ÄúSAC / AMBULANCE / TABLE‚Ä¶‚Äù au niveau racine de ton stock.
      </div>
    </div>

    <div class="card">
      <div class="title">Acc√®s rapides</div>

      <div class="row" style="gap:8px; flex-wrap:wrap;">
        {% if current_user.role.name == 'ADMIN' %}
          <!-- Liens directs pour √©viter toute erreur Jinja -->
          <a class="btn" href="/manage">üß∞ Stock</a>
          <a class="btn" href="/admin">üîß Administration</a>
        {% else %}
          <div class="muted">Le Stock et l‚ÄôAdministration sont r√©serv√©s aux administrateurs.</div>
        {% endif %}
      </div>

      <div class="title" style="margin-top:12px;">√âv√©nements r√©cents</div>
      {% if events %}
        <ul>
          {% for e in events %}
            <li class="row" style="justify-content:space-between;">
              <span>
                <strong>{{ e.name }}</strong>
                ‚Äî {{ e.status if e.status is string else e.status.name }}
                {% if e.date %} ‚Äî {{ e.date }}{% endif %}
              </span>
              <span>
                <a class="btn" href="{{ url_for('pages.event_page', event_id=e.id) }}">Ouvrir</a>
                {% if current_user.role.name == 'ADMIN' %}
                  <a class="btn ghost" href="#" data-event-id="{{ e.id }}" onclick="return deleteEvent(this);">Supprimer</a>
                {% endif %}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">Aucun √©v√©nement.</div>
      {% endif %}
    </div>
  </div>

  <script>
    async function api(url, opts={}){
      const r = await fetch(url, {credentials:'include', ...opts});
      if(!r.ok){
        let msg=''; try{msg = await r.text();}catch(e){}
        throw new Error(msg || ('HTTP '+r.status));
      }
      const ct = r.headers.get('Content-Type') || '';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    async function loadParents(){
      // NB: /stock/roots est r√©serv√© ADMIN. Si tu veux que les CHEF puissent cr√©er un √©v√®nement,
      // dis-moi et j‚Äôouvrirai un endpoint en lecture pour eux.
      try{
        const roots = await api('/stock/roots');
        const host = document.getElementById('parents');
        host.innerHTML = '';
        roots.forEach(r => {
          const wrap = document.createElement('label'); wrap.className='check';
          const inp = document.createElement('input'); inp.type='checkbox'; inp.value=String(r.id);
          const lbl = document.createElement('span'); lbl.textContent = r.name;
          wrap.append(inp, lbl);
          host.append(wrap);
        });
        if(!roots.length){
          host.innerHTML = '<div class="muted">Aucune racine trouv√©e. Va dans ‚ÄúStock‚Äù pour cr√©er tes parents.</div>';
        }
      }catch(e){
        document.getElementById('parents').innerHTML =
          '<div class="muted">Impossible de charger les racines (r√©serv√© admin ou erreur r√©seau).</div>';
      }
    }

    async function createEvent(){
      const name = (document.getElementById('ev-name').value || '').trim();
      const date = document.getElementById('ev-date').value || '';
      if(!name){ alert("Nom requis"); return; }
      const parent_ids = Array
        .from(document.querySelectorAll('#parents input[type=checkbox]:checked'))
        .map(i=>parseInt(i.value,10));
      const res = await api('/events', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, date, parent_ids})
      });
      if(res?.id){ location.href = '/events/' + res.id; }
    }

    document.getElementById('btn-create').onclick = ()=> { createEvent().catch(e=>alert(e.message||e)); };
    loadParents();

    {% if current_user.role.name == 'ADMIN' %}
    async function deleteEvent(a){
      const id = a.getAttribute('data-event-id');
      if(!confirm("Supprimer l'√©v√©nement #"+id+" ?")) return false;
      const r = await fetch('/events/' + id, {method:'DELETE', credentials:'include'});
      if(!r.ok){ const t = await r.text(); alert('Suppression impossible: ' + t); return false; }
      location.reload();
      return false;
    }
    {% endif %}
  </script>
{% endblock %}
