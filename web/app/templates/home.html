{% extends "base.html" %}
{% from "base.html" import icon %}
{% set title = "Tableau de bord" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="title">Créer un événement</div>
      <div class="row">
        <input id="ev-name" placeholder="Nom de l'événement" style="flex:1;">
        <input id="ev-date" type="date" style="max-width: 200px;">
      </div>
      <div class="muted" style="margin-top:8px;">Sélectionne les parents (stocks racine) à vérifier pour cet événement :</div>
      <div id="parents" class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px;"></div>
      <div class="row" style="margin-top:8px;">
        <a class="btn primary" id="btn-create">Créer l'événement</a>
      </div>
    </div>

    <div class="card">
      <div class="title">Événements récents</div>
      {% if events %}
        <ul>
          {% for e in events %}
            <li class="row" style="justify-content:space-between;">
              <span>
                <strong>{{ e.name }}</strong> — {{ e.status if e.status is string else e.status.name }}
              </span>
              <span>
                <a class="btn" href="{{ url_for('pages.event_page', event_id=e.id) }}">Ouvrir</a>
                {% if current_user.role.name == 'ADMIN' %}
                <a class="btn ghost" href="#" data-event-id="{{ e.id }}" onclick="return deleteEvent(this);">Supprimer</a>
                {% endif %}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">Aucun événement.</div>
      {% endif %}
    </div>
  </div>

  <script>
    async function api(url, opts={}){
      const r = await fetch(url, {credentials:'include', ...opts});
      if(!r.ok){ throw new Error(await r.text()); }
      const ct = r.headers.get('Content-Type') || '';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    async function loadParents(){
      const roots = await api('/stock/roots');
      const host = document.getElementById('parents');
      host.innerHTML = '';
      roots.forEach(r => {
        const id = 'p-'+r.id;
        const wrap = document.createElement('label'); wrap.className='check';
        const inp = document.createElement('input'); inp.type='checkbox'; inp.id=id; inp.value=String(r.id);
        const lbl = document.createElement('span'); lbl.textContent = r.name;
        wrap.append(inp, lbl);
        host.append(wrap);
      });
    }

    async function createEvent(){
      const name = (document.getElementById('ev-name').value || '').trim();
      const date = document.getElementById('ev-date').value || '';
      if(!name){ alert("Nom requis"); return; }
      const parent_ids = Array.from(document.querySelectorAll('#parents input[type=checkbox]:checked')).map(i=>parseInt(i.value,10));
      const r = await api('/events', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, date, parent_ids})
      });
      if(r?.id){ location.href = '/events/' + r.id; }
    }

    document.getElementById('btn-create').onclick = ()=> { createEvent().catch(e=>alert(e.message||e)); };
    loadParents();

    {% if current_user.role.name == 'ADMIN' %}
    async function deleteEvent(a){
      const id = a.getAttribute('data-event-id');
      if(!confirm("Supprimer l'événement #"+id+" ?")) return false;
      const r = await fetch('/events/' + id, {method:'DELETE', credentials:'include'});
      if(!r.ok){ const t = await r.text(); alert('Suppression impossible: ' + t); return false; }
      location.reload();
      return false;
    }
    {% endif %}
  </script>
{% endblock %}
