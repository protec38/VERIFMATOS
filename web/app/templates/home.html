{% extends "base.html" %}
{% set title = "Tableau de bord" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="title">Cr√©er un √©v√©nement</div>
      <div class="row">
        <input id="ev-name" placeholder="Nom de l'√©v√©nement" style="flex:1;">
        <input id="ev-date" type="date" style="max-width: 200px;">
      </div>
      <div class="muted" style="margin-top:8px;">
        S√©lectionne les parents (stocks racine) √† v√©rifier pour cet √©v√©nement :
      </div>
      <div id="parents" class="row" style="flex-wrap:wrap; gap:10px; margin-top:6px;"></div>
      <div class="row" style="margin-top:8px;">
        <a class="btn primary" id="btn-create">Cr√©er l'√©v√©nement</a>
      </div>
    </div>

    <div class="card">
      <div class="title">Acc√®s rapides</div>
      {% if current_user.role.name == 'ADMIN' %}
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <a class="btn" href="/manage">üß∞ Stock</a>
          <a class="btn" href="/admin">üîß Administration</a>
        </div>
      {% else %}
        <div class="muted">Le Stock et l‚ÄôAdministration sont r√©serv√©s aux administrateurs.</div>
      {% endif %}
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="row" style="justify-content:space-between;">
      <div class="title">√âv√©nements r√©cents</div>
      <div class="muted">Clique ‚ÄúExport PDF‚Äù pour g√©n√©rer un r√©cap.</div>
    </div>
    {% if events %}
      <table class="table">
        <thead>
          <tr>
            <th>#</th><th>Nom</th><th>Date</th><th>Statut</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for e in events %}
          <tr>
            <td>{{ e.id }}</td>
            <td>{{ e.name }}</td>
            <td>{{ e.date or "‚Äî" }}</td>
            <td>{{ e.status if e.status is string else e.status.name }}</td>
            <td class="row" style="gap:6px;">
              <a class="btn" href="{{ url_for('pages.event_page', event_id=e.id) }}">Ouvrir</a>
              <a class="btn" href="/reports/event/{{ e.id }}/pdf" target="_blank">Export PDF</a>
              {% if current_user.role.name == 'ADMIN' %}
              <a class="btn ghost" href="#" data-event-id="{{ e.id }}" onclick="return deleteEvent(this);">Supprimer</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted">Aucun √©v√©nement.</div>
    {% endif %}
  </div>

  <script>
    async function api(url, opts={}){
      const r = await fetch(url, {credentials:'include', ...opts});
      if(!r.ok){ let t=''; try{t=await r.text();}catch(e){}; throw new Error(t||('HTTP '+r.status)); }
      const ct = r.headers.get('Content-Type') || '';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    async function loadParents(){
      try{
        const roots = await api('/stock/roots');
        const host = document.getElementById('parents');
        host.innerHTML = '';
        roots.forEach(r => {
          const label = document.createElement('label'); label.className='check';
          const inp = document.createElement('input'); inp.type='checkbox'; inp.value=String(r.id);
          const span = document.createElement('span'); span.textContent = r.name;
          label.append(inp, span);
          host.append(label);
        });
        if(!roots.length){
          host.innerHTML = '<div class="muted">Aucune racine. Va dans ‚ÄúStock‚Äù.</div>';
        }
      }catch(e){
        document.getElementById('parents').innerHTML =
          '<div class="muted">Impossible de charger les racines (r√©serv√© admin ?)</div>';
      }
    }

    async function createEvent(){
      const name = (document.getElementById('ev-name').value || '').trim();
      const date = document.getElementById('ev-date').value || '';
      if(!name){ alert("Nom requis"); return; }
      const parent_ids = Array.from(
        document.querySelectorAll('#parents input[type=checkbox]:checked')
      ).map(i=>parseInt(i.value,10));
      const res = await api('/events', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name, date, parent_ids})
      });
      if(res?.id){ location.href = '/events/' + res.id; }
    }

    document.getElementById('btn-create').onclick = ()=>createEvent().catch(e=>alert(e.message||e));
    loadParents();

    {% if current_user.role.name == 'ADMIN' %}
    async function deleteEvent(a){
      const id = a.getAttribute('data-event-id');
      if(!confirm("Supprimer l'√©v√©nement #"+id+" ?")) return false;
      const r = await fetch('/events/'+id, {method:'DELETE', credentials:'include'});
      if(!r.ok){ alert(await r.text()); return false; }
      location.reload();
      return false;
    }
    {% endif %}
  </script>
{% endblock %}
