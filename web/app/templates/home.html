{% extends "base.html" %}
{% set title = "Tableau de bord" %}
{% block content %}
{% set stats = namespace(open=0) %}
{% for ev in events %}
  {% if ev.status == 'OPEN' %}
    {% set stats.open = stats.open + 1 %}
  {% endif %}
{% endfor %}
{% set total_events = events|length %}
{% set template_count = templates|length if templates else 0 %}
{% set lot_count = lots|length if lots else 0 %}

<div class="dashboard-page">
  <section class="dashboard-hero">
    <div class="dashboard-hero__copy">
      <span class="eyebrow">Protection Civile</span>
      <h1 class="dashboard-hero__title">Interface simplifi√©e pour chaque intervention</h1>
      <p class="dashboard-hero__subtitle">
        Visualise l'historique, programme les dates cl√©s et coche seulement le mat√©riel utile.
        Les menus, ic√¥nes et boutons ont √©t√© repens√©s pour guider chaque √©tape.
      </p>
      <div class="dashboard-hero__actions">
        <button class="btn primary" id="btn-open-wizard">Nouveau dossier guid√©</button>
        <a class="btn" href="/calendar">Voir le planning</a>
        <a class="btn ghost" href="/templates">Configurer les lots</a>
      </div>
    </div>
    <div class="dashboard-hero__stats">
      <div class="stat-card stat-card--accent">
        <span class="stat-card__label">√âv√©nements ouverts</span>
        <span class="stat-card__value">{{ stats.open }}</span>
        <span class="stat-card__hint">sur {{ total_events }} r√©cent{{ 's' if total_events > 1 else '' }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__label">Templates disponibles</span>
        <span class="stat-card__value">{{ template_count }}</span>
        <span class="stat-card__hint">Pr√©pare des mod√®les r√©utilisables</span>
      </div>
      <div class="stat-card">
        <span class="stat-card__label">Lots enregistr√©s</span>
        <span class="stat-card__value">{{ lot_count }}</span>
        <span class="stat-card__hint">Compl√®te tes interventions rapidement</span>
      </div>
    </div>
  </section>

  <section class="layout-grid">
    <section class="surface-panel" id="events-list">
      <div class="surface-panel__header">
        <div>
          <h2 class="surface-panel__title">√âv√©nements r√©cents</h2>
          <p class="surface-panel__subtitle">Analyse l'historique et acc√®de en un clic √† chaque dossier.</p>
        </div>
        <div class="surface-panel__toolbar">
          <form method="get" class="search-bar">
            <input type="search" name="q" placeholder="Rechercher un √©v√©nement" value="{{ search_query }}">
            <button class="btn" type="submit">Rechercher</button>
            {% if search_query %}
              <a class="btn ghost" href="{{ url_for('pages.dashboard') }}">R√©initialiser</a>
            {% endif %}
          </form>
        </div>
      </div>

      {% if search_query %}
        <div class="search-feedback">
          {{ events|length }} r√©sultat{{ 's' if events|length > 1 else '' }} pour ¬´ {{ search_query }} ¬ª.
        </div>
      {% endif %}

      <div class="events-table">
        <table>
          <thead>
            <tr>
              <th>Nom</th>
              <th>Statut</th>
              <th>Date</th>
              <th style="width: 240px;">Actions</th>
            </tr>
          </thead>
          <tbody id="events-body">
            {% for ev in events %}
              <tr data-id="{{ ev.id }}">
                <td class="events-table__name">
                  <a href="{{ url_for('pages.event_page', event_id=ev.id) }}">{{ ev.name }}</a>
                </td>
                <td><span class="status-pill" data-status="{{ ev.status }}">{{ ev.status }}</span></td>
                <td>{{ ev.date or "‚Äî" }}</td>
                <td class="events-table__actions">
                  <a class="btn" href="{{ url_for('pages.event_page', event_id=ev.id) }}">Ouvrir</a>
                  <a class="btn" target="_blank" href="/reports/event/{{ ev.id }}/pdf">Export PDF</a>
                  <button class="btn danger btn-del" data-id="{{ ev.id }}">Supprimer</button>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="4" class="empty-state">
                  {% if search_query %}
                    Aucun √©v√©nement ne correspond √† ¬´ {{ search_query }} ¬ª.
                  {% else %}
                    Aucun √©v√©nement enregistr√© pour le moment.
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <aside class="surface-panel surface-panel--secondary">
      <div class="surface-panel__header">
        <div>
          <h2 class="surface-panel__title">Acc√®s rapides</h2>
          <p class="surface-panel__subtitle">Passe de l'id√©e √† l'action en toute simplicit√©.</p>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-action" id="btn-open-wizard-cta">
          <span class="quick-action__icon">üéØ</span>
          <span class="quick-action__body">
            <span class="quick-action__title">Assistant √©v√©nement</span>
            <span class="quick-action__hint">Laisse toi guider √©tape par √©tape pour cr√©er un √©v√©nement.</span>
          </span>
        </button>
        <a class="quick-action" href="/calendar">
          <span class="quick-action__icon">üìÜ</span>
          <span class="quick-action__body">
            <span class="quick-action__title">Vue calendrier</span>
            <span class="quick-action__hint">Visualise les interventions confirm√©es et pass√©es.</span>
          </span>
        </a>
        <a class="quick-action" href="/templates">
          <span class="quick-action__icon">üì¶</span>
          <span class="quick-action__body">
            <span class="quick-action__title">Templates & lots</span>
            <span class="quick-action__hint">Pr√©configure du mat√©riel √† r√©utiliser.</span>
          </span>
        </a>
      </div>
    </aside>
  </section>
</div>

<div class="wizard" id="event-wizard" data-open="false" aria-hidden="true">
  <div class="wizard__backdrop" data-role="dismiss"></div>
  <div class="wizard__dialog" role="dialog" aria-modal="true" aria-labelledby="wizard-title">
    <div class="wizard__header">
      <div>
        <h2 class="wizard__title" id="wizard-title">Assistant de cr√©ation d'√©v√©nement</h2>
        <p class="wizard__subtitle">4 √©tapes guid√©es pour pr√©parer sereinement ton dispositif.</p>
      </div>
      <button class="wizard__close" type="button" id="btn-close-wizard" aria-label="Fermer">√ó</button>
    </div>

    <ol class="wizard-steps" id="wizard-steps">
      <li class="wizard-steps__item" data-progress-step="0">Informations</li>
      <li class="wizard-steps__item" data-progress-step="1">Cr√©neaux</li>
      <li class="wizard-steps__item" data-progress-step="2">S√©lection</li>
      <li class="wizard-steps__item" data-progress-step="3">R√©sum√©</li>
    </ol>

    <div class="wizard__body">
      <form id="wizard-form" onsubmit="return false;">
        <div class="wizard-step" data-step="0">
          <h3 class="wizard-step__title">Informations g√©n√©rales</h3>
          <p class="wizard-step__hint">Donne un nom clair √† l'√©v√©nement et, si besoin, indique la date cible.</p>
          <div class="form-grid">
            <label class="form-field">
              <span>Nom de l'√©v√©nement</span>
              <input type="text" name="name" id="ev-name" placeholder="Ex. Dispositif Buvette Concert" required>
            </label>
            <label class="form-field">
              <span>Date (optionnel)</span>
              <input type="date" name="date" id="ev-date" placeholder="Date (optionnel)">
            </label>
          </div>
        </div>

        <div class="wizard-step" data-step="1">
          <h3 class="wizard-step__title">Cr√©neaux horaires</h3>
          <p class="wizard-step__hint">Ajoute les tranches horaires pendant lesquelles l'√©quipe sera mobilis√©e.</p>
          <div class="slot-editor">
            <div class="slot-editor__form">
              <label class="form-field">
                <span>D√©but</span>
                <input type="datetime-local" id="slot-start" step="900">
              </label>
              <label class="form-field">
                <span>Fin</span>
                <input type="datetime-local" id="slot-end" step="900">
              </label>
              <button class="btn" type="button" id="btn-add-slot">Ajouter le cr√©neau</button>
            </div>
            <div class="slot-editor__list" id="slot-list">
              <div class="empty-state">Aucun cr√©neau ajout√© pour le moment.</div>
            </div>
            <div class="slot-editor__hint" id="slot-hint">Ajoute au moins un cr√©neau (date et heures de d√©part / fin).</div>
          </div>
        </div>

        <div class="wizard-step" data-step="2">
          <h3 class="wizard-step__title">S√©lection du mat√©riel racine</h3>
          <p class="wizard-step__hint">Applique un template ou choisis manuellement les parents √† v√©rifier.</p>

          <div class="selection-toolbar">
            <label>
              <span>Templates enregistr√©s</span>
              <select id="template-select">
                <option value="">Appliquer un template‚Ä¶</option>
                {% for tpl in templates %}
                  <option value="{{ tpl.id }}">{{ tpl.name }}</option>
                {% endfor %}
              </select>
            </label>
            <label>
              <span>Lots disponibles</span>
              <select id="lot-select">
                <option value="">Ajouter un lot‚Ä¶</option>
                {% for lot in lots %}
                  <option value="{{ lot.id }}">{{ lot.name }}</option>
                {% endfor %}
              </select>
            </label>
          </div>

          {% if root_groups and root_groups|length %}
            <div class="root-groups">
              {% for group in root_groups %}
                <div class="root-group">
                  <div class="root-group__title">
                    {{ group.category.name if group.category else "Sans cat√©gorie" }}
                    {% if group.nodes %}
                      <span class="badge">{{ group.nodes|length }} parent{{ 's' if group.nodes|length > 1 else '' }}</span>
                    {% endif %}
                  </div>
                  {% if group.nodes and group.nodes|length %}
                    <div class="root-group__nodes">
                      {% for r in group.nodes %}
                        <label class="root-chip" data-unique="{{ 1 if r.unique_item else 0 }}">
                          <input type="checkbox" class="root-cb" value="{{ r.id }}"
                                 data-name="{{ r.name }}"
                                 data-unique="{{ 1 if r.unique_item else 0 }}"
                                 data-max="{{ r.unique_quantity if r.unique_quantity is not none else '' }}">
                          <span class="root-chip__content">
                            <span class="root-chip__name">{{ r.name }}</span>
                            {% if r.unique_item %}
                              <span class="root-chip__meta">Objet unique{% if r.unique_quantity is not none %} ¬∑ max {{ r.unique_quantity }}{% endif %}</span>
                              <span class="root-chip__qty">
                                <span>Quantit√©</span>
                                <input type="number" class="root-qty-input"
                                       min="0"
                                       {% if r.unique_quantity is not none %}max="{{ r.unique_quantity }}"{% endif %}
                                       value="{{ r.unique_quantity if r.unique_quantity is not none else 1 }}"
                                       step="1" disabled>
                              </span>
                            {% endif %}
                          </span>
                        </label>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="root-group__empty">Aucun parent dans cette cat√©gorie.</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">Aucun parent racine disponible. Cr√©e d‚Äôabord un stock parent dans üß∞ Stock.</div>
          {% endif %}
        </div>

        <div class="wizard-step" data-step="3">
          <h3 class="wizard-step__title">R√©sum√© intelligent</h3>
          <p class="wizard-step__hint">V√©rifie les informations avant de lancer l'√©v√©nement.</p>
          <div class="summary" id="wizard-summary">
            <div class="empty-state">Renseigne les √©tapes pr√©c√©dentes pour g√©n√©rer un r√©sum√©.</div>
          </div>
        </div>
      </form>
    </div>

    <div class="wizard__footer">
      <button class="btn ghost" type="button" id="wizard-prev">√âtape pr√©c√©dente</button>
      <div class="wizard__footer-right">
        <button class="btn" type="button" id="wizard-reset">R√©initialiser</button>
        <button class="btn primary" type="button" id="wizard-next">√âtape suivante</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const byId = (id) => document.getElementById(id);
  const wizardEl = byId('event-wizard');
  const wizardForm = byId('wizard-form');
  const btnOpenWizard = byId('btn-open-wizard');
  const btnOpenWizardCta = byId('btn-open-wizard-cta');
  const btnCloseWizard = byId('btn-close-wizard');
  const btnPrev = byId('wizard-prev');
  const btnNext = byId('wizard-next');
  const btnReset = byId('wizard-reset');
  const stepsEls = Array.from(document.querySelectorAll('.wizard-step'));
  const progressEls = Array.from(document.querySelectorAll('[data-progress-step]'));
  const slotList = byId('slot-list');
  const slotHint = byId('slot-hint');
  const slotStartInput = byId('slot-start');
  const slotEndInput = byId('slot-end');
  const slotAddBtn = byId('btn-add-slot');
  const evDateInput = byId('ev-date');
  const summaryEl = byId('wizard-summary');
  const templateSpecs = {{ templates|tojson }} || [];
  const lotSpecs = {{ lots|tojson }} || [];
  const templateMap = new Map(templateSpecs.map(t => [String(t.id), t]));
  const lotMap = new Map(lotSpecs.map(t => [String(t.id), t]));
  const tplSelect = byId('template-select');
  const lotSelect = byId('lot-select');
  const templateCount = {{ template_count|tojson }};
  const searchQuery = {{ search_query|tojson }};
  const isSearchActive = typeof searchQuery === 'string' && searchQuery.trim().length > 0;
  const state = {
    step: 0,
    slots: [],
    creating: false,
    rootSelections: new Map(),
  };

  const fmtSlotDay = new Intl.DateTimeFormat('fr-FR', {weekday:'short', day:'2-digit', month:'short'});
  const fmtSlotTime = new Intl.DateTimeFormat('fr-FR', {hour:'2-digit', minute:'2-digit'});

  function openWizard(){
    if(!wizardEl) return;
    wizardEl.setAttribute('data-open', 'true');
    wizardEl.setAttribute('aria-hidden', 'false');
    document.body.classList.add('is-modal-open');
    showStep(state.step);
  }

  function closeWizard(){
    if(!wizardEl) return;
    wizardEl.setAttribute('data-open', 'false');
    wizardEl.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('is-modal-open');
  }

  btnOpenWizard?.addEventListener('click', openWizard);
  btnOpenWizardCta?.addEventListener('click', openWizard);
  btnCloseWizard?.addEventListener('click', closeWizard);
  wizardEl?.addEventListener('click', (event) => {
    if(event.target && event.target.getAttribute('data-role') === 'dismiss'){
      closeWizard();
    }
  });
  document.addEventListener('keydown', (event) => {
    if(event.key === 'Escape' && wizardEl?.getAttribute('data-open') === 'true'){
      closeWizard();
    }
  });

  function showStep(index){
    state.step = Math.max(0, Math.min(index, stepsEls.length - 1));
    stepsEls.forEach((stepEl, idx) => {
      stepEl.setAttribute('data-active', idx === state.step ? 'true' : 'false');
    });
    progressEls.forEach((item, idx) => {
      item.setAttribute('data-active', idx === state.step ? 'true' : 'false');
      item.setAttribute('data-complete', idx < state.step ? 'true' : 'false');
    });
    btnPrev.disabled = state.step === 0;
    if(state.step === stepsEls.length - 1){
      btnNext.textContent = state.creating ? 'Cr√©ation‚Ä¶' : 'Cr√©er l\'√©v√©nement';
    }else{
      btnNext.textContent = '√âtape suivante';
    }
    if(state.step === stepsEls.length - 1){
      updateSummary();
    }
  }

  function slotLabel(start, end){
    const startDate = new Date(start);
    const endDate = new Date(end);
    if(isNaN(startDate) || isNaN(endDate)){
      return `${start} ‚Üí ${end}`;
    }
    const sameDay = startDate.getFullYear() === endDate.getFullYear()
      && startDate.getMonth() === endDate.getMonth()
      && startDate.getDate() === endDate.getDate();
    if(sameDay){
      return `${fmtSlotDay.format(startDate)} ‚Ä¢ ${fmtSlotTime.format(startDate)} ‚Üí ${fmtSlotTime.format(endDate)}`;
    }
    return `${fmtSlotDay.format(startDate)} ‚Ä¢ ${fmtSlotTime.format(startDate)} ‚Üí ${fmtSlotDay.format(endDate)} ‚Ä¢ ${fmtSlotTime.format(endDate)}`;
  }

  function renderSlots(){
    if(!slotList) return;
    slotList.innerHTML = '';
    if(state.slots.length === 0){
      slotList.innerHTML = '<div class="empty-state">Aucun cr√©neau ajout√© pour le moment.</div>';
      if(slotHint){ slotHint.textContent = 'Ajoute au moins un cr√©neau (date et heures de d√©part / fin).'; }
      return;
    }

    state.slots.forEach((slot, index) => {
      const row = document.createElement('div');
      row.className = 'slot-chip';

      const info = document.createElement('div');
      info.className = 'slot-chip__info';
      info.textContent = slotLabel(slot.start, slot.end);
      row.appendChild(info);

      const meta = document.createElement('div');
      meta.className = 'slot-chip__meta';
      meta.textContent = `Cr√©neau ${index + 1}`;
      row.appendChild(meta);

      const remove = document.createElement('button');
      remove.className = 'btn danger sm';
      remove.type = 'button';
      remove.textContent = 'Retirer';
      remove.addEventListener('click', () => {
        state.slots.splice(index, 1);
        renderSlots();
      });
      row.appendChild(remove);

      slotList.appendChild(row);
    });

    if(slotHint){
      slotHint.textContent = `${state.slots.length} cr√©neau${state.slots.length>1?'x':''} configur√©${state.slots.length>1?'s':''}.`;
    }
  }

  slotAddBtn?.addEventListener('click', () => {
    const startVal = (slotStartInput?.value || '').trim();
    const endVal = (slotEndInput?.value || '').trim();
    if(!startVal || !endVal){
      alert('Renseigne la date et les heures de d√©but/fin.');
      return;
    }
    const startDate = new Date(startVal);
    const endDate = new Date(endVal);
    if(isNaN(startDate) || isNaN(endDate)){
      alert('Format de date/heure invalide.');
      return;
    }
    if(endDate <= startDate){
      alert('La fin du cr√©neau doit √™tre apr√®s le d√©but.');
      return;
    }
    if(state.slots.some(slot => slot.start === startVal && slot.end === endVal)){
      alert('Ce cr√©neau est d√©j√† pr√©sent.');
      return;
    }
    const overlaps = state.slots.some(slot => {
      const existingStart = new Date(slot.start);
      const existingEnd = new Date(slot.end);
      return endDate > existingStart && startDate < existingEnd;
    });
    if(overlaps && !confirm('Ce cr√©neau chevauche un autre cr√©neau d√©j√† ajout√©. Continuer malgr√© tout ?')){
      return;
    }
    state.slots.push({start: startVal, end: endVal});
    state.slots.sort((a,b)=> new Date(a.start) - new Date(b.start));
    if(evDateInput && !evDateInput.value){
      evDateInput.value = startVal.slice(0, 10);
    }
    if(slotStartInput){ slotStartInput.value = ''; }
    if(slotEndInput){ slotEndInput.value = ''; }
    renderSlots();
  });

  function syncRootChipState(cb){
    const wrap = cb.closest('label.root-chip');
    if(!wrap) return;
    if(cb.checked){
      wrap.classList.add('is-checked');
    }else{
      wrap.classList.remove('is-checked');
    }
    const qtyInput = wrap.querySelector('.root-qty-input');
    if(qtyInput){
      qtyInput.disabled = !cb.checked;
      if(cb.checked){
        qtyInput.focus();
      }else{
        qtyInput.value = qtyInput.getAttribute('data-default') || qtyInput.value || '1';
      }
    }
  }

  function updateRootSelection(cb){
    const wrap = cb.closest('label.root-chip');
    if(!wrap) return;
    const id = parseInt(cb.value, 10);
    if(!id) return;
    const qtyInput = wrap.querySelector('.root-qty-input');
    if(cb.checked){
      if(cb.dataset.unique === '1'){
        let qty = qtyInput ? parseInt(qtyInput.value, 10) : 1;
        if(isNaN(qty) || qty < 0){ qty = 0; }
        const maxRaw = cb.dataset.max;
        const max = maxRaw ? parseInt(maxRaw, 10) : null;
        if(max != null && qty > max){ qty = max; qtyInput && (qtyInput.value = max); }
        state.rootSelections.set(id, qty);
      }else{
        state.rootSelections.delete(id);
      }
    }else{
      state.rootSelections.delete(id);
    }
  }

  document.querySelectorAll('.root-cb').forEach(cb => {
    const wrap = cb.closest('label.root-chip');
    const qtyInput = wrap?.querySelector('.root-qty-input');
    if(qtyInput && !qtyInput.hasAttribute('data-default')){
      qtyInput.setAttribute('data-default', qtyInput.value);
      qtyInput.addEventListener('input', () => {
        if(!cb.checked) return;
        let qty = parseInt(qtyInput.value, 10);
        if(isNaN(qty) || qty < 0){ qty = 0; }
        const maxRaw = cb.dataset.max;
        const max = maxRaw ? parseInt(maxRaw, 10) : null;
        if(max != null && qty > max){ qty = max; qtyInput.value = String(max); }
        state.rootSelections.set(parseInt(cb.value, 10), qty);
      });
    }
    cb.addEventListener('change', () => {
      syncRootChipState(cb);
      updateRootSelection(cb);
    });
  });

  function clearRootSelection(){
    document.querySelectorAll('.root-cb').forEach(cb => {
      cb.checked = false;
      syncRootChipState(cb);
    });
    state.rootSelections.clear();
  }

  function applyNodes(nodes, {reset=false}={}){
    if(reset){
      clearRootSelection();
    }
    if(!Array.isArray(nodes)) return;
    nodes.forEach(spec => {
      if(!spec) return;
      const id = parseInt(spec.id ?? spec.node_id, 10);
      if(!id) return;
      const cb = document.querySelector(`.root-cb[value="${id}"]`);
      if(!cb) return;
      cb.checked = true;
      syncRootChipState(cb);
      if(spec.quantity != null){
        const wrap = cb.closest('label.root-chip');
        const qtyInput = wrap?.querySelector('.root-qty-input');
        state.rootSelections.set(id, spec.quantity);
        if(qtyInput){
          qtyInput.value = spec.quantity;
        }
      }else{
        state.rootSelections.delete(id);
      }
    });
  }

  tplSelect?.addEventListener('change', () => {
    const choice = tplSelect.value;
    if(!choice) return;
    const tpl = templateMap.get(choice);
    if(tpl){
      applyNodes(tpl.nodes || [], {reset:true});
    }
    tplSelect.value = '';
  });

  lotSelect?.addEventListener('change', () => {
    const choice = lotSelect.value;
    if(!choice) return;
    const lot = lotMap.get(choice);
    if(lot){
      applyNodes(lot.nodes || [], {reset:false});
    }
    lotSelect.value = '';
  });

  function buildSelectionPayload(){
    const payload = [];
    document.querySelectorAll('.root-cb:checked').forEach(cb => {
      const id = parseInt(cb.value, 10);
      if(!id) return;
      const entry = {id};
      if(cb.dataset.unique === '1'){
        const qty = state.rootSelections.get(id);
        if(qty == null){
          throw new Error(`S√©lectionne une quantit√© pour ${cb.dataset.name || 'ce parent'}.`);
        }
        entry.quantity = qty;
      }
      payload.push(entry);
    });
    return payload;
  }

  function resetWizard(){
    wizardForm?.reset();
    state.slots.splice(0, state.slots.length);
    renderSlots();
    clearRootSelection();
    tplSelect && (tplSelect.value = '');
    lotSelect && (lotSelect.value = '');
    state.step = 0;
    showStep(0);
    if(summaryEl){ summaryEl.innerHTML = '<div class="empty-state">Renseigne les √©tapes pr√©c√©dentes pour g√©n√©rer un r√©sum√©.</div>'; }
  }

  btnReset?.addEventListener('click', resetWizard);

  function validateStep(step){
    if(step === 0){
      const name = byId('ev-name').value.trim();
      if(!name){
        alert('Merci d\'indiquer un nom pour l\'√©v√©nement.');
        return false;
      }
    }
    if(step === 1){
      if(state.slots.length === 0){
        alert('Ajoute au moins un cr√©neau horaire.');
        return false;
      }
    }
    if(step === 2){
      const selected = document.querySelectorAll('.root-cb:checked');
      if(selected.length === 0){
        alert('S√©lectionne au moins un parent racine.');
        return false;
      }
      for(const cb of selected){
        if(cb.dataset.unique === '1'){
          const id = parseInt(cb.value, 10);
          if(!state.rootSelections.has(id)){
            alert(`S√©lectionne une quantit√© pour ${cb.dataset.name || 'ce parent'}.`);
            return false;
          }
        }
      }
    }
    return true;
  }

  function updateSummary(){
    if(!summaryEl) return;
    const name = byId('ev-name').value.trim();
    const date = byId('ev-date').value;
    const slots = state.slots;
    const roots = buildSelectionPayload();
    const suggestions = [];
    if(slots.length === 1){ suggestions.push('Un seul cr√©neau est pr√©vu, v√©rifie qu\'il couvre toute l\'intervention.'); }
    if(templateCount === 0 && roots.length > 3){ suggestions.push('Pense √† enregistrer ces parents dans un template pour les r√©utiliser.'); }

    const listItems = roots.map(entry => {
      const cb = document.querySelector(`.root-cb[value="${entry.id}"]`);
      const name = cb ? (cb.dataset.name || `Parent #${entry.id}`) : `Parent #${entry.id}`;
      const qty = entry.quantity != null ? `<span class="badge">Qt√© ${entry.quantity}</span>` : '';
      return `<li>${name} ${qty}</li>`;
    }).join('');

    summaryEl.innerHTML = `
      <div class="summary__item">
        <span class="summary__label">Nom</span>
        <span class="summary__value">${name || '‚Äî'}</span>
      </div>
      <div class="summary__item">
        <span class="summary__label">Date</span>
        <span class="summary__value">${date || 'Non d√©finie'}</span>
      </div>
      <div class="summary__item">
        <span class="summary__label">Cr√©neaux</span>
        <div class="summary__value summary__value--list">
          ${slots.length ? `<ul>${slots.map(slot => `<li>${slotLabel(slot.start, slot.end)}</li>`).join('')}</ul>` : '<div class="empty-state">Aucun cr√©neau</div>'}
        </div>
      </div>
      <div class="summary__item">
        <span class="summary__label">Parents s√©lectionn√©s</span>
        <div class="summary__value summary__value--list">
          ${roots.length ? `<ul>${listItems}</ul>` : '<div class="empty-state">Aucun parent s√©lectionn√©</div>'}
        </div>
      </div>
      ${suggestions.length ? `<div class="summary__suggestions">${suggestions.map(text => `<div class="summary__suggestion">üí° ${text}</div>`).join('')}</div>` : ''}
    `;
  }

  btnPrev?.addEventListener('click', () => {
    showStep(state.step - 1);
  });

  btnNext?.addEventListener('click', async () => {
    if(state.step < stepsEls.length - 1){
      if(!validateStep(state.step)) return;
      showStep(state.step + 1);
      return;
    }
    if(state.creating) return;
    if(!validateStep(2)) return;

    const name = byId('ev-name').value.trim();
    const date = byId('ev-date').value || null;
    const rootsPayload = buildSelectionPayload();
    const slotsPayload = state.slots.map(slot => ({start: slot.start, end: slot.end}));

    state.creating = true;
    showStep(state.step);

    try {
      const res = await fetch('/events', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'Accept':'application/json'},
        body: JSON.stringify({ name, date, roots: rootsPayload, slots: slotsPayload })
      });
      const text = await res.text();
      if(!res.ok){
        let message = text;
        try {
          const data = JSON.parse(text);
          if(data && typeof data.error === 'string'){ message = data.error; }
        } catch(_){}
        alert(message);
        return;
      }
      let data; try{ data = JSON.parse(text); }catch{ data = {}; }
      if(data.url){ location.href = data.url; }
      else { location.reload(); }
    } catch (e){
      alert('Erreur r√©seau: '+ e);
    } finally {
      state.creating = false;
      showStep(state.step);
    }
  });

  renderSlots();
  showStep(0);

  function bindDeleteButtons(root=document){
    root.querySelectorAll('.btn-del').forEach(btn => {
      if(btn.dataset.bound){ return; }
      btn.dataset.bound = '1';
      btn.addEventListener('click', async () => {
        if(!confirm('Supprimer cet √©v√©nement ?')) return;
        const id = btn.dataset.id;
        if(!id) return;
        try {
          const res = await fetch(`/events/${id}`, {
            method: 'DELETE',
            headers: {'Accept':'application/json'}
          });
          if(!res.ok){
            const t = await res.text();
            alert(t);
            return;
          }
          const tr = document.querySelector(`tr[data-id="${id}"]`);
          tr?.parentNode?.removeChild(tr);
        } catch(e){
          alert('Erreur r√©seau: '+e);
        }
      });
    });
  }
  bindDeleteButtons();

  const bodyEl = byId('events-body');

  function badgeHTML(status){
    return `<span class="status-pill" data-status="${status}">${status}</span>`;
  }

  function rowHTML(ev){
    const date = ev.date || '‚Äî';
    return `
      <tr data-id="${ev.id}">
        <td class="events-table__name"><a href="/events/${ev.id}">${ev.name}</a></td>
        <td>${badgeHTML(ev.status)}</td>
        <td>${date}</td>
        <td class="events-table__actions">
          <a class="btn" href="/events/${ev.id}">Ouvrir</a>
          <a class="btn" target="_blank" href="/reports/event/${ev.id}/pdf">Export PDF</a>
          <button class="btn danger btn-del" data-id="${ev.id}">Supprimer</button>
        </td>
      </tr>`;
  }

  function diffApply(list){
    const existing = new Map();
    bodyEl.querySelectorAll('tr[data-id]').forEach(tr=>{
      existing.set(parseInt(tr.getAttribute('data-id'),10), tr);
    });

    const frag = document.createDocumentFragment();
    list.forEach(ev=>{
      const tr = existing.get(ev.id);
      if(!tr){
        const tmp = document.createElement('tbody');
        tmp.innerHTML = rowHTML(ev);
        const newTr = tmp.firstElementChild;
        frag.appendChild(newTr);
        bindDeleteButtons(newTr);
      }else{
        const tds = tr.querySelectorAll('td');
        const a = tds[0].querySelector('a');
        if (a && (a.textContent !== ev.name || a.getAttribute('href') !== `/events/${ev.id}`)) {
          a.textContent = ev.name;
          a.setAttribute('href', `/events/${ev.id}`);
        }
        const statusCell = tds[1];
        if (statusCell && statusCell.innerHTML.trim() !== badgeHTML(ev.status)) {
          statusCell.innerHTML = badgeHTML(ev.status);
        }
        const date = ev.date || '‚Äî';
        if (tds[2] && tds[2].textContent.trim() !== date) {
          tds[2].textContent = date;
        }
        const pdf = tr.querySelector(`a[href="/reports/event/${ev.id}/pdf"]`);
        if (!pdf) {
          const actions = tds[3];
          const btnPDF = document.createElement('a');
          btnPDF.className = 'btn';
          btnPDF.target = '_blank';
          btnPDF.href = `/reports/event/${ev.id}/pdf`;
          btnPDF.textContent = 'Export PDF';
          actions.insertBefore(btnPDF, actions.querySelector('.btn-del'));
        }
      }
    });

    if (frag.childNodes.length) bodyEl.appendChild(frag);

    existing.forEach((tr, id)=>{
      if(!list.find(e=>e.id===id)){
        tr.parentNode.removeChild(tr);
      }
    });
  }

  async function fetchEventsOnce(){
    try{
      let res = await fetch('/events/list', {headers:{'Accept':'application/json'}});
      if(!res.ok){
        res = await fetch('/api/events', {headers:{'Accept':'application/json'}});
      }
      if(!res.ok) return;
      const data = await res.json();
      if(Array.isArray(data)) diffApply(data);
    }catch(_){}
  }

  if(bodyEl && !isSearchActive){
    fetchEventsOnce();
    setInterval(fetchEventsOnce, 5000);
  }
})();
</script>
{% endblock %}
