{% extends "base.html" %}
{% set title = "Tableau de bord" %}
{% block content %}

<div class="grid cols-2">
  <div class="card">
    <div class="title">Cr√©er un √©v√©nement</div>
    <div class="subtitle">S√©lectionne les stocks ¬´ parents ¬ª √† v√©rifier (au moins un)</div>

    <form id="event-form" class="row wrap" style="margin-top:8px" onsubmit="return false;">
      <input type="text" name="name" id="ev-name" placeholder="Nom de l'√©v√©nement" required>
      <input type="date" name="date" id="ev-date" placeholder="Date (optionnel)">
    </form>

    <div class="alert" style="margin-top:10px">
      <div class="row wrap">
        {% if roots and roots|length %}
          {% for r in roots %}
            <label class="btn ghost" style="cursor:pointer;">
              <input type="checkbox" class="root-cb" value="{{ r.id }}" style="margin-right:6px">
              {{ r.name }}
            </label>
          {% endfor %}
        {% else %}
          <span class="muted">Aucun parent racine disponible. Cr√©e d‚Äôabord un stock parent dans üß∞ Stock.</span>
        {% endif %}
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btn-create" class="btn primary">Cr√©er l'√©v√©nement</button>
    </div>
  </div>

  <div class="card">
    <div class="title">Derniers √©v√©nements</div>
    <table class="table" style="margin-top:8px">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Statut</th>
          <th>Date</th>
          <th style="width:220px">Actions</th>
        </tr>
      </thead>
      <tbody id="events-body">
        {% for ev in events %}
        <tr data-id="{{ ev.id }}">
          <td><a href="{{ url_for('pages.event_page', event_id=ev.id) }}">{{ ev.name }}</a></td>
          <td>
            <span class="badge">{{ ev.status }}</span>
          </td>
          <td>{{ ev.date or "‚Äî" }}</td>
          <td class="row">
            <a class="btn" href="{{ url_for('pages.event_page', event_id=ev.id) }}">Ouvrir</a>
            <button class="btn danger btn-del" data-id="{{ ev.id }}">Supprimer</button>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="muted">Aucun √©v√©nement pour le moment.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const byId = (id)=>document.getElementById(id);

  // Cr√©ation
  byId('btn-create')?.addEventListener('click', async () => {
    const name = byId('ev-name').value.trim();
    const date = byId('ev-date').value || null;
    const rootIds = Array.from(document.querySelectorAll('.root-cb:checked')).map(cb => parseInt(cb.value,10));

    if(!name){ alert("Nom requis"); return; }
    if(rootIds.length === 0){ alert("S√©lectionne au moins un parent"); return; }

    try {
      const res = await fetch('/events', {
        method: 'POST',
        headers: {'Content-Type':'application/json', 'Accept':'application/json'},
        body: JSON.stringify({ name, date, root_ids: rootIds })
      });

      // Si backend renvoie HTML (erreur), on l‚Äôaffiche tel quel
      const text = await res.text();
      if(!res.ok){
        alert(text); return;
      }
      // Normalement JSON avec {url}
      let data;
      try { data = JSON.parse(text); } catch { data = {}; }
      if(data.url){ location.href = data.url; }
      else { location.reload(); }
    } catch (e){
      alert("Erreur r√©seau: "+ e);
    }
  });

  // Suppression (POST fallback)
  document.querySelectorAll('.btn-del').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      if(!confirm("Supprimer cet √©v√©nement ?")) return;
      try {
        const res = await fetch(`/events/${id}/delete`, {
          method: 'POST',
          headers: {'Accept':'application/json'}
        });
        if(!res.ok){
          const t = await res.text();
          alert(t);
          return;
        }
        // Retire la ligne sans recharger
        const tr = document.querySelector(`tr[data-id="${id}"]`);
        tr?.parentNode?.removeChild(tr);
      } catch(e){
        alert("Erreur r√©seau: "+e);
      }
    });
  });
})();
</script>

{% endblock %}
