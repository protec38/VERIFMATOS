{% extends "base.html" %}
{% set title = "Gestion" %}
{% block content %}
  <div class="card" style="margin-bottom:12px;">
    <div class="row">
      <a class="btn {% if active_tab=='stock' %}primary{% endif %}" href="{{ url_for('pages.stock_page') }}">üß∞ Stock</a>
      {% if current_user.role.name == 'ADMIN' %}
        <a class="btn {% if active_tab=='admin' %}primary{% endif %}" href="{{ url_for('pages.admin_page') }}">‚öôÔ∏è Administration</a>
      {% endif %}
    </div>
  </div>

  {% if active_tab == 'stock' %}
  <div class="grid cols-2">
    <div class="card">
      <div class="title">Cr√©er un parent (racine)</div>
      <form id="form-root" class="row" onsubmit="return createRoot(event)">
        <input name="name" placeholder="ex: SAC PS BLEU" required>
        <button class="btn primary" type="submit">Cr√©er</button>
      </form>
    </div>
    <div class="card">
      <div class="title">Cr√©er un enfant / sous-parent</div>
      <form id="form-child" class="row" onsubmit="return createChild(event)">
        <input name="name" placeholder="Nom" required>
        <select name="type" required>
          <option value="GROUP">Sous-parent</option>
          <option value="ITEM">Enfant (item)</option>
        </select>
        <input name="parent_id" type="number" placeholder="Parent ID (ex: 12)" required>
        <input name="quantity" type="number" placeholder="Quantit√© (si item)">
        <button class="btn primary" type="submit">Cr√©er</button>
      </form>
      <div class="muted">Astuce: trouvez l‚ÄôID du parent dans l‚Äôarbre √† droite.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="title">Arbre des stocks</div>
    <div id="roots" class="tree" style="margin-top:8px;"></div>
  </div>

  <script>
    async function fetchJSON(url, opts={}){ const r=await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}},opts)); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    function el(tag, attrs={}, ...kids){ const e=document.createElement(tag); for(const [k,v] of Object.entries(attrs)){ if(k==='class') e.className=v; else e.setAttribute(k,v); } for(const k of kids){ if(k==null) continue; e.append(k.nodeType? k : document.createTextNode(k)); } return e; }
    function renderNode(n){
      const header=el('div',{class:'header'}, el('div',{class:'name'}, `${n.name} ${n.type==='ITEM' ? ' (x'+(n.quantity||0)+')' : ''}`), el('div',{class:'muted'}, `ID #${n.id} ‚Ä¢ ${n.type}`));
      const box=el('div',{class:'node'}, header);
      if(n.children && n.children.length){ const childs=el('div',{class:'childs'}); n.children.forEach(c=>childs.append(renderNode(c))); box.append(childs); }
      return box;
    }
    async function loadTree(){
      const rootsEl=document.getElementById('roots'); rootsEl.innerHTML='Chargement...';
      const roots=await fetchJSON('/stock/roots'); rootsEl.innerHTML='';
      for(const r of roots){ const tree=await fetchJSON(`/stock/${r.id}/tree`); const wrap=el('div',{}, el('div',{class:'title'}, r.name), renderNode(tree)); rootsEl.append(wrap); }
    }
    async function createRoot(ev){ ev.preventDefault(); const f=ev.target; const name=f.name.value.trim(); await fetchJSON('/stock',{method:'POST', body: JSON.stringify({name, type:'GROUP'})}); f.reset(); loadTree(); return false; }
    async function createChild(ev){ ev.preventDefault(); const f=ev.target; const name=f.name.value.trim(); const type=f.type.value; const parent_id=parseInt(f.parent_id.value,10); const payload={name, type, parent_id}; if(type==='ITEM'){ payload.quantity=parseInt(f.quantity.value||'0',10); } await fetchJSON('/stock',{method:'POST', body: JSON.stringify(payload)}); f.reset(); loadTree(); return false; }
    loadTree();
  </script>

  {% elif active_tab == 'admin' %}
  <div class="grid cols-2">
    <div class="card">
      <div class="title">Utilisateurs</div>
      <div id="users" style="margin-top:8px;"></div>
    </div>
    <div class="card">
      <div class="title">Cr√©er un utilisateur</div>
      <form id="form-user" class="row" onsubmit="return createUser(event)">
        <input name="username" placeholder="Nom d'utilisateur" required>
        <select name="role" required>
          <option value="ADMIN">ADMIN</option>
          <option value="CHEF">CHEF</option>
          <option value="VIEWER">VIEWER</option>
        </select>
        <input name="password" type="password" placeholder="Mot de passe" required>
        <button class="btn primary" type="submit">Cr√©er</button>
      </form>
    </div>
  </div>
  <script>
    async function fetchJSON(url, opts={}){ const r=await fetch(url, Object.assign({headers:{'Content-Type':'application/json'}},opts)); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    function userRow(u){
      const row=document.createElement('div'); row.className='item';
      const left=document.createElement('div'); left.innerHTML='<div style="font-weight:600">'+u.username+'</div><div class="muted">R√¥le: '+u.role+' ‚Ä¢ Actif: '+u.is_active+'</div>';
      const actions=document.createElement('div'); actions.className='row';
      const btn=document.createElement('a'); btn.className='btn ghost'; btn.href='#'; btn.textContent='R√©init. MDP';
      btn.onclick=async(e)=>{ e.preventDefault(); const pwd=prompt("Nouveau mot de passe pour "+u.username+" ?"); if(!pwd) return; await fetchJSON('/admin/users/'+u.id+'/reset_password',{method:'POST', body: JSON.stringify({password: pwd})}); alert('Mot de passe mis √† jour.'); };
      actions.append(btn); row.append(left, actions); return row;
    }
    async function loadUsers(){ const box=document.getElementById('users'); box.innerHTML='Chargement...'; const data=await fetchJSON('/admin/users'); box.innerHTML=''; (data.items || data || []).forEach(u=>box.append(userRow(u))); }
    async function createUser(ev){ ev.preventDefault(); const f=ev.target; const payload={username:f.username.value.trim(), role:f.role.value, password:f.password.value}; await fetchJSON('/admin/users',{method:'POST', body: JSON.stringify(payload)}); f.reset(); loadUsers(); return false; }
    loadUsers();
  </script>
  {% endif %}
{% endblock %}

/* END original */
