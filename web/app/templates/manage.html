{% extends "base.html" %}
{% set title = "Gestion des stocks" %}
{% block content %}

<style>
  :root{ --col-left: 280px; }
  .layout{display:grid;grid-template-columns:var(--col-left) 1fr;gap:16px}
  @media (max-width: 1080px){ .layout{grid-template-columns:1fr} }

  .card{border:1px solid var(--border);border-radius:12px;background:#0f1a2a}
  .card .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
  .card .bd{padding:12px 14px}

  .btn{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#0f1e2f;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn.primary{border-color:#f59f00}

  /* Roots list */
  .roots{display:flex;flex-direction:column;gap:8px}
  .root{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#0f1e2f;cursor:pointer}
  .root.active{outline:2px solid #37527a}
  .root .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .root .meta{opacity:.8;font-size:12px}
  .root-groups{display:flex;flex-direction:column;gap:12px}
  .root-group{border:1px solid var(--border);border-radius:10px;padding:10px;background:#0f1e2f}
  .root-group-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .root-group-label{font-weight:600}
  .root-group-actions{display:flex;gap:6px;flex-wrap:wrap}
  .root-group-actions .btn{padding:4px 8px;font-size:12px}
  .root-group-list{display:flex;flex-direction:column;gap:6px}
  .root-group-empty{font-size:12px;color:var(--muted)}

  .empty{border:1px dashed var(--border);border-radius:12px;padding:20px;text-align:center;opacity:.9}

  /* Tree */
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .toolbar input[type="search"]{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#0f1e2f;color:var(--text);min-width:240px}
  .selbar{position:sticky;top:0;z-index:5;background:#0f1a2a;border:1px solid var(--border);border-radius:10px;margin-bottom:10px;padding:10px;display:none;gap:8px;align-items:center}
  .selbar.show{display:flex}
  .selbar .count{font-weight:700}
  .selbar .btn{padding:6px 10px}

  .drop-root{border:1px dashed var(--border);border-radius:8px;padding:8px;text-align:center;margin:8px 0;opacity:.85}
  .drop-root.drag-over{background:#0f1e2f;}

  .node{border:1px solid var(--border);border-radius:12px;margin:6px 0;padding:8px;background:#0f1e2f}
  .header{display:flex;align-items:center;gap:8px}
  .name{font-weight:700}
  .childs{margin-left:18px;margin-top:6px}

  .badge{display:inline-flex;border:1px dashed var(--border);border-radius:999px;padding:2px 8px;font-size:12px;opacity:.9}
  .b-expired{background:#2a1111;border-color:#a33;color:#ffdce1}
  .b-j30{background:#2a1b0f;border-color:#b86b00;color:#ffd8a8}
  .b-j60{background:#2a270f;border-color:#b3a100;color:#ffe566}
  .b-later{background:#0f2a22;border-color:#17614f;color:#bff3e7}
  .b-none{opacity:.6}

  /* Dropdowns */
  .dd{position:relative;display:inline-block}
  .dd-menu{position:absolute;right:0;top:calc(100% + 6px);background:#0f1e2f;border:1px solid var(--border);border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;min-width:200px;z-index:15}
  .dd.show .dd-menu{display:block}
  .dd-menu button{display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:transparent;color:var(--text);cursor:pointer}
  .dd-menu button:hover{background:#11263a}

  .dd-ops{position:relative;display:inline-block}
  .dd-ops .dd-menu{right:0;left:auto}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#0f1a2a;border:1px solid var(--border);border-radius:12px;padding:18px;max-width:600px;width:95%;max-height:calc(100vh - 40px);overflow-y:auto}
  .modal .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .modal label{display:block;margin-top:8px;font-size:14px;opacity:.85}
  .modal input, .modal select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#0f1e2f;color:var(--text)}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .modal .btn.danger{background:#5b1220;border-color:#75212f;color:#ffd5dc}
  .modal table.table-expiries{width:100%;border-collapse:collapse;margin-top:6px}
  .modal table.table-expiries th,
  .modal table.table-expiries td{border-bottom:1px solid var(--border);padding:6px 6px;text-align:left;font-size:13px}
  .modal table.table-expiries th{font-size:11px;text-transform:uppercase;letter-spacing:.05em;opacity:.75}
  .modal table.table-expiries td:last-child{text-align:right;white-space:nowrap}

  .selbox{margin-right:8px}
  .node.drag-over{outline:2px dashed #37527a; outline-offset: 4px}
</style>

<div class="layout">

  <!-- LEFT: ROOTS -->
  <div class="card">
    <div class="hd">
      <div style="font-weight:700">Parents racines</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
        <button class="btn" id="btn-root-cat-add">‚ûï Cat√©gorie</button>
        <button class="btn primary" id="btn-root-add">‚ûï Parent racine</button>
      </div>
    </div>
    <div class="bd">
      <div id="roots-empty" class="empty" style="display:none">
        Aucun parent racine. <br><br>
        <button class="btn primary" onclick="openAddModal(null,'GROUP')">‚ûï Cr√©er un parent racine</button>
      </div>
      <div id="roots" class="roots root-groups"></div>
    </div>
  </div>

  <!-- RIGHT: TREE -->
  <div class="card">
    <div class="hd">
      <div class="toolbar">
        <a class="btn" href="/stock/export.json" download>‚¨á Export JSON</a>
        <label class="btn">üìÑ Choisir JSON‚Ä¶
          <input type="file" id="import-file" accept="application/json" style="display:none">
        </label>
        <select id="import-mode">
          <option value="merge" selected>Fusion (ajout)</option>
          <option value="replace">Remplacer tout</option>
        </select>
        <button class="btn" id="btn-import">Importer</button>
        <input id="global-search" type="search" placeholder="Rechercher (nom ou #ID)‚Ä¶">
      </div>
    </div>
    <div class="bd">
      <div id="selbar" class="selbar">
        <span class="count"><span id="sel-count">0</span> s√©lectionn√©(s)</span>
        <button class="btn" id="sel-move">D√©placer vers‚Ä¶</button>
        <button class="btn" id="sel-dup">Dupliquer vers‚Ä¶</button>
        <button class="btn" id="sel-del">Supprimer</button>
        <div style="margin-left:auto;opacity:.8">Astuce: Ctrl/Cmd+clic pour multi-s√©lection</div>
      </div>
      <div id="drop-root" class="drop-root">D√©poser ici pour mettre √† la racine (GROUP uniquement)</div>
      <div id="tree"></div>
    </div>
  </div>

</div>

<!-- Modal: Ajouter -->
<div id="addModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 style="margin-top:0">Ajouter</h3>
    <div class="row">
      <div style="flex:1;min-width:180px">
        <label>Type</label>
        <select id="add-type">
          <option value="GROUP">Sous-parent</option>
          <option value="ITEM">Item</option>
        </select>
      </div>
      <div style="flex:2;min-width:220px">
        <label>Nom</label>
        <input id="add-name" type="text" placeholder="Nom‚Ä¶">
      </div>
    </div>
    <div id="add-item-fields" style="display:none">
      <div class="row" style="margin-top:8px">
        <div style="flex:1;min-width:160px">
          <label>Quantit√©</label>
          <input id="add-qty" type="number" min="0" value="1">
        </div>
        <div style="flex:1;min-width:180px">
          <label>P√©remption (optionnel)</label>
          <input id="add-expiry" type="date">
        </div>
      </div>
    </div>
    <div id="add-group-fields" style="display:none;margin-top:8px">
      <div id="add-root-category-field" class="row" style="display:none;gap:10px;align-items:center;margin-bottom:8px">
        <label style="margin:0;min-width:100px">Cat√©gorie</label>
        <select id="add-root-category" style="flex:1;min-width:160px">
          <option value="">Sans cat√©gorie</option>
        </select>
      </div>
      <label style="display:flex;align-items:center;gap:8px">
        <input id="add-unique" type="checkbox">
        Objet unique (demande une quantit√© lors de l'ajout √† un √©v√©nement)
      </label>
      <div id="add-unique-qty-wrap" class="row" style="margin-top:8px;display:none">
        <div style="flex:1;min-width:160px">
          <label>Quantit√© maximale</label>
          <input id="add-unique-qty" type="number" min="0" value="1">
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeAddModal()">Annuler</button>
      <button class="btn primary" onclick="confirmAdd()">Ajouter</button>
    </div>
  </div>
</div>

<!-- Modal: √âditer -->
<div id="editModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 style="margin-top:0">√âditer</h3>
    <p class="muted" id="editTitle">‚Äî</p>
    <div class="row">
      <div style="flex:2;min-width:220px">
        <label>Nom</label>
        <input id="edit-name" type="text" placeholder="Nom‚Ä¶">
      </div>
      <div style="flex:1;min-width:160px" id="edit-qty-wrap">
        <label>Quantit√©</label>
        <input id="edit-qty" type="number" min="0" value="0">
      </div>
      <div style="flex:1;min-width:180px" id="edit-expiry-wrap">
        <label>P√©remption (r√©sum√©)</label>
        <input id="edit-expiry" type="date">
      </div>
    </div>
    <div id="edit-group-fields" style="display:none;margin-top:8px">
      <div id="edit-root-category-field" class="row" style="display:none;gap:10px;align-items:center;margin-bottom:8px">
        <label style="margin:0;min-width:100px">Cat√©gorie</label>
        <select id="edit-root-category" style="flex:1;min-width:160px">
          <option value="">Sans cat√©gorie</option>
        </select>
      </div>
      <label style="display:flex;align-items:center;gap:8px">
        <input id="edit-unique" type="checkbox">
        Objet unique (demande une quantit√© lors de l'ajout √† un √©v√©nement)
      </label>
      <div id="edit-unique-qty-wrap" class="row" style="margin-top:8px;display:none">
        <div style="flex:1;min-width:160px">
          <label>Quantit√© maximale</label>
          <input id="edit-unique-qty" type="number" min="0" value="1">
        </div>
      </div>
    </div>
    <div id="edit-expiries-section" style="display:none;margin-top:12px">
      <div class="row" style="justify-content:space-between;align-items:flex-end;margin-bottom:6px">
        <div style="flex:1">
          <label style="margin-top:0">Lots de p√©remption</label>
          <div class="muted" id="edit-expiries-info">Ajoute une ligne par lot.</div>
        </div>
        <button class="btn" type="button" id="edit-exp-open-page">‚Üó Page d√©taill√©e</button>
      </div>
      <table class="table-expiries">
        <thead>
          <tr>
            <th>Date</th>
            <th>Quantit√©</th>
            <th>Lot</th>
            <th>Note</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="edit-expiries-body">
          <tr><td colspan="5" class="muted">Aucun lot suivi.</td></tr>
        </tbody>
      </table>
      <div class="row" style="margin-top:8px">
        <input id="edit-exp-new-date" type="date" style="min-width:150px">
        <input id="edit-exp-new-qty" type="number" min="0" placeholder="Quantit√© (optionnel)" style="min-width:140px">
        <input id="edit-exp-new-lot" type="text" placeholder="Lot (optionnel)" style="min-width:140px">
        <input id="edit-exp-new-note" type="text" placeholder="Note (optionnel)" style="flex:1;min-width:200px">
        <button class="btn primary" type="button" id="edit-exp-add">Ajouter</button>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeEditModal()">Annuler</button>
      <button class="btn primary" onclick="confirmEdit()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modal: D√©placer -->
<div id="moveModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 style="margin-top:0">D√©placer</h3>
    <p class="muted" id="moveTitle">‚Äî</p>
    <label>Nouveau parent</label>
    <select id="move-parent"></select>
    <div class="actions">
      <button class="btn" onclick="closeMoveModal()">Annuler</button>
      <button class="btn primary" onclick="confirmMove()">D√©placer</button>
    </div>
  </div>
</div>

<!-- Modal: Dupliquer -->
<div id="dupModal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 style="margin-top:0">Dupliquer</h3>
    <p class="muted" id="dupTitle">‚Äî</p>
    <label>Nouveau nom</label>
    <input id="dup-name" type="text" placeholder="Nouveau nom‚Ä¶">
    <label style="margin-top:8px">Placer sous</label>
    <select id="dup-parent"></select>
    <div class="actions">
      <button class="btn" onclick="closeDupModal()">Annuler</button>
      <button class="btn primary" onclick="confirmDup()">Dupliquer</button>
    </div>
  </div>
</div>

<script>
// ------- API helper -------
async function api(url, opts={}){
  const r = await fetch(url, {credentials:'include', ...opts});
  if(!r.ok){
    const t = await r.text().catch(()=> '');
    throw new Error(t || ('HTTP '+r.status));
  }
  try{ return await r.json(); }catch(_){ return {}; }
}

// ------- State -------
let ROOTS = [];
let ROOT_CATEGORIES = [];
let CURRENT_ROOT_ID = null;
let TREE = null;
let ALL_NODES = [];
const SEL = new Set();
let MOVE_NODE_ID = null;
let DUP_NODE_ID = null;
let EDIT_NODE_ID = null;

// ------- Roots -------
function createRootRow(r){
  const row = document.createElement('div');
  row.className = 'root'+(r.id===CURRENT_ROOT_ID?' active':'');
  row.onclick = ()=>{ CURRENT_ROOT_ID = r.id; loadTree(); renderRoots(); };
  const name = document.createElement('div');
  name.className = 'name';
  name.textContent = r.name;
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = `id ${r.id}`;
  row.append(name, meta);
  return row;
}

function renderRoots(){
  const wrap = document.getElementById('roots');
  const empty = document.getElementById('roots-empty');
  wrap.innerHTML = '';
  if(!ROOTS.length){
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  const groups = [];
  (ROOT_CATEGORIES||[]).forEach(cat => {
    const nodes = ROOTS.filter(r => (r.root_category && r.root_category.id === cat.id));
    groups.push({category: cat, nodes});
  });
  const unassigned = ROOTS.filter(r => !r.root_category);
  if(unassigned.length || !ROOT_CATEGORIES.length){
    groups.push({category: null, nodes: unassigned});
  }

  groups.forEach(group => {
    const section = document.createElement('div');
    section.className = 'root-group';
    const header = document.createElement('div');
    header.className = 'root-group-header';
    const label = document.createElement('div');
    label.className = 'root-group-label';
    label.textContent = group.category ? group.category.name : 'Sans cat√©gorie';
    header.appendChild(label);

    if(group.category){
      const actions = document.createElement('div');
      actions.className = 'root-group-actions';

      const idx = ROOT_CATEGORIES.findIndex(c => c.id === group.category.id);

      const renameBtn = document.createElement('button');
      renameBtn.className = 'btn';
      renameBtn.textContent = 'Renommer';
      renameBtn.onclick = (e)=>{ e.stopPropagation(); renameCategory(group.category); };
      actions.appendChild(renameBtn);

      const upBtn = document.createElement('button');
      upBtn.className = 'btn';
      upBtn.textContent = '‚Üë';
      upBtn.disabled = idx <= 0;
      upBtn.onclick = (e)=>{ e.stopPropagation(); moveCategory(group.category, -1); };
      actions.appendChild(upBtn);

      const downBtn = document.createElement('button');
      downBtn.className = 'btn';
      downBtn.textContent = '‚Üì';
      downBtn.disabled = idx === -1 || idx >= ROOT_CATEGORIES.length - 1;
      downBtn.onclick = (e)=>{ e.stopPropagation(); moveCategory(group.category, 1); };
      actions.appendChild(downBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn danger';
      deleteBtn.textContent = 'Supprimer';
      deleteBtn.disabled = (group.nodes || []).length > 0;
      deleteBtn.onclick = (e)=>{ e.stopPropagation(); deleteCategory(group.category); };
      actions.appendChild(deleteBtn);

      header.appendChild(actions);
    }

    section.appendChild(header);

    if(group.nodes && group.nodes.length){
      const list = document.createElement('div');
      list.className = 'root-group-list';
      group.nodes.forEach(r => list.appendChild(createRootRow(r)));
      section.appendChild(list);
    }else{
      const emptyMsg = document.createElement('div');
      emptyMsg.className = 'root-group-empty';
      emptyMsg.textContent = 'Aucun parent dans cette cat√©gorie.';
      section.appendChild(emptyMsg);
    }

    wrap.appendChild(section);
  });
}

async function loadRootCategories(){
  try{
    const data = await api('/stock/root-categories');
    ROOT_CATEGORIES = Array.isArray(data) ? data : [];
  }catch(e){
    ROOT_CATEGORIES = [];
    console.warn('Erreur /stock/root-categories :', e);
  }
}

async function loadRoots(){
  try{
    await loadRootCategories();
    const data = await api('/stock/roots');
    ROOTS = Array.isArray(data) ? data : [];
    if(!ROOTS.length){ CURRENT_ROOT_ID = null; renderRoots(); renderTreeEmpty(); return; }
    if(!CURRENT_ROOT_ID || !ROOTS.some(r=>r.id==CURRENT_ROOT_ID)){
      CURRENT_ROOT_ID = ROOTS[0].id;
    }
    renderRoots();
  }catch(e){
    alert('Erreur /stock/roots : '+(e.message||e));
  }
}

async function createCategoryPrompt(){
  const raw = prompt('Nom de la nouvelle cat√©gorie ?');
  if(!raw) return;
  const name = raw.trim();
  if(!name) return;
  try{
    await api('/stock/root-categories', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name})
    });
    await loadRoots();
  }catch(e){
    alert('Cr√©ation impossible: '+(e.message||e));
  }
}

async function renameCategory(cat){
  if(!cat) return;
  const raw = prompt('Nouveau nom pour la cat√©gorie ?', cat.name || '');
  if(!raw) return;
  const name = raw.trim();
  if(!name || name === cat.name) return;
  try{
    await api(`/stock/root-categories/${cat.id}`, {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name})
    });
    await loadRoots();
  }catch(e){
    alert('Renommage impossible: '+(e.message||e));
  }
}

async function deleteCategory(cat){
  if(!cat) return;
  if(!confirm(`Supprimer la cat√©gorie "${cat.name}" ?`)) return;
  try{
    await api(`/stock/root-categories/${cat.id}`, {method:'DELETE'});
    await loadRoots();
  }catch(e){
    alert('Suppression impossible: '+(e.message||e));
  }
}

async function moveCategory(cat, direction){
  if(!cat || !direction) return;
  const index = ROOT_CATEGORIES.findIndex(c => c.id === cat.id);
  if(index === -1) return;
  const newPos = index + direction;
  if(newPos < 0 || newPos >= ROOT_CATEGORIES.length) return;
  try{
    await api(`/stock/root-categories/${cat.id}`, {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({position: newPos})
    });
    await loadRoots();
  }catch(e){
    alert('D√©placement impossible: '+(e.message||e));
  }
}

function populateCategorySelect(selectEl, selectedId=null){
  if(!selectEl) return;
  selectEl.innerHTML = '';
  const optNone = document.createElement('option');
  optNone.value = '';
  optNone.textContent = 'Sans cat√©gorie';
  selectEl.appendChild(optNone);
  (ROOT_CATEGORIES||[]).forEach(cat => {
    const opt = document.createElement('option');
    opt.value = String(cat.id);
    opt.textContent = cat.name;
    if(selectedId != null && Number(selectedId) === Number(cat.id)){
      opt.selected = true;
    }
    selectEl.appendChild(opt);
  });
}

// ------- Tree -------
function buildIndex(n, arr){
  arr.push(n);
  (n.children||[]).forEach(c=>buildIndex(c,arr));
}
function findNode(id){
  return ALL_NODES.find(n=>n.id===id);
}
function daysUntilISO(iso){
  if(!iso) return null;
  try{
    const [y,m,d] = iso.split('-').map(Number);
    const dt = new Date(Date.UTC(y, m-1, d));
    const now = new Date();
    const today = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
    return Math.floor((dt.getTime() - today)/86400000);
  }catch(_){ return null; }
}
function perempClass(iso){
  const k = daysUntilISO(iso);
  if(k===null) return 'b-none';
  if(k<0) return 'b-expired';
  if(k<=30) return 'b-j30';
  if(k<=60) return 'b-j60';
  return 'b-later';
}
function perempLabel(iso){
  const k = daysUntilISO(iso);
  if(k===null) return '‚Äî';
  if(k<0) return 'P√©rim√©';
  if(k<=30) return '‚â§30j';
  if(k<=60) return '‚â§60j';
  return '>60j';
}
function formatISODate(iso){
  if(!iso) return '‚Äî';
  try{
    return new Date(iso+'T00:00:00').toLocaleDateString();
  }catch(_){ return iso; }
}
function h(tag, attrs={}, ...kids){
  const el = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==='class') el.className = v;
    else if(k==='style') el.style = v;
    else if(k.startsWith('on') && typeof v === 'function') el.addEventListener(k.slice(2), v);
    else el.setAttribute(k, v);
  }
  kids.flat().forEach(k=>{
    if(k==null) return;
    if(typeof k === 'string' || typeof k === 'number') el.appendChild(document.createTextNode(String(k)));
    else el.appendChild(k);
  });
  return el;
}

// ------- Node renderer -------
function nodeEl(n){
  const head = h('div', {class:'header'});

  const sel = h('input', {type:'checkbox', class:'selbox'});
  sel.checked = SEL.has(n.id);
  sel.onchange = (e)=>{
    const multi = e.shiftKey || e.ctrlKey || e.metaKey;
    if(!multi) SEL.clear();
    if(sel.checked) SEL.add(n.id); else SEL.delete(n.id);
    updateSelbar();
  };
  head.append(sel);

  const name = h('div', {class:'name'}, `${n.name}  (lvl ${n.level}, ${n.type})`);
  name.style.cursor = 'pointer';
  if(n.unique_item){
    const maxTxt = (n.unique_quantity != null) ? `max ${n.unique_quantity}` : 'unique';
    name.append(' ', h('span', {class:'badge', style:'margin-left:6px'}, `Objet unique (${maxTxt})`));
  }
  if(n.type==='ITEM'){
    const b = h('span', {class:'badge '+perempClass(n.expiry_date), style:'margin-left:8px'}, perempLabel(n.expiry_date));
    name.append(' ', b);
  }
  head.append(name);

  // Actions
  const right = h('div', {style:'margin-left:auto; display:flex; gap:6px; align-items:center'});

  // Ajouter ‚ñæ (GROUP)
  if(n.type==='GROUP'){
    const ddAdd = h('div', {class:'dd'});
    const btnAdd = h('button', {class:'btn', onclick: (e)=>{ e.stopPropagation(); ddAdd.classList.toggle('show'); }}, 'Ajouter ‚ñæ');
    const menuAdd = h('div', {class:'dd-menu'});
    menuAdd.append(
      h('button', {onclick: ()=>{ ddAdd.classList.remove('show'); openAddModal(n.id, 'GROUP'); }}, '‚ûï Sous-parent'),
      h('button', {onclick: ()=>{ ddAdd.classList.remove('show'); openAddModal(n.id, 'ITEM'); }}, '‚ûï Item'),
    );
    ddAdd.append(btnAdd, menuAdd);
    right.append(ddAdd);
  }

  // ‚ãØ Ops
  const ddOps = h('div', {class:'dd dd-ops'});
  const btnOps = h('button', {class:'btn', onclick: (e)=>{ e.stopPropagation(); ddOps.classList.toggle('show'); }}, '‚ãØ');
  const menuOps = h('div', {class:'dd-menu'});
  menuOps.append(
    h('button', {onclick: ()=>{ ddOps.classList.remove('show'); openEditModal(n.id); }}, '√âditer‚Ä¶'),
    h('button', {onclick: ()=>{ ddOps.classList.remove('show'); openDupModal(n.id); }}, 'Dupliquer‚Ä¶'),
    h('button', {onclick: ()=>{ ddOps.classList.remove('show'); openMoveModal(n.id); }}, 'D√©placer‚Ä¶'),
    h('button', {onclick: ()=>{ ddOps.classList.remove('show'); confirmDelete(n.id); }}, 'Supprimer‚Ä¶'),
  );
  ddOps.append(btnOps, menuOps);
  right.append(ddOps);

  head.append(right);

  const box = h('div', {class:'node', 'data-id': String(n.id)});
  box.append(head);

  // Drag & drop (tous n≈ìuds) -> d√©p√¥t permis seulement sur GROUP
  bindDnDFor(head, n);

  if((n.children||[]).length){
    const childs = h('div', {class:'childs'});
    (n.children||[]).forEach(c=> childs.append(nodeEl(c)));
    box.append(childs);
  }
  return box;
}

function renderTree(){
  const root = document.getElementById('tree');
  root.innerHTML = '';
  if(!TREE){ renderTreeEmpty(); return; }
  updateSelbar();
  root.append(nodeEl(TREE));
  // filtre global (si pr√©sent)
  const g = document.getElementById('global-search');
  if(g && g.value.trim()){
    const qraw = g.value.trim();
    const q = qraw.toLowerCase();
    const idQuery = qraw.startsWith('#') ? qraw.slice(1) : (/^\d+$/.test(qraw) ? qraw : null);
    root.querySelectorAll('.node').forEach(node=>{
      const nm = node.querySelector('.name')?.textContent?.toLowerCase() || '';
      const nid = node.getAttribute('data-id') || '';
      const match = idQuery ? (nid === idQuery) : (!q ? true : nm.includes(q));
      node.style.display = match ? '' : 'none';
    });
  }
}
function renderTreeEmpty(){
  const root = document.getElementById('tree');
  root.innerHTML = '<div class="empty">Aucune racine s√©lectionn√©e.</div>';
}

async function loadTree(){
  if(!CURRENT_ROOT_ID){ renderTreeEmpty(); return; }
  try{
    const data = await api('/stock/tree?root_id='+CURRENT_ROOT_ID);
    TREE = data || null;
    ALL_NODES = [];
    if(TREE) buildIndex(TREE, ALL_NODES);
    renderTree();
  }catch(e){
    alert('Erreur /stock/tree : '+(e.message||e));
  }
}

// ------- Utilitaires communs -------
function updateSelbar(){
  const c = SEL.size;
  document.getElementById('sel-count').textContent = c;
  document.getElementById('selbar').classList.toggle('show', c>0);
}
function clearSelection(){ SEL.clear(); updateSelbar(); renderTree(); }

function getDescendantIds(n){
  const out = new Set([n.id]);
  (function rec(x){ (x.children||[]).forEach(c=>{ out.add(c.id); rec(c); }); })(n);
  return out;
}
function findParentId(targetId, n=TREE, parent=null){
  if(!n) return null;
  if(n.id === targetId) return parent ? parent.id : null;
  for(const c of (n.children||[])){
    const r = findParentId(targetId, c, n);
    if(r !== undefined) return r;
  }
  return undefined;
}
function buildParentSelect(selectEl, currentNode, preselectId){
  selectEl.innerHTML = '';
  const optRoot = document.createElement('option');
  optRoot.value = '';
  optRoot.textContent = '‚Äî Racine ‚Äî';
  selectEl.appendChild(optRoot);
  const forbid = getDescendantIds(currentNode);
  (ALL_NODES||[]).forEach(n=>{
    if(n.type !== 'GROUP') return;
    if(forbid.has(n.id)) return;
    const o = document.createElement('option');
    o.value = String(n.id);
    o.textContent = '‚Ä¢ ' + '  '.repeat(n.level) + n.name;
    if(preselectId && String(preselectId) === String(n.id)) o.selected = true;
    selectEl.appendChild(o);
  });
}

// ------- Drag & Drop -------
let DRAG_ID = null;
function canDrop(targetNode, dragId){
  if(!targetNode || targetNode.type !== 'GROUP') return false;
  if(targetNode.id === dragId) return false;
  // √©viter d√©p√¥t sur un descendant
  function isDesc(n, targetId){
    if(n.id === targetId) return true;
    return (n.children||[]).some(c=>isDesc(c, targetId));
  }
  const dragNode = findNode(dragId);
  return !isDesc(dragNode, targetNode.id);
}
function bindDnDFor(el, node){
  el.draggable = true;
  el.addEventListener('dragstart', (e)=>{
    DRAG_ID = node.id;
    e.dataTransfer.setData('text/plain', String(node.id));
    e.dataTransfer.effectAllowed = 'move';
  });
  el.addEventListener('dragover', (e)=>{
    if(canDrop(node, DRAG_ID)){ e.preventDefault(); el.closest('.node')?.classList.add('drag-over'); }
  });
  el.addEventListener('dragleave', ()=> el.closest('.node')?.classList.remove('drag-over'));
  el.addEventListener('drop', async (e)=>{
    e.preventDefault();
    el.closest('.node')?.classList.remove('drag-over');
    if(!canDrop(node, DRAG_ID)) return;
    try{
      await api('/stock/'+DRAG_ID, {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({parent_id: node.id})});
      DRAG_ID = null;
      await loadRoots(); await loadTree();
    }catch(err){ alert('√âchec d√©placement: '+(err.message||err)); }
  });
}
// Zone d√©p√¥t racine
(function(){
  const rootDZ = document.getElementById('drop-root');
  rootDZ.addEventListener('dragover', (e)=>{ if(DRAG_ID){ e.preventDefault(); rootDZ.classList.add('drag-over'); } });
  rootDZ.addEventListener('dragleave', ()=> rootDZ.classList.remove('drag-over'));
  rootDZ.addEventListener('drop', async (e)=>{
    e.preventDefault(); rootDZ.classList.remove('drag-over');
    if(!DRAG_ID) return;
    const node = findNode(DRAG_ID);
    if(node && node.type !== 'GROUP'){ alert('Seuls les GROUP peuvent devenir racine.'); return; }
    try{
      await api('/stock/'+DRAG_ID, {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({parent_id: null})});
      DRAG_ID = null;
      await loadRoots(); await loadTree();
    }catch(err){ alert('√âchec d√©placement: '+(err.message||err)); }
  });
})();

// ------- Actions n≈ìud -------
async function confirmDelete(nodeId){
  const n = findNode(nodeId);
  if(!n) return;
  if(!confirm(`Supprimer "${n.name}" et tout son sous-arbre ?`)) return;
  try{
    await api('/stock/'+nodeId, {method:'DELETE'});
    if(SEL.has(nodeId)) SEL.delete(nodeId);
    await loadRoots(); await loadTree();
  }catch(e){ alert('√âchec suppression: '+(e.message||e)); }
}

// Move
function openMoveModal(nodeId){
  const n = findNode(nodeId);
  if(!n){ alert('N≈ìud introuvable'); return; }
  window.__moveBulk = false;
  MOVE_NODE_ID = nodeId;
  document.getElementById('moveTitle').textContent = n.name + ' (id '+n.id+')';
  const parentId = findParentId(nodeId);
  buildParentSelect(document.getElementById('move-parent'), n, parentId || '');
  document.getElementById('moveModal').classList.add('show');
}
function closeMoveModal(){ document.getElementById('moveModal').classList.remove('show'); MOVE_NODE_ID = null; }
async function confirmMove(){
  const v = document.getElementById('move-parent').value;
  const parent_id = v ? parseInt(v,10) : null;
  const ids = (window.__moveBulk ? Array.from(SEL) : [MOVE_NODE_ID]).filter(Boolean);
  try{
    for(const id of ids){
      await api('/stock/'+id, {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({parent_id})});
    }
    closeMoveModal();
    window.__moveBulk = false;
    SEL.clear(); updateSelbar();
    await loadRoots(); await loadTree();
  }catch(e){ alert('√âchec d√©placement: '+(e.message||e)); }
}

// Duplicate
function openDupModal(nodeId){
  const n = findNode(nodeId);
  if(!n){ alert('N≈ìud introuvable'); return; }
  window.__dupBulk = false;
  DUP_NODE_ID = nodeId;
  document.getElementById('dupTitle').textContent = n.name + ' (id '+n.id+')';
  document.getElementById('dup-name').value = n.name + ' (copie)';
  const parentId = findParentId(nodeId);
  buildParentSelect(document.getElementById('dup-parent'), n, parentId || '');
  document.getElementById('dupModal').classList.add('show');
}
function closeDupModal(){ document.getElementById('dupModal').classList.remove('show'); DUP_NODE_ID = null; }
async function confirmDup(){
  const new_name_base = (document.getElementById('dup-name').value || '').trim();
  const v = document.getElementById('dup-parent').value;
  const new_parent_id = v ? parseInt(v,10) : null;
  const ids = (window.__dupBulk ? Array.from(SEL) : [DUP_NODE_ID]).filter(Boolean);
  try{
    let i=0;
    for(const id of ids){
      const new_name = ids.length>1 ? `${new_name_base} (${++i})` : new_name_base;
      await api('/stock/'+id+'/duplicate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({new_name, new_parent_id})});
    }
    closeDupModal();
    window.__dupBulk = false;
    SEL.clear(); updateSelbar();
    await loadRoots(); await loadTree();
  }catch(e){ alert('√âchec duplication: '+(e.message||e)); }
}

// Edit
async function refreshEditExpiries(nodeId){
  if(!nodeId) return;
  const section = document.getElementById('edit-expiries-section');
  if(!section || section.style.display === 'none') return;
  const tbody = document.getElementById('edit-expiries-body');
  const info = document.getElementById('edit-expiries-info');
  tbody.innerHTML = '<tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr>';
  if(info) info.textContent = 'Chargement‚Ä¶';
  try{
    const data = await api(`/stock/api/item/${nodeId}/expiries`);
    if(EDIT_NODE_ID !== nodeId) return;
    if(!Array.isArray(data) || !data.length){
      tbody.innerHTML = '<tr><td colspan="5" class="muted">Aucun lot suivi.</td></tr>';
      if(info) info.textContent = 'Aucun lot suivi. Ajoute un lot ci-dessous.';
      const legacyInput = document.getElementById('edit-expiry');
      if(legacyInput && EDIT_NODE_ID === nodeId){
        legacyInput.value = '';
      }
      return;
    }
    tbody.innerHTML = '';
    data.forEach(exp=>{
      const tr = document.createElement('tr');
      tr.appendChild(h('td', {}, formatISODate(exp.expiry_date)));
      tr.appendChild(h('td', {}, exp.quantity ?? ''));
      tr.appendChild(h('td', {}, exp.lot ?? ''));
      tr.appendChild(h('td', {}, exp.note ?? ''));
      const delBtn = h('button', {class:'btn danger', type:'button'}, 'Supprimer');
      delBtn.onclick = async ()=>{
        if(!confirm('Supprimer cette date ?')) return;
        try{
          const res = await api(`/stock/api/expiry/${exp.id}`, {method:'DELETE'});
          if(res && typeof res === 'object' && 'next_expiry' in res){
            document.getElementById('edit-expiry').value = res.next_expiry || '';
          }
          await refreshEditExpiries(nodeId);
          await loadTree();
        }catch(err){
          alert('Suppression refus√©e: '+(err.message||err));
        }
      };
      tr.appendChild(h('td', {}, delBtn));
      tbody.appendChild(tr);
    });
    const first = data[0]?.expiry_date || null;
    let txt = `${data.length} lot${data.length>1?'s':''} suivi${data.length>1?'s':''}`;
    if(first) txt += ` ‚Ä¢ Prochaine: ${formatISODate(first)}`;
    if(info) info.textContent = txt;
    const legacyInput = document.getElementById('edit-expiry');
    if(legacyInput && EDIT_NODE_ID === nodeId){
      legacyInput.value = first || '';
    }
  }catch(e){
    if(EDIT_NODE_ID !== nodeId) return;
    tbody.innerHTML = '<tr><td colspan="5" class="muted">Impossible de charger les lots.</td></tr>';
    if(info) info.textContent = 'Erreur: '+(e.message||e);
  }
}

function openEditModal(nodeId){
  const n = findNode(nodeId);
  if(!n){ alert('N≈ìud introuvable'); return; }
  EDIT_NODE_ID = nodeId;
  document.getElementById('editTitle').textContent = n.name + ' (id '+n.id+')';
  document.getElementById('edit-name').value = n.name || '';
  const qtyWrap = document.getElementById('edit-qty-wrap');
  const expWrap = document.getElementById('edit-expiry-wrap');
  const expSection = document.getElementById('edit-expiries-section');
  const groupFields = document.getElementById('edit-group-fields');
  const uniqueCb = document.getElementById('edit-unique');
  const uniqueQtyWrap = document.getElementById('edit-unique-qty-wrap');
  const uniqueQtyInput = document.getElementById('edit-unique-qty');
  const editCatField = document.getElementById('edit-root-category-field');
  const editCatSelect = document.getElementById('edit-root-category');
  if(n.type === 'ITEM'){
    qtyWrap.style.display = '';
    expWrap.style.display = '';
    if(groupFields) groupFields.style.display = 'none';
    document.getElementById('edit-qty').value = n.quantity ?? 0;
    document.getElementById('edit-expiry').value = n.expiry_date || '';
    if(expSection) expSection.style.display = '';
    document.getElementById('edit-exp-new-date').value = '';
    document.getElementById('edit-exp-new-qty').value = '';
    document.getElementById('edit-exp-new-lot').value = '';
    document.getElementById('edit-exp-new-note').value = '';
    const infoEl = document.getElementById('edit-expiries-info');
    if(infoEl) infoEl.textContent = 'Chargement‚Ä¶';
    const openBtn = document.getElementById('edit-exp-open-page');
    if(openBtn){
      openBtn.onclick = ()=> window.open(`/stock/item/${n.id}/expiries`, '_blank');
    }
    refreshEditExpiries(n.id);
  }else{
    qtyWrap.style.display = 'none';
    expWrap.style.display = 'none';
    if(expSection) expSection.style.display = 'none';
    if(groupFields){
      groupFields.style.display = '';
      if(uniqueCb){
        uniqueCb.checked = !!n.unique_item;
      }
      if(uniqueQtyInput){
        uniqueQtyInput.value = n.unique_quantity ?? 0;
      }
      if(uniqueQtyWrap){
        uniqueQtyWrap.style.display = (uniqueCb && uniqueCb.checked) ? '' : 'none';
      }
    }
  }
  if(editCatField){
    if(n.parent_id === null && n.type === 'GROUP'){
      editCatField.style.display = '';
      const rootInfo = ROOTS.find(r => r.id === n.id);
      const selectedId = (typeof n.root_category_id !== 'undefined' && n.root_category_id !== null)
        ? n.root_category_id
        : (rootInfo && rootInfo.root_category ? rootInfo.root_category.id : null);
      populateCategorySelect(editCatSelect, selectedId);
    }else{
      editCatField.style.display = 'none';
      if(editCatSelect) editCatSelect.value = '';
    }
  }
  document.getElementById('editModal').classList.add('show');
}
function closeEditModal(){
  document.getElementById('editModal').classList.remove('show');
  EDIT_NODE_ID = null;
  const section = document.getElementById('edit-expiries-section');
  if(section){
    section.style.display = 'none';
  }
  const tbody = document.getElementById('edit-expiries-body');
  if(tbody){
    tbody.innerHTML = '<tr><td colspan="5" class="muted">Aucun lot suivi.</td></tr>';
  }
  const info = document.getElementById('edit-expiries-info');
  if(info){ info.textContent = 'Ajoute une ligne par lot.'; }
  const openBtn = document.getElementById('edit-exp-open-page');
  if(openBtn){ openBtn.onclick = null; }
  const groupFields = document.getElementById('edit-group-fields');
  const uniqueQtyWrap = document.getElementById('edit-unique-qty-wrap');
  const uniqueCb = document.getElementById('edit-unique');
  const editCatField = document.getElementById('edit-root-category-field');
  const editCatSelect = document.getElementById('edit-root-category');
  if(groupFields) groupFields.style.display = 'none';
  if(uniqueQtyWrap) uniqueQtyWrap.style.display = 'none';
  if(uniqueCb) uniqueCb.checked = false;
  if(editCatField) editCatField.style.display = 'none';
  if(editCatSelect) editCatSelect.value = '';
  ['edit-exp-new-date','edit-exp-new-qty','edit-exp-new-lot','edit-exp-new-note'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = '';
  });
}
async function confirmEdit(){
  const nodeId = EDIT_NODE_ID;
  if(!nodeId) return;
  const n = findNode(nodeId);
  const name = (document.getElementById('edit-name').value || '').trim();
  const payload = { name };
  if(n.type==='ITEM'){
    const q = parseInt(document.getElementById('edit-qty').value || '0', 10);
    if(isNaN(q) || q<0){ alert('Quantit√© invalide'); return; }
    payload.quantity = q;
    const ex = document.getElementById('edit-expiry').value;
    payload.expiry_date = ex || null;
  }else{
    const uniqueCb = document.getElementById('edit-unique');
    const uniqueQtyInput = document.getElementById('edit-unique-qty');
    if(uniqueCb){
      payload.unique_item = !!uniqueCb.checked;
      if(uniqueCb.checked){
        const uq = parseInt((uniqueQtyInput?.value || '0'), 10);
        if(isNaN(uq) || uq < 0){ alert('Quantit√© maximale invalide'); return; }
        payload.unique_quantity = uq;
      }
    }
    if(n.parent_id === null){
      const catSelect = document.getElementById('edit-root-category');
      if(catSelect){
        if(catSelect.value){
          const catId = parseInt(catSelect.value, 10);
          payload.root_category_id = isNaN(catId) ? null : catId;
        }else{
          payload.root_category_id = null;
        }
      }
    }
  }
  try{
    await api('/stock/'+nodeId, {method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    closeEditModal();
    await loadRoots(); await loadTree();
  }catch(e){ alert('√âchec √©dition: '+(e.message||e)); }
}

// Add (root or child)
let ADD_PARENT_ID = null;
function openAddModal(parentId, defaultType){
  ADD_PARENT_ID = parentId || null;
  const typeSel = document.getElementById('add-type');
  typeSel.value = (defaultType || 'GROUP');
  document.getElementById('add-name').value = '';
  document.getElementById('add-qty').value = 1;
  document.getElementById('add-expiry').value = '';
  const addItemFields = document.getElementById('add-item-fields');
  const addGroupFields = document.getElementById('add-group-fields');
  const uniqueCb = document.getElementById('add-unique');
  const uniqueQtyWrap = document.getElementById('add-unique-qty-wrap');
  const uniqueQtyInput = document.getElementById('add-unique-qty');
  const addCatField = document.getElementById('add-root-category-field');
  const addCatSelect = document.getElementById('add-root-category');
  if(addItemFields) addItemFields.style.display = (typeSel.value === 'ITEM') ? '' : 'none';
  if(addGroupFields) addGroupFields.style.display = (typeSel.value === 'GROUP') ? '' : 'none';
  if(uniqueCb){ uniqueCb.checked = false; }
  if(uniqueQtyInput){ uniqueQtyInput.value = 1; }
  if(uniqueQtyWrap){ uniqueQtyWrap.style.display = 'none'; }
  if(addCatField){
    const showCategory = (ADD_PARENT_ID === null && typeSel.value === 'GROUP');
    addCatField.style.display = showCategory ? '' : 'none';
    if(showCategory){
      populateCategorySelect(addCatSelect);
      if(addCatSelect) addCatSelect.value = '';
    }else if(addCatSelect){
      addCatSelect.value = '';
    }
  }
  document.getElementById('addModal').classList.add('show');
  document.getElementById('add-name').focus();
}
function closeAddModal(){
  document.getElementById('addModal').classList.remove('show');
  ADD_PARENT_ID = null;
  const addCatField = document.getElementById('add-root-category-field');
  const addCatSelect = document.getElementById('add-root-category');
  if(addCatField) addCatField.style.display = 'none';
  if(addCatSelect) addCatSelect.value = '';
}
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'add-type'){
    const isItem = (e.target.value === 'ITEM');
    const addItemFields = document.getElementById('add-item-fields');
    const addGroupFields = document.getElementById('add-group-fields');
    if(addItemFields) addItemFields.style.display = isItem ? '' : 'none';
    if(addGroupFields) addGroupFields.style.display = isItem ? 'none' : '';
    const addCatField = document.getElementById('add-root-category-field');
    const addCatSelect = document.getElementById('add-root-category');
    if(addCatField){
      const showCategory = (ADD_PARENT_ID === null && e.target.value === 'GROUP');
      addCatField.style.display = showCategory ? '' : 'none';
      if(showCategory){
        populateCategorySelect(addCatSelect);
      }else if(addCatSelect){
        addCatSelect.value = '';
      }
    }
  }
  if(e.target && e.target.id === 'add-unique'){
    const wrap = document.getElementById('add-unique-qty-wrap');
    if(wrap) wrap.style.display = e.target.checked ? '' : 'none';
  }
  if(e.target && e.target.id === 'edit-unique'){
    const wrap = document.getElementById('edit-unique-qty-wrap');
    if(wrap) wrap.style.display = e.target.checked ? '' : 'none';
  }
});
async function confirmAdd(){
  const type = document.getElementById('add-type').value;
  const name = (document.getElementById('add-name').value || '').trim();
  if(!name){ alert('Nom requis'); return; }
  const payload = { name, type, parent_id: ADD_PARENT_ID };
  if(type === 'ITEM'){
    let q = parseInt(document.getElementById('add-qty').value || '0', 10);
    if(isNaN(q) || q < 0){ alert('Quantit√© invalide'); return; }
    payload.quantity = q;
    const ex = document.getElementById('add-expiry').value;
    if(ex) payload.expiry_date = ex;
  }else{
    const uniqueCb = document.getElementById('add-unique');
    if(uniqueCb && uniqueCb.checked){
      const uq = parseInt((document.getElementById('add-unique-qty').value || '0'), 10);
      if(isNaN(uq) || uq < 0){ alert('Quantit√© maximale invalide'); return; }
      payload.unique_item = true;
      payload.unique_quantity = uq;
    }
    if(ADD_PARENT_ID === null){
      const catSelect = document.getElementById('add-root-category');
      if(catSelect){
        if(catSelect.value){
          const catId = parseInt(catSelect.value, 10);
          payload.root_category_id = isNaN(catId) ? null : catId;
        }else{
          payload.root_category_id = null;
        }
      }
    }
  }
  try{
    const res = await api('/stock', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    closeAddModal();
    await loadRoots();
    if(ADD_PARENT_ID === null && res && res.id){ // nouvelle racine -> s√©lection imm√©diate
      CURRENT_ROOT_ID = res.id;
    }
    await loadTree();
  }catch(e){ alert('√âchec cr√©ation: '+(e.message||e)); }
}

// ------- Import -------
async function doImport(){
  const f = document.getElementById('import-file').files[0];
  if(!f){ alert("S√©lectionne un fichier JSON d'export de stock."); return; }
  const mode = document.getElementById('import-mode').value || 'merge';
  const fd = new FormData();
  fd.append('file', f, f.name);
  fd.append('mode', mode);
  try{
    await api('/stock/import', {method:'POST', body: fd});
    document.getElementById('import-file').value = '';
    await loadRoots(); await loadTree();
    alert('Import effectu√© ('+mode+').');
  }catch(e){ alert('√âchec import: '+(e.message||e)); }
}

// ------- Multi-s√©lection (barre) -------
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('sel-del').onclick = async ()=>{
    if(SEL.size===0) return;
    if(!confirm('Supprimer '+SEL.size+' n≈ìud(s) et leurs sous-arbres ?')) return;
    for(const id of Array.from(SEL)){
      try{ await api('/stock/'+id, {method:'DELETE'}); }catch(e){ alert('√âchec suppression id '+id+': '+(e.message||e)); }
    }
    clearSelection();
    await loadRoots(); await loadTree();
  };
  document.getElementById('sel-move').onclick = ()=>{
    if(SEL.size===0) return;
    openMoveModal(Array.from(SEL)[0]);
    window.__moveBulk = true;
  };
  document.getElementById('sel-dup').onclick = ()=>{
    if(SEL.size===0) return;
    openDupModal(Array.from(SEL)[0]);
    window.__dupBulk = true;
  };
});

// ------- Global init -------
document.addEventListener('DOMContentLoaded', ()=>{
  // Buttons
  document.getElementById('btn-import').onclick = doImport;
document.getElementById('btn-root-add').onclick = ()=> openAddModal(null,'GROUP');
const btnCatAdd = document.getElementById('btn-root-cat-add');
if(btnCatAdd){ btnCatAdd.onclick = createCategoryPrompt; }
  const expAddBtn = document.getElementById('edit-exp-add');
  if(expAddBtn){
    expAddBtn.addEventListener('click', async ()=>{
      const nodeId = EDIT_NODE_ID;
      if(!nodeId){ alert('Ouvre un item √† √©diter avant d‚Äôajouter une p√©remption.'); return; }
      const dateValue = (document.getElementById('edit-exp-new-date').value || '').trim();
      if(!dateValue){ alert('Merci de renseigner une date de p√©remption.'); return; }
      const qtyRaw = (document.getElementById('edit-exp-new-qty').value || '').trim();
      const lot = (document.getElementById('edit-exp-new-lot').value || '').trim();
      const note = (document.getElementById('edit-exp-new-note').value || '').trim();
      const payload = { expiry_date: dateValue };
      if(qtyRaw !== ''){
        const qtyNum = Number(qtyRaw);
        if(!Number.isFinite(qtyNum) || qtyNum < 0){ alert('Quantit√© invalide'); return; }
        payload.quantity = qtyNum;
      }
      if(lot) payload.lot = lot;
      if(note) payload.note = note;
      try{
        const res = await api(`/stock/api/item/${nodeId}/expiries`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        document.getElementById('edit-exp-new-date').value = '';
        document.getElementById('edit-exp-new-qty').value = '';
        document.getElementById('edit-exp-new-lot').value = '';
        document.getElementById('edit-exp-new-note').value = '';
        if(res && typeof res === 'object' && 'next_expiry' in res){
          document.getElementById('edit-expiry').value = res.next_expiry || '';
        }
        await refreshEditExpiries(nodeId);
        await loadTree();
      }catch(e){
        alert('Ajout refus√©: '+(e.message||e));
      }
    });
  }

  // Close dropdowns on outside click
  document.addEventListener('click', (e)=>{
    document.querySelectorAll('.dd.show').forEach(dd=>{ if(!dd.contains(e.target)) dd.classList.remove('show'); });
  });

  // Global search
  const g = document.getElementById('global-search');
  g.addEventListener('input', renderTree);

  // Start
  loadRoots().then(loadTree);
});
</script>

{% endblock %}
