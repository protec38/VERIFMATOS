{% extends "base.html" %}
{% from "base.html" import icon %}
{% set title = "Administration / Stock" %}
{% block content %}
  <div class="card">
    <div class="row">
      <div class="title">Gestion des stocks</div>
      <div class="row">
        <a class="btn" href="{{ url_for('pages.dashboard') }}">← Menu principal</a>
        <a class="btn ghost" href="{{ url_for('pages.logout') }}">Déconnexion</a>
      </div>
    </div>
    <div class="muted">Création / suppression réservées à l’admin.</div>
  </div>

  <div class="grid cols-2" style="align-items:start;">
    <div class="card">
      <div class="title">Arbre</div>
      <div class="row" style="gap:8px;">
        <select id="root-select"></select>
        <a class="btn" id="btn-reload">Recharger</a>
      </div>
      <div id="stock-tree" class="tree" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="title">Créer un nœud</div>
      <div class="row">
        <input id="new-name" placeholder="Nom (ex: SAC PS BLEU)">
      </div>
      <div class="row">
        <select id="new-type">
          <option value="GROUP">GROUP (parent)</option>
          <option value="ITEM">ITEM (enfant quantifié)</option>
        </select>
        <input id="new-qty" type="number" min="0" value="0" style="max-width:120px;" placeholder="Qté (ITEM)">
      </div>
      <div class="row">
        <select id="new-parent"></select>
      </div>
      <div class="row">
        <a class="btn primary" id="btn-create">Créer</a>
      </div>
    </div>
  </div>

  <script>
    async function api(url, opts={}){
      const r = await fetch(url, {credentials:'include', ...opts});
      if(!r.ok){ throw new Error(await r.text()); }
      return r.json();
    }

    async function loadRoots(){
      const roots = await api('/stock/roots');
      const sel = document.getElementById('root-select');
      const par = document.getElementById('new-parent');
      sel.innerHTML = ''; par.innerHTML='';
      roots.forEach(r => {
        const o = document.createElement('option'); o.value = r.id; o.textContent = r.name; sel.appendChild(o);
        const p = document.createElement('option'); p.value = r.id; p.textContent = r.name; par.appendChild(p);
      });
      if(!roots.length){
        const o = document.createElement('option'); o.value=''; o.textContent='(Aucune racine)'; sel.appendChild(o);
        const p = document.createElement('option'); p.value=''; p.textContent='(Aucune racine)'; par.appendChild(p);
      }
    }

    async function loadTree(){
      const id = document.getElementById('root-select').value;
      if(!id){ document.getElementById('stock-tree').innerHTML = '<div class="muted">Sélectionne une racine…</div>'; return; }
      const t = await api('/stock/' + id + '/tree');
      const host = document.getElementById('stock-tree');
      host.innerHTML = '';
      host.appendChild(renderNode(t));
    }

    function renderNode(tree){
      const wrap = document.createElement('div'); wrap.className = 'node';
      const head = document.createElement('div'); head.className='header';
      const name = document.createElement('div'); name.className='name'; name.textContent = tree.name + (tree.level !== undefined ? ' (lvl ' + tree.level + ')' : '');
      head.append(name);

      const actions = document.createElement('div'); actions.className='row';
      const del = document.createElement('a'); del.className='btn ghost'; del.textContent='Supprimer';
      del.onclick = async (e)=>{
        e.preventDefault();
        let url = '/stock/' + tree.id;
        const hasChildren = (tree.children && tree.children.length);
        if(hasChildren){
          const cascade = confirm('Ce nœud a des enfants. Supprimer en cascade ?');
          if(!cascade) return;
          // Si ton API supporte la cascade : décommente
          // url += '?force=1';
        }
        try{
          const r = await fetch(url, {method:'DELETE', credentials:'include'});
          if(!r.ok){ throw new Error(await r.text()); }
          await loadTree();
        }catch(err){ alert('Suppression impossible: ' + (err?.message || err)); }
      };
      actions.append(del);
      head.append(actions);

      wrap.append(head);
      const childs = document.createElement('div'); childs.className='childs';
      (tree.children || []).forEach(c => childs.appendChild(renderNode(c)));
      wrap.append(childs);
      return wrap;
    }

    document.getElementById('btn-reload').onclick = loadTree;
    document.getElementById('root-select').onchange = loadTree;

    document.getElementById('btn-create').onclick = async () => {
      try{
        const name = document.getElementById('new-name').value.trim();
        const type = document.getElementById('new-type').value;
        const qty = parseInt(document.getElementById('new-qty').value || '0', 10);
        const parent_id = document.getElementById('new-parent').value || null;
        const payload = {name, type, parent_id, quantity: type==='ITEM' ? qty : null};
        const r = await fetch('/stock', {method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(!r.ok){ throw new Error(await r.text()); }
        await loadRoots(); await loadTree();
        document.getElementById('new-name').value = ''; document.getElementById('new-qty').value = '0';
      }catch(err){ alert('Création impossible: ' + (err?.message || err)); }
    };

    (async function init(){
      await loadRoots();
      await loadTree();
    })();
  </script>
{% endblock %}
