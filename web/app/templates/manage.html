{% extends "base.html" %}
{% from "base.html" import icon %}
{% set title = "Administration / Stock" %}
{% block content %}
<style>
  /* Dropdown 'Ajouter' */
  .dd{position:relative;display:inline-block}
  .dd-menu{position:absolute;right:0;top:calc(100% + 6px);background:#0f1e2f;border:1px solid var(--border);border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;min-width:180px;z-index:15}
  .dd.show .dd-menu{display:block}
  .dd-menu button{display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:transparent;color:var(--text);cursor:pointer}
  .dd-menu button:hover{background:#11263a}

  /* Modal Add Child */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#0f1a2a;border:1px solid var(--border);border-radius:12px;padding:18px;max-width:520px;width:95%}
  .modal .row{display:flex;gap:10px;align-items:center}
  .modal label{display:block;margin-top:8px;font-size:14px;opacity:.85}
  .modal input, .modal select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#0f1e2f;color:var(--text)}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
</style>

  <div class="card">
    <div class="row">
      <div class="title">Gestion des stocks</div>
      <div class="row">
        <a class="btn" href="{{ url_for('pages.dashboard') }}">‚Üê Menu principal</a>
        <a class="btn ghost" href="{{ url_for('pages.logout') }}">D√©connexion</a>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="btn primary" id="btn-root-add">‚ûï Parent racine</button>  <a class="btn" href="/stock/export.json" download>‚¨á Export JSON</a>
        <label class="btn">üìÑ Choisir JSON‚Ä¶
          <input type="file" id="import-file" accept="application/json" style="display:none">
        </label>
        <select id="import-mode">
          <option value="merge" selected>Fusion (ajout)</option>
          <option value="replace">Remplacer tout</option>
        </select>
        <button class="btn primary" id="btn-import">Importer</button>
      </div>
    </div>
    <div class="muted">Toutes les actions sont r√©serv√©es √† l‚Äôadministrateur.</div>
  </div>

  <div class="grid cols-2" style="align-items:start;">
    <!-- Colonne gauche : navigation / arbre -->
    <div class="card">
      <div class="title">Arbre & racines</div>

      <div class="row" style="gap:8px; align-items:flex-end;">
        <div style="flex:1;">
          <label class="muted">Racine</label>
          <select id="root-select" style="width:100%;"></select>
        </div>
        <a class="btn" id="btn-reload">Recharger</a>
      </div>

      <div class="row" style="gap:8px; margin-top:8px; align-items:flex-end;">
        <div style="flex:1;">
          <label class="muted">Cr√©er une racine (GROUP)</label>
          <input id="root-name" placeholder="Nom de la racine (ex: SAC PS BLEU)">
        </div>
        <a class="btn primary" id="btn-create-root">Cr√©er</a>
      </div>

      <div class="row" style="gap:8px; margin-top:8px;">
        <input id="filter" placeholder="Rechercher dans l‚Äôarbre (nom partiel)" style="flex:1;">
        <a class="btn" id="btn-clear-filter">Effacer</a>
      </div>

      <div id="stock-tree" class="tree" style="margin-top:10px;"></div>
    </div>

    <!-- Colonne droite : panneau d‚Äô√©dition -->
    <div class="card">
      <div class="title">√âdition du n≈ìud</div>

      <div id="no-selection" class="muted">
        S√©lectionne un n≈ìud dans l‚Äôarbre pour l‚Äô√©diter, ou cr√©e un nouvel √©l√©ment √† partir d‚Äôune racine.
      </div>

      <div id="editor" style="display:none;">
        <div class="row">
          <div class="title" id="node-path" style="font-size:14px; font-weight:600;"></div>
        </div>

        <div class="row">
          <div style="flex:1;">
            <label class="muted">Nom</label>
            <input id="edit-name" placeholder="Nom du n≈ìud">
          </div>
        </div>

        <div class="row">
          <div>
            <label class="muted">Type</label>
            <select id="edit-type">
              <option value="GROUP">GROUP (parent)</option>
              <option value="ITEM">ITEM (enfant quantifi√©)</option>
            </select>
          </div>
          <div id="qty-wrap" style="display:none;">
            <label class="muted">Quantit√©</label>
            <input id="edit-qty" type="number" min="0" value="0" style="max-width:140px;">
          </div>
          <div id="expiry-wrap" style="display:none;">
            <label class="muted">P√©remption</label>
            <input id="edit-expiry" type="date" style="max-width:180px;">
          </div>
        </div>

        <div class="row">
          <div style="flex:1;">
            <label class="muted">D√©placer sous‚Ä¶ (nouveau parent)</label>
            <select id="edit-parent" style="width:100%;"></select>
            <div class="muted" style="font-size:12px;">Choisis "(Racine actuelle)" pour remonter au niveau racine.</div>
          </div>
        </div>

        <div class="row" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
          <a class="btn primary" id="btn-save">Enregistrer</a>
          <a class="btn" id="btn-add-group">+ Sous-parent (GROUP)</a>
          <a class="btn" id="btn-add-item">+ Enfant (ITEM)</a>
          <a class="btn" id="btn-duplicate">Dupliquer le sous-arbre</a>
          <a class="btn ghost" id="btn-delete">Supprimer</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- State ---
    let ROOTS = [];
    let TREE = null;        // arbre de la racine s√©lectionn√©e
    let ALL_NODES = [];     // flatten de TREE (pour selects)
    let SELECTED_ID = null; // n≈ìud courant dans TREE

    // --- Utils ---
    async function api(url, opts={}){
      const r = await fetch(url, {credentials:'include', ...opts});
      if(!r.ok){
        let msg = '';
        try { msg = await r.text(); } catch(e){}
        throw new Error(msg || ('HTTP '+r.status));
      }
      const ct = r.headers.get('Content-Type') || '';
      if(ct.includes('application/json')) return r.json();
      return r.text();
    }

    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==='class') el.className = v;
        else if(k.startsWith('on') && typeof v === 'function') el.addEventListener(k.slice(2), v);
        else el.setAttribute(k, v);
      }
      for(const c of children){
        if(c == null) continue;
        el.append(c.nodeType ? c : document.createTextNode(c));
      }
      return el;
    }

    // --- P√©remption helpers ---
    function daysUntilISO(iso){ // iso: 'YYYY-MM-DD'
      if(!iso) return null;
      try{
        const [y,m,d] = iso.split('-').map(x=>parseInt(x,10));
        const dt = new Date(Date.UTC(y, m-1, d));
        const now = new Date();
        const todayUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
        const diff = (dt.getTime() - todayUTC) / 86400000;
        return Math.floor(diff);
      }catch(e){ return null; }
    }
    function perempCategory(iso){
      const k = daysUntilISO(iso);
      if(k === null) return 'no_date';
      if(k < 0) return 'expired';
      if(k <= 30) return 'j30';
      if(k <= 60) return 'j60';
      return 'later';
    }
    function perempBadge(cat){
      if(cat==='expired') return ['P√©rim√©', 'background:#2a1111;border-color:#a33;color:#ffdce1'];
      if(cat==='j30')     return ['‚â§30j',   'background:#2a1b0f;border-color:#b86b00;color:#ffd8a8'];
      if(cat==='j60')     return ['‚â§60j',   'background:#2a270f;border-color:#b3a100;color:#ffe566'];
      if(cat==='later')   return ['>60j',   'background:#0f2a22;border-color:#17614f;color:#bff3e7'];
      return ['‚Äî',        'opacity:.7'];
    }


    function flatten(tree){
      const out = [];
      (function walk(n, path){
        out.push({id:n.id, name:n.name, type:n.type, level:n.level, path: path.concat([n.name])});
        (n.children||[]).forEach(c => walk(c, path.concat([n.name])));
      })(tree, []);
      return out;
    }

    function findNode(id, n=TREE){
      if(!n) return null;
      if(n.id === id) return n;
      for(const c of (n.children||[])){
        const f = findNode(id, c);
        if(f) return f;
      }
      return null;
    }

    function pathOf(id){
      const out = [];
      (function walk(n){
        if(n.id === id){ out.push(n.name); return true; }
        for(const c of (n.children||[])){
          if(walk(c)){ out.unshift(n.name); return true; }
        }
        return false;
      })(TREE);
      return out.join(' ‚Ä∫ ');
    }

    function renderTree(host, tree, filter=''){
      host.innerHTML = '';
      if(!tree){
        host.append(h('div', {class:'muted'}, "S√©lectionne une racine‚Ä¶"));
        return;
      }
      const match = (name) => !filter || name.toLowerCase().includes(filter.toLowerCase());

      function nodeEl(n){
        const box = h('div', {class:'node'});
        const head = h('div', {class:'header'});
        const name = h('div', {class:'name'}, n.name + `  (lvl ${n.level}, ${n.type})`);
        name.style.cursor = 'pointer';
        name.onclick = () => selectNode(n.id);
        // P√©remption badge pour ITEM
        if(n.type === 'ITEM'){
          const cat = perempCategory(n.expiry_date);
          const [lbl, style] = perempBadge(cat);
          const b = h('span', {class:'badge', style:'margin-left:8px;'+style}, lbl);
          name.append(' ', b);
        }
        head.append(name);

        const actions = h('div', {class:'row'});
        const btnG = h('a', {class:'btn', on: 'click'}, '+Sous-parent');
        btnG.onclick = async (e)=>{
          e.preventDefault();
          const nm = prompt("Nom du sous-parent (GROUP) ?");
          if(!nm) return;
          await createNode({name:nm, type:'GROUP', parent_id: n.id});
          await reloadTree();
        };
        const btnI = h('a', {class:'btn', on:'click'}, '+Item');
        btnI.onclick = async (e)=>{
          e.preventDefault();
          const nm = prompt("Nom de l'item ?");
          if(!nm) return;
          const q = parseInt(prompt("Quantit√© ? (entier >=0)", "1")||"0", 10);
          await createNode({name:nm, type:'ITEM', parent_id: n.id, quantity: isNaN(q)?0:q});
          await reloadTree();
        };
        const btnDel = h('a', {class:'btn ghost', on:'click'}, 'Supprimer');
        btnDel.onclick = async (e)=>{
          e.preventDefault();
          if(!confirm(`Supprimer "${n.name}" et tout son sous-arbre ?`)) return;
          await api('/stock/'+n.id, {method:'DELETE'});
          if(SELECTED_ID === n.id) SELECTED_ID = null;
          await reloadTree();
        };
        actions.append(btnG, btnI, btnDel);
        head.append(actions);

        box.append(head);
        const childs = h('div', {class:'childs'});
        (n.children||[]).forEach(c => {
          if(match(c.name)) childs.append(nodeEl(c));
          else childs.append(nodeEl(c)); // on ne filtre pas structurellement (on affiche tout)
        });
        box.append(childs);
        return box;
      }

      host.append(nodeEl(tree));
    }

    function fillParentSelect(){
      const sel = document.getElementById('edit-parent');
      sel.innerHTML = '';
      const current = SELECTED_ID ? findNode(SELECTED_ID) : null;
      // Option racine
      sel.append(h('option', {value:''}, '(Racine actuelle)'));
      // Tous les n≈ìuds du m√™me arbre (on emp√™che parent = soi-m√™me)
      ALL_NODES.forEach(n=>{
        if(current && n.id === current.id) return;
        sel.append(h('option', {value:String(n.id)}, (n.path||[n.name]).join(' ‚Ä∫ ')));
      });
      // Pr√©-s√©lectionner le parent actuel si possible
      if(current){
        // Trouver l'id du parent actuel
        let currentParentId = null;
        (function findParent(n, parentId){
          if(n.id === current.id){ currentParentId = parentId; return true; }
          for(const c of (n.children||[])){
            if(findParent(c, n.id)) return true;
          }
          return false;
        })(TREE, null);
        sel.value = currentParentId ? String(currentParentId) : '';
      }
    }

    function showEditor(n){
      document.getElementById('no-selection').style.display = 'none';
      document.getElementById('editor').style.display = '';
      document.getElementById('node-path').textContent = pathOf(n.id);
      document.getElementById('edit-name').value = n.name;
      document.getElementById('edit-type').value = n.type;
      const qtyWrap = document.getElementById('qty-wrap');
      if(n.type === 'ITEM'){ qtyWrap.style.display = ''; document.getElementById('edit-qty').value = n.quantity ?? 0; document.getElementById('expiry-wrap').style.display=''; document.getElementById('edit-expiry').value = (n.expiry_date||''); }
      else { qtyWrap.style.display = 'none'; document.getElementById('expiry-wrap').style.display='none'; document.getElementById('edit-expiry').value=''; }
      fillParentSelect();
    }

    function hideEditor(){
      document.getElementById('no-selection').style.display = '';
      document.getElementById('editor').style.display = 'none';
    }

    function selectNode(id){
      SELECTED_ID = id;
      const n = findNode(id);
      if(n) showEditor(n); else hideEditor();
    }

    // --- API helpers ---
    async function loadRoots(){
      ROOTS = await api('/stock/roots');
      const sel = document.getElementById('root-select');
      sel.innerHTML = '';
      ROOTS.forEach(r => sel.append(h('option', {value:String(r.id)}, r.name)));
      if(!ROOTS.length){
        sel.append(h('option', {value:''}, '(Aucune racine)'));
      }
    }

    async function loadTree(){
      const sel = document.getElementById('root-select');
      const rid = sel.value;
      if(!rid){ TREE = null; ALL_NODES = []; SELECTED_ID = null; hideEditor(); document.getElementById('stock-tree').innerHTML = '<div class="muted">Aucune racine</div>'; return; }
      TREE = await api('/stock/'+rid+'/tree');
      ALL_NODES = flatten(TREE);
      SELECTED_ID = null;
      hideEditor();
      renderTree(document.getElementById('stock-tree'), TREE, document.getElementById('filter').value.trim());
    }

    async function reloadTree(){
      await loadTree();
      // re-s√©lectionne si encore pr√©sent
      if(SELECTED_ID && findNode(SELECTED_ID)) showEditor(findNode(SELECTED_ID));
    }

    async function createNode({name, type, parent_id=null, quantity=null}){
      const payload = {name, type};
      if(parent_id) payload.parent_id = parent_id;
      if(type === 'ITEM') payload.quantity = (quantity ?? 0);
      await api('/stock', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }

    async function saveNode(){
      if(!SELECTED_ID) return;
      const n = findNode(SELECTED_ID);
      if(!n) return;
      const name = document.getElementById('edit-name').value.trim();
      const type = document.getElementById('edit-type').value;
      let parent_id = document.getElementById('edit-parent').value;
      parent_id = parent_id ? parseInt(parent_id,10) : null;
      let payload = {name, type};
      if(type === 'ITEM'){
        const qty = parseInt(document.getElementById('edit-qty').value || '0', 10);
        payload.quantity = isNaN(qty) ? 0 : qty;
        const ex = document.getElementById('edit-expiry').value; // '' ou 'YYYY-MM-DD'
        payload.expiry_date = ex || null; // envoie null pour effacer
      }
      // Changement de parent ?
      if(parent_id !== null) payload.parent_id = parent_id;
      else payload.parent_id = null;

      await api('/stock/'+SELECTED_ID, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      await reloadTree();
    }

    async function duplicateNode(){
      if(!SELECTED_ID) return;
      const newName = prompt("Nom de la nouvelle copie ?");
      if(!newName) return;
      await api('/stock/'+SELECTED_ID+'/duplicate', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({new_name: newName, new_parent_id: null})
      });
      await reloadTree();
    }

    async function deleteNode(){
      if(!SELECTED_ID) return;
      const n = findNode(SELECTED_ID);
      if(!n) return;
      if(!confirm(`Supprimer "${n.name}" et tout son sous-arbre ?`)) return;
      await api('/stock/'+SELECTED_ID, {method:'DELETE'});
      SELECTED_ID = null;
      await reloadTree();
    }

    // --- UI bindings ---
    document.getElementById('btn-reload').onclick = reloadTree;
    document.getElementById('btn-import').onclick = doImport;

    document.getElementById('root-select').onchange = loadTree;

    document.getElementById('btn-create-root').onclick = async () => {
      const nm = document.getElementById('root-name').value.trim();
      if(!nm) return;
      await createNode({name:nm, type:'GROUP', parent_id:null});
      document.getElementById('root-name').value = '';
      await loadRoots();
      // s√©lectionne automatiquement la derni√®re racine cr√©√©e
      const last = ROOTS[ROOTS.length-1];
      if(last) document.getElementById('root-select').value = String(last.id);
      await loadTree();
    };

    document.getElementById('filter').oninput = () => {
      renderTree(document.getElementById('stock-tree'), TREE, document.getElementById('filter').value.trim());
    };
    document.getElementById('btn-clear-filter').onclick = () => {
      document.getElementById('filter').value = '';
      renderTree(document.getElementById('stock-tree'), TREE, '');
    };

    document.getElementById('edit-type').onchange = (e) => {
      const showQty = (e.target.value === 'ITEM');
      document.getElementById('qty-wrap').style.display = showQty ? '' : 'none';
    };

    document.getElementById('btn-save').onclick = saveNode;
    document.getElementById('btn-duplicate').onclick = duplicateNode;
    document.getElementById('btn-delete').onclick = deleteNode;

    document.getElementById('btn-add-group').onclick = async () => {
      if(!SELECTED_ID) return;
      const nm = prompt("Nom du sous-parent (GROUP) ?");
      if(!nm) return;
      await createNode({name:nm, type:'GROUP', parent_id: SELECTED_ID});
      await reloadTree();
    };

    document.getElementById('btn-add-item').onclick = async () => {
      if(!SELECTED_ID) return;
      const nm = prompt("Nom de l'item ?");
      if(!nm) return;
      const q = parseInt(prompt("Quantit√© ? (entier >=0)", "1")||"0", 10);
      await createNode({name:nm, type:'ITEM', parent_id: SELECTED_ID, quantity: isNaN(q)?0:q});
      await reloadTree();
    };

    
    // --- Import JSON ---
    async function doImport(){
      const f = document.getElementById('import-file').files[0];
      if(!f){ alert("S√©lectionne un fichier JSON d'export de stock."); return; }
      const mode = document.getElementById('import-mode').value || 'merge';
      const fd = new FormData();
      fd.append('file', f, f.name);
      fd.append('mode', mode);
      try{
        const r = await fetch('/stock/import', {method:'POST', body: fd, credentials:'include'});
        if(!r.ok){
          const msg = await r.text().catch(()=>'');
          throw new Error(msg || ('HTTP '+r.status));
        }
        alert('Import effectu√© ('+mode+').');
        // reset input
        document.getElementById('import-file').value = '';
        await loadRoots();
        await loadTree();
      }catch(e){
        alert('√âchec import: '+(e.message||e));
      }
    }

    
// ------- Ajout (modal) -------
let ADD_PARENT_ID = null; // null => racine
function openAddModal(parentId, defaultType){
  ADD_PARENT_ID = parentId || null;
  const typeSel = document.getElementById('add-type');
  typeSel.value = (defaultType || 'GROUP');
  document.getElementById('add-name').value = '';
  document.getElementById('add-qty').value = 1;
  document.getElementById('add-expiry').value = '';
  document.getElementById('add-item-fields').style.display = (typeSel.value === 'ITEM') ? '' : 'none';
  document.getElementById('addModal').classList.add('show');
  document.getElementById('add-name').focus();
}
function closeAddModal(){
  document.getElementById('addModal').classList.remove('show');
  ADD_PARENT_ID = null;
}
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'add-type'){
    document.getElementById('add-item-fields').style.display = (e.target.value === 'ITEM') ? '' : 'none';
  }
});
async function confirmAdd(){
  const type = document.getElementById('add-type').value;
  const name = (document.getElementById('add-name').value || '').trim();
  if(!name){ alert('Nom requis'); return; }
  const payload = { name, type, parent_id: ADD_PARENT_ID };
  if(type === 'ITEM'){
    let q = parseInt(document.getElementById('add-qty').value || '0', 10);
    if(isNaN(q) || q < 0){ alert('Quantit√© invalide'); return; }
    payload.quantity = q;
    const ex = document.getElementById('add-expiry').value;
    if(ex) payload.expiry_date = ex;
  }
  try{
    const r = await fetch('/stock', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!r.ok){ const msg = await r.text().catch(()=> ''); throw new Error(msg || ('HTTP '+r.status)); }
    closeAddModal();
    await loadRoots();
    await loadTree();
  }catch(e){
    alert('√âchec cr√©ation: ' + (e.message || e));
  }
}
// Bouton "Parent racine"
document.addEventListener('DOMContentLoaded', ()=> {
  const btnRoot = document.getElementById('btn-root-add');
  if(btnRoot){ btnRoot.onclick = ()=> openAddModal(null, 'GROUP'); }
});


// Fermer les dropdowns au clic ext√©rieur
document.addEventListener('click', (e)=>{
  document.querySelectorAll('.dd.show').forEach(dd => {
    if(!dd.contains(e.target)){ dd.classList.remove('show'); }
  });
});

// Init
    (async function init(){
      await loadRoots();
      await loadTree();
    })();
  </script>
{% endblock %}
