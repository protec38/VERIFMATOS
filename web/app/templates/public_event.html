{% extends "base_public.html" %}
{% set title = "Vérification – Secouristes" %}
{% block content %}

<style>
  /* Layout & cards */
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
  .card{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--bg-2)}

  /* States */
  .state-ok{
    border-color: var(--success) !important;
    background: radial-gradient(600px 200px at top left, rgba(18,184,134,.15), transparent), #0f1e2f;
    box-shadow: 0 0 0 1px rgba(18,184,134,.35) inset, 0 0 18px rgba(18,184,134,.15);
  }
  .state-bad{
    border-color: var(--danger) !important;
    background: radial-gradient(600px 200px at top left, rgba(255,107,107,.12), transparent), #0f1a27;
    box-shadow: 0 0 0 1px rgba(255,107,107,.30) inset, 0 0 18px rgba(255,107,107,.12);
  }
  .state-wait{
    border-color: var(--border) !important;
    background: radial-gradient(600px 200px at top left, rgba(45,123,191,.08), transparent), var(--bg-2);
  }

  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .dot-ok{background:var(--success)} .dot-bad{background:var(--danger)} .dot-wait{background:#37527a}

  .chip{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border);}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.wait{background:#101c2e;color:#b7c7dc;border-color:#24344f}
  .muted{opacity:.8}

  /* Expiry badge */
  .expiry{display:inline-flex;align-items:center;gap:6px;margin-left:8px;font-size:12px;font-weight:700}
  .exp-flag{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px}
  .exp-soon{background:#2c2104;color:#e9c46a;border:1px solid #735c1a}   /* triangle jaune */
  .exp-expired{background:#2a0e14;color:#ffb3be;border:1px solid #7a1f2e} /* triangle rouge */
  .exp-text{opacity:.9}

  /* Tree */
  .node{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .name{font-weight:800}
  .childs{margin-top:10px}
  .item{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0}

  .vehicle{font-size:12px; opacity:.9; padding:2px 6px; border-radius:6px; border:1px dashed var(--border); margin-left:8px}
  .vehicle.on{background:#0e2a24; color:#bff3e7; border-color:#1d6e5d}
  .vehicle.off{background:#101c2e; color:#b7c7dc; border-color:#24344f}

  /* Collapse caret */
  .caret{cursor:pointer;user-select:none;display:inline-flex;align-items:center;gap:6px}
  .caret .triangle{transition:transform .15s ease}
  .collapsed .triangle{transform:rotate(-90deg)}
</style>

<div class="grid">
  <div class="card">
    <div class="row space-between">
      <div>
        <div class="title">{{ event.name }}</div>
        <div class="muted">Date : {{ event.date or "—" }}</div>
      </div>
      <span class="badge" id="status-badge">Statut : {{ event.status }}</span>
    </div>

    <div class="row wrap" style="margin-top:10px;gap:8px;">
      <button class="btn primary" id="btn-change-name">Changer nom/prénom</button>
      <div class="muted">Opérateur : <span id="who"></span></div>
    </div>

    <div class="row wrap" style="margin-top:10px;gap:10px;">
      <span class="chip ok"   id="stat-ok">OK : 0</span>
      <span class="chip bad"  id="stat-bad">Non conformes : 0</span>
      <span class="chip wait" id="stat-wait">En attente : 0</span>
    </div>
    <div class="progress" style="margin-top:8px;"><div id="progress-bar" style="width:0%"></div></div>
    <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
  </div>

  <div class="card">
    <div class="title">Aide rapide</div>
    <div class="muted">⚠️ Triangle <b>jaune</b> = péremption bientôt • ⚠️ Triangle <b>rouge</b> = périmé</div>
    <div class="muted">Un parent est “Chargeable” quand <b>tous ses items sont OK</b>.</div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="row space-between">
    <div class="title">Matériel</div>
    <div class="muted">Cliquer sur un parent pour déplier/replier.</div>
  </div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<script>
const TOKEN = "{{ token }}";
let TREE = {{ (tree or [])|tojson }};
let IS_OPEN = ("{{ event.status }}".toUpperCase() === "OPEN");
const EXPIRE_SOON_DAYS = 30;

/* ========= opérateur ========= */
function askOperator(initial){
  let v = prompt("Nom / Prénom du secouriste :", initial || "");
  if(v===null) return null;
  v = (v||"").trim();
  if(!v) return askOperator(initial);
  localStorage.setItem("op_name", v);
  document.getElementById("who").textContent = v;
  return v;
}
(function initWho(){
  const saved = localStorage.getItem("op_name");
  document.getElementById("who").textContent = saved || "—";
  if(!saved) askOperator("");
})();
document.getElementById("btn-change-name").addEventListener("click", ()=> askOperator(localStorage.getItem("op_name")||""));

/* ========= State ========= */
const NODE_MAP = new Map();
const GROUP_EL = new Map();
const ITEM_EL  = new Map();
const ITEM_STATUS_TXT = new Map();
const ITEM_QTY_TXT = new Map();

/* ---------- Utils ---------- */
function indexTree(nodes){
  (nodes||[]).forEach(function rec(n){
    NODE_MAP.set(n.id, n);
    (n.children||[]).forEach(rec);
  });
}
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
const isItem  = n => (n.type||"").toUpperCase()==="ITEM";
const isGroup = n => (n.type||"").toUpperCase()==="GROUP";
function normStatus(s){
  s = (s||"").toUpperCase();
  if(s==="OK") return "OK";
  if(s==="NOT_OK" || s==="NOK" || s==="KO" || s==="NOT-OK" || s==="NOTOK") return "NOT_OK";
  return "PENDING";
}

/* ---------- Expiry helpers ---------- */
function daysUntil(dateStr){
  if(!dateStr) return null;
  const d = new Date(dateStr + "T00:00:00");
  if(isNaN(d.getTime())) return null;
  const now = new Date();
  const ms = d.getTime() - (new Date(now.getFullYear(), now.getMonth(), now.getDate())).getTime();
  return Math.floor(ms / (24*3600*1000)); // arrondi jours
}
function expiryInfo(n){
  const days = daysUntil(n.expiry_date);
  if(days === null) return {flag:null, text:null};
  if(days < 0) return {flag:"expired", text:`périmé (${Math.abs(days)} j)`};
  if(days <= EXPIRE_SOON_DAYS) return {flag:"soon", text:`${days} j`};
  return {flag:null, text:null};
}
function buildExpiryBadge(n){
  const {flag, text} = expiryInfo(n);
  if(!flag) return null;
  const cls = flag === "expired" ? "exp-expired" : "exp-soon";
  const title = flag === "expired" ? "Périmé" : "Bientôt périmé";
  return el("span", {class:"expiry", title:title},
    el("span",{class:`exp-flag ${cls}`}, "⚠️"),
    el("span",{class:"exp-text"}, text)
  );
}

/* ---------- Statuts ---------- */
function groupAllOk(n){
  let ok = true, hasItem=false;
  (function rec(x){
    if(isItem(x)){ hasItem=true; ok = ok && (normStatus(x.last_status)==="OK"); }
    (x.children||[]).forEach(rec);
  })(n);
  return hasItem && ok;
}
function groupHasBad(n){
  let bad = false;
  (function rec(x){
    if(isItem(x) && normStatus(x.last_status)==="NOT_OK") bad = true;
    (x.children||[]).forEach(rec);
  })(n);
  return bad;
}
function groupStatus(n){
  if(groupAllOk(n)) return "OK";
  if(groupHasBad(n)) return "BAD";
  return "WAIT";
}
function flattenItems(nodes){
  const out=[]; (nodes||[]).forEach(function rec(n){
    if(isItem(n)) out.push(n);
    (n.children||[]).forEach(rec);
  });
  return out;
}

/* ---------- Stats ---------- */
function recomputeStats(){
  const items = flattenItems(TREE);
  const total = items.length;
  const ok = items.filter(i=>normStatus(i.last_status)==="OK").length;
  const bad = items.filter(i=>normStatus(i.last_status)==="NOT_OK").length;
  const wait = total - ok - bad;

  document.getElementById("stat-ok").textContent = `OK : ${ok}`;
  document.getElementById("stat-bad").textContent = `Non conformes : ${bad}`;
  document.getElementById("stat-wait").textContent = `En attente : ${wait}`;
  const pct = total? Math.round(ok/total*100) : 0;
  document.getElementById("progress-bar").style.width = pct+"%";
  document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
}

/* ---------- Rendu ---------- */
function itemStateClass(n){
  const s = normStatus(n.last_status);
  if(s==="OK") return "state-ok";
  if(s==="NOT_OK") return "state-bad";
  return "state-wait";
}
function groupStateClass(n){
  const s = groupStatus(n);
  if(s==="OK") return "state-ok";
  if(s==="BAD") return "state-bad";
  return "state-wait";
}
function statusDot(isOk, isBad){
  return el("span", {class:"status-dot "+(isOk?"dot-ok":(isBad?"dot-bad":"dot-wait"))});
}

function renderItem(n){
  const s = normStatus(n.last_status);
  const statusLbl = s==="OK" ? "✅ OK" : (s==="NOT_OK" ? "❌ Non conforme" : "⏳ En attente");
  const by = n.last_by ? ` (${n.last_by})` : "";

  const qtySpan = el("span", {class:"qty", id:`qty-${n.id}`}, `Qté: ${n.quantity ?? 1}`);
  ITEM_QTY_TXT.set(n.id, qtySpan);

  const statusDiv = el("div", {class:"muted", id:`status-${n.id}`}, `Dernier statut: ${statusLbl}${by}`);
  ITEM_STATUS_TXT.set(n.id, statusDiv);

  const exp = buildExpiryBadge(n);

  const right = el("div", {class:"row"},
    el("button", {class:"btn success", disabled:!IS_OPEN, onclick:()=>verify(n.id,"OK")}, "OK"),
    el("button", {class:"btn ghost", disabled:!IS_OPEN, onclick:()=>verify(n.id,"NOT_OK")}, "Non conforme"),
  );

  const wrap = el("div", {class:"item "+itemStateClass(n), id:`item-${n.id}`},
    el("div", null,
      el("div", {class:"name"},
        statusDot(s==="OK", s==="NOT_OK"), " ", n.name, " ", qtySpan, exp?exp:null
      ),
      statusDiv
    ),
    right
  );
  ITEM_EL.set(n.id, wrap);
  return wrap;
}

function renderGroup(n){
  // racines repliées par défaut
  const caret = el("span",{class:"triangle"},"▸");
  const caretBtn = el("span",{class:"caret"}, caret, el("span",null,n.name));

  const veh = el("span", {class:"vehicle "+(n.charged_vehicle?'on':'off')},
    n.charged_vehicle ? `Chargé : ${n.charged_vehicle_name || "—"}` : "Non chargé"
  );

  const headerLeft = el("div", {class:"name"}, statusDot(groupStatus(n)==="OK", groupStatus(n)==="BAD"), " ", caretBtn, n.is_event_root ? veh : null);

  const header = el("div", {class:"header"}, headerLeft);

  const childrenWrap = el("div", {class:"childs"});
  (n.children||[]).forEach(c => childrenWrap.appendChild(renderNode(c)));

  const box = el("div", {class:`node ${groupStateClass(n)} collapsed`, id:`node-${n.id}`}, header, childrenWrap);
  GROUP_EL.set(n.id, box);

  caretBtn.addEventListener("click", ()=>{
    box.classList.toggle("collapsed");
    childrenWrap.style.display = box.classList.contains("collapsed") ? "none" : "block";
  });
  // démarrage replié
  childrenWrap.style.display = "none";

  return box;
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

function buildUIOnce(){
  const root = document.getElementById("tree");
  root.innerHTML = "";
  indexTree(TREE);
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
  recomputeStats();
}

/* ---------- MAJ incrémentales ---------- */
function updateExpiryBadgeInDOM(box, n){
  // supprime l'ancienne badge si présente puis regénère
  const nameDiv = box.querySelector(".name");
  if(!nameDiv) return;
  // retire anciens badges
  nameDiv.querySelectorAll(".expiry").forEach(x=>x.remove());
  const badge = buildExpiryBadge(n);
  if(badge) nameDiv.appendChild(badge);
}

function applyItemDelta(local, incoming){
  // normalise & applique
  local.last_status = normStatus(incoming.last_status || "PENDING");
  local.last_by = incoming.last_by || "";
  if(incoming.quantity != null) local.quantity = incoming.quantity;
  if(incoming.expiry_date !== undefined) local.expiry_date = incoming.expiry_date;

  const box = ITEM_EL.get(local.id);
  const statusDiv = ITEM_STATUS_TXT.get(local.id);
  const qtySpan = ITEM_QTY_TXT.get(local.id);
  if(!box) return;

  // couleur
  box.classList.remove("state-ok","state-bad","state-wait");
  box.classList.add(itemStateClass(local));

  // dot
  const dot = box.querySelector(".status-dot");
  const s = normStatus(local.last_status);
  if(dot){
    dot.classList.remove("dot-ok","dot-bad","dot-wait");
    dot.classList.add(s==="OK" ? "dot-ok" : (s==="NOT_OK" ? "dot-bad" : "dot-wait"));
  }

  // texte & quantité
  const label = s==="OK" ? "✅ OK" : (s==="NOT_OK" ? "❌ Non conforme" : "⏳ En attente");
  if(statusDiv) statusDiv.textContent = `Dernier statut: ${label}${local.last_by ? " ("+local.last_by+")" : ""}`;
  if(qtySpan) qtySpan.textContent = `Qté: ${local.quantity ?? 1}`;

  // expiry badge
  updateExpiryBadgeInDOM(box, local);
}

function applyGroupDelta(local, incoming){
  if(local.is_event_root && (typeof incoming.charged_vehicle !== "undefined")){
    local.charged_vehicle = !!incoming.charged_vehicle;
    local.charged_vehicle_name = incoming.charged_vehicle_name || null;
    const veh = GROUP_EL.get(local.id)?.querySelector(".vehicle");
    if(veh){
      veh.classList.toggle("on", !!local.charged_vehicle);
      veh.classList.toggle("off", !local.charged_vehicle);
      veh.textContent = local.charged_vehicle ? `Chargé : ${local.charged_vehicle_name || "—"}` : "Non chargé";
    }
  }
  const box = GROUP_EL.get(local.id);
  if(!box) return;
  box.classList.remove("state-ok","state-bad","state-wait");
  box.classList.add(groupStateClass(local));
}

function syncTreeIncoming(incomingRoots){
  (incomingRoots||[]).forEach(function recInc(nInc){
    const nLoc = NODE_MAP.get(nInc.id);
    if(!nLoc) return;
    if(isItem(nLoc)){
      applyItemDelta(nLoc, nInc);
    } else {
      if(nLoc.is_event_root){
        nLoc.charged_vehicle = !!nInc.charged_vehicle;
        nLoc.charged_vehicle_name = nInc.charged_vehicle_name || null;
      }
      (nInc.children||[]).forEach(recInc);
      applyGroupDelta(nLoc, nInc);
    }
  });
  recomputeStats();
}

/* ---------- API ---------- */
async function refreshTree(){
  try{
    const r = await fetch(`/public/event/${TOKEN}/tree`);
    if(!r.ok) return;
    const latest = await r.json();
    syncTreeIncoming(latest);
  }catch(_){}
}
function verify(nodeId, status){
  const who = localStorage.getItem("op_name") || "op";
  const payload = { node_id: nodeId, status, verifier_name: who };
  fetch(`/public/event/${TOKEN}/verify`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(res=>res.ok?refreshTree():res.text().then(t=>alert(t)))
  .catch(()=>{});
}

/* ---------- Init (polling) ---------- */
(function init(){
  buildUIOnce();
  setInterval(refreshTree, 2000);
})();
</script>
{% endblock %}
