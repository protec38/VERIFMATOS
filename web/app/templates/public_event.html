{% extends "base.html" %}
{% set title = "Vérification — Lien secouristes" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="row wrap">
        <div class="title">{{ event.name }}</div>
        <span class="badge">Statut : {{ event.status if event.status is string else event.status.name }}</span>
      </div>
      <div class="muted">Date : {{ event.date or "—" }}</div>
      <div class="row" style="margin-top:10px;">
        <input id="who" placeholder="Nom & prénom (obligatoire)" style="max-width:260px;">
      </div>
    </div>
    <div class="card">
      <div class="title">Consignes</div>
      <div class="subtitle">Valide chaque élément. Plusieurs secouristes peuvent travailler en parallèle.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="title">Matériel à vérifier</div>
    <div id="tree" class="tree" style="margin-top:10px;"></div>
  </div>

  <script>
    // Client Socket.IO v4 (déjà chargé dans base.html). Ici on n'utilise que l'API HTTP publique.
    const TOKEN = "{{ token }}";
    let WHO = "";

    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className = v;
        else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
        else e.setAttribute(k,v);
      }
      for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
      return e;
    }

    function renderItemActions(item) {
      const disabled = !WHO;
      return el("div", {class:"item"},
        el("div", null, el("span", {class:"muted"}, "Vérification")),
        el("div", {class:"row"},
          el("button", {class:"btn", disabled, onclick: () => verifyItem(item.id, "OK")}, "OK"),
          el("button", {class:"btn ghost", disabled, onclick: () => verifyItem(item.id, "NOT_OK")}, "Non conforme"),
        )
      );
    }

    function renderTree(root) {
      const isGroup = (root.type === "GROUP");
      return el("div", {class:"node", id:"node-"+root.id},
        el("div", {class:"header"},
          el("div", {class:"name"}, root.name),
          isGroup ? el("span", {class:"muted"}, "Parent") : el("span", {class:"qty"}, `Qté: ${root.quantity ?? 0}`)
        ),
        el("div", {class:"childs"},
          ...(root.children || []).map(renderTree),
          ...(!isGroup ? [renderItemActions(root)] : [])
        )
      );
    }

    async function loadTree(){
      const r = await fetch(`/public/event/${TOKEN}/tree`);
      const TREE = await r.json();
      const host = document.getElementById("tree");
      host.innerHTML = "";
      (TREE || []).forEach(root => host.appendChild(renderTree(root)));
    }

    async function verifyItem(nodeId, status){
      if(!WHO){ alert("Merci de renseigner votre nom & prénom."); return; }
      const r = await fetch(`/public/event/${TOKEN}/verify`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ node_id: nodeId, status, verifier_name: WHO })
      });
      if(!r.ok){ const t = await r.text(); alert(t||"Erreur"); return; }
      const n = document.getElementById("node-"+nodeId);
      if(n){ n.style.outline = "2px solid rgba(0,200,0,.5)"; setTimeout(()=> n.style.outline="", 800); }
    }

    document.getElementById("who").addEventListener("input", (e) => {
      WHO = e.target.value.trim();
      // rafraîchit pour activer/désactiver les boutons
      loadTree();
    });

    loadTree();
  </script>
{% endblock %}
