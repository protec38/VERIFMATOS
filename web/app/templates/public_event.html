{% extends "base.html" %}
{% set title = "Vérification Secouriste" %}
{% block content %}

<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --pad-xs: 6px;
    --pad-sm: 10px;
    --pad-md: 14px;
    --pad-lg: 18px;
    --radius: 14px;
    --shadow: 0 6px 22px rgba(0,0,0,.25);
    --muted: #9fb0c6;
    --bg-card: #0f1726;
    --bg-block:#0f1a2a;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:var(--pad-md)}
  .topbar{
    display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
    padding:var(--pad-md);border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-2);box-shadow:var(--shadow);
    position:sticky;top:8px;z-index:10
  }
  .topbar .title{font-weight:800;font-size:18px}
  .name-edit{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .name-edit input{min-width:240px;background:#0b1120;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text)}
  .name-edit .btn{padding:10px 12px;border-radius:10px}

  .card-like{margin-top:12px;padding:var(--pad-md);border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-2)}
  .parents-card .title{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .parents-bar{display:flex;gap:10px;overflow:auto;padding:4px 2px}
  .parent-pill{
    display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--border);
    background:#0f1a2a;color:var(--text);white-space:nowrap;cursor:pointer;user-select:none;transition:transform .08s,border-color .08s,background .08s
  }
  .parent-pill:hover{transform:translateY(-1px)}
  .pill-ok{border-color:#1d6e5d;background:#0e2a24;color:#bff3e7}
  .pill-bad{border-color:#75212f;background:#2a0e14;color:#ffd5dc}
  .pill-wait{border-color:#24344f;background:#101c2e;color:#b7c7dc}

  .legend{color:var(--muted);font-size:13px}

  .node{border:1px solid var(--border);border-radius:12px;padding:var(--pad-sm);margin:12px 0;background:var(--bg-block)}
  .state-ok{
    border-color:var(--success)!important;background:radial-gradient(600px 200px at top left, rgba(18,184,134,.15), transparent),#0f1e2f;
    box-shadow:0 0 0 1px rgba(18,184,134,.35) inset,0 0 18px rgba(18,184,134,.15)
  }
  .state-bad{
    border-color:var(--danger)!important;background:radial-gradient(600px 200px at top left, rgba(255,107,107,.12), transparent),#0f1a27;
    box-shadow:0 0 0 1px rgba(255,107,107,.30) inset,0 0 18px rgba(255,107,107,.12)
  }
  .state-wait{border-color:var(--border)!important;background:radial-gradient(600px 200px at top left, rgba(45,123,191,.08), transparent),var(--bg-2)}
  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .dot-ok{background:var(--success)} .dot-bad{background:var(--danger)} .dot-wait{background:#37527a}

  .header{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;border-radius:10px}
  .toggle{cursor:pointer}
  .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .name{font-weight:800}
  .meta{font-size:12px;color:var(--muted)}
  .chev{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;opacity:.9}
  .veh{font-size:12px;opacity:.95;padding:2px 6px;border-radius:6px;border:1px dashed var(--border)}
  .veh.on{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .veh.off{background:#101c2e;color:#b7c7dc;border-color:#24344f}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn.xs{padding:8px 12px;border-radius:10px;font-size:14px}
  .btn.primary{background:var(--pc-orange);color:#000}

  .childs{padding:10px 8px 6px 28px}
  .childs.collapsed{display:none}

  .item{
    display:flex;align-items:flex-start;gap:14px;justify-content:space-between;
    padding:14px;border-radius:12px;margin:12px 0;border:1px solid var(--border);background:var(--bg-card)
  }
  .item .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .label{font-weight:800}
  .qty{opacity:.9;font-size:12px;border:1px dashed var(--border);border-radius:8px;padding:2px 8px}
  .warn{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:2px 8px;border-radius:8px;border:1px solid #7a5d1e;background:#221a07;color:#ffd679}

  .chip{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border)}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.wait{background:#101c2e;color:#b7c7dc;border-color:#24344f}

  .substats{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 0 28px}

  .stats-card .progress{height:8px;background:rgba(255,255,255,.08);border-radius:8px;overflow:hidden;margin-top:10px}
  .stats-card .progress > div{height:100%;width:0;background:var(--pc-orange);transition:width .25s ease}
  .stats-card .stats-chipbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}

  @media (max-width: 640px){
    .topbar{gap:12px}
    .item,.header{padding:14px}
    .item .right .btn{width:100%}
    .childs{padding-left:14px}
    .substats{margin-left:14px}
  }
  @media (min-width: 900px){
    .childs{padding-left:34px}
    .item{padding:16px 18px}
  }

  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal-card{width:min(520px,92%);background:#0f1726;border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .modal-card input{width:100%;margin:8px 0 12px 0;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0b1120;color:#fff}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end}
</style>

<div class="wrap">
  <div class="topbar">
    <div class="title">Vérification secouriste</div>
    <div class="name-edit">
      <label for="opname" class="muted">Nom & Prénom :</label>
      <input id="opname" placeholder="Ex : Dupont Marie" />
      <button class="btn" id="save-name">Enregistrer</button>
    </div>
  </div>

  <div class="card-like stats-card">
    <div class="title">Progression</div>
    <div class="stats-chipbar">
      <span class="chip ok"  id="stat-ok">OK : 0</span>
      <span class="chip bad" id="stat-bad">Non conformes : 0</span>
      <span class="chip wait" id="stat-wait">En attente : 0</span>
    </div>
    <div class="progress"><div id="progress-bar"></div></div>
    <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
  </div>

  <div class="card-like parents-card">
    <div class="title">Parents</div>
    <div id="parents-bar" class="parents-bar"></div>
  </div>

  <div class="card-like">
    <div class="row space-between">
      <div class="title">Matériel</div>
      <div class="legend">Vert = tout OK • Rouge = non conforme • Bleu = en attente • ⚠️ proche péremption</div>
    </div>
    <div id="tree"></div>
  </div>
</div>

<script>
const TOKEN = "{{ token }}";
let TREE = [];
const NODE_MAP  = new Map();
const GROUP_EL  = new Map();
const ITEM_EL   = new Map();
const VEH_LABEL = new Map();
const COLLAPSED = new Map();

const NAME_KEY = "pcprep_public_operator";
function getOperator(){ return (localStorage.getItem(NAME_KEY) || "").trim(); }
function setOperator(v){ localStorage.setItem(NAME_KEY, (v||"").trim()); }
const opname = document.getElementById("opname");
document.getElementById("save-name").addEventListener("click", ()=>{ setOperator(opname.value); alert("Nom enregistré."); });
window.addEventListener("DOMContentLoaded", ()=>{
  const cur = getOperator();
  opname.value = cur;
  if(!cur){ openNameModal(true); }
});

function openNameModal(force=false){
  if(document.getElementById("name-modal")) return;
  const modal = document.createElement("div");
  modal.id = "name-modal";
  modal.className = "modal-back";
  modal.innerHTML = `
    <div class="modal-card">
      <div class="title" style="margin-bottom:10px">Votre nom & prénom</div>
      <div class="muted">Merci de renseigner votre identité. Elle sera associée aux vérifications.</div>
      <input id="name-input" placeholder="Ex : Martin Julie" value="${getOperator().replace(/"/g,'&quot;')}" />
      <div class="modal-actions">
        ${force ? '' : '<button class="btn ghost" id="name-cancel">Plus tard</button>'}
        <button class="btn primary" id="name-save">Valider</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  document.getElementById("name-input").focus();
  const save = ()=> {
    const v = (document.getElementById("name-input").value || "").trim();
    if(!v){ alert("Merci d’indiquer votre nom & prénom."); return; }
    setOperator(v); opname.value = v;
    modal.remove();
  };
  document.getElementById("name-save").addEventListener("click", save);
  const cancelBtn = document.getElementById("name-cancel");
  if(cancelBtn) cancelBtn.addEventListener("click", ()=> modal.remove());
}
function ensureOperatorOrAsk(){ if(getOperator()) return true; openNameModal(true); return false; }

/* ====== Helpers DOM / data ====== */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
const isUnique = n => !!(n && n.unique_item);
const isUniqueParent = n => !!(n && n.unique_parent);
const targetNodeId = n => (n && (n.target_node_id || n.id));
const domSafeId = id => String(id).replace(/[^a-zA-Z0-9_-]/g, "-");
function formatChargeInfo(vehicle, operator){
  const veh = (vehicle && vehicle.trim()) ? vehicle.trim() : "—";
  if(operator && operator.trim()){
    return `${veh} (par ${operator.trim()})`;
  }
  return veh;
}
const isItem  = n => {
  if(!n) return false;
  if(isUniqueParent(n)) return false;
  const type = (n.type||"").toUpperCase();
  return type === "ITEM" || (!!n.unique_item && !isUniqueParent(n));
};
const isGroup = n => !isItem(n);
function normStatus(s){
  s = (s||"").toUpperCase();
  if(s==="OK") return "OK";
  if(s==="NOT_OK" || s==="NOK" || s==="KO" || s==="NOT-OK" || s==="NOTOK") return "NOT_OK";
  return "PENDING";
}
function daysUntilISO(iso){
  if(!iso) return null;
  try{ const d=new Date(iso+"T00:00:00"); const now=new Date(); return Math.ceil((d-now)/86400000); }catch(_){ return null; }
}
function nextExpiryDaysFromNode(n){
  // Priorité à n.expiries (liste), fallback sur n.expiry_date (legacy)
  if (Array.isArray(n.expiries) && n.expiries.length){
    // expiries est déjà trié côté API (date asc)
    for (const e of n.expiries){
      const d = daysUntilISO(e.date);
      if (d !== null) return d;
    }
  }
  return daysUntilISO(n.expiry_date);
}
function flattenItems(nodes){ const out=[]; (nodes||[]).forEach(function rec(n){ if(isItem(n)) out.push(n); (n.children||[]).forEach(rec); }); return out; }
function groupAllOk(n){ const items=flattenItems([n]); return items.length>0 && items.every(i=>normStatus(i.last_status)==="OK"); }
function groupHasBad(n){ return flattenItems([n]).some(i=>normStatus(i.last_status)==="NOT_OK"); }
function groupStatus(n){ if(groupAllOk(n)) return "OK"; if(groupHasBad(n)) return "BAD"; return "WAIT"; }
function canChargeGroup(n){ return groupAllOk(n); }

/* ====== Stats ====== */
function recomputeGlobalStats(){
  const items = flattenItems(TREE);
  const total = items.length;
  let ok=0, bad=0, wait=0;
  for(const it of items){
    const s = normStatus(it.last_status);
    if(s==="OK") ok++; else if(s==="NOT_OK") bad++; else wait++;
  }
  document.getElementById("stat-ok").textContent   = `OK : ${ok}`;
  document.getElementById("stat-bad").textContent  = `Non conformes : ${bad}`;
  document.getElementById("stat-wait").textContent = `En attente : ${wait}`;
  const pct = total ? Math.round(ok/total*100) : 0;
  document.getElementById("progress-bar").style.width = pct+"%";
  document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
}

/* ====== Parents bar ====== */
function statusDot(isOk, isBad){ return el("span",{class:"status-dot "+(isOk?"dot-ok":(isBad?"dot-bad":"dot-wait"))}); }
function buildParentsBar(){
  const holder = document.getElementById("parents-bar");
  holder.innerHTML = "";
  (TREE||[]).forEach(p=>{
    if(!isGroup(p)) return;
    const s   = groupStatus(p);
    const cls = s==="OK" ? "pill-ok" : (s==="BAD" ? "pill-bad" : "pill-wait");
    const pill = el("div",{class:"parent-pill "+cls, onclick:()=>scrollAndOpen(p.id)},
      statusDot(s==="OK", s==="BAD"),
      el("span",{class:"strong"}, p.name),
      p.charged_vehicle ? el("span",{class:"veh on"}, formatChargeInfo(p.charged_vehicle_name, p.charged_operator_name)) : null
    );
    holder.appendChild(pill);
  });
}
function scrollAndOpen(id){
  COLLAPSED.set(id,false);
  const cont = document.getElementById("childs-"+id);
  const chev = document.getElementById("chev-"+id);
  if(cont){ cont.classList.remove("collapsed"); }
  if(chev){ chev.textContent = "▾"; }
  const target = document.getElementById("node-"+id);
  if(target){ target.scrollIntoView({behavior:"smooth", block:"start"}); setTimeout(()=>window.scrollBy({top:-70,left:0}), 250); }
}

/* ====== UI classes ====== */
function statusChip(s){
  s = normStatus(s);
  if(s==="OK") return el("span",{class:"chip ok"},"OK");
  if(s==="NOT_OK") return el("span",{class:"chip bad"},"Non conforme");
  return el("span",{class:"chip wait"},"En attente");
}
function groupStateClass(n){
  const s = groupStatus(n);
  if(s==="OK") return "state-ok";
  if(s==="BAD") return "state-bad";
  return "state-wait";
}

/* ====== Rendu ====== */
function renderItem(n){
  const s = normStatus(n.last_status);
  const dl = nextExpiryDaysFromNode(n);
  const qty = (n.quantity != null ? n.quantity : (n.selected_quantity != null ? n.selected_quantity : 1));
  const showWarn = (dl!=null && dl<=30);

  // petit résumé des dates (ex: 12/10, 28/10…)
  let expSummary = null;
  if (Array.isArray(n.expiries) && n.expiries.length){
    const parts = n.expiries.slice(0,3).map(e=>{
      try{ const d=new Date(e.date+"T00:00:00"); return d.toLocaleDateString(); }catch(_){ return e.date; }
    });
    expSummary = el("span",{class:"meta"}, "• Exp: "+parts.join(", ")+(n.expiries.length>3?"…":""));
  }

  const left = el("div",{class:"left"},
    el("span",{class:"status-dot "+(s==="OK"?"dot-ok":(s==="NOT_OK"?"dot-bad":"dot-wait"))}),
    el("span",{class:"label"}, n.name),
    el("span",{class:"qty"}, `Qté: ${qty}`),
    statusChip(s),
    n.last_by ? el("span",{class:"meta"}, `• par ${n.last_by}`) : null,
    expSummary,
    showWarn ? el("span",{class:"warn", title:`Péremption dans ${dl} jour(s)`},"⚠️ Péremption") : null
  );
  const targetId = targetNodeId(n);
  const safeId = domSafeId(n.id);

  const right = el("div",{class:"right"},
    el("button",{class:"btn xs success", onclick:()=>{ if(!ensureOperatorOrAsk()) return; verify(targetId,"OK"); }},"OK"),
    el("button",{class:"btn xs ghost",   onclick:()=>{ if(!ensureOperatorOrAsk()) return; verify(targetId,"NOT_OK"); }},"Non conforme")
  );

  const wrap = el("div",{class:"item "+(s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait")), id:`item-${safeId}`}, left, right);
  ITEM_EL.set(n.id, wrap);
  return wrap;
}

function renderUniqueParentRow(n){
  const s = normStatus(n.last_status);
  const qtyValue = (n.selected_quantity != null)
    ? n.selected_quantity
    : (n.quantity != null ? n.quantity : (n.unique_quantity != null ? n.unique_quantity : 1));
  const targetId = targetNodeId(n);
  const safeId = domSafeId(n.id);

  const left = el("div",{class:"left"},
    el("span",{class:"status-dot "+(s==="OK"?"dot-ok":(s==="NOT_OK"?"dot-bad":"dot-wait"))}),
    el("span",{class:"label"}, "Qté sélectionnée"),
    el("span",{class:"qty"}, `Qté: ${qtyValue}`),
    statusChip(s),
    n.last_by ? el("span",{class:"meta"}, `• par ${n.last_by}`) : null
  );

  const right = el("div",{class:"right"},
    el("button",{class:"btn xs success", onclick:()=>{ if(!ensureOperatorOrAsk()) return; verify(targetId,"OK"); }},"Charger"),
    el("button",{class:"btn xs ghost",   onclick:()=>{ if(!ensureOperatorOrAsk()) return; verify(targetId,"NOT_OK"); }},"Non conforme")
  );

  const wrap = el("div",{class:`item unique-parent ${s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait")}`, id:`item-${safeId}`}, left, right);
  ITEM_EL.set(n.id, wrap);
  return wrap;
}

function renderGroupStats(n){
  const items = flattenItems([n]);
  let ok=0,bad=0,wait=0;
  for(const it of items){
    const s = normStatus(it.last_status);
    if(s==="OK") ok++; else if(s==="NOT_OK") bad++; else wait++;
  }
  const wrap = el("div",{class:"substats", id:`gstat-${n.id}`},
    statusChip(groupStatus(n)),
    el("span",{class:"chip ok"}, `OK: ${ok}`),
    el("span",{class:"chip bad"}, `Non conf.: ${bad}`),
    el("span",{class:"chip wait"}, `Attente: ${wait}`),
    el("span",{class:"meta"}, `• Total: ${items.length}`)
  );
  return wrap;
}

function renderGroup(n){
  const isRoot = !!n.is_event_root;
  if(!COLLAPSED.has(n.id)) COLLAPSED.set(n.id, true);
  const chev = el("span",{class:"chev", id:`chev-${n.id}`}, COLLAPSED.get(n.id) ? "▸" : "▾");
  const dot  = statusDot(groupStatus(n)==="OK", groupStatus(n)==="BAD");

  const veh  = isRoot
    ? el("span",{class:"veh "+(n.charged_vehicle?'on':'off')},
        n.charged_vehicle ? `Chargé : ${formatChargeInfo(n.charged_vehicle_name, n.charged_operator_name)}` : "Non chargé")
    : null;
  if(isRoot) VEH_LABEL.set(n.id, veh);

  const headerLeft = el("div",{class:"left"},
    chev, dot, el("span",{class:"name"}, n.name),
    isRoot ? veh : null,
    el("span",{class:"meta"}, `• ${flattenItems([n]).length} élément(s)`)
  );

  const btnCharge = isRoot ? el("button",{class:"btn xs primary", onclick:(e)=>{e.stopPropagation(); if(!ensureOperatorOrAsk()) return; openChargeModal(n.id);}},"Charger") : null;

  const header = el("div",{class:"header toggle"}, headerLeft, el("div",{class:"actions"}, btnCharge));
  header.addEventListener("click", ()=>toggleCollapse(n.id));

  const gstats = renderGroupStats(n);
  const childNodes = [];
  if(isUnique(n)){
    childNodes.push(renderUniqueParentRow(n));
  }
  childNodes.push(gstats);
  (n.children||[]).forEach(child => childNodes.push(renderNode(child)));
  const childs = el("div",{class:"childs "+(COLLAPSED.get(n.id)?"collapsed":""), id:`childs-${n.id}`},
    ...childNodes
  );

  const box = el("div",{class:`node ${groupStateClass(n)}`, id:`node-${n.id}`}, header, childs);
  GROUP_EL.set(n.id, box);
  if(isRoot) updateChargeButtonState(n.id);
  return box;
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

function indexTree(nodes){
  (nodes||[]).forEach(function rec(n){
    NODE_MAP.set(n.id, n);
    (n.children||[]).forEach(rec);
  });
}
function buildUIOnce(){
  const root = document.getElementById("tree");
  root.innerHTML = "";
  indexTree(TREE);
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
  buildParentsBar();
  recomputeGlobalStats();
}

/* ====== Updates ====== */
function updateGroupStatsEl(n){
  const items = flattenItems([n]);
  let ok=0,bad=0,wait=0;
  for(const it of items){
    const s = normStatus(it.last_status);
    if(s==="OK") ok++; else if(s==="NOT_OK") bad++; else wait++;
  }
  const elWrap = document.getElementById(`gstat-${n.id}`);
  if(!elWrap) return;
  elWrap.innerHTML = "";
  elWrap.append(
    statusChip(groupStatus(n)),
    el("span",{class:"chip ok"}, `OK: ${ok}`),
    el("span",{class:"chip bad"}, `Non conf.: ${bad}`),
    el("span",{class:"chip wait"}, `Attente: ${wait}`),
    el("span",{class:"meta"}, `• Total: ${items.length}`)
  );
}

function applyItemDelta(local, incoming){
  local.last_status = normStatus(incoming.last_status || "PENDING");
  local.quantity    = (incoming.quantity!=null)?incoming.quantity:local.quantity;
  local.last_by     = (incoming.last_by!=null)?incoming.last_by:local.last_by;
  if(typeof incoming.target_node_id !== "undefined") local.target_node_id = incoming.target_node_id;
  if(typeof incoming.unique_from_parent !== "undefined") local.unique_from_parent = incoming.unique_from_parent;

  // ⬇️ support nouveaux champs
  if (Array.isArray(incoming.expiries)) local.expiries = incoming.expiries;
  if (incoming.expiry_date != null) local.expiry_date = incoming.expiry_date;

  const box = ITEM_EL.get(local.id);
  if(!box) return;

  box.classList.remove("state-ok","state-bad","state-wait");
  const s = normStatus(local.last_status);
  box.classList.add(s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait"));

  const dot = box.querySelector(".status-dot");
  if(dot){
    dot.classList.remove("dot-ok","dot-bad","dot-wait");
    dot.classList.add(s==="OK" ? "dot-ok" : (s==="NOT_OK" ? "dot-bad" : "dot-wait"));
  }

  const q = box.querySelector(".qty");
  if(q) q.textContent = `Qté: ${local.quantity != null ? local.quantity : 1}`;

  const chip = box.querySelector(".chip.ok, .chip.bad, .chip.wait");
  if(chip){
    chip.className = "chip " + (s==="OK"?"ok":(s==="NOT_OK"?"bad":"wait"));
    chip.textContent = (s==="OK"?"OK":(s==="NOT_OK"?"Non conforme":"En attente"));
  }

  let metaBy = Array.from(box.querySelectorAll(".meta")).find(m => m.textContent.trim().startsWith("• par"));
  if(!metaBy){
    metaBy = el("span",{class:"meta"});
    const left = box.querySelector(".left");
    if(left) left.appendChild(metaBy);
  }
  metaBy.textContent = local.last_by ? `• par ${local.last_by}` : "";

  // MàJ résumé expirations + triangle
  // 1) supprimer anciens éléments warn et résumé exp
  Array.from(box.querySelectorAll(".warn")).forEach(e=>e.remove());
  const left = box.querySelector(".left");
  // remove ancient "• Exp:" meta if present (very simple heuristic)
  Array.from(box.querySelectorAll(".meta")).forEach(m=>{
    if (m.textContent.startsWith("• Exp:")) m.remove();
  });

  // 2) résumé exp
  if (left){
    if (Array.isArray(local.expiries) && local.expiries.length){
      const parts = local.expiries.slice(0,3).map(e=>{
        try{ const d=new Date(e.date+"T00:00:00"); return d.toLocaleDateString(); }catch(_){ return e.date; }
      });
      left.appendChild(el("span",{class:"meta"},"• Exp: "+parts.join(", ")+(local.expiries.length>3?"…":"")));
    }
    // 3) triangle
    const dl = nextExpiryDaysFromNode(local);
    if (dl!=null && dl<=30){
      left.appendChild(el("span",{class:"warn", title:`Péremption dans ${dl} jour(s)`},"⚠️ Péremption"));
    }
  }
}

function applyGroupDelta(local, incoming){
  if(typeof incoming.charged_vehicle !== "undefined"){
    local.charged_vehicle = !!incoming.charged_vehicle;
    if(typeof incoming.charged_vehicle_name !== "undefined"){
      local.charged_vehicle_name = incoming.charged_vehicle_name || null;
    }
    if(typeof incoming.operator_name !== "undefined"){
      local.charged_operator_name = incoming.operator_name || null;
    } else if(typeof incoming.charged_operator_name !== "undefined"){
      local.charged_operator_name = incoming.charged_operator_name || null;
    }
    if(!local.charged_vehicle){
      local.charged_vehicle_name = null;
      local.charged_operator_name = null;
    }
    const lab = VEH_LABEL.get(local.id);
    if(lab){
      lab.classList.toggle("on", !!local.charged_vehicle);
      lab.classList.toggle("off", !local.charged_vehicle);
      lab.textContent = local.charged_vehicle
        ? `Chargé : ${formatChargeInfo(local.charged_vehicle_name, local.charged_operator_name)}`
        : "Non chargé";
    }
  }

  const box = GROUP_EL.get(local.id);
  if(!box) return;

  box.classList.remove("state-ok","state-bad","state-wait");
  box.classList.add(groupStateClass(local));

  const dot = box.querySelector(".header .status-dot");
  if(dot){
    dot.classList.remove("dot-ok","dot-bad","dot-wait");
    const gs = groupStatus(local);
    dot.classList.add(gs==="OK" ? "dot-ok" : (gs==="BAD" ? "dot-bad" : "dot-wait"));
  }

  updateGroupStatsEl(local);
  updateChargeButtonState(local.id);
}

function syncTreeIncoming(incomingRoots){
  (incomingRoots||[]).forEach(function recInc(nInc){
    const nLoc = NODE_MAP.get(nInc.id);
    if(!nLoc) return;
    if(isUnique(nLoc)){
      applyItemDelta(nLoc, nInc);
      if(typeof nInc.charged_vehicle !== "undefined"){
        nLoc.charged_vehicle = !!nInc.charged_vehicle;
      }
      if(typeof nInc.charged_vehicle_name !== "undefined"){
        nLoc.charged_vehicle_name = nInc.charged_vehicle_name || null;
      }
      if(typeof nInc.operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.operator_name || null;
      } else if(typeof nInc.charged_operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.charged_operator_name || null;
      }
      (nInc.children||[]).forEach(recInc);
      applyGroupDelta(nLoc, nInc);
    } else if(isItem(nLoc)){
      applyItemDelta(nLoc, nInc);
    }else{
      if(typeof nInc.charged_vehicle !== "undefined"){
        nLoc.charged_vehicle = !!nInc.charged_vehicle;
      }
      if(typeof nInc.charged_vehicle_name !== "undefined"){
        nLoc.charged_vehicle_name = nInc.charged_vehicle_name || null;
      }
      if(typeof nInc.operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.operator_name || null;
      } else if(typeof nInc.charged_operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.charged_operator_name || null;
      }
      (nInc.children||[]).forEach(recInc);
      applyGroupDelta(nLoc, nInc);
    }
  });
  buildParentsBar();
  recomputeGlobalStats();
}

/* ===== API ===== */
async function fetchTree(){
  const r = await fetch(`/public/event/{{ token }}/tree`);
  if(!r.ok) throw new Error("fetch tree failed");
  return r.json();
}
async function refreshTree(){
  try{
    const latest = await fetchTree();
    if(TREE.length===0){
      TREE = latest;
      buildUIOnce();
      NODE_MAP.forEach((n,id)=>{
        if(isGroup(n)){
          COLLAPSED.set(id,true);
          document.getElementById("childs-"+id)?.classList.add("collapsed");
          const chev = document.getElementById("chev-"+id);
          if(chev) chev.textContent = "▸";
        }
      });
    }else{
      syncTreeIncoming(latest);
    }
  }catch(_){}
}
function verify(nodeId, status){
  const payload = { node_id: nodeId, status, verifier_name: getOperator() || "" };
  fetch(`/public/event/{{ token }}/verify`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  }).then(async res=>{
    if(!res.ok){ const t=await res.text(); alert(t || "Vérification refusée."); return; }
    refreshTree();
  }).catch(()=>{});
}

/* ===== Charger (racine) ===== */
let CHARGE_TARGET = null;
function openChargeModal(parentId){
  const node = NODE_MAP.get(parentId);
  if(!node) return;
  if(!canChargeGroup(node)){ alert("Impossible : tous les éléments doivent être OK."); return; }
  CHARGE_TARGET = parentId;

  const old = document.getElementById("charge-modal"); if(old) old.remove();
  const modal = el("div",{id:"charge-modal",class:"modal-back"},
    el("div",{class:"modal-card"},
      el("div",{class:"title",style:"margin-bottom:10px"},"Charger le parent"),
      el("label",{class:"muted",for:"veh-name"},"Nom du véhicule (obligatoire)"),
      el("input",{id:"veh-name",placeholder:"Ex : VSAV-2", required:true}),
      el("div",{class:"muted",style:"margin-bottom:10px"},"Opérateur : ", getOperator() || "—"),
      el("div",{class:"modal-actions"},
        el("button",{class:"btn ghost",onclick:closeChargeModal},"Annuler"),
        el("button",{class:"btn primary",onclick:confirmCharge},"Confirmer")
      )
    )
  );
  document.body.appendChild(modal);
  setTimeout(()=>document.getElementById("veh-name")?.focus(), 10);
}
function closeChargeModal(){ document.getElementById("charge-modal")?.remove(); CHARGE_TARGET = null; }
function confirmCharge(){
  const veh = (document.getElementById("veh-name")?.value || "").trim();
  if(!veh){ alert("Merci d’indiquer le nom du véhicule."); return; }

  const payload = { node_id: CHARGE_TARGET, charged_vehicle: true, operator_name: getOperator() || "", vehicle_name: veh };
  fetch(`/public/event/{{ token }}/charge`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  }).then(async res=>{
    if(!res.ok){ const t=await res.text(); alert(t || "Échec du chargement."); return; }
    // MAJ optimiste du libellé immédiatement
    const n = NODE_MAP.get(CHARGE_TARGET);
    if(n){
      n.charged_vehicle = true;
      n.charged_vehicle_name = veh;
      n.charged_operator_name = getOperator() || null;
      const lab = VEH_LABEL.get(n.id);
      if(lab){
        lab.classList.remove("off"); lab.classList.add("on");
        lab.textContent = `Chargé : ${formatChargeInfo(veh, n.charged_operator_name)}`;
      }
    }
    closeChargeModal();
    refreshTree();
  }).catch(()=>{});
}
function updateChargeButtonState(parentId){
  const n = NODE_MAP.get(parentId);
  const box = GROUP_EL.get(parentId);
  if(!n || !box) return;
  const btn = box.querySelector(".actions .btn.primary");
  if(!btn) return;
  const enable = canChargeGroup(n);
  btn.disabled = !enable;
  btn.title = enable ? "" : "Tous les éléments doivent être OK";
}

/* ====== Pliage ====== */
function toggleCollapse(id){
  const now = !COLLAPSED.get(id);
  COLLAPSED.set(id, now);
  const cont = document.getElementById("childs-"+id);
  const chev = document.getElementById("chev-"+id);
  if(cont) cont.classList.toggle("collapsed", now);
  if(chev) chev.textContent = now ? "▸" : "▾";
}

/* Boot */
(function init(){
  refreshTree();
  setInterval(()=>{
    refreshTree();
    if(!getOperator() && !document.getElementById("name-modal")) openNameModal(true);
  }, 2000);
})();
</script>

{% endblock %}
