{% extends "base.html" %}
{% set title = "Vérification Secouriste" %}
{% block content %}

<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    color-scheme:dark;
    --se-space-1:0.35rem;
    --se-space-2:0.65rem;
    --se-space-3:clamp(0.95rem,2.8vw,1.35rem);
    --se-space-4:clamp(1.25rem,4vw,1.95rem);
    --se-space-5:clamp(1.55rem,6vw,2.45rem);
    --se-space-6:clamp(2.1rem,7vw,3rem);
    --se-radius:22px;
    --se-surface:rgba(14,25,46,.78);
    --se-surface-strong:rgba(18,34,68,.86);
    --se-border:rgba(255,255,255,.08);
    --se-border-strong:rgba(255,255,255,.12);
    --se-shadow:0 28px 60px rgba(6,13,26,.45);
    --se-glow-1:rgba(60,120,255,.45);
    --se-glow-2:rgba(255,120,90,.35);
    --se-glow-3:rgba(73,211,169,.28);
    --se-blur:18px;
    --se-max-width:min(960px,100%);
    font-family:"Inter","Segoe UI",system-ui,sans-serif;
  }

  body{
    background:radial-gradient(circle at 15% 15%,rgba(34,60,130,.45),transparent 45%),#050b18;
    color:var(--text);
    min-height:100dvh;
    display:flex;
    flex-direction:column;
  }
  body>.appbar,
  body>.footer{display:none;}
  body>main{padding:0;flex:1;display:flex;}

  body>main>.public-shell{flex:1;display:flex;}

  .public-shell{
    min-height:100dvh;
    position:relative;
    isolation:isolate;
    overflow:hidden;
  }

  .public-shell::after{
    content:"";
    position:fixed;
    inset:auto 0 0 0;
    height:env(safe-area-inset-bottom,0px);
    background:linear-gradient(180deg,transparent,rgba(5,11,24,.35));
    pointer-events:none;
  }

  .background-fx{
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:-1;
  }
  .background-fx::before,
  .background-fx::after{
    content:"";
    position:absolute;
    filter:blur(110px);
    opacity:.8;
  }
  .background-fx::before{
    width:420px;
    height:420px;
    left:-120px;
    top:-160px;
    background:var(--se-glow-1);
  }
  .background-fx::after{
    width:360px;
    height:360px;
    right:-120px;
    bottom:-160px;
    background:var(--se-glow-2);
  }
  .background-fx .glow{
    position:absolute;
    border-radius:50%;
    filter:blur(120px);
  }
  .background-fx .glow.one{width:280px;height:280px;left:15%;bottom:10%;background:var(--se-glow-3);opacity:.6;}
  .background-fx .glow.two{width:220px;height:220px;right:8%;top:35%;background:var(--se-glow-1);opacity:.45;}

  .wrap{
    width:var(--se-max-width);
    margin:0 auto;
    padding:clamp(1rem,5vw,2.2rem) clamp(.85rem,5vw,2.6rem) calc(clamp(2.6rem,8vw,3.8rem) + env(safe-area-inset-bottom,0px));
    display:flex;
    flex-direction:column;
    gap:var(--se-space-6);
    flex:1;
  }

  .topbar{
    position:sticky;
    top:calc(clamp(10px,2.5vw,24px) + env(safe-area-inset-top,0px));
    z-index:40;
    display:grid;
    gap:var(--se-space-4);
    padding:var(--se-space-4);
    border-radius:28px;
    border:1px solid var(--se-border);
    background:linear-gradient(165deg,rgba(24,43,83,.92),rgba(8,17,36,.88));
    box-shadow:var(--se-shadow);
    backdrop-filter:blur(var(--se-blur)) saturate(150%);
    min-height:0;
  }
  .topbar-heading{
    display:flex;
    flex-direction:column;
    gap:.5rem;
  }
  .topbar .title{
    font-size:clamp(1.35rem,5vw,1.8rem);
    font-weight:800;
    letter-spacing:.4px;
  }
  .topbar .subtitle{
    font-size:clamp(.9rem,4vw,1.05rem);
    color:rgba(219,229,255,.75);
    line-height:1.45;
  }

  .name-edit{
    display:grid;
    gap:var(--se-space-2);
    align-content:start;
    padding:var(--se-space-3);
    border-radius:20px;
    background:linear-gradient(160deg,rgba(9,19,38,.85),rgba(9,26,54,.9));
    border:1px solid var(--se-border-strong);
    box-shadow:0 16px 36px rgba(6,13,28,.45);
  }
  .name-edit label{
    font-size:.92rem;
    color:rgba(219,230,255,.78);
    letter-spacing:.35px;
  }
  .name-edit input{
    width:100%;
    min-width:0;
    border-radius:16px;
    padding:.75rem 1rem;
    font-size:1.05rem;
    background:rgba(4,12,27,.85);
    border:1px solid rgba(255,255,255,.18);
    color:var(--text);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
  }
  .name-edit .btn{
    width:100%;
    justify-content:center;
    padding:.75rem 1.1rem;
    font-size:1.05rem;
    border-radius:16px;
  }

  .card-like{
    display:flex;
    flex-direction:column;
    gap:var(--se-space-2);
    padding:var(--se-space-4);
    border-radius:26px;
    background:linear-gradient(170deg,var(--se-surface-strong),rgba(10,20,38,.82));
    border:1px solid var(--se-border);
    box-shadow:0 18px 48px rgba(7,14,28,.45);
    scroll-margin-top:var(--se-space-6);
  }
  .materials-card{
    position:relative;
    overflow:hidden;
  }
  .materials-card .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:var(--se-space-2);
    flex-wrap:wrap;
  }
  .materials-card::after{
    content:"";
    position:absolute;
    inset:auto -40% -55% -40%;
    height:160px;
    background:linear-gradient(135deg,rgba(255,152,102,.22),rgba(86,155,255,.18));
    filter:blur(55px);
    opacity:.75;
    pointer-events:none;
  }
  #tree{display:flex;flex-direction:column;gap:var(--se-space-3);}
  .card-like .title{
    font-size:clamp(1.15rem,3.8vw,1.45rem);
    font-weight:700;
    margin:0;
  }
  .legend{
    color:rgba(208,220,245,.75);
    font-size:.95rem;
    line-height:1.55;
    display:flex;
    flex-wrap:wrap;
    gap:.35rem .65rem;
  }

  .stats-card{
    position:relative;
    overflow:hidden;
  }
  .stats-card::after{
    content:"";
    position:absolute;
    inset:auto -30% -45% -30%;
    height:140px;
    background:linear-gradient(135deg,rgba(73,138,255,.28),rgba(45,212,191,.18));
    filter:blur(45px);
    opacity:.9;
    pointer-events:none;
  }
  .stats-chipbar{
    display:flex;
    flex-wrap:wrap;
    gap:var(--se-space-2);
  }
  .stats-chipbar .chip{
    flex:1 1 140px;
    justify-content:center;
    text-align:center;
  }
  .stats-card .muted{
    font-size:.98rem;
  }
  .progress{
    position:relative;
    height:clamp(10px,2.4vw,14px);
    border-radius:999px;
    overflow:hidden;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.16);
  }
  .progress>div{
    height:100%;
    width:0;
    background:linear-gradient(90deg,var(--pc-orange-strong),var(--pc-orange));
    transition:width .25s ease;
    box-shadow:0 8px 16px rgba(255,166,77,.35);
  }

  .parents-card{position:relative;}
  .parents-card::after{
    content:"";
    position:absolute;
    inset:auto 0 0 0;
    height:1px;
    background:linear-gradient(90deg,rgba(255,255,255,.12),transparent 35%,transparent 65%,rgba(255,255,255,.12));
    opacity:.35;
  }
  .parents-card .title{
    display:flex;
    align-items:center;
    gap:.75rem;
  }
  .parents-bar{
    display:flex;
    gap:var(--se-space-2);
    overflow-x:auto;
    padding-bottom:var(--se-space-1);
    scroll-snap-type:x proximity;
    -webkit-mask-image:linear-gradient(90deg,transparent 0,rgba(0,0,0,.85) 18px,rgba(0,0,0,.85) calc(100% - 18px),transparent 100%);
    mask-image:linear-gradient(90deg,transparent 0,rgba(0,0,0,.85) 18px,rgba(0,0,0,.85) calc(100% - 18px),transparent 100%);
  }
  .parents-bar::-webkit-scrollbar{height:6px}
  .parent-pill{
    scroll-snap-align:center;
    display:inline-flex;
    align-items:center;
    gap:.55rem;
    padding:.6rem .95rem;
    border-radius:999px;
    border:1px solid var(--se-border);
    background:rgba(9,20,39,.82);
    color:var(--text);
    white-space:nowrap;
    cursor:pointer;
    user-select:none;
    transition:transform .22s ease,background .22s ease,border-color .22s ease,box-shadow .22s ease;
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
    box-shadow:0 10px 20px rgba(6,13,26,.25);
    touch-action:manipulation;
  }
  .parent-pill:hover{transform:translateY(-1px);}
  .parent-pill:focus-visible,
  .btn:focus-visible,
  input:focus-visible,
  textarea:focus-visible{
    outline:2px solid rgba(102,164,255,.85);
    outline-offset:2px;
  }
  .pill-ok{border-color:rgba(43,212,161,.5);background:rgba(16,46,42,.82);color:#c8fff0;}
  .pill-bad{border-color:rgba(255,118,138,.55);background:rgba(73,22,36,.82);color:#ffe4ec;}
  .pill-wait{border-color:rgba(84,125,210,.55);background:rgba(18,33,65,.82);color:#d4e2ff;}
  .parent-pill .reassort-chip{
    margin-left:6px;
    font-size:.78rem;
    padding:.25rem .55rem;
    border-radius:999px;
    background:rgba(66,47,15,.9);
    color:#ffd98b;
    border:1px solid rgba(255,211,105,.45);
  }

  .status-dot{width:11px;height:11px;border-radius:50%;display:inline-block;flex-shrink:0;background:rgba(255,255,255,.18);box-shadow:0 0 0 2px rgba(255,255,255,.06) inset;}
  .dot-ok{background:var(--success)}
  .dot-bad{background:var(--danger)}
  .dot-wait{background:#5471b5}

  .node{
    border:1px solid rgba(255,255,255,.06);
    border-radius:22px;
    background:linear-gradient(160deg,rgba(12,26,52,.9),rgba(8,18,34,.82));
    padding:clamp(.85rem,2.4vw,1.2rem);
    display:flex;
    flex-direction:column;
    gap:var(--se-space-3);
    box-shadow:0 14px 30px rgba(6,12,24,.35);
  }
  .state-ok{border-color:rgba(43,212,161,.45)!important;background:linear-gradient(155deg,rgba(16,46,42,.88),rgba(8,18,34,.82));box-shadow:0 0 0 1px rgba(43,212,161,.22) inset,0 22px 46px rgba(16,46,42,.35);}
  .state-bad{border-color:rgba(255,118,138,.45)!important;background:linear-gradient(155deg,rgba(73,22,36,.88),rgba(8,18,34,.82));box-shadow:0 0 0 1px rgba(255,118,138,.22) inset,0 22px 46px rgba(73,22,36,.28);}
  .state-wait{border-color:rgba(84,125,210,.42)!important;background:linear-gradient(155deg,rgba(18,33,65,.88),rgba(8,18,34,.82));box-shadow:0 0 0 1px rgba(84,125,210,.18) inset,0 22px 46px rgba(18,33,65,.28);}

  .header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:var(--se-space-2);
    flex-wrap:wrap;
    width:100%;
  }
  .toggle{cursor:pointer;}
  .left{display:flex;align-items:center;flex-wrap:wrap;gap:.45rem .75rem;min-width:0;}
  .name{font-weight:700;font-size:1.05rem;letter-spacing:.25px;word-break:break-word;}
  .meta{font-size:.88rem;color:rgba(205,214,235,.7);word-break:break-word;}
  .chev{width:1.35rem;height:1.35rem;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:rgba(255,255,255,.08);font-size:.95rem;}
  .veh{font-size:.8rem;padding:.25rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.16);}
  .veh.on{background:rgba(23,63,57,.82);border-color:rgba(43,212,161,.5);color:#c8fff0;}
  .veh.off{background:rgba(17,34,61,.82);border-color:rgba(84,125,210,.45);color:#d4e2ff;}
  .reassort-note{font-size:.82rem;padding:.3rem .65rem;border-radius:999px;border:1px solid rgba(255,211,105,.45);background:rgba(66,47,15,.85);color:#ffd98b;display:inline-flex;align-items:center;gap:.4rem;}
  .reassort-note.empty{display:none;}

  .actions{display:flex;gap:.55rem;flex-wrap:wrap;justify-content:flex-end;width:100%;}
  .actions .btn{flex:1 1 130px;min-width:0;justify-content:center;}
  .btn.xs{padding:.55rem .85rem;border-radius:14px;font-size:.92rem;}
  .btn{touch-action:manipulation;}

  @media (hover:none){
    .parent-pill:hover{transform:none;}
    .btn:hover{transform:none;}
  }

  .childs{display:flex;flex-direction:column;gap:var(--se-space-3);padding:0 0 0 clamp(.75rem,2.6vw,1.45rem);border-left:2px solid rgba(255,255,255,.08);}
  .childs.collapsed{display:none;}

  .item{
    display:flex;
    flex-direction:column;
    gap:var(--se-space-2);
    padding:clamp(.95rem,3vw,1.35rem);
    border-radius:18px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(10,22,43,.9);
    box-shadow:0 10px 26px rgba(6,13,26,.35);
    min-width:0;
  }
  .item .left{display:flex;gap:.45rem .75rem;align-items:center;flex-wrap:wrap;}
  .item .right{display:flex;gap:.65rem;flex-wrap:wrap;}
  .item .right .btn{flex:1 1 160px;justify-content:center;font-size:1.05rem;padding:.7rem 1rem;border-radius:14px;}
  .label{font-weight:700;font-size:1.08rem;word-break:break-word;}
  .qty{font-size:.87rem;border:1px dashed rgba(255,255,255,.22);border-radius:999px;padding:.25rem .7rem;letter-spacing:.25px;}
  .warn{display:inline-flex;align-items:center;gap:.35rem;font-size:.82rem;padding:.25rem .6rem;border-radius:10px;border:1px solid rgba(255,211,105,.4);background:rgba(66,47,15,.88);color:#ffd98b;word-break:break-word;}

  .chip{padding:.3rem .65rem;border-radius:999px;font-weight:700;font-size:.82rem;border:1px solid rgba(255,255,255,.16);background:rgba(16,32,62,.72);line-height:1.35;letter-spacing:.2px;text-transform:none;}
  .chip.ok{background:rgba(16,46,42,.82);border-color:rgba(43,212,161,.45);color:#c8fff0;}
  .chip.bad{background:rgba(73,22,36,.82);border-color:rgba(255,118,138,.45);color:#ffe4ec;}
  .chip.wait{background:rgba(18,33,65,.82);border-color:rgba(84,125,210,.45);color:#d4e2ff;}

  .substats{display:flex;gap:.55rem;flex-wrap:wrap;padding-left:.2rem;}

  .modal-back{position:fixed;inset:0;background:rgba(5,12,24,.7);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:90;padding:clamp(.9rem,4vw,1.8rem);}
  .modal-card,.modal{
    width:min(520px,100%);
    background:linear-gradient(165deg,rgba(12,26,52,.95),rgba(6,14,28,.92));
    border:1px solid rgba(255,255,255,.12);
    border-radius:24px;
    padding:clamp(1.1rem,3vw,1.7rem);
    box-shadow:0 30px 80px rgba(5,12,24,.6);
    max-height:calc(100vh - clamp(2.4rem,10vh,4.5rem));
    overflow-y:auto;
  }
  .modal input,.modal textarea,.modal-card input,.modal-card textarea{
    width:100%;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(6,14,28,.9);
    color:var(--text);
    padding:.75rem .9rem;
    font-size:1.05rem;
  }
  .modal-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;}
  .modal .field{display:flex;flex-direction:column;gap:.6rem;}
  .modal .exp-list,.modal .reassort-list{display:flex;flex-direction:column;gap:.65rem;margin:12px 0;}
  .modal .exp-option,.modal .reassort-option{display:flex;gap:.65rem;align-items:flex-start;padding:.65rem;border:1px solid rgba(255,255,255,.1);border-radius:14px;background:rgba(15,30,60,.75);}
  .modal .exp-option input,.modal .reassort-option input{margin-top:.25rem;}
  .modal .exp-text,.modal .reassort-text{font-size:.92rem;line-height:1.4;}
  .modal .section-title{font-weight:700;margin-top:10px;}
  .modal .modal-action-row{display:flex;gap:.6rem;margin-top:12px;flex-wrap:wrap;}
  .modal .reassort-section{flex-direction:column;gap:.75rem;margin-top:14px;background:rgba(12,26,52,.55);border:1px dashed rgba(255,255,255,.14);padding:.85rem;border-radius:16px;}
  .modal .reassort-text .strong{font-weight:800;}
  .modal .reassort-text .tag{display:inline-flex;margin-top:4px;padding:2px 6px;border-radius:999px;background:rgba(16,46,42,.82);border:1px solid rgba(43,212,161,.45);font-size:.75rem;color:#c8fff0;}
  .modal .reassort-controls{display:flex;align-items:center;gap:.5rem;font-size:.9rem;flex-wrap:wrap;}
  .modal .reassort-confirm{margin-top:12px;display:flex;justify-content:flex-end;}

  .strong{font-weight:700;}

  @media (min-width:780px){
    .topbar{grid-template-columns:1fr minmax(320px,2fr);align-items:stretch;}
    .name-edit{grid-template-columns:auto minmax(220px,1fr) auto;align-items:center;padding:var(--se-space-3);}
    .name-edit .btn{width:auto;}
    .actions{width:auto;}
    .actions .btn{flex:none;}
    .item{flex-direction:row;align-items:flex-start;justify-content:space-between;}
    .item .right{justify-content:flex-end;}
    .childs{padding-left:clamp(1.1rem,3vw,1.9rem);}
  }

  @media (max-width:860px){
    .wrap{gap:var(--se-space-5);}
    .topbar{padding:var(--se-space-3);}
    .name-edit{padding:var(--se-space-2);}
    .card-like{padding:clamp(1rem,4.5vw,1.6rem);}
    .node{padding:clamp(.8rem,3.6vw,1.15rem);}
  }

  @media (max-width:720px){
    .topbar{position:static;padding:var(--se-space-4);border-radius:26px;gap:var(--se-space-3);}
    .wrap{padding-inline:clamp(.8rem,6vw,1.6rem);gap:var(--se-space-5);}
    .card-like{padding:var(--se-space-4);border-radius:24px;gap:var(--se-space-3);}
    .parents-bar{margin-right:-.6rem;padding-right:.6rem;}
    .name-edit{padding:var(--se-space-3);}
    .item .right .btn{flex:1 1 130px;}
    .actions{justify-content:flex-start;}
    .materials-card .row{flex-direction:column;align-items:flex-start;gap:.65rem;}
    .legend{font-size:.9rem;}
  }

  @media (max-width:520px){
    .stats-chipbar{flex-direction:column;}
    .stats-chipbar .chip{width:100%;text-align:center;padding:.6rem .85rem;}
    .parents-bar{gap:var(--se-space-1);}
    .parent-pill{padding:.55rem .75rem;font-size:.95rem;}
    .item{padding:clamp(.95rem,5vw,1.35rem);}
    .item .left{gap:.4rem .6rem;}
    .item .right{flex-direction:column;}
    .item .right .btn{flex:1 1 auto;width:100%;}
    .topbar .title{font-size:1.55rem;}
    .wrap{padding-top:clamp(.8rem,4vw,1.6rem);}
    .name-edit input{font-size:1rem;padding:.7rem .9rem;}
    .name-edit .btn{font-size:1rem;padding:.7rem .9rem;}
    .childs{padding-left:clamp(.65rem,5vw,1.1rem);}
    .node{gap:var(--se-space-2);}
    .actions{gap:.45rem;}
    .materials-card::after{height:120px;}
    .modal-back{align-items:flex-end;}
  }

  @media (max-width:420px){
    .topbar{padding:clamp(.9rem,6vw,1.4rem);gap:var(--se-space-3);}
    .topbar .subtitle{font-size:.88rem;}
    .card-like{padding:clamp(.95rem,5.5vw,1.4rem);border-radius:20px;}
    .stats-chipbar .chip{font-size:.88rem;}
    .legend{font-size:.85rem;}
    .parent-pill{font-size:.9rem;padding:.5rem .7rem;}
    .item .right .btn{font-size:1rem;padding:.65rem .85rem;}
    .label{font-size:1rem;}
    .meta{font-size:.82rem;}
    .qty{font-size:.8rem;}
    .modal-card,.modal{border-radius:18px;padding:clamp(1rem,5.5vw,1.4rem);}
  }

  @media (prefers-reduced-motion:reduce){
    *{transition-duration:0.01ms!important;animation-duration:0.01ms!important;scroll-behavior:auto!important;}
  }
</style>

<div class="public-shell">
  <div class="background-fx" aria-hidden="true">
    <span class="glow one"></span>
    <span class="glow two"></span>
  </div>

  <div class="wrap">
    <header class="topbar" role="banner">
      <div class="topbar-heading">
        <div class="title">Vérification secouriste</div>
        <div class="subtitle">Interface optimisée mobile pour cocher et signaler le matériel en mission.</div>
      </div>
      <div class="name-edit" role="group" aria-labelledby="label-opname">
        <label id="label-opname" for="opname" class="muted">Nom &amp; prénom du binôme</label>
        <input id="opname" placeholder="Ex : Dupont Marie" autocomplete="name" inputmode="text" aria-describedby="label-opname" />
        <button class="btn" id="save-name" type="button" aria-label="Enregistrer le nom saisi">Enregistrer</button>
      </div>
    </header>

    <section class="card-like stats-card" role="region" aria-labelledby="stats-title">
      <div class="title" id="stats-title">Progression</div>
      <div class="stats-chipbar" role="list">
        <span class="chip ok"  id="stat-ok" role="listitem">OK : 0</span>
        <span class="chip bad" id="stat-bad" role="listitem">Non conformes : 0</span>
        <span class="chip wait" id="stat-wait" role="listitem">En attente : 0</span>
      </div>
      <div class="progress" role="presentation"><div id="progress-bar" aria-hidden="true"></div></div>
      <div class="muted" id="progress-text" style="margin-top:6px;" aria-live="polite">0 / 0 vérifiés</div>
    </section>

    <section class="card-like parents-card" role="region" aria-labelledby="parents-title">
      <div class="title" id="parents-title">Sections</div>
      <div id="parents-bar" class="parents-bar" role="list"></div>
    </section>

    <section class="card-like materials-card" role="region" aria-labelledby="materials-title">
      <div class="row space-between">
        <div class="title" id="materials-title">Matériel</div>
        <div class="legend">Vert = tout OK • Rouge = non conforme • Bleu = en attente • ⚠️ proche péremption</div>
      </div>
      <div id="tree"></div>
    </section>
  </div>
</div>

<script>
const TOKEN = "{{ token }}";
let TREE = [];
const NODE_MAP  = new Map();
const GROUP_EL  = new Map();
const ITEM_EL   = new Map();
const VEH_LABEL = new Map();
const COLLAPSED = new Map();
const REASSORT_CACHE = new Map();
const CHARGE_BUTTON = new Map();
const REASSORT_LABEL = new Map();
const REASSORT_BUTTON = new Map();
let REASSORT_TARGET = null;
let REFRESH_BUSY = false;
let REFRESH_QUEUED = false;
const REFRESH_INTERVAL_MS = 5000;

const NAME_KEY = "pcprep_public_operator";
function getOperator(){ return (localStorage.getItem(NAME_KEY) || "").trim(); }
function setOperator(v){ localStorage.setItem(NAME_KEY, (v||"").trim()); }
const opname = document.getElementById("opname");
document.getElementById("save-name").addEventListener("click", ()=>{ setOperator(opname.value); alert("Nom enregistré."); });
window.addEventListener("DOMContentLoaded", ()=>{
  const cur = getOperator();
  opname.value = cur;
  if(!cur){ openNameModal(true); }
});

function openNameModal(force=false){
  if(document.getElementById("name-modal")) return;
  const modal = document.createElement("div");
  modal.id = "name-modal";
  modal.className = "modal-back";
  modal.innerHTML = `
    <div class="modal-card">
      <div class="title" style="margin-bottom:10px">Votre nom & prénom</div>
      <div class="muted">Merci de renseigner votre identité. Elle sera associée aux vérifications.</div>
      <input id="name-input" placeholder="Ex : Martin Julie" value="${getOperator().replace(/"/g,'&quot;')}" />
      <div class="modal-actions">
        ${force ? '' : '<button class="btn ghost" id="name-cancel">Plus tard</button>'}
        <button class="btn primary" id="name-save">Valider</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  document.getElementById("name-input").focus();
  const save = ()=> {
    const v = (document.getElementById("name-input").value || "").trim();
    if(!v){ alert("Merci d’indiquer votre nom & prénom."); return; }
    setOperator(v); opname.value = v;
    modal.remove();
  };
  document.getElementById("name-save").addEventListener("click", save);
  const cancelBtn = document.getElementById("name-cancel");
  if(cancelBtn) cancelBtn.addEventListener("click", ()=> modal.remove());
}
function ensureOperatorOrAsk(){ if(getOperator()) return true; openNameModal(true); return false; }

/* ====== Helpers DOM / data ====== */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
function closeModal(){ const m = document.getElementById("modal-root"); if(m) m.remove(); }
function openModal(content){
  closeModal();
  const wrap = document.createElement('div');
  wrap.id = 'modal-root';
  wrap.className = 'modal-back';
  const card = document.createElement('div');
  card.className = 'modal';
  card.appendChild(content);
  wrap.appendChild(card);
  document.body.appendChild(wrap);
}
const isUnique = n => !!(n && n.unique_item);
const isUniqueParent = n => !!(n && n.unique_parent);
const targetNodeId = n => (n && (n.target_node_id || n.id));
const domSafeId = id => String(id).replace(/[^a-zA-Z0-9_-]/g, "-");
function formatChargeInfo(vehicle, operator){
  const veh = (vehicle && vehicle.trim()) ? vehicle.trim() : "—";
  if(operator && operator.trim()){
    return `${veh} (par ${operator.trim()})`;
  }
  return veh;
}
const isItem  = n => {
  if(!n) return false;
  if(isUniqueParent(n)) return false;
  const type = (n.type||"").toUpperCase();
  return type === "ITEM" || (!!n.unique_item && !isUniqueParent(n));
};
const isGroup = n => !isItem(n);
function normStatus(s){
  s = (s||"").toUpperCase();
  if(s==="OK") return "OK";
  if(s==="NOT_OK" || s==="NOK" || s==="KO" || s==="NOT-OK" || s==="NOTOK") return "NOT_OK";
  return "PENDING";
}
function daysUntilISO(iso){
  if(!iso) return null;
  try{ const d=new Date(iso+"T00:00:00"); const now=new Date(); return Math.ceil((d-now)/86400000); }catch(_){ return null; }
}
function formatISODate(iso){
  if(!iso) return "—";
  try{ return new Date(iso+"T00:00:00").toLocaleDateString(); }
  catch(_){ return iso; }
}
function nextExpiryDaysFromNode(n){
  // Priorité à n.expiries (liste), fallback sur n.expiry_date (legacy)
  if (Array.isArray(n.expiries) && n.expiries.length){
    // expiries est déjà trié côté API (date asc)
    for (const e of n.expiries){
      const d = daysUntilISO(e.date);
      if (d !== null) return d;
    }
  }
  return daysUntilISO(n.expiry_date);
}
function flattenItems(nodes){ const out=[]; (nodes||[]).forEach(function rec(n){ if(isItem(n) || isUniqueParent(n)) out.push(n); (n.children||[]).forEach(rec); }); return out; }
function groupAllOk(n){ const items=flattenItems([n]); return items.length>0 && items.every(i=>normStatus(i.last_status)==="OK"); }
function groupHasBad(n){ return flattenItems([n]).some(i=>normStatus(i.last_status)==="NOT_OK"); }
function groupStatus(n){ if(groupAllOk(n)) return "OK"; if(groupHasBad(n)) return "BAD"; return "WAIT"; }
function canChargeGroup(n){ return groupAllOk(n); }

function collectNodeIds(nodes, out){
  (nodes||[]).forEach(n=>{
    if(!n || typeof n.id === "undefined") return;
    out.add(n.id);
    if(Array.isArray(n.children) && n.children.length){
      collectNodeIds(n.children, out);
    }
  });
}

/* ====== Stats ====== */
function recomputeGlobalStats(){
  const items = flattenItems(TREE);
  const total = items.length;
  let ok=0, bad=0, wait=0;
  for(const it of items){
    const s = normStatus(it.last_status);
    if(s==="OK") ok++; else if(s==="NOT_OK") bad++; else wait++;
  }
  document.getElementById("stat-ok").textContent   = `OK : ${ok}`;
  document.getElementById("stat-bad").textContent  = `Non conformes : ${bad}`;
  document.getElementById("stat-wait").textContent = `En attente : ${wait}`;
  const pct = total ? Math.round(ok/total*100) : 0;
  document.getElementById("progress-bar").style.width = pct+"%";
  document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
}

/* ====== Parents bar ====== */
function statusDot(isOk, isBad){ return el("span",{class:"status-dot "+(isOk?"dot-ok":(isBad?"dot-bad":"dot-wait"))}); }
function buildParentsBar(){
  const holder = document.getElementById("parents-bar");
  holder.innerHTML = "";
  (TREE||[]).forEach(p=>{
    if(!isGroup(p)) return;
    const s   = groupStatus(p);
    const cls = s==="OK" ? "pill-ok" : (s==="BAD" ? "pill-bad" : "pill-wait");
    const reassortChip = p.reassort_note ? el("span",{class:"reassort-chip"}, `Réassort : ${p.reassort_note}`) : null;
    const pill = el("button",{
      type:"button",
      class:"parent-pill "+cls,
      role:"listitem",
      "aria-label":`Afficher la section ${p.name}`,
      onclick:()=>scrollAndOpen(p.id),
      onkeydown:(ev)=>{ if(ev.key===" "||ev.key==="Enter"){ ev.preventDefault(); scrollAndOpen(p.id);} }
    },
      statusDot(s==="OK", s==="BAD"),
      el("span",{class:"strong"}, p.name),
      p.charged_vehicle ? el("span",{class:"veh on"}, formatChargeInfo(p.charged_vehicle_name, p.charged_operator_name)) : null,
      reassortChip
    );
    holder.appendChild(pill);
  });
}
function scrollAndOpen(id){
  COLLAPSED.set(id,false);
  const cont = document.getElementById("childs-"+id);
  const chev = document.getElementById("chev-"+id);
  if(cont){ cont.classList.remove("collapsed"); }
  if(chev){ chev.textContent = "▾"; }
  const target = document.getElementById("node-"+id);
  if(target){ target.scrollIntoView({behavior:"smooth", block:"start"}); setTimeout(()=>window.scrollBy({top:-70,left:0}), 250); }
}

/* ====== UI classes ====== */
function statusChip(s){
  s = normStatus(s);
  if(s==="OK") return el("span",{class:"chip ok"},"OK");
  if(s==="NOT_OK") return el("span",{class:"chip bad"},"Non conforme");
  return el("span",{class:"chip wait"},"En attente");
}
function groupStateClass(n){
  const s = groupStatus(n);
  if(s==="OK") return "state-ok";
  if(s==="BAD") return "state-bad";
  return "state-wait";
}

/* ====== Rendu ====== */
function renderItem(n){
  const s = normStatus(n.last_status);
  const dl = nextExpiryDaysFromNode(n);
  const qty = (n.quantity != null ? n.quantity : (n.selected_quantity != null ? n.selected_quantity : 1));
  const showWarn = (dl!=null && dl<=30);

  // petit résumé des dates (ex: 12/10, 28/10…)
  let expSummary = null;
  if (Array.isArray(n.expiries) && n.expiries.length){
    const parts = n.expiries.slice(0,3).map(e=>{
      try{ const d=new Date(e.date+"T00:00:00"); return d.toLocaleDateString(); }catch(_){ return e.date; }
    });
    expSummary = el("span",{class:"meta"}, "• Exp: "+parts.join(", ")+(n.expiries.length>3?"…":""));
  }

  const left = el("div",{class:"left"},
    el("span",{class:"status-dot "+(s==="OK"?"dot-ok":(s==="NOT_OK"?"dot-bad":"dot-wait"))}),
    el("span",{class:"label"}, n.name),
    el("span",{class:"qty"}, `Qté: ${qty}`),
    statusChip(s),
    n.last_by ? el("span",{class:"meta"}, `• par ${n.last_by}`) : null,
    expSummary,
    showWarn ? el("span",{class:"warn", title:`Péremption dans ${dl} jour(s)`},"⚠️ Péremption") : null
  );
  const targetId = targetNodeId(n);
  const safeId = domSafeId(n.id);

  const right = el("div",{class:"right"},
    el("button",{class:"btn xs success", onclick:()=>{ if(!ensureOperatorOrAsk()) return; verify(targetId,"OK"); }},"OK"),
    el("button",{class:"btn xs ghost",   onclick:()=>{ if(!ensureOperatorOrAsk()) return; openNotOkModal(n); }},"Non conforme")
  );

  const wrap = el("div",{class:"item "+(s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait")), id:`item-${safeId}`}, left, right);
  ITEM_EL.set(n.id, wrap);
  return wrap;
}

function renderUniqueParentRow(n){
  const s = normStatus(n.last_status);
  const qtyValue = (n.selected_quantity != null)
    ? n.selected_quantity
    : (n.quantity != null ? n.quantity : (n.unique_quantity != null ? n.unique_quantity : 1));
  const targetId = targetNodeId(n);
  const safeId = domSafeId(n.id);

  const left = el("div",{class:"left"},
    el("span",{class:"status-dot "+(s==="OK"?"dot-ok":(s==="NOT_OK"?"dot-bad":"dot-wait"))}),
    el("span",{class:"label"}, "Qté à charger"),
    el("span",{class:"qty"}, `Qté: ${qtyValue}`),
    statusChip(s),
    n.last_by ? el("span",{class:"meta"}, `• par ${n.last_by}`) : null
  );

  const right = el("div",{class:"right"},
    el("button",{class:"btn xs success", onclick:()=>{ if(!ensureOperatorOrAsk()) return; verify(targetId,"OK"); }},"OK"),
    el("button",{class:"btn xs ghost",   onclick:()=>{ if(!ensureOperatorOrAsk()) return; openNotOkModal(n); }},"Non conforme")
  );

  const wrap = el("div",{class:`item unique-parent ${s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait")}`, id:`item-${safeId}`}, left, right);
  ITEM_EL.set(n.id, wrap);
  return wrap;
}

function renderGroupStats(n){
  const items = flattenItems([n]);
  let ok=0,bad=0,wait=0;
  for(const it of items){
    const s = normStatus(it.last_status);
    if(s==="OK") ok++; else if(s==="NOT_OK") bad++; else wait++;
  }
  const wrap = el("div",{class:"substats", id:`gstat-${n.id}`},
    statusChip(groupStatus(n)),
    el("span",{class:"chip ok"}, `OK: ${ok}`),
    el("span",{class:"chip bad"}, `Non conf.: ${bad}`),
    el("span",{class:"chip wait"}, `Attente: ${wait}`),
    el("span",{class:"meta"}, `• Total: ${items.length}`)
  );
  return wrap;
}

function renderGroup(n){
  const isRoot = !!n.is_event_root;
  if(!COLLAPSED.has(n.id)) COLLAPSED.set(n.id, true);
  const chev = el("span",{class:"chev", id:`chev-${n.id}`}, COLLAPSED.get(n.id) ? "▸" : "▾");
  const dot  = statusDot(groupStatus(n)==="OK", groupStatus(n)==="BAD");

  const veh  = isRoot
    ? el("span",{class:"veh "+(n.charged_vehicle?'on':'off')},
        n.charged_vehicle ? `Chargé : ${formatChargeInfo(n.charged_vehicle_name, n.charged_operator_name)}` : "Non chargé")
    : null;
  if(isRoot) VEH_LABEL.set(n.id, veh);

  let reassortBadge = null;
  if(isRoot){
    reassortBadge = el("span", {
      class:`reassort-note${n.reassort_note?"":" empty"}`,
      id:`reassort-${n.id}`,
    }, n.reassort_note ? `Réassort : ${n.reassort_note}` : "");
    REASSORT_LABEL.set(n.id, reassortBadge);
  }

  const headerLeft = el("div",{class:"left"},
    chev, dot, el("span",{class:"name"}, n.name),
    isRoot ? veh : null,
    isRoot ? reassortBadge : null,
    el("span",{class:"meta"}, `• ${flattenItems([n]).length} élément(s)`)
  );

  const btnCharge = isRoot ? el("button",{class:"btn xs primary", onclick:(e)=>{e.stopPropagation(); if(!ensureOperatorOrAsk()) return; openChargeModal(n.id);}},"Charger") : null;
  if(isRoot && btnCharge) CHARGE_BUTTON.set(n.id, btnCharge);

  const btnReassort = isRoot ? el("button",{class:"btn xs", onclick:(e)=>{e.stopPropagation(); if(!ensureOperatorOrAsk()) return; openReassortModal(n.id);}},"Réassort") : null;
  if(btnReassort && !n.charged_vehicle){ btnReassort.style.display = "none"; }
  if(isRoot && btnReassort) REASSORT_BUTTON.set(n.id, btnReassort);

  const header = el("div",{class:"header toggle"}, headerLeft, el("div",{class:"actions"}, btnCharge, btnReassort));
  header.addEventListener("click", ()=>toggleCollapse(n.id));

  const gstats = renderGroupStats(n);
  const childNodes = [];
  if(isUnique(n)){
    childNodes.push(renderUniqueParentRow(n));
  }
  childNodes.push(gstats);
  (n.children||[]).forEach(child => childNodes.push(renderNode(child)));
  const childs = el("div",{class:"childs "+(COLLAPSED.get(n.id)?"collapsed":""), id:`childs-${n.id}`},
    ...childNodes
  );

  const box = el("div",{class:`node ${groupStateClass(n)}`, id:`node-${n.id}`}, header, childs);
  GROUP_EL.set(n.id, box);
  if(isRoot){
    updateChargeButtonState(n.id);
    updateReassortUI(n.id);
  }
  return box;
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

function indexTree(nodes){
  (nodes||[]).forEach(function rec(n){
    NODE_MAP.set(n.id, n);
    (n.children||[]).forEach(rec);
  });
}
function buildUIOnce(){
  NODE_MAP.clear();
  GROUP_EL.clear();
  ITEM_EL.clear();
  VEH_LABEL.clear();
  CHARGE_BUTTON.clear();
  REASSORT_LABEL.clear();
  REASSORT_BUTTON.clear();
  const root = document.getElementById("tree");
  root.innerHTML = "";
  indexTree(TREE);
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
  buildParentsBar();
  recomputeGlobalStats();
}

/* ====== Updates ====== */
function updateGroupStatsEl(n){
  const items = flattenItems([n]);
  let ok=0,bad=0,wait=0;
  for(const it of items){
    const s = normStatus(it.last_status);
    if(s==="OK") ok++; else if(s==="NOT_OK") bad++; else wait++;
  }
  const elWrap = document.getElementById(`gstat-${n.id}`);
  if(!elWrap) return;
  elWrap.innerHTML = "";
  elWrap.append(
    statusChip(groupStatus(n)),
    el("span",{class:"chip ok"}, `OK: ${ok}`),
    el("span",{class:"chip bad"}, `Non conf.: ${bad}`),
    el("span",{class:"chip wait"}, `Attente: ${wait}`),
    el("span",{class:"meta"}, `• Total: ${items.length}`)
  );
}

function applyItemDelta(local, incoming){
  local.last_status = normStatus(incoming.last_status || "PENDING");
  if(incoming.quantity != null) local.quantity = incoming.quantity;
  if(typeof incoming.selected_quantity !== "undefined") local.selected_quantity = incoming.selected_quantity;
  if(typeof incoming.unique_quantity !== "undefined") local.unique_quantity = incoming.unique_quantity;
  local.last_by     = (incoming.last_by!=null)?incoming.last_by:local.last_by;
  if(typeof incoming.target_node_id !== "undefined") local.target_node_id = incoming.target_node_id;
  if(typeof incoming.unique_from_parent !== "undefined") local.unique_from_parent = incoming.unique_from_parent;

  // ⬇️ support nouveaux champs
  if (Array.isArray(incoming.expiries)) local.expiries = incoming.expiries;
  if (incoming.expiry_date != null) local.expiry_date = incoming.expiry_date;

  const box = ITEM_EL.get(local.id);
  if(!box) return;

  box.classList.remove("state-ok","state-bad","state-wait");
  const s = normStatus(local.last_status);
  box.classList.add(s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait"));

  const dot = box.querySelector(".status-dot");
  if(dot){
    dot.classList.remove("dot-ok","dot-bad","dot-wait");
    dot.classList.add(s==="OK" ? "dot-ok" : (s==="NOT_OK" ? "dot-bad" : "dot-wait"));
  }

  const q = box.querySelector(".qty");
  if(q){
    const qtyVal = (local.selected_quantity != null)
      ? local.selected_quantity
      : (local.quantity != null ? local.quantity : (local.unique_quantity != null ? local.unique_quantity : 1));
    q.textContent = `Qté: ${qtyVal}`;
  }

  const chip = box.querySelector(".chip.ok, .chip.bad, .chip.wait");
  if(chip){
    chip.className = "chip " + (s==="OK"?"ok":(s==="NOT_OK"?"bad":"wait"));
    chip.textContent = (s==="OK"?"OK":(s==="NOT_OK"?"Non conforme":"En attente"));
  }

  let metaBy = Array.from(box.querySelectorAll(".meta")).find(m => m.textContent.trim().startsWith("• par"));
  if(!metaBy){
    metaBy = el("span",{class:"meta"});
    const left = box.querySelector(".left");
    if(left) left.appendChild(metaBy);
  }
  metaBy.textContent = local.last_by ? `• par ${local.last_by}` : "";

  // MàJ résumé expirations + triangle
  // 1) supprimer anciens éléments warn et résumé exp
  Array.from(box.querySelectorAll(".warn")).forEach(e=>e.remove());
  const left = box.querySelector(".left");
  // remove ancient "• Exp:" meta if present (very simple heuristic)
  Array.from(box.querySelectorAll(".meta")).forEach(m=>{
    if (m.textContent.startsWith("• Exp:")) m.remove();
  });

  // 2) résumé exp
  if (left){
    if (Array.isArray(local.expiries) && local.expiries.length){
      const parts = local.expiries.slice(0,3).map(e=>{
        try{ const d=new Date(e.date+"T00:00:00"); return d.toLocaleDateString(); }catch(_){ return e.date; }
      });
      left.appendChild(el("span",{class:"meta"},"• Exp: "+parts.join(", ")+(local.expiries.length>3?"…":"")));
    }
    // 3) triangle
    const dl = nextExpiryDaysFromNode(local);
    if (dl!=null && dl<=30){
      left.appendChild(el("span",{class:"warn", title:`Péremption dans ${dl} jour(s)`},"⚠️ Péremption"));
    }
  }
}

function applyGroupDelta(local, incoming){
  if(typeof incoming.charged_vehicle !== "undefined"){
    local.charged_vehicle = !!incoming.charged_vehicle;
    if(typeof incoming.charged_vehicle_name !== "undefined"){
      local.charged_vehicle_name = incoming.charged_vehicle_name || null;
    }
    if(typeof incoming.operator_name !== "undefined"){
      local.charged_operator_name = incoming.operator_name || null;
    } else if(typeof incoming.charged_operator_name !== "undefined"){
      local.charged_operator_name = incoming.charged_operator_name || null;
    }
  }
  if(typeof incoming.reassort_note !== "undefined"){
    local.reassort_note = incoming.reassort_note || null;
  }
  if(!local.charged_vehicle){
    local.reassort_note = null;
  }
  if(typeof incoming.charged_vehicle !== "undefined"){
    if(!local.charged_vehicle){
      local.charged_vehicle_name = null;
      local.charged_operator_name = null;
    }
    const lab = VEH_LABEL.get(local.id);
    if(lab){
      lab.classList.toggle("on", !!local.charged_vehicle);
      lab.classList.toggle("off", !local.charged_vehicle);
      lab.textContent = local.charged_vehicle
        ? `Chargé : ${formatChargeInfo(local.charged_vehicle_name, local.charged_operator_name)}`
        : "Non chargé";
    }
  }

  updateReassortUI(local.id);

  const box = GROUP_EL.get(local.id);
  if(!box) return;

  box.classList.remove("state-ok","state-bad","state-wait");
  box.classList.add(groupStateClass(local));

  const dot = box.querySelector(".header .status-dot");
  if(dot){
    dot.classList.remove("dot-ok","dot-bad","dot-wait");
    const gs = groupStatus(local);
    dot.classList.add(gs==="OK" ? "dot-ok" : (gs==="BAD" ? "dot-bad" : "dot-wait"));
  }

  updateGroupStatsEl(local);
  updateChargeButtonState(local.id);
}

function syncTreeIncoming(incomingRoots){
  (incomingRoots||[]).forEach(function recInc(nInc){
    const nLoc = NODE_MAP.get(nInc.id);
    if(!nLoc) return;
    if(isUnique(nLoc)){
      applyItemDelta(nLoc, nInc);
      if(typeof nInc.charged_vehicle !== "undefined"){
        nLoc.charged_vehicle = !!nInc.charged_vehicle;
      }
      if(typeof nInc.charged_vehicle_name !== "undefined"){
        nLoc.charged_vehicle_name = nInc.charged_vehicle_name || null;
      }
      if(typeof nInc.operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.operator_name || null;
      } else if(typeof nInc.charged_operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.charged_operator_name || null;
      }
      if(typeof nInc.reassort_note !== "undefined"){
        nLoc.reassort_note = nInc.reassort_note || null;
      }
      (nInc.children||[]).forEach(recInc);
      applyGroupDelta(nLoc, nInc);
    } else if(isItem(nLoc)){
      applyItemDelta(nLoc, nInc);
    }else{
      if(typeof nInc.charged_vehicle !== "undefined"){
        nLoc.charged_vehicle = !!nInc.charged_vehicle;
      }
      if(typeof nInc.charged_vehicle_name !== "undefined"){
        nLoc.charged_vehicle_name = nInc.charged_vehicle_name || null;
      }
      if(typeof nInc.operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.operator_name || null;
      } else if(typeof nInc.charged_operator_name !== "undefined"){
        nLoc.charged_operator_name = nInc.charged_operator_name || null;
      }
      if(typeof nInc.reassort_note !== "undefined"){
        nLoc.reassort_note = nInc.reassort_note || null;
      }
      (nInc.children||[]).forEach(recInc);
      applyGroupDelta(nLoc, nInc);
    }
  });
  buildParentsBar();
  recomputeGlobalStats();
}

function pruneStateForIds(validIds){
  Array.from(COLLAPSED.keys()).forEach(id=>{
    if(!validIds.has(id)){
      COLLAPSED.delete(id);
    }
  });
}

function rebuildTree(latest){
  TREE = Array.isArray(latest) ? latest : [];
  const ids = new Set();
  collectNodeIds(TREE, ids);
  pruneStateForIds(ids);
  buildUIOnce();
}

/* ===== API ===== */
async function fetchTree(){
  const r = await fetch(`/public/event/{{ token }}/tree`);
  if(!r.ok) throw new Error("fetch tree failed");
  return r.json();
}
async function refreshTree(force=false){
  if(REFRESH_BUSY){
    if(force) REFRESH_QUEUED = true;
    return;
  }
  REFRESH_BUSY = true;
  try{
    const latest = await fetchTree();
    const normalized = Array.isArray(latest) ? latest : [];
    if(TREE.length===0 || NODE_MAP.size===0){
      rebuildTree(normalized);
      NODE_MAP.forEach((n,id)=>{
        if(isGroup(n)){
          COLLAPSED.set(id,true);
          document.getElementById("childs-"+id)?.classList.add("collapsed");
          const chev = document.getElementById("chev-"+id);
          if(chev) chev.textContent = "▸";
        }
      });
      return;
    }

    const knownIds = new Set(NODE_MAP.keys());
    const incomingIds = new Set();
    collectNodeIds(normalized, incomingIds);

    let structureChanged = knownIds.size !== incomingIds.size;
    if(!structureChanged){
      for(const id of incomingIds){
        if(!knownIds.has(id)){ structureChanged = true; break; }
      }
    }
    if(!structureChanged){
      for(const id of knownIds){
        if(!incomingIds.has(id)){ structureChanged = true; break; }
      }
    }

    if(structureChanged){
      rebuildTree(normalized);
      return;
    }

    syncTreeIncoming(normalized);
  }catch(_){
  }finally{
    REFRESH_BUSY = false;
    if(REFRESH_QUEUED){
      REFRESH_QUEUED = false;
      refreshTree();
    }
  }
}
function verify(nodeId, status, extra={}){
  const payload = Object.assign({ node_id: nodeId, status, verifier_name: getOperator() || "" }, extra||{});
  return fetch(`/public/event/{{ token }}/verify`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  }).then(async res=>{
    if(!res.ok){ const t=await res.text(); alert(t || "Vérification refusée."); return Promise.reject(new Error(t||'fail')); }
    refreshTree(true);
    return true;
  }).catch(err=>{ if(err) console.error(err); });
}

function buildExpiryChoices(item){
  const out = [];
  if(Array.isArray(item.expiries) && item.expiries.length){
    item.expiries.forEach((e, idx)=>{
      const labelParts = [];
      if(e.date) labelParts.push(`Péremption ${formatISODate(e.date)}`);
      if(e.lot) labelParts.push(`Lot ${e.lot}`);
      if(typeof e.quantity === 'number') labelParts.push(`Qté ${e.quantity}`);
      if(e.note) labelParts.push(e.note);
      out.push({
        key: `exp-${e.id || idx}`,
        expiry_id: e.id || null,
        date: e.date || null,
        lot: e.lot || null,
        quantity: e.quantity || null,
        label: labelParts.join(' • ') || `Péremption ${formatISODate(e.date)}`,
      });
    });
  } else {
    const d = item.expiry_date || null;
    out.push({
      key: `legacy-${d || 'none'}`,
      expiry_id: null,
      date: d,
      lot: null,
      quantity: null,
      label: d ? `Péremption ${formatISODate(d)}` : "Aucune date enregistrée",
    });
  }
  return out;
}

async function fetchReassortOptions(nodeId){
  if(REASSORT_CACHE.has(nodeId)) return REASSORT_CACHE.get(nodeId);
  const res = await fetch(`/public/event/{{ token }}/reassort/${nodeId}`);
  if(!res.ok){ const txt = await res.text(); throw new Error(txt || 'Chargement impossible'); }
  const data = await res.json();
  REASSORT_CACHE.set(nodeId, data);
  return data;
}

function invalidateReassort(nodeId){ REASSORT_CACHE.delete(nodeId); }

function openNotOkModal(item){
  const targetId = targetNodeId(item);
  const choices = buildExpiryChoices(item);
  let selectedExpiry = choices[0] || null;
  let selectedReassort = null;

  const commentInput = el('textarea',{placeholder:'Commentaire (optionnel)', style:'margin-top:6px'});

  const expiryList = el('div',{class:'exp-list'}, ...choices.map(choice=>{
    const input = el('input',{type:'radio',name:'exp-choice',value:choice.key});
    if(choice===selectedExpiry) input.checked = true;
    input.addEventListener('change',()=>{ selectedExpiry = choice; });
    return el('label',{class:'exp-option'}, input, el('div',{class:'exp-text'}, choice.label));
  }));

  const qtyInput = el('input',{type:'number',min:'1',value:String(Math.max(1, item.missing_qty || 1)), style:'width:120px'});
  const reassortList = el('div',{class:'reassort-list'});
  const reassortSection = el('div',{class:'reassort-section',style:'display:none'},
    el('div',{class:'section-title'},'Sélectionnez un article de réassort à utiliser :'),
    reassortList,
    el('div',{class:'reassort-controls'},
      el('label',{},'Quantité'),
      qtyInput
    )
  );

  const btnConfirmReplace = el('button',{class:'btn primary',disabled:true},'Confirmer le remplacement');
  const confirmWrap = el('div',{class:'reassort-confirm',style:'display:none'}, btnConfirmReplace);

  const closeAndRefresh = ()=>{ closeModal(); refreshTree(true); };

  async function loadReassort(){
    reassortSection.style.display = 'flex';
    reassortList.innerHTML = '';
    const loader = el('div',{class:'muted'},'Chargement en cours…');
    reassortList.appendChild(loader);
    try{
      const data = await fetchReassortOptions(targetId);
      reassortList.innerHTML = '';
      const items = Array.isArray(data?.items) ? data.items : [];
      if(!items.length){
        reassortList.appendChild(el('div',{class:'muted'},'Aucun lot de réassort disponible.'));
        btnConfirmReplace.disabled = true;
        return;
      }
      items.forEach(entry=>{
        const input = el('input',{type:'radio',name:'reassort-choice',value:String(entry.batch_id)});
        input.addEventListener('change',()=>{ selectedReassort = entry; btnConfirmReplace.disabled = false; });
        if(!selectedReassort){ input.checked = true; selectedReassort = entry; btnConfirmReplace.disabled = false; }
        const option = el('label',{class:'reassort-option'},
          input,
          el('div',{class:'reassort-text'},
            el('div',{class:'strong'}, entry.item_name || 'Réassort'),
            el('div',{class:'muted'}, `Qté dispo: ${entry.quantity}`),
            el('div',{class:'muted'}, entry.expiry_date ? `Péremption ${formatISODate(entry.expiry_date)}` : 'Péremption inconnue'),
            entry.lot ? el('div',{class:'muted'}, `Lot ${entry.lot}`) : null,
            entry.preferred ? el('div',{class:'tag'},'Article recommandé') : null
          )
        );
        reassortList.appendChild(option);
      });
    }catch(err){
      reassortList.innerHTML = '';
      reassortList.appendChild(el('div',{class:'muted'}, err.message || 'Impossible de charger le réassort.'));
      btnConfirmReplace.disabled = true;
    }
  }

  async function confirmNotOk(){
    const btn = btnMarkNotOk;
    btn.disabled = true;
    const parts = [];
    if(selectedExpiry){
      const detail = [];
      if(selectedExpiry.date) detail.push(`péremption ${formatISODate(selectedExpiry.date)}`);
      if(selectedExpiry.lot) detail.push(`lot ${selectedExpiry.lot}`);
      if(detail.length) parts.push(detail.join(' · '));
    }
    const raw = (commentInput.value || '').trim();
    if(raw) parts.push(raw);
    const payload = { comment: parts.join(' — ') || undefined, issue_code: 'OTHER' };
    try{
      await verify(targetId, 'NOT_OK', payload);
      closeModal();
    }catch(err){
      console.error(err);
    }finally{
      btn.disabled = false;
    }
  }

  async function confirmReplace(){
    if(!selectedReassort){ alert('Choisissez un lot de réassort.'); return; }
    const qty = Math.max(1, parseInt(qtyInput.value, 10) || 1);
    const payload = {
      node_id: targetId,
      batch_id: selectedReassort.batch_id,
      quantity: qty,
      verifier_name: getOperator() || '',
      comment: (commentInput.value || '').trim() || undefined,
    };
    if(selectedExpiry){
      if(selectedExpiry.expiry_id) payload.expiry_id = selectedExpiry.expiry_id;
      else if(selectedExpiry.date) payload.expiry_date = selectedExpiry.date;
    }
    btnConfirmReplace.disabled = true;
    try{
      const res = await fetch(`/public/event/{{ token }}/replace`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){ const txt = await res.text(); throw new Error(txt || 'Remplacement impossible'); }
      await res.json().catch(()=>null);
      invalidateReassort(targetId);
      closeAndRefresh();
    }catch(err){
      alert(err.message || 'Remplacement impossible');
      btnConfirmReplace.disabled = false;
    }
  }

  const btnMarkNotOk = el('button',{class:'btn ghost'},'Marquer non conforme');
  btnMarkNotOk.addEventListener('click', confirmNotOk);

  const btnShowReassort = el('button',{class:'btn primary'},'Remplacer via réassort');
  btnShowReassort.addEventListener('click',()=>{
    btnShowReassort.disabled = true;
    reassortSection.style.display = 'flex';
    confirmWrap.style.display = 'flex';
    loadReassort();
  });

  btnConfirmReplace.addEventListener('click', confirmReplace);

  const content = el('div',{},
    el('h3',{},`Résoudre la non conformité`),
    el('div',{class:'muted'}, item.name),
    el('div',{class:'section-title'},'Quel lot est concerné ?'),
    expiryList,
    el('div',{class:'field'}, commentInput),
    el('div',{class:'modal-action-row'}, btnMarkNotOk, btnShowReassort),
    reassortSection,
    confirmWrap
  );

  openModal(content);
}

/* ===== Charger (racine) ===== */
let CHARGE_TARGET = null;
function openChargeModal(parentId){
  const node = NODE_MAP.get(parentId);
  if(!node) return;
  if(!canChargeGroup(node)){ alert("Impossible : tous les éléments doivent être OK."); return; }
  CHARGE_TARGET = parentId;

  const old = document.getElementById("charge-modal"); if(old) old.remove();
  const modal = el("div",{id:"charge-modal",class:"modal-back"},
    el("div",{class:"modal-card"},
      el("div",{class:"title",style:"margin-bottom:10px"},"Charger le parent"),
      el("label",{class:"muted",for:"veh-name"},"Nom du véhicule (obligatoire)"),
      el("input",{id:"veh-name",placeholder:"Ex : VSAV-2", required:true}),
      el("div",{class:"muted",style:"margin-bottom:10px"},"Opérateur : ", getOperator() || "—"),
      el("div",{class:"modal-actions"},
        el("button",{class:"btn ghost",onclick:closeChargeModal},"Annuler"),
        el("button",{class:"btn primary",onclick:confirmCharge},"Confirmer")
      )
    )
  );
  document.body.appendChild(modal);
  setTimeout(()=>document.getElementById("veh-name")?.focus(), 10);
}
function closeChargeModal(){ document.getElementById("charge-modal")?.remove(); CHARGE_TARGET = null; }
function confirmCharge(){
  const veh = (document.getElementById("veh-name")?.value || "").trim();
  if(!veh){ alert("Merci d’indiquer le nom du véhicule."); return; }

  const payload = { node_id: CHARGE_TARGET, charged_vehicle: true, operator_name: getOperator() || "", vehicle_name: veh };
  fetch(`/public/event/{{ token }}/charge`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  }).then(async res=>{
    if(!res.ok){ const t=await res.text(); alert(t || "Échec du chargement."); return; }
    // MAJ optimiste du libellé immédiatement
    const n = NODE_MAP.get(CHARGE_TARGET);
    if(n){
      n.charged_vehicle = true;
      n.charged_vehicle_name = veh;
      n.charged_operator_name = getOperator() || null;
      const lab = VEH_LABEL.get(n.id);
      if(lab){
        lab.classList.remove("off"); lab.classList.add("on");
        lab.textContent = `Chargé : ${formatChargeInfo(veh, n.charged_operator_name)}`;
      }
      updateChargeButtonState(n.id);
    }
    closeChargeModal();
    refreshTree(true);
  }).catch(()=>{});
}
function closeReassortModal(){
  document.getElementById("reassort-modal")?.remove();
  REASSORT_TARGET = null;
}
function openReassortModal(parentId){
  const node = NODE_MAP.get(parentId);
  if(!node) return;
  if(!node.charged_vehicle){ alert("Parent non chargé."); return; }
  closeReassortModal();
  REASSORT_TARGET = parentId;
  const modal = el("div",{id:"reassort-modal",class:"modal-back"},
    el("div",{class:"modal-card"},
      el("div",{class:"title",style:"margin-bottom:10px"},`Réassort – ${node.name}`),
      el("textarea",{id:"reassort-note",placeholder:"Ex : Ajouter du consommable",style:"min-height:110px"}, node.reassort_note || ""),
      el("div",{class:"muted",style:"margin:8px 0"},"Laisser vide pour supprimer le commentaire."),
      el("div",{class:"modal-actions"},
        el("button",{class:"btn ghost",onclick:closeReassortModal},"Annuler"),
        el("button",{class:"btn primary",onclick:confirmReassort},"Valider")
      )
    )
  );
  document.body.appendChild(modal);
  setTimeout(()=>document.getElementById("reassort-note")?.focus(), 10);
}
function confirmReassort(){
  if(!REASSORT_TARGET) return;
  const note = (document.getElementById("reassort-note")?.value || "").trim();
  fetch(`/public/event/{{ token }}/reassort-note`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ node_id: REASSORT_TARGET, note })
  }).then(async res=>{
    if(!res.ok){ const txt = await res.text(); throw new Error(txt || "Échec de l'enregistrement"); }
    return res.json().catch(()=>({}));
  }).then(()=>{
    const node = NODE_MAP.get(REASSORT_TARGET);
    if(node){
      node.reassort_note = note || null;
      updateReassortUI(REASSORT_TARGET);
      buildParentsBar();
    }
    closeReassortModal();
    refreshTree(true);
  }).catch(err=>{
    alert(err.message || "Échec de l'enregistrement");
  });
}
function updateChargeButtonState(parentId){
  const n = NODE_MAP.get(parentId);
  const btn = CHARGE_BUTTON.get(parentId);
  if(btn){
    const enable = n ? canChargeGroup(n) : false;
    btn.disabled = !enable;
    btn.title = enable ? "" : "Tous les éléments doivent être OK";
  }
  updateReassortUI(parentId);
}

function updateReassortUI(parentId){
  const node = NODE_MAP.get(parentId);
  const badge = REASSORT_LABEL.get(parentId);
  if(badge){
    const note = node && node.reassort_note ? node.reassort_note : "";
    badge.textContent = note ? `Réassort : ${note}` : "";
    badge.classList.toggle("empty", !note);
  }
  const btn = REASSORT_BUTTON.get(parentId);
  if(btn){
    const visible = !!(node && node.charged_vehicle);
    btn.style.display = visible ? "" : "none";
  }
}

/* ====== Pliage ====== */
function toggleCollapse(id){
  const now = !COLLAPSED.get(id);
  COLLAPSED.set(id, now);
  const cont = document.getElementById("childs-"+id);
  const chev = document.getElementById("chev-"+id);
  if(cont) cont.classList.toggle("collapsed", now);
  if(chev) chev.textContent = now ? "▸" : "▾";
}

/* Boot */
(function init(){
  refreshTree();
  window.addEventListener("focus", ()=>refreshTree(true));
  setInterval(()=>{
    refreshTree();
    if(!getOperator() && !document.getElementById("name-modal")) openNameModal(true);
  }, REFRESH_INTERVAL_MS);
})();
</script>

{% endblock %}
