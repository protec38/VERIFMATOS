{% extends "base.html" %}
{% set title = "Événement (secouristes)" %}
{% block content %}

<style>
  .wrap{max-width:1100px;margin:20px auto;padding:0 14px}
  .header{display:flex;align-items:center;justify-content:space-between;margin:10px 0 18px}
  .h1{font-size:22px;margin:0}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .card{border:1px solid var(--border);background:var(--bg-2);border-radius:14px;box-shadow:var(--shadow);padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:var(--bg-3);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.success{background:#0e2a24;border-color:#1d6e5d}
  .btn.ghost{background:#2a0e14;border-color:#75212f}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .item{display:flex;justify-content:space-between;gap:8px;border:1px dashed var(--border-2);padding:10px;border-radius:10px}
  .group{border:1px solid var(--border);padding:10px;border-radius:10px}
  .children{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .chip{padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-weight:700}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.todo{background:#101c2e;color:#b7c7dc;border-color:#24344f}
  .small{font-size:12px}
  dialog{border:1px solid var(--border);background:var(--bg-2);color:var(--text);border-radius:12px}
  dialog input{background:var(--bg-3);color:var(--text);border:1px solid var(--border);padding:8px;border-radius:10px}
</style>

<div class="wrap">
  <div class="header">
    <div>
      <h1 class="h1">{{ event.name }}</h1>
      <div class="muted small">Partage: {{ token }}</div>
    </div>
    <div class="row">
      <span class="muted small">Opérateur</span>
      <input id="opFullName" placeholder="Nom Prénom" />
      <button class="btn" onclick="saveOperator()">OK</button>
    </div>
  </div>

  <div id="tree" class="grid"></div>
</div>

<dialog id="idModal">
  <h3>Identifie-toi</h3>
  <p class="small muted">Rentre ton nom pour valider les items</p>
  <div class="row">
    <input id="opModalFull" placeholder="Nom Prénom" />
    <button class="btn" onclick="saveOperatorFromModal()">OK</button>
  </div>
</dialog>

<script>
  const TOKEN = "{{ token }}";
  let TREE = [];
  const NODE_MAP = new Map();

  // ----- Operator -----
  function getSavedName(){ return localStorage.getItem("pcprep:operator") || ""; }
  function setSavedName(n){ localStorage.setItem("pcprep:operator", n); document.getElementById("opFullName").value = n; }
  function requireOperatorName(){
    const n = getSavedName();
    if(n) return n;
    document.getElementById("idModal").showModal();
    return null;
  }
  function saveOperator(){
    const v = (document.getElementById("opFullName").value || "").trim();
    if(!v){ alert("Nom requis"); return; }
    setSavedName(v);
  }
  function saveOperatorFromModal(){
    const v = (document.getElementById("opModalFull").value || "").trim();
    if(!v){ alert("Nom requis"); return; }
    setSavedName(v);
    document.getElementById("idModal").close();
  }

  // ----- UI -----
  function el(tag, props, ...children){
    const n = document.createElement(tag);
    if(props) for(const k of Object.keys(props)){ 
      if(k === "class") n.className = props[k];
      else if(k.startsWith("on") && typeof props[k] === "function") n.addEventListener(k.substring(2), props[k]);
      else n.setAttribute(k, props[k]);
    }
    for(const c of children){
      if(c == null) continue;
      if(Array.isArray(c)) c.forEach(x=>n.appendChild(typeof x === "string" ? document.createTextNode(x) : x));
      else n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
    }
    return n;
  }

  function renderTree(){
    NODE_MAP.clear();
    const cont = document.getElementById("tree");
    cont.innerHTML = "";
    for(const r of TREE){
      cont.appendChild(renderNode(r, true));
    }
  }
  function renderNode(n, isRoot){
    NODE_MAP.set(n.id, n);
    if((n.type||"").toUpperCase() === "ITEM"){
      const chip = el("span",{class:"chip " + (n.last_status==="OK"?"ok":(n.last_status==="NOT_OK"?"bad":"todo"))},
        n.last_status==="OK"?"OK":(n.last_status==="NOT_OK"?"Non conforme":"En attente")
      );
      const btns = el("div",{class:"row"},
        el("button",{class:"btn success", onclick:()=>verify(n.id,"ok")}, "OK"),
        el("button",{class:"btn ghost", onclick:()=>verify(n.id,"not_ok")}, "Non conforme"),
      );
      const right = el("div",{}, chip, el("div",{class:"small muted"}, n.last_by?`(${n.last_by})`:""), btns);
      return el("div",{class:"item"}, el("div",{}, n.name), right);
    }else{
      const children = (n.children||[]).map(c=>renderNode(c,false));
      const head = el("div",{class:"row"},
        el("strong",{}, n.name),
        isRoot && n.charged_vehicle ? el("span",{class:"chip ok small"},"Chargé") : null
      );
      return el("div",{class:"group"}, head, el("div",{class:"children"}, children));
    }
  }

  function syncTreeIncoming(latest){
    // remplace entièrement (plus simple et sûr)
    TREE = latest || [];
    renderTree();
  }

  // ----- API -----
  async function refreshTree(){
    try{
      const r = await fetch(`/public/event/${TOKEN}/tree`);
      if(!r.ok) return;
      const latest = await r.json();
      syncTreeIncoming(latest);
    }catch(_){}
  }

  function notifyFromResponse(res){
    if(!res.ok){
      return res.json().then(j=>{
        alert(j && (j.error||j.message) ? (j.error||j.message) : "Action impossible.");
      }).catch(()=>res.text().then(t=>alert(t || "Action impossible.")));
    }
    return Promise.resolve();
  }

  function verify(nodeId, statusLower){ // statusLower: "ok" | "not_ok"
    const name = requireOperatorName();
    if(!name) return;
    const payload = { node_id: nodeId, status: statusLower, verifier_name: name };
    fetch(`/public/event/${TOKEN}/verify`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    })
    .then(res => notifyFromResponse(res).then(()=> res.ok && refreshTree()))
    .catch(()=>{});
  }

  // ----- bootstrap -----
  (function init(){
    const saved = getSavedName();
    if(saved) document.getElementById("opFullName").value = saved;
    refreshTree();
    setInterval(refreshTree, 4000);
  })();
</script>
{% endblock %}
