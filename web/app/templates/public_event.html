{% extends "base.html" %}
{% set title = "Vérification du matériel (secouristes)" %}
{% block content %}

<style>
  /* Thème états */
  .state-ok{
    border-color: var(--success) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(18,184,134,.15), transparent),
      #0f1e2f;
    box-shadow: 0 0 0 1px rgba(18,184,134,.35) inset, 0 0 18px rgba(18,184,134,.15);
  }
  .state-bad{
    border-color: var(--danger) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(255,107,107,.12), transparent),
      #0f1e2f;
    box-shadow: 0 0 0 1px rgba(255,107,107,.35) inset, 0 0 18px rgba(255,107,107,.12);
  }
  .state-wait{
    border-color: #37527a !important;
    background:
      radial-gradient(600px 200px at top left, rgba(55,82,122,.10), transparent),
      #0f1e2f;
    box-shadow: 0 0 0 1px rgba(55,82,122,.35) inset, 0 0 18px rgba(55,82,122,.10);
  }

  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .dot-ok{background:var(--success)} .dot-bad{background:var(--danger)} .dot-wait{background:#37527a}

  /* Barre parents */
  .parents-card .title{display:flex;align-items:center;gap:10px}
  .parents-bar{display:flex;gap:8px;overflow:auto;padding:8px 2px}
  .parent-pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;border:1px solid var(--border);cursor:pointer;
    user-select:none;white-space:nowrap;transition:transform .08s ease, box-shadow .08s ease, border-color .08s ease;
    background:#0f1a2a;color:var(--text)
  }
  .parent-pill:hover{transform:translateY(-1px)}
  .pill-ok{border-color:#1d6e5d;background:#0e2a24;color:#bff3e7}
  .pill-bad{border-color:#6e1d1d;background:#2a0f0f;color:#f3c0c0}
  .pill-wait{border-color:#37527a;background:#0f1e2f;color:#b8c4d9}

  .card{border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px;background:#0f1a2a}
  .row{display:flex;align-items:flex-start;gap:12px;padding:10px;border:1px solid var(--border);border-radius:8px;margin:6px 0}
  .row .meta{flex:1}
  .row .actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .btn{padding:6px 10px;border:1px solid var(--border);background:#0f1e2f;border-radius:6px;cursor:pointer}
  .btn:hover{filter:brightness(1.15)}
  .btn-ok{border-color:var(--success)}
  .btn-bad{border-color:var(--danger)}
  .btn-wait{border-color:#37527a}
  .badge{display:inline-flex;padding:2px 8px;border-radius:999px;border:1px dashed var(--border);font-size:12px;opacity:.9}

  .notok-extra{display:none;margin-top:8px;padding:8px;border:1px dashed var(--border);border-radius:8px;background:#0e1625}
  .notok-extra label{margin-right:8px;font-size:14px}
  .notok-extra input[type=number]{width:100px}

  /* Gate (nom vérificateur) */
  .gate{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:30}
  .gate .box{background:#0f1a2a;border:1px solid var(--border);border-radius:12px;padding:18px;max-width:420px;width:92%}
</style>

<div class="card parents-card">
  <div class="title">
    <img src="{{ url_for('static', filename='pc_logo.webp') }}" alt="PC" style="height:28px">
    <div>
      <div style="font-weight:700;font-size:18px">Vérification — {{ event.name }}</div>
      <div class="badge">Lien public (secouristes)</div>
    </div>
    <div style="margin-left:auto" id="whoBadge"></div>
  </div>
  <div class="parents-bar" id="parentsBar"></div>
</div>

<div id="treeContainer"></div>

<!-- Gate: demander le nom du vérificateur -->
<div class="gate" id="gate">
  <div class="box">
    <h3 style="margin-top:0">Qui vérifie ?</h3>
    <p>Merci d’indiquer votre nom/prénom (il sera affiché sur les enregistrements).</p>
    <input type="text" id="verifierInput" placeholder="Ex : Dupont Alice" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#0f1e2f;color:var(--text)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn" onclick="hideGate()">Annuler</button>
      <button class="btn btn-ok" onclick="saveVerifier()">Valider</button>
    </div>
  </div>
</div>

<script>
/* ------- State ------- */
const TOKEN = {{ token|tojson }};
let TREE = {{ tree|tojson }};
let VERIFIER_NAME = localStorage.getItem("verifier_name") || "";

/* ------- UI helpers ------- */
function $(sel, parent=document){ return parent.querySelector(sel); }
function $all(sel, parent=document){ return Array.from(parent.querySelectorAll(sel)); }

function fmtStatusDot(s){
  if(s==="OK") return '<span class="status-dot dot-ok"></span>OK';
  if(s==="NOT_OK") return '<span class="status-dot dot-bad"></span>Non conforme';
  return '<span class="status-dot dot-wait"></span>À faire';
}

function parentPillClass(node){
  if(node.complete) return 'parent-pill pill-ok';
  if((node.total_items||0)===0) return 'parent-pill pill-wait';
  return 'parent-pill pill-bad';
}

/* ------- Gate ------- */
function showGate(){ $("#gate").style.display="flex"; }
function hideGate(){ $("#gate").style.display="none"; }
function saveVerifier(){
  const v = ($("#verifierInput").value || "").trim();
  if(!v){ alert("Merci d’indiquer votre nom."); return; }
  VERIFIER_NAME = v;
  localStorage.setItem("verifier_name", v);
  hideGate();
  buildUI();
  // premier refresh auto
  fetchTree();
}

/* ------- Build UI ------- */
function buildParentsBar(){
  const bar = $("#parentsBar");
  bar.innerHTML = "";
  (TREE||[]).forEach(root=>{
    const pill = document.createElement("div");
    pill.className = parentPillClass(root);
    pill.innerHTML = `<strong>${root.name}</strong><span style="opacity:.8"> · ${root.ok_count||0}/${root.total_items||0} OK</span>`;
    pill.onclick = () => {
      const el = document.getElementById("root_"+root.id);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    };
    bar.appendChild(pill);
  });
}

function buildTree(){
  const cont = $("#treeContainer");
  cont.innerHTML = "";
  (TREE||[]).forEach(root=>{
    const card = document.createElement("div");
    card.className = "card";
    card.id = "root_"+root.id;
    card.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div style="font-weight:700;font-size:16px">${root.name}</div>
        <div class="badge">${(root.ok_count||0)}/${(root.total_items||0)} OK</div>
        ${root.complete ? '<div class="badge" style="border-color:var(--success);color:#bff3e7">Complet</div>' : ''}
      </div>
      <div data-children></div>
    `;
    cont.appendChild(card);
    const holder = $('[data-children]', card);
    renderChildren(holder, root.children||[], 1);
  });
}

function renderChildren(holder, children, level){
  children.forEach(n=>{
    if(n.type==="GROUP"){
      const sub = document.createElement("div");
      sub.className = "card";
      sub.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <div style="font-weight:700">${"▪︎ ".repeat(Math.min(level,3))}${n.name}</div>
          <div class="badge">${(n.ok_count||0)}/${(n.total_items||0)} OK</div>
          ${n.complete ? '<div class="badge" style="border-color:var(--success);color:#bff3e7">Complet</div>' : ''}
        </div>
        <div data-children></div>
      `;
      holder.appendChild(sub);
      renderChildren($('[data-children]', sub), n.children||[], level+1);
    } else {
      const row = document.createElement("div");
      row.className = "row";
      row.dataset.nodeId = n.id;

      const stateClass = n.last_status === "OK" ? "state-ok" : (n.last_status === "NOT_OK" ? "state-bad" : "state-wait");
      row.classList.add(stateClass);

      const lastWho = n.last_by ? ` — <span style="opacity:.8">${n.last_by}</span>` : "";
      const qBadge = `<span class="badge" title="Quantité cible">Qté: ${n.quantity||0}</span>`;

      row.innerHTML = `
        <div class="meta" style="min-width:220px">
          <div style="font-weight:600">${n.name} ${qBadge}</div>
          <div style="font-size:13px;opacity:.9">Statut: ${fmtStatusDot(n.last_status||"TODO")}${lastWho}</div>
          <div class="notok-extra" data-extra>
            <label>Motif
              <select name="issue_code">
                <option value="broken">Cassé</option>
                <option value="missing">Manquant</option>
                <option value="other">Autre</option>
              </select>
            </label>
            <label>Quantité constatée
              <input type="number" min="0" name="observed_qty" inputmode="numeric" />
            </label>
            <label>Nombre manquant
              <input type="number" min="0" name="missing_qty" inputmode="numeric" />
            </label>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-ok"    data-action="set-ok">OK</button>
          <button class="btn btn-bad"   data-action="set-bad">Non conforme</button>
          <button class="btn btn-wait"  data-action="set-todo">À faire</button>
        </div>
      `;
      holder.appendChild(row);

      // Préremplir champs si déjà NOT_OK
      if(n.last_status === "NOT_OK"){
        const extra = $('[data-extra]', row);
        if(extra) extra.style.display = "block";
        if(n.issue_code) $('select[name=issue_code]', row).value = n.issue_code.toLowerCase();
        if(n.observed_qty != null) $('input[name=observed_qty]', row).value = n.observed_qty;
        if(n.missing_qty  != null) $('input[name=missing_qty]',  row).value = n.missing_qty;
      }

      // Listeners
      row.addEventListener('click', async (ev)=>{
        const btn = ev.target.closest('[data-action]');
        if(!btn) return;
        if(!VERIFIER_NAME){
          showGate();
          return;
        }
        const action = btn.dataset.action;
        if(action === "set-ok"){
          await submitStatus(row, "ok");
        } else if(action === "set-todo"){
          await submitStatus(row, "todo");
        } else if(action === "set-bad"){
          // toggle affichage bloc extra
          const extra = $('[data-extra]', row);
          if(extra) extra.style.display = extra.style.display === "block" ? "none" : "block";
          await submitStatus(row, "not_ok");
        }
      });
    }
  });
}

function buildUI(){
  // badge qui
  const wb = $("#whoBadge");
  wb.innerHTML = VERIFIER_NAME ? `<span class="badge">Vérificateur : ${VERIFIER_NAME}</span>` :
                                 `<button class="btn" onclick="showGate()">Saisir mon nom</button>`;

  buildParentsBar();
  buildTree();
}

/* ------- API calls ------- */
async function fetchTree(){
  try{
    const res = await fetch(`/public/event/${TOKEN}/tree`);
    if(!res.ok) return;
    const data = await res.json();
    TREE = data;
    buildUI();
  }catch(e){}
}

async function submitStatus(row, status){
  const node_id = parseInt(row.dataset.nodeId, 10);
  const payload = {
    node_id,
    status,
    verifier_name: VERIFIER_NAME,
  };

  if(status === "not_ok"){
    const issueSel = row.querySelector('select[name=issue_code]');
    const oq = row.querySelector('input[name=observed_qty]');
    const mq = row.querySelector('input[name=missing_qty]');
    if(!issueSel || !issueSel.value){
      alert("Merci de choisir un motif (cassé / manquant / autre).");
      return;
    }
    payload.issue_code = issueSel.value;
    if(oq && oq.value !== "") payload.observed_qty = parseInt(oq.value, 10);
    if(mq && mq.value !== "") payload.missing_qty  = parseInt(mq.value, 10);
  }

  try{
    const res = await fetch(`/public/event/${TOKEN}/verify`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
    });
    if(!res.ok){
      const err = await res.json().catch(()=>({}));
      alert(err.error || "Erreur réseau");
      return;
    }
    // succès => refresh
    await fetchTree();
  }catch(e){
    alert("Erreur réseau");
  }
}

/* ------- Démarrage ------- */
document.addEventListener("DOMContentLoaded", ()=>{
  if(VERIFIER_NAME){
    hideGate();
    buildUI();
    setInterval(fetchTree, 2000);
  }else{
    showGate();
  }
});
</script>

{% endblock %}
