{% extends "base.html" %}
{% set title = "Vérification du matériel (secouristes)" %}
{% block content %}

<style>
  :root{
    --bg:#0d1320; --bg2:#111a2b; --bg3:#0b1322;
    --text:#e6eefb; --muted:#9fb3cc;
    --border:#2a3a53; --border2:#334968;
    --ok:#12b886; --bad:#ff6b6b; --wait:#376099; --warn:#f0b429;
    --wait-border:#274a78;
    --shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .wrap{max-width:1100px;margin:16px auto;padding:0 14px}
  .header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 14px}
  .title{display:flex;flex-direction:column}
  .h1{font-size:22px;margin:0}
  .muted{color:var(--muted)}
  .small{font-size:12px}

  .card{border:1px solid var(--border);background:var(--bg2);border-radius:14px;box-shadow:var(--shadow);padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:var(--bg3);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.success{background:#0e2a24;border-color:#1d6e5d}
  .btn.danger{background:#2a0e14;border-color:#75212f}
  .btn.primary{background:#0c1b30;border-color:#274a78}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .legend{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border);display:inline-flex;align-items:center;gap:6px}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.wait{background:#0c1b30;color:#cfe2ff;border-color:var(--wait-border)}
  .chip.warn{background:#2a210c;color:#ffe9b8;border-color:#7a5a1d}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)} .dot.wait{background:var(--wait)} .dot.warn{background:var(--warn)}

  .warn-ic{width:16px;height:16px;display:inline-block;vertical-align:middle}
  .warn-ic svg{width:16px;height:16px}
  .warn-ic path{fill:var(--warn)}

  .parents{margin-top:10px}
  .parents-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .parents-bar{display:flex;gap:10px;overflow:auto;padding:4px 2px}
  .parent{display:flex;align-items:center;gap:10px;border:1px solid var(--border);padding:8px 10px;border-radius:12px;background:var(--bg3)}
  .parent .name{font-weight:700}
  .parent .veh{font-size:12px;color:var(--muted)}
  .parent .state{display:flex;align-items:center;gap:6px;margin-left:auto}

  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  .group{border:1px solid var(--border);padding:12px;border-radius:12px;background:var(--bg2)}
  .group.ok{border-color:#1d6e5d;background:radial-gradient(600px 200px at top left, rgba(18,184,134,.12), transparent), var(--bg2); box-shadow:0 0 0 1px rgba(18,184,134,.35) inset, 0 0 18px rgba(18,184,134,.12)}
  .group.bad{border-color:#75212f;background:radial-gradient(600px 200px at top left, rgba(255,107,107,.09), transparent), var(--bg2)}
  .group.wait{border-color:var(--wait-border);background:radial-gradient(600px 200px at top left, rgba(55,96,153,.12), transparent), var(--bg2)}
  .group>.head{display:flex;align-items:center;gap:10px;margin-bottom:8px}

  .item{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px dashed var(--border2);padding:10px;border-radius:10px;background:var(--bg3)}
  .item.ok{border-color:#1d6e5d;background:radial-gradient(500px 180px at top left, rgba(18,184,134,.10), transparent), var(--bg3)}
  .item.bad{border-color:#75212f;background:radial-gradient(500px 180px at top left, rgba(255,107,107,.08), transparent), var(--bg3)}
  .item.wait{border-color:var(--wait-border);background:radial-gradient(500px 180px at top left, rgba(55,96,153,.10), transparent), var(--bg3)}
  .item .name-area{display:flex;align-items:center;gap:8px}
  .item .right{display:flex;align-items:center;gap:8px}

  dialog{border:1px solid var(--border);background:var(--bg2);color:var(--text);border-radius:12px;max-width:460px}
  dialog form{display:flex;flex-direction:column;gap:10px;padding:8px}
  input[type="text"]{background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:10px;border-radius:10px;width:100%}
  .dialog-actions{display:flex;justify-content:flex-end;gap:8px}

  @media (min-width: 920px){
    .h1{font-size:24px}
  }
</style>

<div class="wrap">
  <div class="header">
    <div class="title">
      <h1 class="h1">{{ event.name }}</h1>
      <div class="muted small">Lien public : {{ token }}</div>
    </div>
    <div class="row">
      <div class="muted small">Opérateur : <strong id="opShown">—</strong></div>
      <button class="btn primary" onclick="openOperator()">Changer d’opérateur</button>
    </div>
  </div>

  <div class="card">
    <div class="legend">
      <span class="chip wait"><span class="dot wait"></span>À vérifier</span>
      <span class="chip ok"><span class="dot ok"></span>OK</span>
      <span class="chip bad"><span class="dot bad"></span>Non conforme</span>
      <span class="chip warn"><span class="dot warn"></span>Péremption proche</span>
    </div>
  </div>

  <div class="card parents">
    <div class="parents-head">
      <strong>Parents inclus dans l’évènement</strong>
    </div>
    <div class="parents-bar" id="parentsBar"></div>
  </div>

  <div id="tree" class="grid"></div>
</div>

<!-- Modal opérateur -->
<dialog id="dlgOperator">
  <form method="dialog" onsubmit="saveOperatorFromModal(event)">
    <h3>Identifiez-vous</h3>
    <p class="small muted">Renseignez votre <strong>Nom</strong> et <strong>Prénom</strong> pour valider les items.</p>
    <input id="opInput" type="text" placeholder="Nom Prénom" autocomplete="name" />
    <div class="dialog-actions">
      <button class="btn" value="cancel" onclick="closeOperator()">Annuler</button>
      <button class="btn success" value="ok">Valider</button>
    </div>
  </form>
</dialog>

<!-- Modal véhicule -->
<dialog id="dlgVehicle">
  <form method="dialog" onsubmit="saveVehicle(event)">
    <h3 id="vehTitle">Véhicule chargé</h3>
    <input id="vehInput" type="text" placeholder="Nom du véhicule (ex : VPSP-1)" />
    <div class="dialog-actions">
      <button class="btn" value="cancel" onclick="closeVehicle()">Annuler</button>
      <button id="vehSaveBtn" class="btn success" value="ok">Enregistrer</button>
    </div>
  </form>
</dialog>

<script>
  const TOKEN = "{{ token }}";
  const PEREMPTION_DAYS = 30; // seuil alerte péremption

  // ---------- state ----------
  let TREE = [];
  const NODE_MAP = new Map();
  let CURRENT_PARENT_ID = null;

  // ---------- operator ----------
  const LS_KEY = "pcprep:operator";
  function getOperator(){ return (localStorage.getItem(LS_KEY) || "").trim(); }
  function setOperator(name){
    localStorage.setItem(LS_KEY, name || "");
    document.getElementById("opShown").textContent = name || "—";
  }
  function ensureOperator(){
    const n = getOperator();
    if(!n){ openOperator(true); return false; }
    return true;
  }
  function openOperator(force){
    const dlg = document.getElementById("dlgOperator");
    document.getElementById("opInput").value = getOperator();
    if(!dlg.open) dlg.showModal(); else if(force) dlg.showModal();
  }
  function closeOperator(){ document.getElementById("dlgOperator").close(); }
  function saveOperatorFromModal(ev){
    ev.preventDefault();
    const v = (document.getElementById("opInput").value || "").trim();
    if(!v){ alert("Nom requis"); return; }
    setOperator(v);
    closeOperator();
  }

  // ---------- helpers ----------
  function itemStatus(n){
    const st = (String(n.last_status || "")).trim().toUpperCase();
    if(st === "OK") return "OK";
    if(st === "NOT_OK") return "NOT_OK";
    return "TODO"; // non vérifié => BLEU
  }
  function statusOf(node){
    if((node.type||"").toUpperCase()==="ITEM"){
      return itemStatus(node);
    }
    const ch = node.children || [];
    if(!ch.length) return "TODO";
    let hasTodo = false;
    for(const c of ch){
      const s = statusOf(c);
      if(s === "NOT_OK") return "NOT_OK";
      if(s === "TODO") hasTodo = true;
    }
    return hasTodo ? "TODO" : "OK";
  }
  function subtreeAllOK(node){
    if((node.type||"").toUpperCase()==="ITEM") return itemStatus(node)==="OK";
    for(const c of (node.children||[])){
      if(!subtreeAllOK(c)) return false;
    }
    return true;
  }
  function el(tag, props, ...children){
    const n = document.createElement(tag);
    if(props) for(const [k,v] of Object.entries(props)){
      if(k === "class") n.className = v;
      else if(k.startsWith("on") && typeof v === "function") n.addEventListener(k.substring(2), v);
      else if(v !== undefined && v !== null) n.setAttribute(k, v);
    }
    for(const c of children){
      if(c == null) continue;
      if(Array.isArray(c)) n.append(...c.map(x=>typeof x === "string" ? document.createTextNode(x) : x));
      else n.append(typeof c === "string" ? document.createTextNode(c) : c);
    }
    return n;
  }
  function ensureOk(res){
    if(!res.ok){ return res.text().then(t=>{ throw new Error(t || "Erreur réseau"); }); }
    return res;
  }

  // ---------- peremption (détection étendue) ----------
  function parseMaybeDate(v){
    if(!v) return null;
    if(typeof v === "number"){
      if(v > 10_000_000_000) return new Date(v);
      return new Date(v*1000);
    }
    const d = new Date(v);
    if(!isNaN(d.getTime())) return d;
    return null;
  }
  function _fromMeta(node, key){
    if(node && typeof node === "object"){
      if(node.meta && typeof node.meta === "object" && node.meta[key] != null) return node.meta[key];
      if(node.data && typeof node.data === "object" && node.data[key] != null) return node.data[key];
    }
    return null;
  }
  function expiryDate(node){
    const keys = [
      "expiry","expiry_date","expires_at",
      "peremption","peremption_date",
      "valid_until","expiration","expiration_date",
      "dlc","dlc_date","dlu","dluo",
      "best_before","best_before_date"
    ];
    for(const k of keys){
      let v = node[k];
      if(v == null) v = _fromMeta(node, k);
      const d = parseMaybeDate(v);
      if(d) return d;
    }
    return null;
  }
  function expiryDaysLeft(node){
    const dayKeys = ["days_to_expiry","days_left","remaining_days","peremption_days","daysRemaining"];
    for(const k of dayKeys){
      let v = node[k];
      if(v == null) v = _fromMeta(node, k);
      if(v == null) continue;
      const n = Number(v);
      if(!Number.isNaN(n)) return n;
    }
    return null;
  }
  function expirySoon(node){
    const days = expiryDaysLeft(node);
    if(days != null){
      return days >= 0 && days <= PEREMPTION_DAYS;
    }
    const d = expiryDate(node);
    if(!d) return false;
    const now = new Date();
    const diff = (d - now) / (1000*60*60*24);
    return diff <= PEREMPTION_DAYS;
  }
  function expiryLabel(node){
    const days = expiryDaysLeft(node);
    if(days != null) return `Péremption proche : ${days}j`;
    const d = expiryDate(node);
    return d ? `Péremption proche : ${d.toLocaleDateString()}` : "Péremption proche";
  }
  function warnIcon(titleText){
    const wrap = document.createElement("span");
    wrap.className = "warn-ic";
    wrap.title = titleText || "Péremption proche";
    wrap.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M1,21H23L12,2L1,21ZM13,18H11V16H13V18ZM13,14H11V10H13V14Z"/></svg>';
    return wrap;
  }

  // ---------- API ----------
  async function refreshTree(){
    try{
      const r = await fetch(`/public/event/{{ token }}/tree`, {cache:"no-store"});
      if(!r.ok) return;
      const latest = await r.json();
      syncTree(latest);
    }catch(e){}
  }

  // ---------- render ----------
  function statusChip(st){
    const map = {
      "OK":["chip ok","OK"],
      "NOT_OK":["chip bad","Non conforme"],
      "TODO":["chip wait","À vérifier"],
      null:["chip wait","À vérifier"],
      undefined:["chip wait","À vérifier"]
    };
    const [klass,label] = map[st] || map["TODO"];
    return el("span",{class:klass, title:label}, el("span",{class:"dot " + (st==="OK"?"ok":st==="NOT_OK"?"bad":"wait")}), label);
  }

  function renderParents(roots){
    const bar = document.getElementById("parentsBar");
    bar.innerHTML = "";
    (roots||[]).forEach(r=>{
      const canCharge = subtreeAllOK(r);
      const pill = el("div",{class:"parent"},
        el("span",{class:"dot " + (r.charged_vehicle ? "ok" : "wait")}),
        el("span",{class:"name"}, r.name),
        el("span",{class:"veh"},
          r.charged_vehicle_name ? "• " + r.charged_vehicle_name : "",
          r.charged_vehicle_by ? " – chargé par " + r.charged_vehicle_by : ""
        ),
        el("span",{class:"state"},
          el("button",{
            class:"btn primary",
            // ⬇️ modif : bouton désactivé seulement si PAS encore chargé ET pas tout OK
            disabled: (!r.charged_vehicle && !canCharge),
            title: (!r.charged_vehicle && !canCharge) ? "Disponible quand tous les éléments du parent sont OK" : "",
            onclick:()=>openVehicle(r.id, r.charged_vehicle_name||"")
          }, r.charged_vehicle ? "Modifier" : "Marquer chargé")
        )
      );
      bar.appendChild(pill);
    });
  }

  function renderTree(){
    NODE_MAP.clear();
    const cont = document.getElementById("tree");
    cont.innerHTML = "";
    for(const r of TREE){
      cont.appendChild(renderNode(r, true));
    }
  }

  function renderNode(n, isRoot){
    NODE_MAP.set(n.id, n);
    const nStatus = statusOf(n); // "OK" | "NOT_OK" | "TODO"
    if((n.type||"").toUpperCase()==="ITEM"){
      const classes = ["item"];
      if(nStatus==="OK") classes.push("ok");
      else if(nStatus==="NOT_OK") classes.push("bad");
      else classes.push("wait"); // TODO -> bleu

      const nameAreaChildren = [ document.createTextNode(n.name) ];
      if(expirySoon(n)){
        nameAreaChildren.push(warnIcon(expiryLabel(n)));
      }

      return el("div",{class:classes.join(" ")},
        el("div",{class:"name-area"}, nameAreaChildren),
        el("div",{class:"right"},
          statusChip(nStatus),
          n.last_by ? el("span",{class:"small muted"},"(", n.last_by ,")") : null,
          el("button",{class:"btn success", onclick:()=>verify(n.id,"OK")}, "OK"),
          el("button",{class:"btn danger", onclick:()=>verify(n.id,"NOT_OK")}, "Non conforme")
        )
      );
    }else{
      const classes = ["group"];
      if(nStatus==="OK") classes.push("ok");
      else if(nStatus==="NOT_OK") classes.push("bad");
      else classes.push("wait"); // TODO -> bleu pour groupe aussi

      const children = (n.children||[]).map(c=>renderNode(c,false));
      return el("div",{class:classes.join(" ")},
        el("div",{class:"head"},
          el("strong",{}, n.name),
          isRoot && n.charged_vehicle ? el("span",{class:"chip ok"}, el("span",{class:"dot ok"}),"Chargé", n.charged_vehicle_by ? " par "+n.charged_vehicle_by : "") : null
        ),
        el("div",{}, children)
      );
    }
  }

  function syncTree(latest){
    TREE = latest || [];
    renderTree();
    renderParents(TREE);
  }

  // ---------- actions ----------
  async function verify(nodeId, status){
    if(!ensureOperator()){ return; }
    try{
      await fetch(`/public/event/{{ token }}/verify`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ node_id: nodeId, status, verifier_name: getOperator() })
      }).then(ensureOk);
      await refreshTree();
    }catch(e){
      alert(e.message || "Échec de la validation");
    }
  }

  // vehicle
  function openVehicle(parentId, currentName){
    CURRENT_PARENT_ID = parentId;
    document.getElementById("vehInput").value = currentName || "";
    document.getElementById("vehTitle").textContent = currentName ? "Modifier le véhicule" : "Marquer comme chargé";
    document.getElementById("dlgVehicle").showModal();
  }
  function closeVehicle(){ document.getElementById("dlgVehicle").close(); }
  async function saveVehicle(ev){
    ev.preventDefault();
    const vehicle = (document.getElementById("vehInput").value || "").trim();
    if(!vehicle){ alert("Nom du véhicule requis"); return; }
    const parent = NODE_MAP.get(CURRENT_PARENT_ID);
    if(!subtreeAllOK(parent) && !parent.charged_vehicle){
      alert("Vous ne pouvez charger que lorsque tous les éléments du parent sont OK.");
      return;
    }
    try{
      await fetch(`/public/event/{{ token }}/charge`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          node_id: CURRENT_PARENT_ID,
          vehicle_name: vehicle,
          operator_name: getOperator() || null
        })
      }).then(ensureOk);
      await refreshTree();
      closeVehicle();
    }catch(e){
      alert(e.message || "Échec enregistrement véhicule");
    }
  }

  // ---------- boot ----------
  (function init(){
    setOperator(getOperator()); // affiche si déjà stocké
    if(!getOperator()){ setTimeout(()=>openOperator(true), 50); }
    refreshTree();
    setInterval(refreshTree, 5000);
  })();
</script>
{% endblock %}
