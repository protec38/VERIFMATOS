{% extends "base.html" %}
{% set title = "Vérification du matériel (secouristes)" %}
{% block content %}
<div class="card">
  <div class="row space-between wrap">
    <div>
      <div class="title">{{ event.name }}</div>
      <div class="muted" style="margin-top:4px;">Date : {{ event.date or "—" }}</div>
    </div>
    <span class="badge" id="status-badge">Statut : {{ event.status }}</span>
  </div>
  <div class="row" style="margin-top:10px;">
    <input id="who" placeholder="Votre nom & prénom" style="min-width:280px;">
    <button class="btn" id="save-who">Enregistrer</button>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="title">Matériel à vérifier</div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<script>
  const EVENT_ID = {{ event.id }};
  const TOKEN = "{{ token }}";
  let TREE = {{ (tree or [])|tojson }};

  // Préremplir nom
  const whoInput = document.getElementById("who");
  whoInput.value = localStorage.getItem("pcprep_who") || "";
  document.getElementById("save-who").addEventListener("click", ()=>{
    localStorage.setItem("pcprep_who", whoInput.value.trim());
    alert("Nom enregistré");
  });

  // Socket.IO join room
  const socket = io({ transports: ["websocket","polling"], timeout: 2000 });
  socket.on("connect", ()=> socket.emit("join_event", {event_id: EVENT_ID}));
  socket.on("event_update", (msg)=>{
    if(!msg || msg.event_id !== EVENT_ID) return;
    if(msg.type==="item_verified") applyItemVerification(msg.node_id, msg.status, msg.by);
    else if (msg.type==="event_closed" || msg.type==="event_opened"){
      document.getElementById("status-badge").textContent = "Statut : " + (msg.type==="event_closed"?"CLOSED":"OPEN");
    }
  });

  const parentOf = new Map();
  function el(tag, attrs={}, ...children){
    const e = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class") e.className = v;
      else if(k==="html") e.innerHTML = v;
      else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
      else e.setAttribute(k, v);
    }
    for(const c of children){ e.append(c?.nodeType?c:document.createTextNode(c)); }
    return e;
  }

  function renderTreeNode(n){
    const isGroup = n.type==="GROUP";
    const node = el("div", {class:"node", id:"node-"+n.id, "data-type":n.type});
    const header = el("div",{class:"header"});
    const name = el("div",{class:"name"}, n.name);
    if(isGroup){
      const badge = el("span",{class:"badge", id:"badge-"+n.id}, n.complete ? "✓ Complet" : "À vérifier");
      header.append(name, badge);
    } else {
      const qty = el("span",{class:"qty"}, "Qté: "+(n.quantity ?? "—"));
      const state = el("span",{class:"badge", id:"state-"+n.id}, n.last_status==="OK" ? ("OK • "+(n.last_by||"")) : "—");
      header.append(name, el("div",{class:"row"}, qty, state));
    }
    node.append(header);

    const childrenWrap = el("div",{class:"childs"});
    (n.children||[]).forEach(ch => {
      parentOf.set(ch.id, n.id);
      childrenWrap.append(renderTreeNode(ch));
    });

    if(!isGroup){
      const actions = el("div",{class:"item", id:"item-actions-"+n.id});
      const btnOk = el("button",{class:"btn", onclick: ()=>verifyPublic(n.id,"OK")}, "OK");
      const btnKo = el("button",{class:"btn ghost", onclick: ()=>verifyPublic(n.id,"NOT_OK")}, "Non conforme");
      actions.append(el("div",{class:"muted"},"Vérification"), el("div",{class:"row"}, btnOk, btnKo));
      childrenWrap.append(actions);
      if(n.last_status==="OK") actions.style.opacity = .6;
    }

    node.append(childrenWrap);
    return node;
  }

  function renderTree(){
    const treeEl = document.getElementById("tree");
    treeEl.innerHTML = "";
    parentOf.clear();
    TREE.forEach(root => treeEl.append(renderTreeNode(root)));
    recomputeAll();
  }

  function allItemNodesIn(groupEl){ return groupEl.querySelectorAll('.node[data-type="ITEM"]'); }
  function okItemsIn(groupEl){ return groupEl.querySelectorAll('.node[data-type="ITEM"] .badge[id^="state-"]:not(:empty)'); }
  function markGroupBadge(groupId){
    const groupEl = document.getElementById("node-"+groupId);
    if(!groupEl) return;
    const badge = document.getElementById("badge-"+groupId);
    if(!badge) return;
    const total = allItemNodesIn(groupEl).length;
    const oks = okItemsIn(groupEl).length;
    badge.textContent = (total>0 && oks===total) ? "✓ Complet" : `À vérifier (${oks}/${total})`;
  }
  function recomputeAll(){
    TREE.forEach(function walk(n){
      if(n.type==="GROUP") markGroupBadge(n.id);
      (n.children||[]).forEach(walk);
    });
  }

  function applyItemVerification(nodeId, status, by){
    const state = document.getElementById("state-"+nodeId);
    const actions = document.getElementById("item-actions-"+nodeId);
    if(state) state.textContent = status==="OK" ? `OK • ${by||""}` : `Non conforme • ${by||""}`;
    if(actions && status==="OK") actions.style.opacity = .6;
    let p = parentOf.get(nodeId);
    while(p){ markGroupBadge(p); p = parentOf.get(p); }
  }

  function verifyPublic(nodeId, status){
    const who = (whoInput.value||"").trim();
    if(!who){ alert("Merci d’indiquer votre nom & prénom (en haut)"); whoInput.focus(); return; }
    fetch(`/public/event/${TOKEN}/verify`, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({node_id: nodeId, status, verifier_name: who})
    }).then(r=>r.ok?r.json():r.json().then(e=>Promise.reject(e)))
      .then(()=>{/* push temps réel par le serveur */})
      .catch(e=>alert(e?.error||"Erreur"));
  }

  renderTree();
</script>
{% endblock %}
