{% extends "base.html" %}
{% set title = "Vérification Secouriste" %}
{% block content %}

<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --pad-xs: 6px;
    --pad-sm: 10px;
    --pad-md: 14px;
    --pad-lg: 18px;
    --radius: 14px;
    --shadow: 0 6px 22px rgba(0,0,0,.25);
    --muted: #9fb0c6;
    --bg-card: #0f1726;
    --bg-block:#0f1a2a;
  }
  /* Layout */
  .wrap{max-width:1100px;margin:0 auto;padding:var(--pad-md)}
  .topbar{
    display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;
    padding:var(--pad-md);border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-2);box-shadow:var(--shadow);
    position:sticky;top:8px;z-index:10
  }
  .topbar .title{font-weight:800;font-size:18px}
  .name-edit{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .name-edit input{min-width:240px;background:#0b1120;border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text)}
  .name-edit .btn{padding:10px 12px;border-radius:10px}

  .parents-card,.board{
    margin-top:12px;padding:var(--pad-md);border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-2)
  }
  .parents-card .title{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .parents-bar{display:flex;gap:10px;overflow:auto;padding:4px 2px}
  .parent-pill{
    display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--border);
    background:#0f1a2a;color:var(--text);white-space:nowrap;cursor:pointer;user-select:none;transition:transform .08s,border-color .08s,background .08s
  }
  .parent-pill:hover{transform:translateY(-1px)}
  .pill-ok{border-color:#1d6e5d;background:#0e2a24;color:#bff3e7}
  .pill-bad{border-color:#75212f;background:#2a0e14;color:#ffd5dc}
  .pill-wait{border-color:#24344f;background:#101c2e;color:#b7c7dc}

  .board .legend{color:var(--muted);font-size:13px}

  /* Groupes & Items */
  .node{border:1px solid var(--border);border-radius:12px;padding:var(--pad-sm);margin:12px 0;background:var(--bg-block)}
  .state-ok{
    border-color:var(--success)!important;background:radial-gradient(600px 200px at top left, rgba(18,184,134,.15), transparent),#0f1e2f;
    box-shadow:0 0 0 1px rgba(18,184,134,.35) inset,0 0 18px rgba(18,184,134,.15)
  }
  .state-bad{
    border-color:var(--danger)!important;background:radial-gradient(600px 200px at top left, rgba(255,107,107,.12), transparent),#0f1a27;
    box-shadow:0 0 0 1px rgba(255,107,107,.30) inset,0 0 18px rgba(255,107,107,.12)
  }
  .state-wait{border-color:var(--border)!important;background:radial-gradient(600px 200px at top left, rgba(45,123,191,.08), transparent),var(--bg-2)}
  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .dot-ok{background:var(--success)} .dot-bad{background:var(--danger)} .dot-wait{background:#37527a}

  .chip{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border)}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.wait{background:#101c2e;color:#b7c7dc;border-color:#24344f}

  .header{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;border-radius:10px}
  .toggle{cursor:pointer}
  .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .name{font-weight:800}
  .meta{font-size:12px;color:var(--muted)}
  .chev{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;opacity:.9}
  .veh{font-size:12px;opacity:.95;padding:2px 6px;border-radius:6px;border:1px dashed var(--border)}
  .veh.on{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .veh.off{background:#101c2e;color:#b7c7dc;border-color:#24344f}

  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn.xs{padding:8px 12px;border-radius:10px;font-size:14px}
  .btn.primary{background:var(--pc-orange);color:#000}

  .childs{padding:10px 8px 6px 28px}
  .childs.collapsed{display:none}

  .item{
    display:flex;align-items:flex-start;gap:14px;justify-content:space-between;
    padding:14px;border-radius:12px;margin:12px 0;border:1px solid var(--border);background:var(--bg-card)
  }
  .item .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .label{font-weight:800}
  .qty{opacity:.9;font-size:12px;border:1px dashed var(--border);border-radius:8px;padding:2px 8px}
  .warn{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:2px 8px;border-radius:8px;border:1px solid #7a5d1e;background:#221a07;color:#ffd679}

  /* Responsive aéré */
  @media (max-width: 640px){
    .topbar{gap:12px}
    .item,.header{padding:14px}
    .item .right .btn{width:100%}
    .childs{padding-left:14px}
  }
  @media (min-width: 900px){
    .childs{padding-left:34px}
    .item{padding:16px 18px}
  }
</style>

<div class="wrap">
  <!-- Nom / prénom -->
  <div class="topbar">
    <div class="title">Vérification secouriste</div>
    <div class="name-edit">
      <label for="opname" class="muted">Nom & Prénom :</label>
      <input id="opname" placeholder="Ex : Dupont Marie" />
      <button class="btn" id="save-name">Enregistrer</button>
    </div>
  </div>

  <!-- Barre parents -->
  <div class="parents-card">
    <div class="title">Parents</div>
    <div id="parents-bar" class="parents-bar"></div>
  </div>

  <!-- Arbre -->
  <div class="board">
    <div class="row space-between">
      <div class="title">Matériel</div>
      <div class="legend">Vert = tout OK • Rouge = non conforme • Bleu = en attente • ⚠️ proche péremption</div>
    </div>
    <div id="tree"></div>
  </div>
</div>

<script>
/* ====== Contexte ====== */
const TOKEN = "{{ token }}";
let TREE = [];
const NODE_MAP  = new Map();        // id -> node (référence locale)
const GROUP_EL  = new Map();        // id -> element group
const ITEM_EL   = new Map();        // id -> element item
const VEH_LABEL = new Map();        // id -> badge véhicule
const COLLAPSED = new Map();        // id -> bool (plié) pour TOUS les groupes
let ROOT_IDS    = new Set();        // ids des parents racines

/* ====== Nom opérateur (persisté) ====== */
const NAME_KEY = "pcprep_public_operator";
function getOperator(){ return (localStorage.getItem(NAME_KEY) || "").trim(); }
function setOperator(v){ localStorage.setItem(NAME_KEY, (v||"").trim()); }
const opname = document.getElementById("opname");
document.getElementById("save-name").addEventListener("click", ()=>{ setOperator(opname.value); alert("Nom enregistré."); });
window.addEventListener("DOMContentLoaded", ()=>{ opname.value = getOperator(); });

/* ====== Utilitaires ====== */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
const isItem  = n => (n.type||"").toUpperCase()==="ITEM";
const isGroup = n => (n.type||"").toUpperCase()==="GROUP";
function normStatus(s){
  s = (s||"").toUpperCase();
  if(s==="OK") return "OK";
  if(s==="NOT_OK" || s==="NOK" || s==="KO" || s==="NOT-OK" || s==="NOTOK") return "NOT_OK";
  return "PENDING"; // TODO / PENDING -> attente
}
function daysUntil(iso){
  if(!iso) return null;
  try{ const d=new Date(iso+"T00:00:00"); const now=new Date(); return Math.ceil((d-now)/86400000); }catch(_){ return null; }
}
function statusLabel(s){
  s = normStatus(s);
  return s==="OK" ? "OK" : (s==="NOT_OK" ? "Non conforme" : "En attente");
}
function fmtDate(iso){
  if(!iso) return "";
  try{ const d=new Date(iso); return d.toLocaleString('fr-FR',{dateStyle:'short',timeStyle:'short'}); }catch(_){ return ""; }
}

/* ====== Règles statut ====== */
function flattenItems(nodes){ const out=[]; (nodes||[]).forEach(function rec(n){ if(isItem(n)) out.push(n); (n.children||[]).forEach(rec); }); return out; }
function groupAllOk(n){ const items=flattenItems([n]); return items.length>0 && items.every(i=>normStatus(i.last_status)==="OK"); }
function groupHasBad(n){ return flattenItems([n]).some(i=>normStatus(i.last_status)==="NOT_OK"); }
function groupStatus(n){ if(groupAllOk(n)) return "OK"; if(groupHasBad(n)) return "BAD"; return "WAIT"; }
function canChargeGroup(n){ return groupAllOk(n); }

/* ====== Barre parents ====== */
function statusDot(isOk, isBad){ return el("span",{class:"status-dot "+(isOk?"dot-ok":(isBad?"dot-bad":"dot-wait"))}); }
function buildParentsBar(){
  const holder = document.getElementById("parents-bar");
  holder.innerHTML = "";
  (TREE||[]).forEach(p=>{
    if(!isGroup(p)) return;
    const s   = groupStatus(p);
    const cls = s==="OK" ? "pill-ok" : (s==="BAD" ? "pill-bad" : "pill-wait");
    const pill = el("div",{class:"parent-pill "+cls, onclick:()=>scrollAndOpen(p.id)},
      statusDot(s==="OK", s==="BAD"),
      el("span",{class:"strong"}, p.name),
      p.charged_vehicle ? el("span",{class:"veh on"}, p.charged_vehicle_name || "—") : null
    );
    holder.appendChild(pill);
  });
}
function scrollAndOpen(id){
  COLLAPSED.set(id,false);
  const cont = document.getElementById("childs-"+id);
  const chev = document.getElementById("chev-"+id);
  if(cont){ cont.classList.remove("collapsed"); }
  if(chev){ chev.textContent = "▾"; }
  const target = document.getElementById("node-"+id);
  if(target){ target.scrollIntoView({behavior:"smooth", block
