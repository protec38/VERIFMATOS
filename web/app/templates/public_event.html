{% extends "base.html" %}
{% set title = "V√©rification du mat√©riel (secouristes)" %}
{% block content %}

<style>
  .state-ok{
    border-color: var(--success) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(18,184,134,.15), transparent),
      #0f1e2f;
    box-shadow: 0 0 0 1px rgba(18,184,134,.35) inset, 0 0 18px rgba(18,184,134,.15);
  }
  .state-bad{
    border-color: var(--danger) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(255,107,107,.12), transparent),
      #0f1a27;
    box-shadow: 0 0 0 1px rgba(255,107,107,.30) inset, 0 0 18px rgba(255,107,107,.12);
  }
  .state-wait{
    border-color: var(--border) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(45,123,191,.08), transparent),
      var(--bg-2);
  }
  .chip{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border);}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.wait{background:#101c2e;color:#b7c7dc;border-color:#24344f}

  /* >>> on garde ton choix: plus de clignotement */
  .blink{animation:none}

  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .dot-ok{background:var(--success)} .dot-bad{background:var(--danger)} .dot-wait{background:#37527a}

  /* Tag v√©hicule sur les groupes */
  .vehicle-tag { margin-left:8px; font-size:12px; opacity:.9; display:inline-flex; gap:4px; align-items:center; }
  .vehicle-tag .car { filter: drop-shadow(0 0 4px rgba(255,255,255,.05)); }
</style>

<div class="card">
  <div class="row space-between">
    <div>
      <div class="title">{{ event.name }}</div>
      <div class="muted">Date : {{ event.date or "‚Äî" }}</div>
    </div>
    <span class="badge">Acc√®s secouristes</span>
  </div>
  <div class="row wrap" style="margin-top:10px;">
    <span class="chip ok" id="stat-ok">OK : 0</span>
    <span class="chip bad" id="stat-bad">Non conformes : 0</span>
    <span class="chip wait" id="stat-wait">En attente : 0</span>
  </div>
  <div class="progress" style="margin-top:10px;"><div id="progress-bar" style="width:0%"></div></div>
  <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 v√©rifi√©s</div>
</div>

<!-- Porte d'entr√©e pour le nom & pr√©nom -->
<div id="gate" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:1000;">
  <div class="card" style="width:min(560px,92vw);">
    <div class="title">Avant de commencer</div>
    <div class="subtitle">Merci d‚Äôindiquer votre <b>Nom & pr√©nom</b> ‚Äî il sera affich√© √† c√¥t√© des validations.</div>
    <div class="row" style="margin-top:10px;">
      <input id="who" placeholder="Nom & pr√©nom" style="flex:1" autocomplete="name">
      <button class="btn primary" id="start">Commencer</button>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="row space-between">
    <div class="title">√Ä v√©rifier</div>
    <div class="muted" id="who-display"></div>
  </div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<script>
const TOKEN = "{{ token }}";
let TREE = {{ (tree or [])|tojson }};
const LS_KEY = "verifier_name_" + TOKEN;
let VERIFIER_NAME = localStorage.getItem(LS_KEY) || "";

/* hash simple pour √©viter de rerendre si rien n‚Äôa chang√© */
let _lastHash = "";
function hash(obj){ try { return JSON.stringify(obj); } catch { return ""; } }

// Helpers DOM
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
const isItem = n => (n.type||"").toUpperCase()==="ITEM";
const isGroup = n => (n.type||"").toUpperCase()==="GROUP";

function groupAllOk(n){
  let ok = true, hasItem=false;
  (function rec(x){
    if(isItem(x)){ hasItem=true; ok = ok && (x.last_status==="OK"); }
    (x.children||[]).forEach(rec);
  })(n);
  return hasItem && ok;
}
function groupHasBad(n){
  let bad=false;
  (function rec(x){
    if(isItem(x) && x.last_status==="NOT_OK") bad=true;
    (x.children||[]).forEach(rec);
  })(n);
  return bad;
}
function flattenItems(nodes){
  const out=[]; (nodes||[]).forEach(function rec(n){
    if(isItem(n)) out.push(n);
    (n.children||[]).forEach(rec);
  });
  return out;
}
function recomputeStats(){
  const items = flattenItems(TREE);
  const total = items.length;
  const ok = items.filter(i=>i.last_status==="OK").length;
  const bad = items.filter(i=>i.last_status==="NOT_OK").length;
  const wait = total - ok - bad;

  document.getElementById("stat-ok").textContent = `OK : ${ok}`;
  document.getElementById("stat-bad").textContent = `Non conformes : ${bad}`;
  document.getElementById("stat-wait").textContent = `En attente : ${wait}`;
  const pct = total? Math.round(ok/total*100) : 0;
  document.getElementById("progress-bar").style.width = pct+"%";
  document.getElementById("progress-text").textContent = `${ok} / ${total} v√©rifi√©s`;
}

function itemStateClass(n){
  if(n.last_status==="OK") return "state-ok";
  if(n.last_status==="NOT_OK") return "state-bad";
  return "state-wait";
}
function groupStateClass(n){
  if(groupAllOk(n)) return "state-ok";
  if(groupHasBad(n)) return "state-bad";
  return "state-wait";
}
function stateDot(n, isGroupNode){
  let cls="dot-wait", label="En attente";
  if(isGroupNode){
    if(groupAllOk(n)) { cls="dot-ok"; label="Tout OK"; }
    else if(groupHasBad(n)) { cls="dot-bad"; label="Non conformes pr√©sents"; }
  } else {
    if(n.last_status==="OK"){ cls="dot-ok"; label="OK"; }
    else if(n.last_status==="NOT_OK"){ cls="dot-bad"; label="Non conforme"; }
  }
  return el("span", {class:"status-dot "+cls, title:label});
}

/* --- NOUVEAU: tag v√©hicule dans l'en-t√™te de groupe --- */
function vehicleTagFor(n){
  const span = el("span", {class:"vehicle-tag", id:`veh-${n.id}`});
  if(n.vehicle_label){ span.innerHTML = `<span class="car">üöê</span><span>${n.vehicle_label}</span>`; }
  return span;
}

/* --- Rendu --- */
function renderItem(n){
  const statusLbl = n.last_status ? (n.last_status==="OK" ? "‚úÖ OK" : "‚ùå Non conforme") : "‚è≥ En attente";
  const by = n.last_by ? ` (${n.last_by})` : "";
  const right = el("div", {class:"row"},
    el("button", {class:"btn success", onclick:()=>verify(n.id,"OK")}, "OK"),
    el("button", {class:"btn ghost", onclick:()=>verify(n.id,"NOT_OK")}, "Non conforme"),
  );
  const wrap = el("div", {class:"item "+itemStateClass(n)},
    el("div", null,
      el("div", {class:"name"}, stateDot(n,false), n.name, " ", el("span", {class:"qty"}, `Qt√©: ${n.quantity ?? 1}`)),
      el("div", {class:"muted"}, `Dernier statut: ${statusLbl}${by}`)
    ),
    right
  );
  return wrap;
}

function renderGroup(n){
  // Ent√™te avec nom + tag v√©hicule
  const headerLeft = el("div", {class:"name"}, stateDot(n,true), n.name, vehicleTagFor(n));

  // NOUVEAU: case √† cocher "Charg√© dans le v√©hicule" c√¥t√© secouristes
  const canMarkCharged = groupAllOk(n); // seulement si tout OK
  const chargedCb = el("input", {
    type:"checkbox",
    onchange:(e)=>setCharged(n, e.target),
    disabled: !canMarkCharged
  });
  if(n.charged_vehicle) chargedCb.checked = true;

  const headerRight = el("label", {class:"check"},
    chargedCb,
    el("span", null, "Charg√© dans le v√©hicule")
  );

  const header = el("div", {class:"header"}, headerLeft, headerRight);
  const children = el("div", {class:"childs"}, ...(n.children||[]).map(renderNode));
  const box = el("div", {class:`node ${groupStateClass(n)}`, id:`node-${n.id}`}, header, children);
  return box;
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

function buildUI(){
  document.getElementById("who-display").textContent = VERIFIER_NAME ? `V√©rificateur : ${VERIFIER_NAME}` : "";
  const root = document.getElementById("tree");
  root.innerHTML = "";
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
  recomputeStats();
}

/* --- Polling --- */
function fetchTree(){
  fetch(`/public/event/${TOKEN}/tree`, {headers:{'Accept':'application/json'}})
    .then(r=>r.json())
    .then(json => {
      const h = hash(json);
      if (h !== _lastHash) {
        TREE = json;
        _lastHash = h;
        buildUI();
      } else {
        recomputeStats();
      }
    })
    .catch(()=>{});
}

/* --- V√©rifier un item --- */
function verify(nodeId, status){
  if(!VERIFIER_NAME){ showGate(); return; }
  fetch(`/public/event/${TOKEN}/verify`, {
    method:"POST",
    headers:{"Content-Type":"application/json", "Accept":"application/json"},
    body: JSON.stringify({node_id: nodeId, status, verifier_name: VERIFIER_NAME})
  }).then(()=> fetchTree());
}

/* --- NOUVEAU : Marquer un groupe "charg√©" + saisie v√©hicule --- */
function setCharged(groupNode, checkboxEl){
  if(!VERIFIER_NAME){ checkboxEl.checked = false; showGate(); return; }

  // V√©rification locale: on ne permet de charger que si tout OK
  if(checkboxEl.checked && !groupAllOk(groupNode)){
    alert("Ce parent n‚Äôest pas enti√®rement OK. Termine les v√©rifications avant de le marquer comme charg√©.");
    checkboxEl.checked = false;
    return;
  }

  if(checkboxEl.checked){
    const veh = (prompt("Dans quel v√©hicule est-ce charg√© ? (ex: VSAV 1)") || "").trim();
    if(!veh){
      checkboxEl.checked = false; // revert
      return;
    }
    fetch(`/public/event/${TOKEN}/parent-status`, {
      method:"POST",
      headers:{"Content-Type":"application/json","Accept":"application/json"},
      body: JSON.stringify({node_id: groupNode.id, charged_vehicle: true, vehicle_label: veh, verifier_name: VERIFIER_NAME})
    })
    .then(async res=>{
      if(!res.ok){
        const t = await res.text();
        alert(t || "Impossible de marquer comme charg√©.");
        checkboxEl.checked = false;
      }
      fetchTree();
    })
    .catch(()=>{
      alert("Fonction non disponible (parent-status).");
      checkboxEl.checked = false;
    });
  }else{
    fetch(`/public/event/${TOKEN}/parent-status`, {
      method:"POST",
      headers:{"Content-Type":"application/json","Accept":"application/json"},
      body: JSON.stringify({node_id: groupNode.id, charged_vehicle: false, verifier_name: VERIFIER_NAME})
    })
    .then(()=> fetchTree())
    .catch(()=> {
      alert("Fonction non disponible (parent-status).");
      checkboxEl.checked = true; // revert en cas d‚Äôerreur de d√©chargement
    });
  }
}

/* Gate (nom & pr√©nom) */
function showGate(){ const gate = document.getElementById("gate"); gate.style.display = "flex"; document.getElementById("who").focus(); }
function hideGate(){ document.getElementById("gate").style.display = "none"; }

document.getElementById("start").addEventListener("click", ()=>{
  const name = (document.getElementById("who").value||"").trim();
  if(!name){ alert("Merci d‚Äôindiquer Nom & pr√©nom"); return; }
  VERIFIER_NAME = name;
  localStorage.setItem(LS_KEY, VERIFIER_NAME);
  hideGate();
  buildUI();
  setInterval(fetchTree, 2000);
});

/* D√©marrage */
if(VERIFIER_NAME){
  hideGate();
  buildUI();
  setInterval(fetchTree, 2000);
}else{
  showGate();
}
</script>
{% endblock %}
