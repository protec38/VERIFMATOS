{% extends "base.html" %}
{% set title = "Vérification du matériel (secouristes)" %}
{% block content %}
<div class="card">
  <div class="row space-between">
    <div>
      <div class="title">{{ event.name }}</div>
      <div class="muted">Date : {{ event.date or "—" }}</div>
    </div>
    <span class="badge">Accès secouristes</span>
  </div>
  <div class="alert" style="margin-top:10px;">
    Merci d’indiquer votre <b>Nom & prénom</b> pour chaque vérification effectuée.
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="title">À vérifier</div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<script>
const TOKEN = "{{ token }}";
let TREE = {{ (tree or [])|tojson }};

function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
function isItem(n){ return (n.type||"").toUpperCase()==="ITEM"; }
function isGroup(n){ return (n.type||"").toUpperCase()==="GROUP"; }
function groupAllOk(n){
  let ok = true, hasItem=false;
  (function rec(x){ if(isItem(x)){hasItem=true; ok = ok && (x.last_status==="OK");} (x.children||[]).forEach(rec); })(n);
  return hasItem && ok;
}

function renderItem(n){
  const status = n.last_status ? (n.last_status==="OK" ? "✅ OK" : "⚠️ Non conforme") : "—";
  const by = n.last_by ? ` (${n.last_by})` : "";
  const right = el("div", {class:"row"},
    el("input", {type:"text", placeholder:"Nom & prénom", id:`name-${n.id}`}),
    el("button", {class:"btn success", onclick:()=>verify(n.id,"OK")}, "OK"),
    el("button", {class:"btn ghost", onclick:()=>verify(n.id,"NOT_OK")}, "Non conforme"),
  );
  return el("div", {class:"item"},
    el("div", null,
      el("div", {class:"name"}, `${n.name} `, el("span", {class:"qty"}, `Qté: ${n.quantity ?? 1}`)),
      el("div", {class:"muted"}, `Dernier statut: ${status}${by}`)
    ),
    right
  );
}
function renderGroup(n){
  const okIcon = groupAllOk(n) ? "✅" : "";
  const header = el("div", {class:"header"},
    el("div", {class:"name"}, `${okIcon} ${n.name}`),
  );
  const children = el("div", {class:"childs"}, ...(n.children||[]).map(renderNode));
  return el("div", {class:"node", id:`node-${n.id}`}, header, children);
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

function buildUI(){
  const root = document.getElementById("tree");
  root.innerHTML = "";
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
}

function fetchTree(){
  fetch(`/public/event/${TOKEN}/tree`)
    .then(r=>r.json())
    .then(json => { TREE = json; buildUI(); })
    .catch(()=>{});
}

function verify(nodeId, status){
  const name = (document.getElementById(`name-${nodeId}`)?.value||"").trim();
  if(!name){ alert("Merci de renseigner votre nom et prénom"); return; }
  fetch(`/public/event/${TOKEN}/verify`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({node_id: nodeId, status, verifier_name: name})
  }).then(()=> fetchTree());
}

// Premier rendu, puis polling toutes les 2 secondes
buildUI();
setInterval(fetchTree, 2000);
</script>
{% endblock %}
