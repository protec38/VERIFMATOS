{% extends "base.html" %}
{% set title = "Péremptions — " ~ (item.name or "Item") %}
{% block content %}
<style>
  .card{background:radial-gradient(1200px 400px at top left,rgba(255,255,255,.03),transparent),var(--bg-2);
    border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .row{display:flex;gap:8px;align-items:center}.wrap{flex-wrap:wrap}.space-between{justify-content:space-between}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;text-decoration:none;
    cursor:pointer;border:1px solid var(--border);background:#16253b;color:#cfe2ff}
  .btn.primary{background:var(--pc-orange);color:#231a00;border-color:#b06c05;font-weight:800}
  .btn.danger{background:#5b1220;border-color:#75212f;color:#ffd5dc}
  .table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid var(--border);
    padding:8px;text-align:left}.table th{color:#b6c7db;font-weight:800;text-transform:uppercase;font-size:12px;letter-spacing:.4px}
  input{background:#0f1a2a;border:1px solid var(--border);color:#fff;padding:10px 12px;border-radius:10px;outline:none}
  .muted{color:var(--muted)}
</style>

<div class="card">
  <div class="row space-between">
    <div>
      <div class="title">Péremptions — {{ item.name }}</div>
      <div class="muted">Item #{{ item.id }} • Qté cible: {{ item.quantity or "—" }}</div>
    </div>
    <div class="row wrap">
      <a class="btn" href="/stock">← Retour Stock</a>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <div class="title">Dates existantes</div>
  <table class="table" id="exp-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Quantité</th>
        <th>Lot</th>
        <th>Note</th>
        <th style="width:1%"></th>
      </tr>
    </thead>
    <tbody id="exp-tbody">
      <tr><td colspan="5" class="muted">Chargement…</td></tr>
    </tbody>
  </table>
</div>

<div class="card" style="margin-top:12px">
  <div class="title">Ajouter une date</div>
  <div class="row wrap" style="margin-top:8px">
    <input id="f-date" type="date" />
    <input id="f-qty" type="number" min="0" placeholder="Quantité (optionnel)" />
    <input id="f-lot" placeholder="Lot (optionnel)" />
    <input id="f-note" placeholder="Note (optionnel)" style="min-width:260px" />
    <button class="btn primary" id="btn-add">Ajouter</button>
  </div>
  <div class="muted" style="margin-top:6px">La date est obligatoire. Les autres champs sont facultatifs.</div>
</div>

<script>
const ITEM_ID = {{ item.id }};
function fmt(d){ try{ return new Date(d+"T00:00:00").toLocaleDateString(); }catch(_){ return d; } }

async function loadList(){
  const tb = document.getElementById('exp-tbody');
  tb.innerHTML = `<tr><td colspan="5" class="muted">Chargement…</td></tr>`;
  const r = await fetch(`/stock/api/item/${ITEM_ID}/expiries`, {credentials:'include'});
  if(!r.ok){ tb.innerHTML = `<tr><td colspan="5" class="muted">Erreur de chargement</td></tr>`; return; }
  const data = await r.json();
  if(!data.length){
    tb.innerHTML = `<tr><td colspan="5" class="muted">Aucune date</td></tr>`;
    return;
  }
  tb.innerHTML = "";
  for(const e of data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmt(e.date)}</td>
      <td>${e.quantity ?? ""}</td>
      <td>${e.lot ?? ""}</td>
      <td>${e.note ?? ""}</td>
      <td><button class="btn danger" data-id="${e.id}">Supprimer</button></td>`;
    tr.querySelector('button').addEventListener('click', async () => {
      if(!confirm('Supprimer cette date ?')) return;
      const rr = await fetch(`/stock/api/expiry/${e.id}`, {method:'DELETE', credentials:'include'});
      if(rr.ok) loadList(); else alert('Suppression refusée');
    });
    tb.appendChild(tr);
  }
}

document.getElementById('btn-add').addEventListener('click', async ()=>{
  const d = (document.getElementById('f-date').value||"").trim();
  const q = (document.getElementById('f-qty').value||"").trim();
  const lot = (document.getElementById('f-lot').value||"").trim();
  const note = (document.getElementById('f-note').value||"").trim();
  if(!d){ alert("Merci de renseigner une date."); return; }
  const payload = { expiry_date: d };
  if(q !== "") payload.quantity = Number(q);
  if(lot) payload.lot = lot;
  if(note) payload.note = note;

  const r = await fetch(`/stock/api/item/${ITEM_ID}/expiries`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify(payload)
  });
  if(r.ok){
    document.getElementById('f-date').value = "";
    document.getElementById('f-qty').value = "";
    document.getElementById('f-lot').value = "";
    document.getElementById('f-note').value = "";
    loadList();
  }else{
    const t = await r.text();
    alert(t || "Création refusée");
  }
});

loadList();
</script>
{% endblock %}
