{% extends "base.html" %}
{% set title = "Péremptions — " ~ (item.name or "Item") %}
{% block content %}
<div class="expiry-page">
  <section class="expiry-hero">
    <h1 class="expiry-hero__title">Péremptions — {{ item.name }}</h1>
    <div class="expiry-hero__meta">
      <span class="expiry-chip">ID #{{ item.id }}</span>
      <span class="expiry-chip">Qté cible : {{ item.quantity or "—" }}</span>
    </div>
    <div class="expiry-hero__actions">
      <a class="btn ghost" href="/stock">← Retour Stock</a>
    </div>
  </section>

  <section class="expiry-card">
    <div class="expiry-card__header">
      <h2 class="expiry-card__title">Dates enregistrées</h2>
      <p class="expiry-card__subtitle">Garde trace des lots et quantités pour assurer un suivi précis.</p>
    </div>
    <div class="expiry-table__wrapper">
      <table class="expiry-table" id="exp-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Quantité</th>
            <th>Lot</th>
            <th>Note</th>
            <th class="expiry-table__actions">Actions</th>
          </tr>
        </thead>
        <tbody id="exp-tbody">
          <tr><td colspan="5" class="expiry-table__empty">Chargement…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="expiry-card">
    <div class="expiry-card__header">
      <h2 class="expiry-card__title">Ajouter une nouvelle date</h2>
      <p class="expiry-card__subtitle">Renseigne la date de péremption puis complète si besoin avec la quantité, le lot et une note.</p>
    </div>
    <div class="expiry-form">
      <input id="f-date" type="date">
      <input id="f-qty" type="number" min="0" placeholder="Quantité (optionnel)">
      <input id="f-lot" placeholder="Lot (optionnel)">
      <input id="f-note" class="expiry-form__note" placeholder="Note (optionnel)">
      <button id="btn-add" type="button" class="btn primary">Ajouter</button>
    </div>
    <span class="expiry-hint">La date est obligatoire. Les autres champs sont facultatifs.</span>
  </section>
</div>

<script>
const ITEM_ID = {{ item.id }};
function fmt(d){ try{ return new Date(d+"T00:00:00").toLocaleDateString(); }catch(_){ return d; } }

async function loadList(){
  const tb = document.getElementById('exp-tbody');
  tb.innerHTML = `<tr><td colspan="5" class="expiry-table__empty">Chargement…</td></tr>`;
  const r = await fetch(`/stock/api/item/${ITEM_ID}/expiries`, {credentials:'include'});
  if(!r.ok){ tb.innerHTML = `<tr><td colspan="5" class="expiry-table__empty">Erreur de chargement</td></tr>`; return; }
  const data = await r.json();
  if(!data.length){
    tb.innerHTML = `<tr><td colspan="5" class="expiry-table__empty">Aucune date</td></tr>`;
    return;
  }
  tb.innerHTML = "";
  for(const e of data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmt(e.expiry_date)}</td>
      <td>${e.quantity ?? ""}</td>
      <td>${e.lot ?? ""}</td>
      <td>${e.note ?? ""}</td>
      <td><button class="btn danger" data-id="${e.id}">Supprimer</button></td>`;
    tr.querySelector('button').addEventListener('click', async () => {
      if(!confirm('Supprimer cette date ?')) return;
      const rr = await fetch(`/stock/api/expiry/${e.id}`, {method:'DELETE', credentials:'include'});
      if(rr.ok) loadList(); else alert('Suppression refusée');
    });
    tb.appendChild(tr);
  }
}

document.getElementById('btn-add').addEventListener('click', async ()=>{
  const d = (document.getElementById('f-date').value||"").trim();
  const q = (document.getElementById('f-qty').value||"").trim();
  const lot = (document.getElementById('f-lot').value||"").trim();
  const note = (document.getElementById('f-note').value||"").trim();
  if(!d){ alert("Merci de renseigner une date."); return; }
  const payload = { expiry_date: d };
  if(q !== "") payload.quantity = Number(q);
  if(lot) payload.lot = lot;
  if(note) payload.note = note;

  const r = await fetch(`/stock/api/item/${ITEM_ID}/expiries`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body: JSON.stringify(payload)
  });
  if(r.ok){
    document.getElementById('f-date').value = "";
    document.getElementById('f-qty').value = "";
    document.getElementById('f-lot').value = "";
    document.getElementById('f-note').value = "";
    loadList();
  }else{
    const t = await r.text();
    alert(t || "Création refusée");
  }
});

loadList();
</script>
{% endblock %}
