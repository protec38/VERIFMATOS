{% extends "base.html" %}
{% set title = "Péremption" %}
{% block content %}

<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --radius: 14px;
    --shadow: 0 6px 22px rgba(0,0,0,.25);
    --bg-card: #0f1726;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .card{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}

  .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .filters input, .filters select{
    background:#0b1120;border:1px solid var(--border);border-radius:10px;color:var(--text);
    padding:10px 12px;min-width:120px
  }
  .filters .btn{padding:10px 12px;border-radius:10px}

  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th{font-weight:800;text-align:left;color:#b7c7dc;padding:6px 10px}
  .row{
    display:grid;grid-template-columns: 1fr 1fr 140px 120px 110px;
    gap:10px;align-items:center;background:#0f1726;border:1px solid var(--border);
    border-radius:12px;padding:10px
  }
  .row.expired{border-color:#7a2330;background:#2a0e14}
  .row.soon{border-color:#7a5d1e;background:#221a07}
  .row.ok{opacity:.95}

  .status-badge{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:800;font-size:12px;display:inline-block;text-align:center}
  .badge-exp{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .badge-soon{background:#221a07;color:#ffd679;border-color:#7a5d1e}
  .badge-ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}

  .muted{color:#9fb0c6}
  .details{opacity:.85;font-size:12px;margin-top:4px}
  .search{flex:1}
  @media (max-width: 820px){
    .row{grid-template-columns: 1fr 140px 100px;gap:8px}
    .col-path{grid-column: 1 / -1; order: 3}
    .col-date{order: 4}
    .col-days{order: 5}
  }
</style>

<div class="wrap">
  <div class="card">
    <div class="row space-between" style="margin-bottom:10px">
      <div class="title">Articles à surveiller</div>
      <div class="muted" id="summary">—</div>
    </div>
    <div class="filters">
      <label for="days" class="muted">Fenêtre (jours) :</label>
      <input id="days" type="number" value="30" min="0" step="1" />
      <input id="q" class="search" placeholder="Rechercher par nom / chemin…" />
      <button class="btn" id="refresh">Actualiser</button>
    </div>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Article</th>
          <th class="col-path">Chemin</th>
          <th class="col-date">Péremption</th>
          <th class="col-days">Jours restants</th>
          <th>Statut</th>
        </tr>
      </thead>
    </table>
    <div id="list" style="margin-top:6px"></div>
    <div id="empty" class="muted" style="display:none;margin-top:8px">Aucun article dans la fenêtre choisie.</div>
  </div>
</div>

<script>
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
function badge(status){
  if(status==="EXPIRED") return el("span",{class:"status-badge badge-exp"},"Périmé");
  if(status==="SOON") return el("span",{class:"status-badge badge-soon"},"Bientôt");
  return el("span",{class:"status-badge badge-ok"},"OK");
}

function fmtDate(iso){
  if(!iso) return "—";
  try{
    const d = new Date(iso+"T00:00:00");
    return d.toLocaleDateString();
  }catch(_){ return iso; }
}

function renderRows(items){
  const holder = document.getElementById("list");
  holder.innerHTML = "";
  const q = (document.getElementById("q").value || "").toLowerCase().trim();

  let shown = 0;
  for(const it of items){
    const hay = (it.name + " " + (it.path||"")).toLowerCase();
    if(q && !hay.includes(q)) continue;

    const cls = it.status==="EXPIRED" ? "expired" : (it.status==="SOON" ? "soon" : "ok");
    const metaParts = [];
    if(it.quantity != null) metaParts.push(`Qté cible : ${it.quantity}`);
    if(it.lot_quantity != null) metaParts.push(`Qté lot : ${it.lot_quantity}`);
    if(it.lot) metaParts.push(`Lot ${it.lot}`);
    if(it.note) metaParts.push(it.note);

    const row = el("div",{class:"row "+cls},
      el("div", null,
        el("div",{class:"strong"}, it.name),
        metaParts.length ? el("div",{class:"muted details"}, metaParts.join(" • ")) : el("div",{class:"muted"}, "Qté cible : ", (it.quantity!=null?it.quantity:"—"))
      ),
      el("div",{class:"col-path muted"}, it.path || "—"),
      el("div",{class:"col-date"}, fmtDate(it.expiry_date)),
      el("div",{class:"col-days"}, it.days_left!=null ? it.days_left+" j" : "—"),
      el("div", null, badge(it.status))
    );
    holder.appendChild(row);
    shown++;
  }

  document.getElementById("empty").style.display = shown ? "none" : "block";
}

async function loadData(){
  const days = parseInt(document.getElementById("days").value||"30", 10);
  const r = await fetch(`/api/peremption?days=${isNaN(days)?30:days}`, {credentials:"include"});
  if(!r.ok){ document.getElementById("summary").textContent = "Erreur de chargement"; return; }
  const data = await r.json();
  const items = data.items || [];
  document.getElementById("summary").textContent = `${items.length} entrée(s) • fenêtre ${data.window_days} j`;
  renderRows(items);
}

document.getElementById("refresh").addEventListener("click", loadData);
document.getElementById("q").addEventListener("input", ()=>loadData());

(function init(){
  loadData();
})();
</script>

{% endblock %}
