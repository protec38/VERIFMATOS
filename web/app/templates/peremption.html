{% extends "base.html" %}
{% set title = "Péremption" %}
{% block content %}



<div class="peremption-page">
  <section class="peremption-hero">
    <div>
      <h1 class="title">Articles à surveiller</h1>
      <p class="subtitle">Identifie rapidement les consommables proches de leur date de péremption et pilote les réassorts depuis une interface optimisée.</p>
    </div>
    <div class="peremption-summary">
      <span class="peremption-summary-label">Synthèse</span>
      <span class="peremption-summary-value" id="summary">—</span>
      <span class="peremption-summary-hint">Actualise la liste pour rafraîchir les données en direct.</span>
    </div>
  </section>

  <section class="peremption-panel">
    <div class="panel-header">
      <h2 class="title">Filtrer les résultats</h2>
      <p class="muted">Affiche uniquement les articles concernés par ta fenêtre de surveillance.</p>
    </div>
    <div class="filters">
      <label for="days">Fenêtre (jours)</label>
      <input id="days" type="number" value="30" min="0" step="1">
      <input id="q" class="search" placeholder="Rechercher par nom ou chemin…">
      <button class="btn" id="refresh" type="button">Actualiser</button>
    </div>
  </section>

  <section class="peremption-table">
    <h2 class="title">Liste détaillée</h2>
    <p class="muted">Triée du plus urgent au moins urgent.</p>
    <div class="table-head">
      <div>Article</div>
      <div>Chemin</div>
      <div>Péremption</div>
      <div>Jours restants</div>
      <div>Statut</div>
    </div>
    <div id="list"></div>
    <div id="empty">Aucun article dans la fenêtre choisie.</div>
  </section>
</div>

<script>
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
function badge(status){
  const norm = status === "EXPIRED" ? "expired" : status === "SOON" ? "soon" : "ok";
  const label = norm === "expired" ? "Périmé" : norm === "soon" ? "Bientôt" : "OK";
  return el("span",{class:"status-badge","data-state":norm},label);
}

function fmtDate(iso){
  if(!iso) return "—";
  try{
    const d = new Date(iso+"T00:00:00");
    return d.toLocaleDateString();
  }catch(_){ return iso; }
}

function renderRows(items){
  const holder = document.getElementById("list");
  holder.innerHTML = "";
  const q = (document.getElementById("q").value || "").toLowerCase().trim();

  let shown = 0;
  for(const it of items){
    const hay = (it.name + " " + (it.path||"")).toLowerCase();
    if(q && !hay.includes(q)) continue;

    const cls = it.status==="EXPIRED" ? "expired" : (it.status==="SOON" ? "soon" : "ok");
    const metaParts = [];
    if(it.quantity != null) metaParts.push(`Qté cible : ${it.quantity}`);
    if(it.lot_quantity != null) metaParts.push(`Qté lot : ${it.lot_quantity}`);
    if(it.lot) metaParts.push(`Lot ${it.lot}`);
    if(it.note) metaParts.push(it.note);

    const row = el("div",{class:"peremption-row "+cls},
      el("div", null,
        el("div",{class:"name"}, it.name),
        metaParts.length ? el("div",{class:"details"}, metaParts.join(" • ")) : null
      ),
      el("div",{class:"path"}, it.path || "—"),
      el("div",{class:"value"}, fmtDate(it.expiry_date)),
      el("div",{class:"value"}, it.days_left!=null ? it.days_left+" j" : "—"),
      el("div", null, badge(it.status))
    );
    holder.appendChild(row);
    shown++;
  }

  document.getElementById("empty").style.display = shown ? "none" : "block";
}

async function loadData(){
  const days = parseInt(document.getElementById("days").value||"30", 10);
  const r = await fetch(`/api/peremption?days=${isNaN(days)?30:days}`, {credentials:"include"});
  if(!r.ok){ document.getElementById("summary").textContent = "Erreur de chargement"; return; }
  const data = await r.json();
  const items = data.items || [];
  const summaryEl = document.getElementById("summary");
  if(summaryEl){
    summaryEl.innerHTML = `<span class="count">${items.length}</span><span class="window">Fenêtre ${data.window_days} j</span>`;
  }
  renderRows(items);
}

document.getElementById("refresh").addEventListener("click", loadData);
document.getElementById("q").addEventListener("input", ()=>loadData());

(function init(){
  loadData();
})();
</script>

{% endblock %}
