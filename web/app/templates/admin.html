{% extends "base.html" %}
{% set title = "Administration ‚Äî Utilisateurs" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="title">Cr√©er un utilisateur</div>
      <form method="post" class="row wrap" style="margin-top:8px; gap:8px;">
        <input type="hidden" name="action" value="create_user">
        <input name="username" placeholder="Nom d‚Äôutilisateur" required style="min-width:200px;">
        <input name="password" type="password" placeholder="Mot de passe" required style="min-width:200px;">
        <select name="role" required>
          <option value="CHEF">CHEF (chef de poste)</option>
          <option value="VIEWER">VIEWER (lecture seule)</option>
          <option value="VERIFICATIONPERIODIQUE">VERIFICATIONPERIODIQUE (contr√¥les p√©riodiques)</option>
          <option value="ADMIN">ADMIN (administrateur)</option>
        </select>
        <button class="btn primary" type="submit">Cr√©er</button>
      </form>
      <div class="subtitle" style="margin-top:6px;">L‚Äôadmin peut modifier les mots de passe et activer/d√©sactiver des comptes.</div>
    </div>

    <div class="card">
      <div class="title">Aide</div>
      <ul class="subtitle" style="margin-top:6px;">
        <li>Le compte <strong>admin</strong> existe par d√©faut (pense √† changer son mot de passe).</li>
        <li>Ne te d√©sactive pas toi-m√™me üòâ.</li>
        <li>R√¥le <strong>CHEF</strong> : cr√©e/modifie des √©v√©nements, partage le lien.</li>
        <li>R√¥le <strong>VIEWER</strong> : lecture seule des √©v√©nements.</li>
        <li>R√¥le <strong>VERIFICATIONPERIODIQUE</strong> : acc√®s d√©di√© √† la page de v√©rification p√©riodique.</li>
      </ul>
    </div>

    <div class="card">
      <div class="title">Suivi des connexions</div>
      <p class="subtitle" style="margin-top:6px;">Consulte les succ√®s et √©checs de connexion avec l‚Äôadresse IP et le message associ√©.</p>
      <a class="btn" href="/admin/logins" style="margin-top:10px;display:inline-flex;align-items:center;gap:6px;">üìú Voir les connexions</a>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="title">Utilisateurs</div>
    {% if users %}
      <table class="table" style="margin-top:8px;">
        <thead>
          <tr>
            <th>#</th><th>Nom</th><th>R√¥le</th><th>Actif</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>{{ u.role.name if u.role else '‚Äî' }}</td>
            <td>
              {% if u.is_active %}
                <span class="badge" style="border-color:#145c3a;background:#0f3b33;color:#bff3e7;">Actif</span>
              {% else %}
                <span class="badge" style="border-color:#5b1220;background:#2a0e14;color:#ffb6c1;">Inactif</span>
              {% endif %}
            </td>
            <td class="row wrap" style="gap:6px;">
              <!-- Reset password -->
              <form method="post" class="row wrap" style="gap:6px;" onsubmit="return confirm('R√©initialiser le mot de passe de {{u.username}} ?');">
                <input type="hidden" name="action" value="reset_password">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <input name="new_password" type="password" placeholder="Nouveau MDP" required style="min-width:160px;">
                <button class="btn" type="submit">R√©initialiser</button>
              </form>

              <!-- Toggle active (pas pour soi-m√™me) -->
              {% if u.id != current_user.id %}
              <form method="post" onsubmit="return confirm('Basculer l‚Äô√©tat actif/inactif de {{u.username}} ?');">
                <input type="hidden" name="action" value="toggle_active">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <button class="btn {{ '' if u.is_active else 'success' }}" type="submit">
                  {{ 'D√©sactiver' if u.is_active else 'Activer' }}
                </button>
              </form>
              {% endif %}

              <!-- Delete (pas pour soi-m√™me) -->
              {% if u.id != current_user.id %}
              <form method="post" onsubmit="return confirm('Supprimer d√©finitivement {{u.username}} ?');">
                <input type="hidden" name="action" value="delete_user">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <button class="btn danger" type="submit">Supprimer</button>
              </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="muted" style="margin-top:6px;">Aucun utilisateur.</div>
    {% endif %}
  </div>
{% endblock %}
