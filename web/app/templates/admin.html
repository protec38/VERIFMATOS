{% extends "base.html" %}
{% set title = "Administration ‚Äî Utilisateurs" %}
{% block content %}
  

  {% set stats = namespace(active=0) %}
  {% for u in users %}
    {% if u.is_active %}
      {% set stats.active = stats.active + 1 %}
    {% endif %}
  {% endfor %}
  {% set total_users = users|length if users else 0 %}

  <div class="admin-page">
    <section class="admin-hero">
      <div>
        <div class="title">Administration des acc√®s</div>
        <p class="subtitle">Cr√©e des comptes pour tes chefs de poste, garde un ≈ìil sur les connexions et pilote les droits en un clin d‚Äô≈ìil.</p>
        <div class="hero-actions">
          <a class="btn primary" href="#create-user">‚ûï Nouvel utilisateur</a>
          <a class="btn" href="#users-table">Voir la liste</a>
          <a class="btn" href="/admin/logins">üìú Historique des connexions</a>
        </div>
      </div>
      <div class="admin-hero-stats">
        <div class="stat-card">
          <span class="label">Comptes actifs</span>
          <span class="value">{{ stats.active }}</span>
          <span class="hint">sur {{ total_users }} enregistr√©{{ 's' if total_users>1 else '' }}</span>
        </div>
        <div class="stat-card">
          <span class="label">R√¥les disponibles</span>
          <span class="value">4</span>
          <span class="hint">Admin ¬∑ Chef ¬∑ V√©rification ¬∑ Viewer</span>
        </div>
      </div>
    </section>

    <div class="admin-grid">
      <div class="admin-card" id="create-user">
        <div class="title">Cr√©er un utilisateur</div>
        <p class="subtitle">Attribue un r√¥le adapt√© et communique le mot de passe au b√©n√©ficiaire.</p>
        <form method="post" class="user-form">
          <input type="hidden" name="action" value="create_user">
          <div class="field">
            <label for="user-username">Nom d‚Äôutilisateur</label>
            <input id="user-username" name="username" placeholder="Ex. j.dupont" required>
          </div>
          <div class="field">
            <label for="user-password">Mot de passe initial</label>
            <input id="user-password" name="password" type="password" placeholder="D√©finis un mot de passe" required>
          </div>
          <div class="field">
            <label for="user-role">R√¥le</label>
            <select id="user-role" name="role" required>
              <option value="CHEF">CHEF ‚Äî G√®re les √©v√©nements</option>
              <option value="VIEWER">VIEWER ‚Äî Lecture seule</option>
              <option value="VERIFICATIONPERIODIQUE">VERIFICATIONPERIODIQUE ‚Äî Contr√¥les p√©riodiques</option>
              <option value="ADMIN">ADMIN ‚Äî Acc√®s complet</option>
            </select>
          </div>
          <div class="form-actions">
            <button class="btn primary" type="submit">Cr√©er le compte</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <div class="title">Bonnes pratiques</div>
        <ul>
          <li>Le compte <strong>admin</strong> existe par d√©faut : change son mot de passe d√®s la premi√®re connexion.</li>
          <li>Cr√©e un compte nominatif par personne et d√©sactive les acc√®s en fin de mission.</li>
          <li>Ne te d√©sactive pas toi-m√™me üòâ.</li>
          <li>Le r√¥le <strong>CHEF</strong> pr√©pare les √©v√©nements et partage les liens de v√©rification.</li>
          <li>Le r√¥le <strong>VERIFICATIONPERIODIQUE</strong> donne acc√®s √† la page de contr√¥le sans modifier le stock.</li>
        </ul>
      </div>
    </div>

    <div class="users-card" id="users-table">
      <div class="title">Utilisateurs enregistr√©s</div>
      <p class="subtitle">R√©initialise un mot de passe, ajuste les r√¥les ou d√©sactive un compte inactif.</p>
      {% if users %}
        <div class="table-scroll">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nom</th>
                  <th>R√¥le</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for u in users %}
                <tr>
                  <td>{{ u.id }}</td>
                  <td>{{ u.username }}</td>
                  <td>{{ u.role.name if u.role else '‚Äî' }}</td>
                  <td>
                    <span class="status-badge" data-state="{{ 'active' if u.is_active else 'inactive' }}">
                      {{ 'Actif' if u.is_active else 'Inactif' }}
                    </span>
                  </td>
                  <td>
                    <div class="user-actions">
                      <form method="post" onsubmit="return confirm('R√©initialiser le mot de passe de {{u.username}} ?');">
                        <input type="hidden" name="action" value="reset_password">
                        <input type="hidden" name="user_id" value="{{ u.id }}">
                        <input name="new_password" type="password" placeholder="Nouveau mot de passe" required>
                        <button type="submit">R√©initialiser</button>
                      </form>
                      {% if u.id != current_user.id %}
                        <form method="post" onsubmit="return confirm('Basculer l‚Äô√©tat actif/inactif de {{u.username}} ?');">
                          <input type="hidden" name="action" value="toggle_active">
                          <input type="hidden" name="user_id" value="{{ u.id }}">
                          <button type="submit" class="{{ '' if u.is_active else 'success' }}">
                            {{ 'D√©sactiver' if u.is_active else 'Activer' }}
                          </button>
                        </form>
                        <form method="post" onsubmit="return confirm('Supprimer d√©finitivement {{u.username}} ?');">
                          <input type="hidden" name="action" value="delete_user">
                          <input type="hidden" name="user_id" value="{{ u.id }}">
                          <button type="submit" class="danger">Supprimer</button>
                        </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <div class="muted" style="margin-top:10px;">Aucun utilisateur pour le moment.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}
