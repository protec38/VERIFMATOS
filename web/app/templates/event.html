{% extends "base.html" %}
{% set title = "Événement" %}
{% block content %}
<div class="grid cols-2">
  <div class="card">
    <div class="row space-between">
      <div>
        <div class="title">{{ event.name }}</div>
        <div class="muted">Date : {{ event.date or "—" }}</div>
      </div>
      <span class="badge" id="status-badge">Statut : {{ event.status }}</span>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="btn-share">Générer un lien pour les secouristes</button>
      <button class="btn" id="btn-close">Clôturer l'événement</button>
    </div>
  </div>

  <div class="card">
    <div class="title">Progression</div>
    <div class="progress" style="margin-top:8px;"><div id="progress-bar" style="width:0%"></div></div>
    <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="row space-between">
    <div class="title">Matériel à vérifier</div>
  </div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<script>
const EVENT_ID = {{ event.id }};
let TREE = {{ (tree or [])|tojson }};
const CURRENT_USER = "{{ (current_user.username if current_user is defined and current_user.is_authenticated else '')|e }}";

// Helpers DOM
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
function isItem(n){ return (n.type||"").toUpperCase()==="ITEM"; }
function isGroup(n){ return (n.type||"").toUpperCase()==="GROUP"; }

// Tous les items descendants sont OK ?
function groupAllOk(n){
  let ok = true, hasItem=false;
  (function rec(x){
    if(isItem(x)){ hasItem = true; ok = ok && (x.last_status==="OK"); }
    (x.children||[]).forEach(rec);
  })(n);
  return hasItem && ok;
}
function flattenItems(nodes){
  const out=[]; (nodes||[]).forEach(function rec(n){
    if(isItem(n)) out.push(n);
    (n.children||[]).forEach(rec);
  });
  return out;
}
function recomputeProgress(){
  const items = flattenItems(TREE);
  const total = items.length;
  const ok = items.filter(i=>i.last_status==="OK").length;
  const pct = total? Math.round(ok/total*100) : 0;
  document.getElementById("progress-bar").style.width = pct+"%";
  document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
}

// Rendu avec contour vert si OK
function renderItem(n){
  const isOk = n.last_status === "OK";
  const border = isOk ? "1px solid var(--success)" : "1px solid var(--border)";
  const status = n.last_status ? (isOk ? "✅ OK" : "⚠️ Non conforme") : "—";
  const by = n.last_by ? ` (${n.last_by})` : "";

  const right = el("div", {class:"row"},
    el("button", {class:"btn success", onclick:()=>verify(n.id,"OK")}, "OK"),
    el("button", {class:"btn ghost", onclick:()=>verify(n.id,"NOT_OK")}, "Non conforme"),
  );
  return el("div", {class:"item", style:`border:${border}`},
    el("div", null,
      el("div", {class:"name"}, `${n.name} `, el("span", {class:"qty"}, `Qté: ${n.quantity ?? 1}`)),
      el("div", {class:"muted"}, `Dernier statut: ${status}${by}`)
    ),
    right
  );
}
function renderGroup(n){
  const okAll = groupAllOk(n);
  const border = okAll ? "1px dashed var(--success)" : "1px dashed #22314a";
  const okIcon = okAll ? "✅ " : "";
  const header = el("div", {class:"header"},
    el("div", {class:"name"}, `${okIcon}${n.name}`),
    el("label", {class:"check"},
      el("input", {type:"checkbox", id:`charged-${n.id}`, onchange:(e)=>setCharged(n.id, e.target.checked), ...(n.charged_vehicle?{checked:true}:{})}),
      el("span", null, "Chargé dans le véhicule")
    )
  );
  const children = el("div", {class:"childs"}, ...(n.children||[]).map(renderNode));
  return el("div", {class:"node", id:`node-${n.id}`, style:`border:${border}`}, header, children);
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

function buildUI(){
  const root = document.getElementById("tree");
  root.innerHTML = "";
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
  recomputeProgress();
}
function fetchTree(){
  fetch(`/events/${EVENT_ID}/tree`, {credentials:"include"})
    .then(r=>r.json())
    .then(json => { TREE = json; buildUI(); })
    .catch(()=>{});
}
function verify(nodeId, status){
  const payload = { node_id: nodeId, status, verifier_name: CURRENT_USER || undefined };
  fetch(`/events/${EVENT_ID}/verify`, {
    method:"POST", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  }).then(()=> fetchTree());
}
function setCharged(nodeId, checked){
  fetch(`/events/${EVENT_ID}/parent-status`, {
    method:"POST", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({node_id: nodeId, charged_vehicle: checked})
  }).then(()=> fetchTree());
}

document.getElementById("btn-share").addEventListener("click", ()=>{
  fetch(`/events/${EVENT_ID}/share-link`, {method:"POST", credentials:"include"})
    .then(r=>r.json()).then(res=>{
      if(res.url){
        const absolute = location.origin + res.url;
        navigator.clipboard.writeText(absolute);
        alert("Lien copié : " + absolute);
      }
    });
});
document.getElementById("btn-close").addEventListener("click", ()=>{
  fetch(`/events/${EVENT_ID}/status`, {
    method:"PATCH", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({status:"CLOSED"})
  }).then(()=>{ document.getElementById("status-badge").textContent = "Statut : CLOSED"; });
});

// Premier rendu puis polling
buildUI();
setInterval(fetchTree, 2000);
</script>
{% endblock %}
