{% extends "base.html" %}
{% set title = "Événement" %}
{% block content %}
<div class="grid cols-2">
  <div class="card">
    <div class="row space-between wrap">
      <div>
        <div class="title">{{ event.name }}</div>
        <div class="muted" style="margin-top:4px;">Date : {{ event.date or "—" }}</div>
      </div>
      <span class="badge" id="status-badge">Statut : {{ event.status }}</span>
    </div>
    <div class="row" style="margin-top:12px;">
      <button class="btn primary" id="btn-share">Générer un lien pour les secouristes</button>
      <button class="btn" id="btn-close">{{ "Réouvrir l'événement" if event.status=="CLOSED" else "Clôturer l'événement" }}</button>
    </div>
  </div>

  <div class="card">
    <div class="title">Progression</div>
    <div class="progress" style="margin-top:8px;"><div id="progress-bar" style="width:0%"></div></div>
    <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="title">Matériel à vérifier</div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<script>
  const EVENT_ID = {{ event.id }};
  let TREE = {{ (tree or [])|tojson }}; // contient last_status, last_by, complete, etc.

  // --- Socket.IO (client fourni par base.html via CDN) ---
  const socket = io({ transports: ["websocket","polling"], timeout: 2000 });
  socket.on("connect", () => {
    socket.emit("join_event", { event_id: EVENT_ID });
  });
  socket.on("event_update", (msg) => {
    if(!msg || msg.event_id !== EVENT_ID) return;
    if(msg.type === "item_verified"){
      applyItemVerification(msg.node_id, msg.status, msg.by);
    } else if (msg.type === "parent_charged"){
      // optionnel : reflet immédiat de la case "chargé véhicule"
      const chk = document.getElementById("charged-"+msg.node_id);
      if(chk) chk.checked = !!msg.charged;
    } else if (msg.type === "event_closed" || msg.type === "event_opened"){
      document.getElementById("status-badge").textContent = "Statut : " + (msg.type==="event_closed"?"CLOSED":"OPEN");
    }
  });

  // --- DOM helpers & rendu ---
  const parentOf = new Map();  // childId -> parentId
  function el(tag, attrs={}, ...children){
    const e = document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)){
      if(k==="class") e.className = v;
      else if(k==="html") e.innerHTML = v;
      else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
      else e.setAttribute(k, v);
    }
    for(const c of children){ e.append(c?.nodeType ? c : document.createTextNode(c)); }
    return e;
  }

  function countItems(root) {
    let c=0;
    (function rec(n){ if(n.type==="ITEM") c++; (n.children||[]).forEach(rec); })(root);
    return c;
  }

  function renderTreeNode(n){
    const isGroup = n.type === "GROUP";
    const node = el("div", {class:"node", id:"node-"+n.id, "data-type": n.type});
    const header = el("div", {class:"header"});
    const name = el("div", {class:"name"});
    name.textContent = n.name;

    if(isGroup){
      // badge ✓ si complet
      const badge = el("span", {class:"badge", id:"badge-"+n.id}, n.complete ? "✓ Complet" : "À vérifier");
      header.append(name, badge);
    } else {
      // ITEM : quantité + état
      const qty = el("span", {class:"qty"}, "Qté: "+(n.quantity ?? "—"));
      const state = el("span", {class:"badge", id:"state-"+n.id}, n.last_status==="OK" ? ("OK • "+(n.last_by||"")) : "—");
      header.append(name, el("div", {class:"row"}, qty, state));
    }

    node.append(header);

    const childrenWrap = el("div", {class:"childs"});
    (n.children||[]).forEach(ch => {
      parentOf.set(ch.id, n.id);
      childrenWrap.append(renderTreeNode(ch));
    });

    if(!isGroup){
      // Actions vérification (côté chef/admin)
      const actions = el("div", {class:"item", id:"item-actions-"+n.id});
      const input = el("input", {type:"text", placeholder:"Nom & prénom", id:"name-"+n.id, value:""});
      const btnOk = el("button", {class:"btn", onclick: ()=>verifyItem(n.id,"OK")}, "OK");
      const btnKo = el("button", {class:"btn ghost", onclick: ()=>verifyItem(n.id,"NOT_OK")}, "Non conforme");
      actions.append(el("div", {class:"muted"}, "Vérification"), el("div",{class:"row"}, input, btnOk, btnKo));
      childrenWrap.append(actions);

      // Si déjà OK à l'état initial, grise les actions
      if(n.last_status==="OK"){
        actions.style.opacity = .6;
      }
    } else {
      // Case "chargé véhicule" sur les GROUP
      const chkWrap = el("label", {class:"check", style:"margin-top:6px;display:flex;align-items:center;gap:8px;"});
      const chk = el("input", {type:"checkbox", id:"charged-"+n.id, onchange:(e)=>setCharged(n.id, e.target.checked)});
      chkWrap.append(chk, document.createTextNode("Chargé dans le véhicule"));
      childrenWrap.prepend(chkWrap);
    }

    node.append(childrenWrap);
    return node;
  }

  function renderTree(){
    const treeEl = document.getElementById("tree");
    treeEl.innerHTML = "";
    parentOf.clear();
    TREE.forEach(root => treeEl.append(renderTreeNode(root)));
    recomputeAllBadgesAndProgress();
  }

  // --- Progression & badges ---
  function allItemNodesIn(groupEl){
    return groupEl.querySelectorAll('.node[data-type="ITEM"]');
  }
  function okItemsIn(groupEl){
    return groupEl.querySelectorAll('.node[data-type="ITEM"] .badge[id^="state-"]:not(:empty)');
  }
  function markGroupBadge(groupId){
    const groupEl = document.getElementById("node-"+groupId);
    if(!groupEl) return;
    const badge = document.getElementById("badge-"+groupId);
    if(!badge) return;
    const total = allItemNodesIn(groupEl).length;
    const oks = okItemsIn(groupEl).length;
    const complete = total>0 && oks===total;
    badge.textContent = complete ? "✓ Complet" : `À vérifier (${oks}/${total})`;
  }
  function recomputeAllBadgesAndProgress(){
    // Badges groupes (tous niveaux)
    TREE.forEach(function walk(n){
      if(n.type==="GROUP") markGroupBadge(n.id);
      (n.children||[]).forEach(walk);
    });
    // Progression globale
    const total = document.querySelectorAll('.node[data-type="ITEM"]').length;
    const ok = document.querySelectorAll('.node[data-type="ITEM"] .badge[id^="state-"]:not(:empty)').length;
    const pct = total ? Math.round(ok/total*100) : 0;
    document.getElementById("progress-bar").style.width = pct+"%";
    document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
  }

  // --- Actions serveur ---
  function verifyItem(nodeId, status){
    const name = (document.getElementById("name-"+nodeId)?.value || "").trim();
    if(!name){ alert("Merci de renseigner votre nom et prénom"); return; }
    fetch(`/events/${EVENT_ID}/verify`, {
      method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
      body: JSON.stringify({node_id: nodeId, status, verifier_name: name})
    }).then(r=>r.ok?r.json():r.json().then(e=>Promise.reject(e)))
      .then(()=>{/* le serveur émettra l'update temps réel */})
      .catch(e=>alert(e?.error||"Erreur"));
  }
  function setCharged(nodeId, checked){
    fetch(`/events/${EVENT_ID}/parent-status`, {
      method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
      body: JSON.stringify({node_id: nodeId, charged_vehicle: !!checked})
    }).catch(()=>{});
  }

  // --- Application des updates temps réel ---
  function applyItemVerification(nodeId, status, by){
    const state = document.getElementById("state-"+nodeId);
    const actions = document.getElementById("item-actions-"+nodeId);
    if(state){
      state.textContent = status==="OK" ? `OK • ${by||""}` : `Non conforme • ${by||""}`;
    }
    if(actions && status==="OK"){
      actions.style.opacity = .6;
    }
    // Remonte et met à jour badges parents
    let p = parentOf.get(nodeId);
    while(p){
      markGroupBadge(p);
      p = parentOf.get(p);
    }
    // Progression globale
    recomputeAllBadgesAndProgress();
  }

  // --- Boutons haut de page ---
  document.getElementById("btn-share").addEventListener("click", () => {
    fetch(`/events/${EVENT_ID}/share-link`, {method:"POST", credentials:"include"})
      .then(r=>r.json()).then(res=>{
        if(res.url){
          const absolute = location.origin + res.url;
          navigator.clipboard.writeText(absolute);
          alert("Lien copié : " + absolute);
        }
      });
  });
  document.getElementById("btn-close").addEventListener("click", () => {
    const to = (document.getElementById("status-badge").textContent.includes("OPEN")) ? "CLOSED" : "OPEN";
    fetch(`/events/${EVENT_ID}/status`, {
      method:"PATCH", headers:{"Content-Type":"application/json"}, credentials:"include",
      body: JSON.stringify({status: to})
    }).then(()=>location.reload());
  });

  renderTree();
</script>
{% endblock %}
