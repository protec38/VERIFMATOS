{% extends "base.html" %}
{% set title = "Événement" %}
{% block content %}

<!-- Styles spécifiques à cette page (états visuels) -->
<style>
  .state-ok{
    border-color: var(--success) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(18,184,134,.15), transparent),
      #0f1e2f;
    box-shadow: 0 0 0 1px rgba(18,184,134,.35) inset, 0 0 18px rgba(18,184,134,.15);
  }
  .state-bad{
    border-color: var(--danger) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(255,107,107,.12), transparent),
      #0f1a27;
    box-shadow: 0 0 0 1px rgba(255,107,107,.30) inset, 0 0 18px rgba(255,107,107,.12);
  }
  .state-wait{
    border-color: var(--border) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(45,123,191,.08), transparent),
      var(--bg-2);
  }
  .chip{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border);}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.wait{background:#101c2e;color:#b7c7dc;border-color:#24344f}
  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .dot-ok{background:var(--success)} .dot-bad{background:var(--danger)} .dot-wait{background:#37527a}

  /* Barre parents (racines) */
  .parents-bar { gap: 8px; flex-wrap: wrap; }
  .parent-pill {
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border:1px solid var(--border); border-radius:999px;
    cursor:pointer; user-select:none; font-weight:700; font-size:12px;
    background:var(--bg-2);
  }
  .parent-pill.ok { border-color:var(--success); }
  .parent-pill.bad { border-color:var(--danger); }
  .parent-pill.wait { border-color:#37527a; }
  .parent-pill .name { max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .vehicle-tag { margin-left:8px; font-size:12px; opacity:.9; display:inline-flex; gap:4px; align-items:center; }
  .vehicle-tag .car { filter: drop-shadow(0 0 4px rgba(255,255,255,.05)); }

  /* Modal historique */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{width:min(720px,92vw);max-height:80vh;overflow:auto;background:var(--bg);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.4);padding:14px}
  .modal .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal .list{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:12px}
  .muted-sm{opacity:.75;font-size:12px}
</style>

<div class="grid cols-2">
  <div class="card">
    <div class="row space-between">
      <div>
        <div class="title">{{ event.name }}</div>
        <div class="muted">Date : {{ event.date or "—" }}</div>
      </div>
      <span class="badge" id="status-badge">Statut : {{ event.status }}</span>
    </div>
    <div class="row wrap" style="margin-top:10px;gap:8px;">
      <a class="btn" target="_blank" href="/reports/event/{{ event.id }}/pdf">Exporter PDF</a>
      <button class="btn" id="btn-share">Générer un lien pour les secouristes</button>
      <button class="btn" id="btn-close">Clôturer l'événement</button>
      <button class="btn success" id="btn-reopen" style="display:none;">Réouvrir l'événement</button>
    </div>
  </div>

  <div class="card">
    <div class="title">Progression</div>
    <div class="row wrap" style="margin-top:8px;gap:10px;">
      <span class="chip ok" id="stat-ok">OK : 0</span>
      <span class="chip bad" id="stat-bad">Non conformes : 0</span>
      <span class="chip wait" id="stat-wait">En attente : 0</span>
    </div>
    <div class="progress" style="margin-top:10px;"><div id="progress-bar" style="width:0%"></div></div>
    <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
  </div>
</div>

<!-- Liste des parents (racines) cliquables -->
<div class="card" style="margin-top:12px;">
  <div class="row space-between">
    <div class="title">Parents (racines)</div>
    <div class="muted">Clique un parent pour scroller à sa section</div>
  </div>
  <div id="parents-bar" class="row parents-bar" style="margin-top:8px;"></div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="row space-between">
    <div class="title">Matériel à vérifier</div>
    <div class="muted">Vert = tout OK • Rouge = au moins un non conforme • Bleu = en attente</div>
  </div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<!-- Modal Historique -->
<div id="hist-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="header">
      <div class="title" id="hist-title">Historique</div>
      <button class="btn" id="hist-close">Fermer</button>
    </div>
    <div class="muted-sm" id="hist-subtitle"></div>
    <div id="hist-list" class="list" style="margin-top:10px;"></div>
  </div>
</div>

<script>
const EVENT_ID = {{ event.id }};
let TREE = {{ (tree or [])|tojson }};
const CURRENT_USER = "{{ (current_user.username if current_user is defined and current_user.is_authenticated else '')|e }}";
const USER_ROLE = "{{ (current_user.role.name if (current_user is defined and current_user.is_authenticated and current_user.role) else '')|e }}";
let IS_OPEN = ("{{ event.status }}".toUpperCase() === "OPEN");
const CAN_MANAGE = ["ADMIN","CHEF"].includes((USER_ROLE||"").toUpperCase());

/* ========= State & index DOM (pour MAJ incrémentales) ========= */
const NODE_MAP = new Map();       // id -> node (dans TREE)
const GROUP_EL = new Map();       // id -> box DOM du groupe
const ITEM_EL  = new Map();       // id -> box DOM de l'item
const ITEM_STATUS_TXT = new Map();// id -> <div> statut + by
const ITEM_QTY_TXT = new Map();   // id -> <span> Qté
const CHARGED_CB = new Map();     // id -> checkbox "chargé"
const VEHICLE_SPAN = new Map();   // id -> <span> libellé véhicule (dans header)
const PARENT_PILL = new Map();    // id -> bouton/raccourci parent

/* ===== helpers ===== */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
const isItem = n => (n.type||"").toUpperCase()==="ITEM";
const isGroup = n => (n.type||"").toUpperCase()==="GROUP";

/* ----- agrégats ----- */
function groupAllOk(n){
  let ok = true, hasItem=false;
  (function rec(x){
    if(isItem(x)){ hasItem=true; ok = ok && (x.last_status==="OK"); }
    (x.children||[]).forEach(rec);
  })(n);
  return hasItem && ok;
}
function groupHasBad(n){
  let bad = false;
  (function rec(x){
    if(isItem(x) && x.last_status==="NOT_OK") bad = true;
    (x.children||[]).forEach(rec);
  })(n);
  return bad;
}
function flattenItems(nodes){
  const out=[]; (nodes||[]).forEach(function rec(n){
    if(isItem(n)) out.push(n);
    (n.children||[]).forEach(rec);
  });
  return out;
}

/* ----- progression ----- */
function recomputeStats(){
  const items = flattenItems(TREE);
  const total = items.length;
  const ok = items.filter(i=>i.last_status==="OK").length;
  const bad = items.filter(i=>i.last_status==="NOT_OK").length;
  const wait = total - ok - bad;

  document.getElementById("stat-ok").textContent = `OK : ${ok}`;
  document.getElementById("stat-bad").textContent = `Non conformes : ${bad}`;
  document.getElementById("stat-wait").textContent = `En attente : ${wait}`;
  const pct = total? Math.round(ok/total*100) : 0;
  document.getElementById("progress-bar").style.width = pct+"%";
  document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
}

/* ----- classes état ----- */
function itemStateClass(n){
  if(n.last_status==="OK") return "state-ok";
  if(n.last_status==="NOT_OK") return "state-bad";
  return "state-wait";
}
function groupStateClass(n){
  if(groupAllOk(n)) return "state-ok";
  if(groupHasBad(n)) return "state-bad";
  return "state-wait";
}
function stateDot(n, isGroupNode){
  let cls="dot-wait", label="En attente";
  if(isGroupNode){
    if(groupAllOk(n)) { cls="dot-ok"; label="Tout OK"; }
    else if(groupHasBad(n)) { cls="dot-bad"; label="Non conformes présents"; }
  } else {
    if(n.last_status==="OK"){ cls="dot-ok"; label="OK"; }
    else if(n.last_status==="NOT_OK"){ cls="dot-bad"; label="Non conforme"; }
  }
  return el("span", {class:"status-dot "+cls, title:label});
}

/* ----- rendu items ----- */
function renderItem(n){
  const statusLbl = n.last_status ? (n.last_status==="OK" ? "✅ OK" : "❌ Non conforme") : "⏳ En attente";
  const by = n.last_by ? ` (${n.last_by})` : "";
  const actionsEnabled = IS_OPEN && CAN_MANAGE;

  const qtySpan = el("span", {class:"qty", id:`qty-${n.id}`}, `Qté: ${n.quantity ?? 1}`);
  ITEM_QTY_TXT.set(n.id, qtySpan);

  const statusDiv = el("div", {class:"muted", id:`status-${n.id}`}, `Dernier statut: ${statusLbl}${by}`);
  ITEM_STATUS_TXT.set(n.id, statusDiv);

  const right = el("div", {class:"row"},
    el("button", {class:"btn success", disabled:!actionsEnabled, onclick:()=>verify(n.id,"OK")}, "OK"),
    el("button", {class:"btn ghost", disabled:!actionsEnabled, onclick:()=>verify(n.id,"NOT_OK")}, "Non conforme"),
  );

  const wrap = el("div", {class:"item "+itemStateClass(n), id:`item-${n.id}`},
    el("div", null,
      el("div", {class:"name"}, stateDot(n,false), n.name, " ", qtySpan),
      statusDiv
    ),
    right
  );
  ITEM_EL.set(n.id, wrap);
  return wrap;
}

/* ----- rendu groupes ----- */
function renderGroupHeaderRight(n){
  const actionsEnabled = IS_OPEN && CAN_MANAGE;

  const btnAllOk = el("button", {
    class:"btn success",
    disabled:!actionsEnabled,
    onclick:()=>verifyAll(n.id, "OK")
  }, "Tout OK");

  const btnReset = el("button", {
    class:"btn",
    disabled:!actionsEnabled,
    onclick:()=>resetParent(n.id)
  }, "Tout remettre en attente");

  const btnHist = el("button", {
    class:"btn",
    onclick:()=>openHistory(n.id, n.name)
  }, "Historique");

  const cb = el("input", {
    type:"checkbox", id:`charged-${n.id}`, disabled:!actionsEnabled,
    onchange:(e)=>setCharged(n.id, e.target)
  });
  if(n.charged_vehicle) cb.checked = true;
  CHARGED_CB.set(n.id, cb);

  return el("div", {class:"row wrap", style:"gap:6px"},
    btnAllOk, btnReset, btnHist,
    el("label", {class:"check"}, cb, el("span", null, "Chargé dans le véhicule"))
  );
}

function renderGroup(n){
  const headerLeft = el("div", {class:"name"},
    stateDot(n,true),
    n.name,
    // Tag véhicule (si dispo)
    (function(){
      const tag = el("span", {class:"vehicle-tag", id:`veh-${n.id}`});
      if(n.vehicle_label){
        tag.innerHTML = `<span class="car">🚐</span><span>${n.vehicle_label}</span>`;
      }
      VEHICLE_SPAN.set(n.id, tag);
      return tag;
    })()
  );

  const header = el("div", {class:"header"},
    headerLeft,
    renderGroupHeaderRight(n)
  );

  const children = el("div", {class:"childs"}, ...(n.children||[]).map(renderNode));
  const box = el("div", {class:`node ${groupStateClass(n)}`, id:`node-${n.id}`}, header, children);
  GROUP_EL.set(n.id, box);
  return box;
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

/* ----- Parents bar ----- */
function buildParentsBar(){
  const bar = document.getElementById("parents-bar");
  bar.innerHTML = "";
  (TREE||[]).forEach(root=>{
    const pill = el("button", {
      class:"parent-pill " + (groupAllOk(root) ? "ok" : groupHasBad(root) ? "bad" : "wait"),
      onclick:()=>document.getElementById(`node-${root.id}`)?.scrollIntoView({behavior:"smooth", block:"start"})
    },
      stateDot(root,true),
      el("span", {class:"name"}, root.name),
      (function(){
        const tag = el("span", {class:"vehicle-tag", id:`veh-pill-${root.id}`});
        if(root.vehicle_label){ tag.innerHTML = `<span class="car">🚐</span><span>${root.vehicle_label}</span>`; }
        return tag;
      })()
    );
    PARENT_PILL.set(root.id, pill);
    bar.appendChild(pill);
  });
}

/* ----- Construction initiale ----- */
function indexTree(nodes){ (nodes||[]).forEach(function rec(n){ NODE_MAP.set(n.id, n); (n.children||[]).forEach(rec); }); }
function buildUIOnce(){
  const root = document.getElementById("tree");
  root.innerHTML = "";
  indexTree(TREE);
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
  buildParentsBar();
  recomputeStats();
  // Afficher bouton réouverture si fermé
  document.getElementById("btn-reopen").style.display = (!IS_OPEN && CAN_MANAGE) ? "" : "none";
}

/* ----- MAJ incrémentales ----- */
function applyItemDelta(local, incoming){
  local.last_status = (incoming.last_status || "PENDING").toUpperCase();
  local.last_by = incoming.last_by || "";
  if(incoming.quantity != null) local.quantity = incoming.quantity;

  const box = ITEM_EL.get(local.id);
  const statusDiv = ITEM_STATUS_TXT.get(local.id);
  const qtySpan = ITEM_QTY_TXT.get(local.id);
  if(!box) return;

  box.classList.remove("state-ok","state-bad","state-wait");
  box.classList.add(itemStateClass(local));

  const label = local.last_status==="OK" ? "✅ OK" : (local.last_status==="NOT_OK" ? "❌ Non conforme" : "⏳ En attente");
  if(statusDiv) statusDiv.textContent = `Dernier statut: ${label}${local.last_by ? " ("+local.last_by+")" : ""}`;
  if(qtySpan) qtySpan.textContent = `Qté: ${local.quantity ?? 1}`;
}
function applyGroupDelta(local){
  const box = GROUP_EL.get(local.id);
  if(box){
    box.classList.remove("state-ok","state-bad","state-wait");
    box.classList.add(groupStateClass(local));
  }
  const vehSpan = VEHICLE_SPAN.get(local.id);
  if(vehSpan){
    vehSpan.innerHTML = local.vehicle_label ? `<span class="car">🚐</span><span>${local.vehicle_label}</span>` : "";
  }
  const pill = PARENT_PILL.get(local.id);
  if(pill){
    pill.classList.remove("ok","bad","wait");
    pill.classList.add(groupAllOk(local) ? "ok" : groupHasBad(local) ? "bad" : "wait");
    const tag = document.getElementById(`veh-pill-${local.id}`);
    if(tag){ tag.innerHTML = local.vehicle_label ? `<span class="car">🚐</span><span>${local.vehicle_label}</span>` : ""; }
  }
  const cb = CHARGED_CB.get(local.id);
  if(cb){ cb.checked = !!local.charged_vehicle; }
}
function syncTreeIncoming(incomingNodes){
  (incomingNodes||[]).forEach(function recInc(nInc){
    const nLoc = NODE_MAP.get(nInc.id);
    if(!nLoc) return;
    if(isItem(nLoc)){
      applyItemDelta(nLoc, nInc);
    } else {
      // MAJ propriétés groupe
      if(typeof nInc.charged_vehicle !== "undefined") nLoc.charged_vehicle = !!nInc.charged_vehicle;
      if(typeof nInc.vehicle_label !== "undefined") nLoc.vehicle_label = nInc.vehicle_label || null;
      (nInc.children||[]).forEach(recInc);
      applyGroupDelta(nLoc);
    }
  });
  recomputeStats();
}

/* ----- API calls ----- */
async function refreshTree(){
  try{
    const r = await fetch(`/events/${EVENT_ID}/tree`, {credentials:"include", headers:{'Accept':'application/json'}});
    if(!r.ok) return;
    const latest = await r.json();
    syncTreeIncoming(latest);
  }catch(_){}
}
function verify(nodeId, status){
  const payload = { node_id: nodeId, status, verifier_name: CURRENT_USER || undefined };
  fetch(`/events/${EVENT_ID}/verify`, {
    method:"POST", credentials:"include",
    headers:{"Content-Type":"application/json","Accept":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(res=>res.ok?refreshTree():res.text().then(t=>alert(t)))
  .catch(()=>{});
}
function setCharged(nodeId, checkboxEl){
  const checked = !!checkboxEl.checked;
  if(checked){
    const veh = (prompt("Dans quel véhicule est-ce chargé ? (ex: VSAV 1)") || "").trim();
    if(!veh){
      checkboxEl.checked = false; // revert
      return;
    }
    fetch(`/events/${EVENT_ID}/parent-status`, {
      method:"POST", credentials:"include",
      headers:{"Content-Type":"application/json","Accept":"application/json"},
      body: JSON.stringify({node_id: nodeId, charged_vehicle: true, vehicle_label: veh})
    })
    .then(async res=>{
      if(!res.ok){ checkboxEl.checked = false; const t = await res.text(); alert(t); }
      refreshTree();
    })
    .catch(()=>{ checkboxEl.checked = false; });
  }else{
    fetch(`/events/${EVENT_ID}/parent-status`, {
      method:"POST", credentials:"include",
      headers:{"Content-Type":"application/json","Accept":"application/json"},
      body: JSON.stringify({node_id: nodeId, charged_vehicle: false})
    }).then(()=> refreshTree());
  }
}
function verifyAll(parentId, status){
  fetch(`/events/${EVENT_ID}/parent/${parentId}/verify-all`, {
    method:"POST", credentials:"include",
    headers:{"Content-Type":"application/json","Accept":"application/json"},
    body: JSON.stringify({status, verifier_name: CURRENT_USER || undefined})
  }).then(async res=>{
    if(!res.ok){ const t = await res.text(); alert(t); }
    refreshTree();
  });
}
function resetParent(parentId){
  if(!confirm("Remettre tous les items de ce parent en attente ?")) return;
  fetch(`/events/${EVENT_ID}/parent/${parentId}/reset`, {
    method:"POST", credentials:"include",
    headers:{"Accept":"application/json"}
  }).then(async res=>{
    if(!res.ok){ const t = await res.text(); alert(t); }
    refreshTree();
  });
}

/* ----- Historique (modal) ----- */
const histBackdrop = document.getElementById("hist-backdrop");
document.getElementById("hist-close").addEventListener("click", ()=> histBackdrop.style.display="none");
function openHistory(parentId, parentName){
  document.getElementById("hist-title").textContent = "Historique";
  document.getElementById("hist-subtitle").textContent = `Parent: ${parentName}`;
  const list = document.getElementById("hist-list");
  list.innerHTML = "Chargement...";
  histBackdrop.style.display = "flex";
  fetch(`/events/${EVENT_ID}/history?parent_id=${parentId}&limit=300`, {credentials:"include"})
    .then(r=>r.json())
    .then(rows=>{
      if(!rows || !rows.length){ list.textContent = "Aucun enregistrement."; return; }
      const frag = document.createDocumentFragment();
      rows.forEach(r=>{
        const line = el("div", null, `[${r.at||"-"}] node:${r.node_id} -> ${r.status} (${r.by||"?"})`);
        frag.appendChild(line);
      });
      list.innerHTML = "";
      list.appendChild(frag);
    })
    .catch(()=>{ list.textContent="Erreur de chargement."; });
}

/* ----- Actions haut de page ----- */
document.getElementById("btn-share").addEventListener("click", ()=>{
  fetch(`/events/${EVENT_ID}/share-link`, {method:"POST", credentials:"include"})
    .then(r=>r.json()).then(res=>{
      if(res.url){
        const absolute = location.origin + res.url;
        navigator.clipboard.writeText(absolute);
        alert("Lien copié : " + absolute);
      }
    });
});
document.getElementById("btn-close").addEventListener("click", ()=>{
  fetch(`/events/${EVENT_ID}/status`, {
    method:"PATCH", credentials:"include",
    headers:{"Content-Type":"application/json","Accept":"application/json"},
    body: JSON.stringify({status:"CLOSED"})
  }).then(async res=>{
    if(!res.ok){ const t = await res.text(); alert(t); return; }
    IS_OPEN = false;
    document.getElementById("status-badge").textContent = "Statut : CLOSED";
    document.getElementById("btn-reopen").style.display = CAN_MANAGE ? "" : "none";
    // désactive les boutons sans re-render
    ITEM_EL.forEach(box=>{ box.querySelectorAll("button").forEach(b=> b.disabled = true); });
    CHARGED_CB.forEach(cb=> cb.disabled = true);
  });
});
document.getElementById("btn-reopen").addEventListener("click", ()=>{
  fetch(`/events/${EVENT_ID}/status`, {
    method:"PATCH", credentials:"include",
    headers:{"Content-Type":"application/json","Accept":"application/json"},
    body: JSON.stringify({status:"OPEN"})
  }).then(async res=>{
    if(!res.ok){ const t = await res.text(); alert(t); return; }
    IS_OPEN = true;
    document.getElementById("status-badge").textContent = "Statut : OPEN";
    document.getElementById("btn-reopen").style.display = "none";
    // réactive les boutons
    ITEM_EL.forEach(box=>{ box.querySelectorAll("button").forEach(b=> b.disabled = !CAN_MANAGE); });
    CHARGED_CB.forEach(cb=> cb.disabled = !CAN_MANAGE);
  });
});

/* ----- Premier rendu + polling doux ----- */
buildUIOnce();
setInterval(refreshTree, 2000);
</script>
{% endblock %}
