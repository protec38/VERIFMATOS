{% extends "base.html" %}
{% set title = "Événement" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="row wrap">
        <div class="title">{{ event.name }}</div>
        <span class="badge" id="status-badge">Statut : {{ event.status if event.status is string else event.status.name }}</span>
      </div>
      <div class="muted">Date : {{ event.date or "—" }}</div>

      <div class="row wrap" style="margin-top:10px;">
        <a class="btn" href="/dashboard">← Menu principal</a>
        <a class="btn ghost" href="/logout">Déconnexion</a>
        <a class="btn primary" id="btn-share">Générer un lien secouristes</a>
        <a class="btn" id="btn-close">Clôturer l'événement</a>
      </div>
    </div>

    <div class="card">
      <div class="title">Progression</div>
      <div class="progress" style="margin-top:8px;"><div id="progress-bar" style="width:0%"></div></div>
      <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="row space-between wrap">
      <div class="title">Matériel à vérifier</div>
      <div class="row wrap">
        <label class="muted">Nom & prénom (pour enregistrer) :</label>
        <input id="who" placeholder="Nom & prénom" style="max-width:260px;">
      </div>
    </div>
    <div id="tree" class="tree" style="margin-top:10px;"></div>
  </div>

  <script>
    // Client Socket.IO v4 (chargé depuis base.html)
    const socket = io({ transports: ['websocket','polling'], upgrade: true, path: '/socket.io/' });

    const EVENT_ID = {{ event.id }};
    socket.emit("join_event", {event_id: EVENT_ID});

    let WHO = "";

    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className = v;
        else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
        else if(k==="html") e.innerHTML = v;
        else e.setAttribute(k,v);
      }
      for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
      return e;
    }

    function renderItemActions(item) {
      const disabled = !WHO;
      return el("div", {class:"item"},
        el("div", null, el("span", {class:"muted"}, "Vérification")),
        el("div", {class:"row"},
          el("button", {class:"btn", disabled, onclick: () => verifyItem(item.id, "OK")}, "OK"),
          el("button", {class:"btn ghost", disabled, onclick: () => verifyItem(item.id, "NOT_OK")}, "Non conforme"),
        )
      );
    }

    function renderTreeNode(root) {
      const group = root.type === "GROUP";
      const headRight = group
        ? el("label", {class:"check"},
            el("input", {type:"checkbox", id:"charged-"+root.id, onchange: e => setCharged(root.id, e.target.checked)}),
            el("span", null, "Chargé dans le véhicule")
          )
        : el("span", {class:"qty"}, `Qté: ${root.quantity ?? 0}`);

      return el("div", {class:"node", id:"node-"+root.id},
        el("div", {class:"header"},
          el("div", {class:"name"}, root.name),
          headRight
        ),
        el("div", {class:"childs"},
          ...(root.children || []).map(renderTreeNode),
          ...(!group ? [renderItemActions(root)] : [])
        )
      );
    }

    function countItems(nodes){ let c=0; (function rec(n){ if(n.type==="ITEM") c++; (n.children||[]).forEach(rec); })(nodes); return c; }
    function refreshProgress(tree){
      const total = (tree||[]).reduce((acc,r)=>acc+countItems(r),0);
      window.__TOTAL_ITEMS = total;
      fetch(`/events/${EVENT_ID}/stats`, {credentials:"include"})
        .then(r=>r.json()).then(s=>{
          const ok = s.verified_ok || 0;
          const pct = total ? Math.round(ok/total*100) : 0;
          document.getElementById("progress-bar").style.width = pct+"%";
          document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
        }).catch(()=>{});
    }

    async function loadTree(){
      const r = await fetch(`/events/${EVENT_ID}/tree`, {credentials:"include"});
      const TREE = await r.json();
      const host = document.getElementById("tree");
      host.innerHTML = "";
      (TREE||[]).forEach(x => host.appendChild(renderTreeNode(x)));
      refreshProgress(TREE||[]);
    }

    function setCharged(nodeId, checked){
      fetch(`/events/${EVENT_ID}/parent-status`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({node_id: nodeId, charged_vehicle: checked})
      });
    }

    function verifyItem(nodeId, status){
      if(!WHO){ alert("Merci de renseigner votre nom & prénom"); return; }
      fetch(`/events/${EVENT_ID}/verify`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({node_id: nodeId, status, verifier_name: WHO})
      }).then(async r=>{
        if(!r.ok){ alert(await r.text()); return; }
      });
    }

    socket.on("event_update", (p) => {
      if(p?.type === "item_verified" && typeof window.__TOTAL_ITEMS === "number"){
        const text = document.getElementById("progress-text").textContent;
        const m = text.match(/(\d+)\s*\/\s*(\d+)/);
        let ok = 0, total = window.__TOTAL_ITEMS;
        if(m){ ok = parseInt(m[1],10); total = parseInt(m[2],10); }
        ok = Math.min(total, ok+1);
        const pct = total ? Math.round(ok/total*100) : 0;
        document.getElementById("progress-bar").style.width = pct+"%";
        document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
        const n = document.getElementById("node-"+p.node_id);
        if(n){ n.style.outline="2px solid rgba(0,200,0,.5)"; setTimeout(()=>n.style.outline="", 800); }
      } else if(p?.type === "event_closed"){
        document.getElementById("status-badge").textContent = "Statut : CLOSED";
      }
    });

    document.getElementById("btn-share").addEventListener("click", () => {
      fetch(`/events/${EVENT_ID}/share-link`, {method:"POST", credentials:"include"})
      .then(r=>r.json()).then(res=>{
        if(res.url){
          const absolute = location.origin + res.url;
          navigator.clipboard.writeText(absolute).catch(()=>{});
          alert("Lien copié : " + absolute);
        }
      });
    });

    document.getElementById("btn-close").addEventListener("click", () => {
      fetch(`/events/${EVENT_ID}/status`, {
        method:"PATCH", headers:{"Content-Type":"application/json"}, credentials:"include",
        body: JSON.stringify({status:"CLOSED"})
      }).then(()=> location.reload());
    });

    document.getElementById("who").addEventListener("input", e=>{ WHO = e.target.value.trim(); });

    loadTree();
  </script>
{% endblock %}
