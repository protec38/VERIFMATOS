{% extends "base.html" %}
{% set title = "Événement" %}
{% block content %}

<style>
  .state-ok{
    border-color: var(--success) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(18,184,134,.15), transparent),
      #0f1e2f;
    box-shadow: 0 0 0 1px rgba(18,184,134,.35) inset, 0 0 18px rgba(18,184,134,.15);
  }
  .state-bad{
    border-color: var(--danger) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(255,107,107,.12), transparent),
      #0f1a27;
    box-shadow: 0 0 0 1px rgba(255,107,107,.30) inset, 0 0 18px rgba(255,107,107,.12);
  }
  .state-wait{
    border-color: var(--border) !important;
    background:
      radial-gradient(600px 200px at top left, rgba(45,123,191,.08), transparent),
      var(--bg-2);
  }
  .chip{padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--border);}
  .chip.ok{background:#0e2a24;color:#bff3e7;border-color:#1d6e5d}
  .chip.bad{background:#2a0e14;color:#ffd5dc;border-color:#75212f}
  .chip.wait{background:#101c2e;color:#b7c7dc;border-color:#24344f}

  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .dot-ok{background:var(--success)} .dot-bad{background:var(--danger)} .dot-wait{background:#37527a}

  .parents-card .title{display:flex;align-items:center;gap:10px}
  .parents-bar{display:flex;gap:8px;overflow:auto;padding:8px 2px}
  .parent-pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;border:1px solid var(--border);cursor:pointer;
    user-select:none;white-space:nowrap;transition:transform .08s ease, box-shadow .08s ease, border-color .08s ease;
    background:#0f1a2a;color:var(--text)
  }
  .parent-pill:hover{transform:translateY(-1px)}
  .pill-ok{border-color:#1d6e5d;background:#0e2a24;color:#bff3e7}
  .pill-bad{border-color:#75212f;background:#2a0e14;color:#ffd5dc}
  .pill-wait{border-color:#24344f;background:#101c2e;color:#b7c7dc}

  .vehicle{font-size:12px; opacity:.9; padding:2px 6px; border-radius:6px; border:1px dashed var(--border); margin-left:8px}
  .vehicle.on{background:#0e2a24; color:#bff3e7; border-color:#1d6e5d}
  .vehicle.off{background:#101c2e; color:#b7c7dc; border-color:#24344f}
</style>

<div class="grid cols-2">
  <div class="card">
    <div class="row space-between">
      <div>
        <div class="title">{{ event.name }}</div>
        <div class="muted">Date : {{ event.date or "—" }}</div>
      </div>
      <span class="badge" id="status-badge">Statut : {{ event.status }}</span>
    </div>
    <div class="row wrap" style="margin-top:10px;">
      <a class="btn" target="_blank" href="/reports/event/{{ event.id }}/pdf">Exporter PDF</a>
      <button class="btn primary" id="btn-share">Lien secouristes</button>
      <button class="btn" id="btn-close">Clôturer l'événement</button>
    </div>
  </div>

  <div class="card">
    <div class="title">Progression</div>
    <div class="row wrap" style="margin-top:8px;gap:10px;">
      <span class="chip ok" id="stat-ok">OK : 0</span>
      <span class="chip bad" id="stat-bad">Non conformes : 0</span>
      <span class="chip wait" id="stat-wait">En attente : 0</span>
    </div>
    <div class="progress" style="margin-top:10px;"><div id="progress-bar" style="width:0%"></div></div>
    <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
  </div>
</div>

<div class="card parents-card" style="margin-top:12px;">
  <div class="title">Parents à vérifier</div>
  <div id="parents-bar" class="parents-bar"></div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="row space-between">
    <div class="title">Matériel à vérifier</div>
    <div class="muted">Vert = tout OK • Rouge = au moins un non conforme • Bleu = en attente</div>
  </div>
  <div id="tree" class="tree" style="margin-top:10px;"></div>
</div>

<script>
const EVENT_ID = {{ event.id }};
let TREE = {{ (tree or [])|tojson }};
let IS_OPEN = ("{{ event.status }}".toUpperCase() === "OPEN");

const NODE_MAP = new Map();
const GROUP_EL = new Map();
const ITEM_EL  = new Map();
const VEH_LABEL = new Map();

function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
  return e;
}
const isItem = n => (n.type||"").toUpperCase()==="ITEM";
const isGroup = n => (n.type||"").toUpperCase()==="GROUP";
function normStatus(s){
  s = (s||"").toUpperCase();
  if(s==="OK") return "OK";
  if(s==="NOT_OK" || s==="NOK" || s==="KO" || s==="NOT-OK" || s==="NOTOK") return "NOT_OK";
  return "PENDING";
}

function flattenItems(nodes){ const out=[]; (nodes||[]).forEach(function rec(n){ if(isItem(n)) out.push(n); (n.children||[]).forEach(rec); }); return out; }
function groupAllOk(n){ const items=flattenItems([n]); return items.length>0 && items.every(i=>normStatus(i.last_status)==="OK"); }
function groupHasBad(n){ return flattenItems([n]).some(i=>normStatus(i.last_status)==="NOT_OK"); }
function groupStatus(n){ if(groupAllOk(n)) return "OK"; if(groupHasBad(n)) return "BAD"; return "WAIT"; }

function recomputeStats(){
  const items = flattenItems(TREE);
  const total = items.length;
  const ok = items.filter(i=>normStatus(i.last_status)==="OK").length;
  const bad = items.filter(i=>normStatus(i.last_status)==="NOT_OK").length;
  const wait = total - ok - bad;
  document.getElementById("stat-ok").textContent = `OK : ${ok}`;
  document.getElementById("stat-bad").textContent = `Non conformes : ${bad}`;
  document.getElementById("stat-wait").textContent = `En attente : ${wait}`;
  const pct = total? Math.round(ok/total*100) : 0;
  document.getElementById("progress-bar").style.width = pct+"%";
  document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
}

function statusDot(isOk, isBad){ return el("span",{class:"status-dot "+(isOk?"dot-ok":(isBad?"dot-bad":"dot-wait"))}); }

function renderItem(n){
  const s = normStatus(n.last_status);
  const right = el("div",{class:"row"},
    el("button",{class:"btn success", disabled:!IS_OPEN, onclick:()=>verify(n.id,"OK")},"OK"),
    el("button",{class:"btn ghost",   disabled:!IS_OPEN, onclick:()=>verify(n.id,"NOT_OK")},"Non conforme")
  );
  const wrap = el("div",{class:"item "+(s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait")), id:`item-${n.id}`},
    el("div",null,
      el("div",{class:"name"}, statusDot(s==="OK", s==="NOT_OK"), " ", n.name),
      el("div",{class:"muted", id:`status-${n.id}`}, `Dernier statut: ${s==="OK"?"✅ OK":(s==="NOT_OK"?"❌ Non conforme":"⏳ En attente")}${n.last_by?` (${n.last_by})`:''}`)
    ),
    right
  );
  ITEM_EL.set(n.id, wrap);
  return wrap;
}

function renderGroup(n){
  const veh = el("span",{class:"vehicle "+(n.charged_vehicle?'on':'off')},
    n.charged_vehicle ? `Chargé : ${n.charged_vehicle_name || "—"}` : "Non chargé"
  );
  VEH_LABEL.set(n.id, veh);

  const headerLeft = el("div",{class:"name"},
    statusDot(groupStatus(n)==="OK", groupStatus(n)==="BAD"), " ", n.name,
    n.is_event_root ? veh : null
  );
  const header = el("div",{class:"header"}, headerLeft);
  const children = el("div",{class:"childs"}, ...(n.children||[]).map(renderNode));
  const box = el("div",{class:`node ${groupStateClass(n)}`, id:`node-${n.id}`}, header, children);
  GROUP_EL.set(n.id, box);
  return box;
}
function groupStateClass(n){
  const s = groupStatus(n);
  if(s==="OK") return "state-ok";
  if(s==="BAD") return "state-bad";
  return "state-wait";
}
function renderNode(n){ return isGroup(n) ? renderGroup(n) : renderItem(n); }

function indexTree(nodes){
  (nodes||[]).forEach(function rec(n){
    NODE_MAP.set(n.id, n);
    (n.children||[]).forEach(rec);
  });
}

function buildUIOnce(){
  const root = document.getElementById("tree");
  root.innerHTML = "";
  indexTree(TREE);
  (TREE||[]).forEach(n => root.appendChild(renderNode(n)));
  recomputeStats();
}

function applyItemDelta(local, incoming){
  local.last_status = normStatus(incoming.last_status || "PENDING");
  local.last_by = incoming.last_by || "";

  const box = ITEM_EL.get(local.id);
  if(!box) return;
  box.classList.remove("state-ok","state-bad","state-wait");
  const s = normStatus(local.last_status);
  box.classList.add(s==="OK"?"state-ok":(s==="NOT_OK"?"state-bad":"state-wait"));
  const statusDiv = box.querySelector(`#status-${local.id}`);
  if(statusDiv){
    statusDiv.textContent = `Dernier statut: ${s==="OK"?"✅ OK":(s==="NOT_OK"?"❌ Non conforme":"⏳ En attente")}${local.last_by?` (${local.last_by})`:''}`;
  }
}

function applyGroupDelta(local, incoming){
  if(typeof incoming.charged_vehicle !== "undefined"){
    local.charged_vehicle = !!incoming.charged_vehicle;
    local.charged_vehicle_name = incoming.charged_vehicle_name || null;
    const lab = VEH_LABEL.get(local.id);
    if(lab){
      lab.classList.toggle("on", !!local.charged_vehicle);
      lab.classList.toggle("off", !local.charged_vehicle);
      lab.textContent = local.charged_vehicle ? `Chargé : ${local.charged_vehicle_name || "—"}` : "Non chargé";
    }
  }
  const box = GROUP_EL.get(local.id);
  if(!box) return;
  box.classList.remove("state-ok","state-bad","state-wait");
  box.classList.add(groupStateClass(local));
}

function syncTreeIncoming(incomingRoots){
  (incomingRoots||[]).forEach(function recInc(nInc){
    const nLoc = NODE_MAP.get(nInc.id);
    if(!nLoc) return;
    if(isItem(nLoc)){
      applyItemDelta(nLoc, nInc);
    } else {
      (nInc.children||[]).forEach(recInc);
      applyGroupDelta(nLoc, nInc);
    }
  });
  recomputeStats();
}

async function refreshTree(){
  try{
    const r = await fetch(`/events/${EVENT_ID}/tree`, {credentials:"include"});
    if(!r.ok) return;
    const latest = await r.json();
    if(TREE.length===0){
      TREE = latest;
      buildUIOnce();
    }else{
      syncTreeIncoming(latest);
    }
  }catch(_){}
}

function verify(nodeId, status){
  fetch(`/events/${EVENT_ID}/verify`, {
    method:"POST", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ node_id: nodeId, status })
  }).then(()=>refreshTree());
}

document.getElementById("btn-share").addEventListener("click", ()=>{
  fetch(`/events/${EVENT_ID}/share-link`, {method:"POST", credentials:"include"})
    .then(r=>r.json())
    .then(res=>{
      if(res && res.url){
        const absolute = location.origin + res.url;
        navigator.clipboard.writeText(absolute).catch(()=>{});
        alert("Lien secouristes copié : " + absolute);
      }else{
        alert("Impossible de générer le lien.");
      }
    })
    .catch(()=> alert("Erreur réseau"));
});

document.getElementById("btn-close").addEventListener("click", ()=>{
  fetch(`/events/${EVENT_ID}/status`, {
    method:"PATCH", credentials:"include",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({status:"CLOSED"})
  }).then(()=>{
    IS_OPEN = false;
    document.getElementById("status-badge").textContent = "Statut : CLOSED";
    ITEM_EL.forEach(box=> box.querySelectorAll("button").forEach(b=> b.disabled = true));
  });
});

(function init(){
  refreshTree();
  setInterval(refreshTree, 2000);
})();
</script>
{% endblock %}
