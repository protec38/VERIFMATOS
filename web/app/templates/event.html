{% extends "base.html" %}
{% from "base.html" import icon %}
{% set title = "Événement" %}
{% block content %}
  <div class="grid cols-2">
    <div class="card">
      <div class="row">
        <div class="title">{{ event.name }}</div>
        <span class="badge" id="status-badge">Statut : {{ event.status if event.status is string else event.status.name }}</span>
      </div>
      <div class="muted">Date : {{ event.date or "—" }}</div>
      <div class="row" style="margin-top:10px;">
        <a class="btn" href="{{ url_for('pages.dashboard') }}">← Menu principal</a>
        <a class="btn ghost" href="{{ url_for('pages.logout') }}">Déconnexion</a>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="btn-share">Générer un lien pour les secouristes</button>
        <button class="btn" id="btn-close">Clôturer l'événement</button>
      </div>
    </div>
    <div class="card">
      <div class="title">Progression</div>
      <div class="progress" style="margin-top:8px;"><div id="progress-bar" style="width:0%"></div></div>
      <div class="muted" id="progress-text" style="margin-top:6px;">0 / 0 vérifiés</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="title">Matériel à vérifier</div>
    <div id="tree" class="tree" style="margin-top:10px;"></div>
  </div>

  <script>
    const EVENT_ID = {{ event.id }};
    let TREE = {{ tree|tojson }};

    const socket = io({transports:['websocket']});
    socket.emit("join_event", {event_id: EVENT_ID});

    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k==="class") e.className = v;
        else if(k.startsWith("on") && typeof v==="function") e.addEventListener(k.slice(2), v);
        else if(k==="html") e.innerHTML = v;
        else e.setAttribute(k,v);
      }
      for(const c of children){ if(c!=null) e.append(c.nodeType?c:document.createTextNode(c)); }
      return e;
    }

    function renderItemActions(item) {
      return el("div", {class:"item"},
        el("div", null, el("span", {class:"muted"}, "Vérification")),
        el("div", {class:"row"},
          el("input", {type:"text", placeholder:"Nom & prénom", id:"name-"+item.id}),
          el("button", {class:"btn", onclick: () => verifyItem(item.id, "OK")}, "OK"),
          el("button", {class:"btn ghost", onclick: () => verifyItem(item.id, "NOT_OK")}, "Non conforme"),
        )
      );
    }

    function renderTree(root) {
      const isGroup = (root.type === "GROUP");
      return el("div", {class:"node", id:"node-"+root.id},
        el("div", {class:"header"},
          el("div", {class:"name"}, root.name),
          isGroup
            ? el("label", {class:"check"},
                el("input", {type:"checkbox", id:"charged-"+root.id, onchange: e => setCharged(root.id, e.target.checked)}),
                el("span", null, "Chargé dans le véhicule"))
            : el("span", {class:"qty"}, `Qté: ${root.quantity ?? 0}`)
        ),
        el("div", {class:"childs"},
          ...(root.children || []).map(renderTree),
          ...(!isGroup ? [renderItemActions(root)] : [])
        )
      );
    }

    function buildUI() {
      const treeEl = document.getElementById("tree");
      treeEl.innerHTML = "";
      (TREE || []).forEach(root => treeEl.appendChild(renderTree(root)));
      recomputeProgressInitial();
    }

    // Fallback: si le serveur n'a pas injecté l'arbre (ou vide), on refetch côté client
    async function loadTreeIfEmpty(){
      try{
        if(Array.isArray(TREE) && TREE.length > 0) return;
        const r = await fetch(`/events/${EVENT_ID}/tree`, {credentials:"include"});
        if(r.ok){ TREE = await r.json(); buildUI(); }
      }catch(e){}
    }

    function flattenItems(nodes) {
      const out = [];
      (function each(n){ if(n.type === "ITEM") out.push(n.id); (n.children||[]).forEach(each); })({children:nodes});
      return out;
    }
    const totalItems = flattenItems(TREE || []).length;
    let okCount = 0;
    function setProgress(ok){
      const total = totalItems || flattenItems(TREE || []).length;
      const pct = total ? Math.round(ok/total*100) : 0;
      document.getElementById("progress-bar").style.width = pct + "%";
      document.getElementById("progress-text").textContent = `${ok} / ${total} vérifiés`;
    }
    function recomputeProgressInitial(){ setProgress(okCount); }

    async function setCharged(nodeId, checked){
      try{
        await fetch(`/events/${EVENT_ID}/parent-status`, {
          method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
          body: JSON.stringify({node_id: nodeId, charged_vehicle: checked})
        });
      }catch(e){}
    }

    async function verifyItem(nodeId, status){
      const name = document.getElementById("name-"+nodeId)?.value.trim();
      if(!name){ alert("Merci de renseigner votre nom et prénom"); return; }
      try{
        const r = await fetch(`/events/${EVENT_ID}/verify`, {
          method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
          body: JSON.stringify({node_id: nodeId, status, verifier_name: name})
        });
        if(!r.ok){ const t = await r.text(); alert(t||"Erreur"); }
      }catch(e){}
    }

    socket.on("event_update", (payload) => {
      if(payload?.type === "item_verified"){
        okCount = okCount + 1; setProgress(okCount);
      }
      if(payload?.type === "event_closed"){
        document.getElementById("status-badge").textContent = "Statut : CLOSED";
      }
    });

    document.getElementById("btn-share").addEventListener("click", async () => {
      try {
        let res = null;
        const r = await fetch(`/events/${EVENT_ID}/share-link`, {method:"POST", credentials:"include"});
        if(r.ok) res = await r.json();
        if(!res || !res.url){
          const rg = await fetch(`/events/${EVENT_ID}/share-link`, {credentials:"include"});
          if(rg.ok) res = await rg.json();
        }
        if(res?.url){
          const absolute = res.url.startsWith("http") ? res.url : (location.origin + res.url);
          try { await navigator.clipboard.writeText(absolute); alert("Lien copié : " + absolute); }
          catch(e){ prompt("Voici le lien à partager :", absolute); }
        } else {
          alert("Impossible de générer / récupérer le lien.");
        }
      } catch(e) { alert("Erreur de génération de lien"); }
    });

    document.getElementById("btn-close").addEventListener("click", () => {
      fetch(`/events/${EVENT_ID}/status`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify({status:"CLOSED"})
      }).then(async r => {
        if(!r.ok){ const t = await r.text(); alert(t||"Erreur"); return; }
        location.reload();
      });
    });

    buildUI();
    loadTreeIfEmpty();
  </script>
{% endblock %}
