{% extends "base.html" %}
{% set title = "Templates & lots" %}
{% block content %}
{% set templates_count = templates|length if templates else 0 %}
{% set lots_count = lots|length if lots else 0 %}

<div class="templates-page">
  <header class="templates-header">
    <div class="templates-header__intro">
      <h1 class="templates-title">Templates & lots</h1>
      <p class="templates-lead">Assemble rapidement les parents racines nÃ©cessaires pour les Ã©vÃ©nements rÃ©currents et garde une trace claire de ce qui doit Ãªtre prÃ©parÃ©.</p>
    </div>
    <div class="templates-metrics">
      <div class="templates-metric">
        <span class="templates-metric__value">{{ templates_count }}</span>
        <span class="templates-metric__label">Templates</span>
      </div>
      <div class="templates-metric">
        <span class="templates-metric__value">{{ lots_count }}</span>
        <span class="templates-metric__label">Lots</span>
      </div>
    </div>
  </header>

  <div class="templates-board">
    <section class="card templates-card">
      <div class="hd">
        <div>
          <h2 class="title">Templates & lots enregistrÃ©s</h2>
          <p class="subtitle">Clique sur Â«Â Ã‰diterÂ Â» pour modifier un modÃ¨le existant ou crÃ©e un nouveau jeu de matÃ©riel.</p>
        </div>
      </div>
      <div class="bd">
        <div class="templates-table">
          <div class="templates-table__scroll">
            <table class="table" id="templates-table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th class="templates-table__kind">Type</th>
                  <th class="templates-table__nodes">Parents inclus</th>
                  <th class="templates-table__actions">Actions</th>
                </tr>
              </thead>
              <tbody id="templates-body">
                <tr><td colspan="4" class="templates-table__empty">Chargementâ€¦</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="card templates-form">
      <div class="hd">
        <div>
          <h2 class="title" id="form-title">CrÃ©er un template ou un lot</h2>
          <p class="subtitle">SÃ©lectionne les parents racines Ã  inclure dans le modÃ¨le.</p>
        </div>
      </div>
      <div class="bd">
        <div class="templates-form__grid">
          <div class="field">
            <label for="tpl-name">Nom</label>
            <input type="text" id="tpl-name" placeholder="Nom du modÃ¨le" required>
          </div>
          <div class="field">
            <label for="tpl-kind">Type</label>
            <select id="tpl-kind">
              <option value="TEMPLATE">Template</option>
              <option value="LOT">Lot</option>
            </select>
          </div>
        </div>

        <div class="field templates-form__description">
          <label for="tpl-desc">Description (optionnel)</label>
          <textarea id="tpl-desc" rows="3" placeholder="Notes complÃ©mentairesâ€¦"></textarea>
        </div>

        <div class="templates-alert">
          <div class="templates-alert__title">Parents racines disponibles</div>
          {% if root_groups and root_groups|length %}
            <div class="root-groups" id="root-checkboxes">
              {% for group in root_groups %}
                <div class="root-group">
                  <div class="root-group-header">
                    <span class="root-group-label">{{ group.category.name if group.category else "Sans catÃ©gorie" }}</span>
                    {% if group.nodes %}
                      <span class="badge badge--soft">{{ group.nodes|length }} parent{{ 's' if group.nodes|length > 1 else '' }}</span>
                    {% endif %}
                  </div>
                  {% if group.nodes and group.nodes|length %}
                    <div class="root-group-list">
                      {% for r in group.nodes %}
                        <label class="root-chip">
                          <input type="checkbox" class="root-cb" value="{{ r.id }}"
                                 data-name="{{ r.name }}"
                                 data-unique="{{ 1 if r.unique_item else 0 }}"
                                 data-max="{{ r.unique_quantity if r.unique_quantity is not none else '' }}">
                          <span class="root-chip-content">
                            <span class="root-chip-name">{{ r.name }}</span>
                            {% if r.unique_item %}
                              <span class="root-chip-meta">
                                Objet unique{% if r.unique_quantity is not none %} Â· max {{ r.unique_quantity }}{% endif %}
                              </span>
                            {% endif %}
                          </span>
                        </label>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="root-group-empty">Aucun parent dans cette catÃ©gorie.</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <span class="templates-alert__empty">Aucun parent racine disponible. CrÃ©e dâ€™abord un stock parent dans ðŸ§° Stock.</span>
          {% endif %}
        </div>

        <div class="templates-actions">
          <button class="btn primary" type="button" id="btn-save">ðŸ’¾ Enregistrer</button>
          <button class="btn ghost" type="button" id="btn-reset">âž• Nouveau</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  const byId = (id)=>document.getElementById(id);
  const rootSelections = new Map();
  const templateSpecs = {{ templates|tojson }};
  const lotSpecs = {{ lots|tojson }};
  const rootsFlat = {{ roots_flat|tojson }};
  const rootMap = new Map((rootsFlat||[]).map(r => [Number(r.id), r]));
  let entries = [];
  let currentEditId = null;

  const tableBody = byId('templates-body');
  const nameInput = byId('tpl-name');
  const kindInput = byId('tpl-kind');
  const descInput = byId('tpl-desc');
  const formTitle = byId('form-title');
  const saveBtn = byId('btn-save');
  const resetBtn = byId('btn-reset');
  const checkboxContainer = byId('root-checkboxes');

  function renderEntries(){
    if(!tableBody) return;
    if(!entries.length){
      tableBody.innerHTML = '<tr><td colspan="4" class="templates-table__empty">Aucun template pour le moment.</td></tr>';
      return;
    }
    tableBody.innerHTML = '';
    for(const entry of entries){
      const tr = document.createElement('tr');
      tr.dataset.id = entry.id;
      tr.innerHTML = `
        <td>${entry.name}</td>
        <td>${entry.kind === 'LOT' ? 'Lot' : 'Template'}</td>
        <td>${(entry.root_nodes||[]).map(n => n.name).join(', ') || 'â€”'}</td>
        <td class="templates-table__actions-cell">
          <button class="btn sm" data-action="edit">Ã‰diter</button>
          <button class="btn danger sm" data-action="delete">Supprimer</button>
        </td>`;

      const editBtn = tr.querySelector('[data-action="edit"]');
      const deleteBtn = tr.querySelector('[data-action="delete"]');

      if(editBtn){
        editBtn.addEventListener('click', () => loadEntry(entry.id));
      }

      if(deleteBtn){
        deleteBtn.addEventListener('click', () => deleteEntry(entry.id));
      }

      tableBody.appendChild(tr);
    }
  }

  function serializeSelections(){
    return Array.from(rootSelections.entries()).map(([id, meta]) => ({ id: Number(id), ...meta }));
  }

  function resetForm(){
    currentEditId = null;
    formTitle.textContent = 'CrÃ©er un template ou un lot';
    nameInput.value = '';
    kindInput.value = 'TEMPLATE';
    descInput.value = '';
    rootSelections.clear();
    if(checkboxContainer){
      checkboxContainer.querySelectorAll('.root-cb').forEach(cb => {
        cb.checked = false;
        cb.closest('.root-chip')?.classList.remove('root-chip--checked');
      });
    }
  }

  function loadEntry(id){
    const entry = entries.find(e => e.id === id);
    if(!entry) return;
    currentEditId = entry.id;
    formTitle.textContent = 'Modifier le modÃ¨le';
    nameInput.value = entry.name || '';
    kindInput.value = entry.kind || 'TEMPLATE';
    descInput.value = entry.description || '';
    rootSelections.clear();
    (entry.root_nodes||[]).forEach(n => rootSelections.set(String(n.id), { name: n.name }));
    if(checkboxContainer){
      checkboxContainer.querySelectorAll('.root-cb').forEach(cb => {
        const checked = rootSelections.has(cb.value);
        cb.checked = checked;
        cb.closest('.root-chip')?.classList.toggle('root-chip--checked', checked);
      });
    }
  }

  function deleteEntry(id){
    if(!confirm('Supprimer ce modÃ¨le ?')) return;
    fetch(`/templates/api/${id}`, { method: 'DELETE', credentials: 'include' })
      .then(resp => {
        if(resp.ok){
          entries = entries.filter(e => e.id !== id);
          if(currentEditId === id){
            resetForm();
          }
          renderEntries();
        }else{
          alert('Suppression refusÃ©e');
        }
      });
  }

  function fetchEntries(){
    const payload = [];
    for(const tpl of templateSpecs || []){
      payload.push({
        id: tpl.id,
        name: tpl.name,
        kind: tpl.kind || 'TEMPLATE',
        description: tpl.description,
        root_nodes: (tpl.root_nodes||[]).map(id => rootMap.get(Number(id))).filter(Boolean)
      });
    }
    for(const lot of lotSpecs || []){
      payload.push({
        id: lot.id,
        name: lot.name,
        kind: 'LOT',
        description: lot.description,
        root_nodes: (lot.root_nodes||[]).map(id => rootMap.get(Number(id))).filter(Boolean)
      });
    }
    entries = payload.sort((a,b) => a.name.localeCompare(b.name));
    renderEntries();
  }

  function setupCheckboxes(){
    if(!checkboxContainer) return;
    checkboxContainer.querySelectorAll('.root-cb').forEach(cb => {
      cb.addEventListener('change', () => {
        const meta = {
          name: cb.dataset.name,
          unique: cb.dataset.unique === '1',
          max: cb.dataset.max ? Number(cb.dataset.max) : null,
        };
        if(cb.checked){
          rootSelections.set(cb.value, meta);
        }else{
          rootSelections.delete(cb.value);
        }
        cb.closest('.root-chip')?.classList.toggle('root-chip--checked', cb.checked);
      });
    });
  }

  function submitForm(){
    if(!nameInput.value.trim()){
      alert('Merci de renseigner un nom.');
      return;
    }
    const body = {
      name: nameInput.value.trim(),
      kind: kindInput.value,
      description: descInput.value.trim() || null,
      roots: serializeSelections().map(r => r.id),
    };

    const url = currentEditId ? `/templates/api/${currentEditId}` : '/templates/api';
    const method = currentEditId ? 'PUT' : 'POST';

    fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(body),
    }).then(resp => {
      if(resp.ok){
        return resp.json();
      }
      throw new Error('Sauvegarde refusÃ©e');
    }).then(data => {
      const updated = {
        id: data.id,
        name: data.name,
        kind: data.kind,
        description: data.description,
        root_nodes: (data.root_nodes||[]).map(id => rootMap.get(Number(id))).filter(Boolean)
      };
      if(currentEditId){
        entries = entries.map(e => e.id === updated.id ? updated : e);
      }else{
        entries = [...entries, updated];
      }
      renderEntries();
      resetForm();
    }).catch(err => {
      alert(err.message || 'Sauvegarde refusÃ©e');
    });
  }

  fetchEntries();
  setupCheckboxes();

  if(saveBtn){ saveBtn.addEventListener('click', submitForm); }
  if(resetBtn){ resetBtn.addEventListener('click', resetForm); }
})();
</script>
{% endblock %}
