<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>{{ title or "Protection Civile ‚Äî Pr√©paration Mat√©riel" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#3d6cff">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}">
</head>
<body>
  <div class="sidebar-backdrop" id="sidebar-backdrop" data-open="false"></div>
  <div class="app-shell">
    <aside class="app-sidebar" id="sidebar" data-open="false">
      <div class="app-sidebar__inner">
        <div class="app-sidebar__brand">
          <img src="{{ url_for('static', filename='pc_logo.webp') }}" alt="Protection Civile" class="app-sidebar__logo" loading="lazy" onerror="this.style.display='none'">
          <div>
            <div class="app-sidebar__title">Protection Civile</div>
            <div class="app-sidebar__subtitle">Pr√©paration mat√©riel</div>
          </div>
          <button type="button" class="app-sidebar__close" id="close-sidebar" aria-label="Fermer le menu">√ó</button>
        </div>

        {% set _cu = current_user if current_user is defined else None %}
        <nav class="app-sidebar__menu">
          <a class="app-sidebar__link" href="/dashboard">üè† Menu principal</a>

          {% if _cu and _cu.is_authenticated %}
            <a class="app-sidebar__link" href="/peremption">
              <span>‚åõ P√©remptions</span>
              <span id="peremp-badge" class="app-sidebar__badge" style="display:none">0</span>
            </a>
            <a class="app-sidebar__link" href="/calendar">üóìÔ∏è Calendrier</a>

            {% if _cu.role and _cu.role.name in ['ADMIN', 'CHEF', 'VERIFICATIONPERIODIQUE'] %}
              <a class="app-sidebar__link" href="/verification-periodique">‚úÖ V√©rification p√©riodique</a>
            {% endif %}

            {% if _cu.role and _cu.role.name in ['ADMIN', 'CHEF'] %}
              <a class="app-sidebar__link" href="/templates">üß© Templates & lots</a>
            {% endif %}

            {% if _cu.role and _cu.role.name == 'ADMIN' %}
              <a class="app-sidebar__link" href="/stock">üß∞ Stock</a>
              <a class="app-sidebar__link" href="/admin">üîß Administration</a>
            {% endif %}

            <a class="app-sidebar__link app-sidebar__link--ghost" href="/logout">‚á¶ D√©connexion</a>
          {% else %}
            <a class="app-sidebar__link app-sidebar__link--highlight" href="/login">Connexion</a>
          {% endif %}
        </nav>
      </div>
    </aside>

    <div class="app-main">
      <header class="topbar">
        <div class="topbar__brand">
          <button class="topbar__toggle" type="button" id="open-sidebar" aria-controls="sidebar" aria-expanded="false">‚ò∞</button>
          <div class="topbar__title">{{ title or "Protection Civile ‚Äî Pr√©paration Mat√©riel" }}</div>
        </div>
        <div class="topbar__actions">
          <span class="badge">Interface DPS</span>
        </div>
      </header>

      <main class="page" id="main-content">
        {% block content %}{% endblock %}
      </main>

      <footer class="footer">
        {% set _now = now() if now is defined else None %}
        ¬© {{ (_now.year if _now else '‚Äî') }} Protection Civile ‚Äî Interface de pr√©paration (DPS)
      </footer>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  {% macro icon(name) -%}<span class="ico">{{ name }}</span>{%- endmacro %}

  <script>
  (function(){
    var sidebar = document.getElementById('sidebar');
    var openBtn = document.getElementById('open-sidebar');
    var closeBtn = document.getElementById('close-sidebar');
    var backdrop = document.getElementById('sidebar-backdrop');

    var setState = function(open){
      var state = open ? 'true' : 'false';
      if(sidebar){ sidebar.setAttribute('data-open', state); }
      if(backdrop){ backdrop.setAttribute('data-open', state); }
      if(openBtn){ openBtn.setAttribute('aria-expanded', state); }
    };

    if(openBtn){
      openBtn.addEventListener('click', function(){
        var isOpen = sidebar && sidebar.getAttribute('data-open') === 'true';
        setState(!isOpen);
      });
    }

    if(closeBtn){
      closeBtn.addEventListener('click', function(){ setState(false); });
    }

    if(backdrop){
      backdrop.addEventListener('click', function(){ setState(false); });
    }

    var mq = window.matchMedia('(min-width: 960px)');
    var syncState = function(e){
      if(e.matches){
        setState(true);
      }else{
        setState(false);
      }
    };

    syncState(mq);
    if(mq.addEventListener){
      mq.addEventListener('change', syncState);
    }else if(mq.addListener){
      mq.addListener(syncState);
    }
  })();

  (function(){
    try{
      fetch('/stats/stock/expiry/counts', {credentials: 'include'})
        .then(function(resp){ return resp && resp.ok ? resp.json() : null; })
        .then(function(data){
          if(!data) return;
          var badge = document.getElementById('peremp-badge');
          if(!badge) return;
          var expired = data.expired || 0;
          var j30 = data.j30 || 0;
          var totalAlert = expired + j30;
          if(totalAlert > 0){
            badge.style.display = 'inline-flex';
            badge.textContent = totalAlert;
            badge.style.background = expired > 0 ? 'rgba(217,48,37,0.92)' : 'rgba(251,188,4,0.88)';
          }
        })
        .catch(function(){});
    }catch(e){}
  })();
  </script>
</body>
</html>
