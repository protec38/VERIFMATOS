{% extends "base.html" %}
{% set title = "Vérification périodique" %}
{% block content %}
<div class="verification-page">
  <div class="verification-grid">
    <section class="card verification-card">
      <div class="verification-card__header">
        <div>
          <h2 class="verification-card__title">Vérification périodique du matériel</h2>
          <p class="verification-card__subtitle">Sélectionne un parent racine pour afficher son contenu et enregistre les contrôles sans créer d’événement.</p>
        </div>
        <button class="btn" id="history-btn">Historique des vérifications</button>
      </div>
      <div class="verification-card__alert">
        <p>Rôles autorisés : ADMIN, CHEF et VERIFICATIONPERIODIQUE.</p>
        <p>Clique sur un parent dans la liste pour charger son arbre puis marque chaque item comme conforme ou non conforme.</p>
      </div>
    </section>

    <section class="card verification-card">
      <div class="verification-card__header">
        <h2 class="verification-card__title">Parents disponibles</h2>
      </div>
      <div id="root-buttons" class="parents-bar"></div>
    </section>
  </div>

  <section class="card verification-card">
    <div class="verification-card__header">
      <div>
        <h2 class="verification-card__title" id="current-root-name">Sélectionne un parent</h2>
        <p class="verification-card__subtitle" id="progress-text">0 / 0 vérifiés</p>
      </div>
      <div class="verification-stats">
        <span class="chip chip--ok" id="stat-ok">OK : 0</span>
        <span class="chip chip--danger" id="stat-bad">Non conformes : 0</span>
        <span class="chip chip--pending" id="stat-wait">En attente : 0</span>
      </div>
    </div>
    <div class="verification-progress">
      <div class="verification-progress__track">
        <div id="progress-bar" class="verification-progress__bar"></div>
      </div>
    </div>
  </section>

  <section class="card verification-card">
    <div class="verification-card__header">
      <h2 class="verification-card__title">Matériel à contrôler</h2>
      <p class="verification-card__subtitle">Vert = tout OK • Rouge = au moins un non conforme • Bleu = en attente</p>
    </div>
    <div id="tree" class="tree"></div>
  </section>

  <section class="card verification-actions">
    <div class="verification-actions__group">
      <button class="btn" id="public-link-btn">Lien public</button>
      <button class="btn primary" id="finish-verification-btn">Finir la vérification</button>
    </div>
  </section>
</div>

<script>
const ROOTS = {{ (roots or [])|tojson }};
const CURRENT_USER_NAME = {{ (current_user_name or '')|tojson }};
let CURRENT_ROOT_ID = ROOTS.length ? ROOTS[0].id : null;
let TREE = [];
let CURRENT_SHARE_INFO = null;

const NODE_MAP = new Map();
const GROUP_EL = new Map();
const ITEM_EL = new Map();
const ITEM_STATUS_TXT = new Map();
const ITEM_QTY_TXT = new Map();
const ROOT_STATUS = new Map();
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==="class") e.className = v;
    else if(k==="html") e.innerHTML = v;
    else if(k.startsWith("on") && typeof v === "function") e.addEventListener(k.slice(2), v);
    else e.setAttribute(k, v);
  }
  for(const c of children){
    if(c == null) continue;
    e.append(c.nodeType ? c : document.createTextNode(c));
  }
  return e;
}

function closeModal(){
  const m = document.getElementById("modal-root");
  if(m) m.remove();
}

function openModal(content){
  closeModal();
  const wrap = document.createElement("div");
  wrap.id = "modal-root";
  wrap.className = "modal-back";
  const card = document.createElement("div");
  card.className = "modal";
  card.appendChild(content);
  wrap.appendChild(card);
  document.body.appendChild(wrap);
}

function indexTree(nodes){
  NODE_MAP.clear();
  (nodes||[]).forEach(function rec(n){
    NODE_MAP.set(n.id, n);
    (n.children||[]).forEach(rec);
  });
}

const domSafeId = id => String(id).replace(/[^a-zA-Z0-9_-]/g, "-");
const isItem = n => {
  if(!n) return false;
  if(n.unique_parent) return true;
  const type = (n.type||"").toUpperCase();
  return type === "ITEM" || (!!n.unique_item && !(n.children||[]).length);
};
const isGroup = n => !isItem(n);
const targetNodeId = n => (n && (n.target_node_id || n.id));
function normStatus(s){
  s = (s||"").toUpperCase();
  if(s === "OK") return "OK";
  if(s === "NOT_OK" || s === "NOT-OK" || s === "KO" || s === "NOK") return "NOT_OK";
  return "PENDING";
}

function flattenItems(nodes){
  const out = [];
  (nodes||[]).forEach(function walk(n){
    out.push(n);
    (n.children||[]).forEach(walk);
  });
  return out;
}

function statusLabel(status){
  switch(status){
    case "OK": return "OK";
    case "NOT_OK": return "Non conforme";
    default: return "En attente";
  }
}

function statusClass(status){
  switch(status){
    case "OK": return "pill-ok";
    case "NOT_OK": return "pill-bad";
    default: return "pill-wait";
  }
}

function computeRootStatus(items){
  let ok = 0; let bad = 0; let wait = 0;
  for(const item of items){
    const s = normStatus(item.status);
    if(s === "OK") ok += 1;
    else if(s === "NOT_OK") bad += 1;
    else wait += 1;
  }
  return { ok, bad, wait };
}

function updateProgress(){
  let total = 0;
  let ok = 0;
  const nodes = TREE || [];
  nodes.forEach(function walk(n){
    if(isItem(n)){
      total += 1;
      if(normStatus(n.status) === "OK") ok += 1;
    }
    (n.children||[]).forEach(walk);
  });
  const bar = document.getElementById('progress-bar');
  const text = document.getElementById('progress-text');
  if(bar){
    const pct = total === 0 ? 0 : Math.round((ok / total) * 100);
    bar.style.width = pct + '%';
  }
  if(text){
    text.textContent = `${ok} / ${total} vérifiés`;
  }
}

function renderParents(){
  const bar = document.getElementById('root-buttons');
  if(!bar) return;
  bar.innerHTML = '';
  const roots = ROOTS || [];
  roots.forEach(root => {
    const status = ROOT_STATUS.get(root.id) || { ok: 0, bad: 0, wait: 0 };
    const label = status.bad > 0 ? 'Non conforme' : (status.ok > 0 ? 'OK' : 'En attente');
    const classes = ["parent-pill"];
    if(status.bad > 0) classes.push('pill-bad');
    else if(status.ok > 0 && status.wait === 0) classes.push('pill-ok');
    else classes.push('pill-wait');
    const pill = el('button', {
      class: classes.join(' '),
      onclick: () => loadRoot(root.id)
    },
      el('div', {class: 'parent-pill-left'},
        el('span', {class: 'status-dot ' + (status.bad > 0 ? 'dot-bad' : (status.ok > 0 && status.wait === 0 ? 'dot-ok' : 'dot-wait'))}),
        el('span', {class: 'parent-pill-name'}, root.name || 'Parent'),
      ),
      el('span', {class: 'parent-pill-status'}, label)
    );
    if(root.id === CURRENT_ROOT_ID){
      pill.classList.add('is-active');
    }
    bar.appendChild(pill);
  });
}

function renderTree(nodes){
  const treeEl = document.getElementById('tree');
  if(!treeEl) return;
  treeEl.innerHTML = '';
  (nodes||[]).forEach(node => {
    treeEl.appendChild(renderNode(node));
  });
  updateProgress();
}

function renderNode(node){
  const status = normStatus(node.status);
  const wrapper = el('div', {class: `node state-${status === 'NOT_OK' ? 'bad' : status.toLowerCase()}`});
  const header = el('div', {class: 'header' + (isGroup(node) ? ' toggle' : '')});
  const left = el('div', {class: 'left'},
    el('span', {class: 'status-dot ' + (status === 'NOT_OK' ? 'dot-bad' : status === 'OK' ? 'dot-ok' : 'dot-wait')}),
    el('span', {class: 'name'}, node.name || '—'),
  );
  header.appendChild(left);

  if(isGroup(node)){
    const meta = computeRootStatus(flattenItems(node.children));
    const sub = el('div', {class: 'substats'},
      el('span', {class: 'chip ok'}, `OK : ${meta.ok}`),
      el('span', {class: 'chip wait'}, `En attente : ${meta.wait}`),
      el('span', {class: 'chip bad'}, `Non conformes : ${meta.bad}`),
    );
    header.appendChild(sub);
    header.addEventListener('click', () => {
      childWrap.classList.toggle('collapsed');
    });
  }else{
    const actions = el('div', {class: 'actions'},
      el('button', {class: 'btn sm success', onclick: () => setItemStatus(node.id, 'OK')}, 'OK'),
      el('button', {class: 'btn sm danger', onclick: () => setItemStatus(node.id, 'NOT_OK')}, 'NOK'),
      el('button', {class: 'btn sm ghost', onclick: () => setItemStatus(node.id, 'PENDING')}, 'Attente'),
    );
    header.appendChild(actions);
  }

  wrapper.appendChild(header);

  const childWrap = el('div', {class: 'childs'});
  (node.children||[]).forEach(child => childWrap.appendChild(renderNode(child)));
  wrapper.appendChild(childWrap);
  return wrapper;
}

function setItemStatus(id, status){
  fetch(`/verification-periodique/api/item/${id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ status })
  }).then(resp => {
    if(resp.ok){
      loadRoot(CURRENT_ROOT_ID);
    }
  });
}

function loadRoot(rootId){
  CURRENT_ROOT_ID = rootId;
  fetch(`/verification-periodique/api/root/${rootId}`, { credentials: 'include' })
    .then(resp => resp.json())
    .then(data => {
      TREE = data.tree || [];
      ROOT_STATUS.set(rootId, computeRootStatus(flattenItems(TREE)));
      document.getElementById('current-root-name').textContent = data.root?.name || 'Parent';
      renderParents();
      renderTree(TREE);
    });
}

renderParents();
if(CURRENT_ROOT_ID){
  loadRoot(CURRENT_ROOT_ID);
}
</script>
{% endblock %}
